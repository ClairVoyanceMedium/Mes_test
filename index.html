```html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGI Send - Email Campaign Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FF6B3B;
            --bg-dark: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-light: #f8f9fa;
            --accent-green: #00ff88;
            --accent-purple: #8b5cf6;
        }
        
        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid #444;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #e55a32;
            border-color: #e55a32;
        }
        
        .btn-success {
            background-color: var(--accent-green);
            border-color: var(--accent-green);
            color: #000;
        }
        
        .form-control, .form-select {
            background-color: var(--bg-dark);
            border-color: #444;
            color: var(--text-light);
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--bg-dark);
            border-color: var(--primary-color);
            color: var(--text-light);
            box-shadow: 0 0 0 0.25rem rgba(255, 107, 59, 0.25);
        }
        
        .table-dark {
            --bs-table-bg: var(--bg-secondary);
        }
        
        .navbar {
            background-color: var(--bg-secondary) !important;
        }
        
        .alert-info {
            background-color: rgba(13, 202, 240, 0.1);
            border-color: #0dcaf0;
            color: #9eeaf9;
        }
        
        .alert-warning {
            background-color: rgba(255, 193, 7, 0.1);
            border-color: #ffc107;
            color: #ffecb5;
        }
        
        .masked-email {
            font-family: monospace;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .day-schedule {
            border: 1px solid #444;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: var(--bg-dark);
        }
        
        .slot-item {
            background-color: var(--bg-secondary);
            border: 1px solid #555;
            border-radius: 0.25rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        #editor {
            background-color: white;
            color: black;
        }
        
        .progress {
            background-color: var(--bg-dark);
        }
        
        .text-primary {
            color: var(--primary-color) !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark sticky-top">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-paper-plane text-primary"></i> PGI Send
            </span>
            <div class="d-flex">
                <button class="btn btn-sm btn-outline-light me-2" onclick="exportConfig()">
                    <i class="fas fa-download"></i> Export Config
                </button>
                <input type="file" id="importConfig" accept=".json" style="display: none;" onchange="importConfig(event)">
                <button class="btn btn-sm btn-outline-light" onclick="document.getElementById('importConfig').click()">
                    <i class="fas fa-upload"></i> Import Config
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Repository & Security -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fab fa-github"></i> Repository & Security</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Owner</label>
                        <input type="text" class="form-control" id="repoOwner" placeholder="username">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Repository</label>
                        <input type="text" class="form-control" id="repoName" placeholder="repo-name">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Branch</label>
                        <input type="text" class="form-control" id="repoBranch" value="main">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">GitHub PAT</label>
                        <input type="password" class="form-control" id="githubPat" placeholder="ghp_...">
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label class="form-label">Encryption Key</label>
                        <input type="password" class="form-control" id="encryptionKey" placeholder="Your secret encryption key">
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn btn-primary me-2" onclick="bootstrapRepository()">
                            <i class="fas fa-rocket"></i> Bootstrap
                        </button>
                        <button class="btn btn-outline-light me-2" onclick="verifyRepository()">
                            <i class="fas fa-check"></i> Verify
                        </button>
                        <button class="btn btn-outline-success" onclick="saveLocalConfig()">
                            <i class="fas fa-save"></i> Save Local
                        </button>
                    </div>
                </div>
                <div id="repoStatus" class="mt-3"></div>
            </div>
        </div>

        <!-- Provider & Recommendations -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-envelope"></i> Email Provider & Anti-Spam Recommendations</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Provider</label>
                        <select class="form-select" id="emailProvider" onchange="updateRecommendations()">
                            <option value="gmail">Gmail</option>
                            <option value="outlook">Outlook</option>
                            <option value="smtp">Generic SMTP</option>
                        </select>
                    </div>
                    <div class="col-md-9">
                        <div id="providerRecommendations"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Editor -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-edit"></i> Email Editor</h5>
                <div>
                    <button class="btn btn-sm btn-outline-light me-2" id="toggleEditor" onclick="toggleEditorMode()">
                        <i class="fas fa-code"></i> HTML Mode
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="copyHtml()">
                        <i class="fas fa-copy"></i> Copy HTML
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Subject</label>
                    <input type="text" class="form-control" id="emailSubject" placeholder="Email subject (use {{prenom}}, {{nom}}, {{email}})">
                </div>
                <div id="editorContainer">
                    <div id="editor" style="height: 300px;"></div>
                </div>
                <div id="htmlEditor" style="display: none;">
                    <textarea class="form-control" id="htmlContent" rows="15" placeholder="HTML content here..."></textarea>
                </div>
                <small class="text-muted">Available variables: {{email}}, {{prenom}}, {{nom}}</small>
            </div>
        </div>

        <!-- Contacts Management -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-users"></i> Contacts Management</h5>
                <div>
                    <button class="btn btn-sm btn-outline-light me-2" onclick="exportSelectedContacts()">
                        <i class="fas fa-download"></i> Export Selected
                    </button>
                    <button class="btn btn-sm btn-success" onclick="selectAll()">
                        <i class="fas fa-check-double"></i> Select All
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="unselectAll()">
                        <i class="fas fa-times"></i> Unselect All
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Import CSV/Text</label>
                        <textarea class="form-control" id="contactsInput" rows="4" placeholder="email,prenom,nom&#10;john@example.com,John,Doe&#10;jane@example.com,Jane,Smith&#10;&#10;Or paste emails one per line"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Manual Add</label>
                        <div class="row g-2">
                            <div class="col-12">
                                <input type="email" class="form-control" id="manualEmail" placeholder="Email">
                            </div>
                            <div class="col-6">
                                <input type="text" class="form-control" id="manualPrenom" placeholder="Prénom">
                            </div>
                            <div class="col-6">
                                <input type="text" class="form-control" id="manualNom" placeholder="Nom">
                            </div>
                            <div class="col-12">
                                <button class="btn btn-primary w-100" onclick="addManualContact()">
                                    <i class="fas fa-plus"></i> Add Contact
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mb-3">
                    <button class="btn btn-success" onclick="importContacts()">
                        <i class="fas fa-file-import"></i> Import & Process
                    </button>
                    <span id="contactsCount" class="badge bg-info fs-6">0 contacts</span>
                </div>

                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th>Email</th>
                                <th>Prénom</th>
                                <th>Nom</th>
                                <th width="80">Action</th>
                            </tr>
                        </thead>
                        <tbody id="contactsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Schedule Planning -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-calendar-alt"></i> Schedule Planning</h5>
            </div>
            <div class="card-body">
                <div class="schedule-grid">
                    <div class="day-schedule">
                        <h6>Lundi</h6>
                        <div id="schedule-monday"></div>
                        <button class="btn btn-sm btn-primary w-100" onclick="addScheduleSlot('monday')">
                            <i class="fas fa-plus"></i> Add Slot
                        </button>
                    </div>
                    <div class="day-schedule">
                        <h6>Mardi</h6>
                        <div id="schedule-tuesday"></div>
                        <button class="btn btn-sm btn-primary w-100" onclick="addScheduleSlot('tuesday')">
                            <i class="fas fa-plus"></i> Add Slot
                        </button>
                    </div>
                    <div class="day-schedule">
                        <h6>Mercredi</h6>
                        <div id="schedule-wednesday"></div>
                        <button class="btn btn-sm btn-primary w-100" onclick="addScheduleSlot('wednesday')">
                            <i class="fas fa-plus"></i> Add Slot
                        </button>
                    </div>
                    <div class="day-schedule">
                        <h6>Jeudi</h6>
                        <div id="schedule-thursday"></div>
                        <button class="btn btn-sm btn-primary w-100" onclick="addScheduleSlot('thursday')">
                            <i class="fas fa-plus"></i> Add Slot
                        </button>
                    </div>
                    <div class="day-schedule">
                        <h6>Vendredi</h6>
                        <div id="schedule-friday"></div>
                        <button class="btn btn-sm btn-primary w-100" onclick="addScheduleSlot('friday')">
                            <i class="fas fa-plus"></i> Add Slot
                        </button>
                    </div>
                    <div class="day-schedule">
                        <h6>Samedi</h6>
                        <div id="schedule-saturday"></div>
                        <button class="btn btn-sm btn-primary w-100" onclick="addScheduleSlot('saturday')">
                            <i class="fas fa-plus"></i> Add Slot
                        </button>
                    </div>
                    <div class="day-schedule">
                        <h6>Dimanche</h6>
                        <div id="schedule-sunday"></div>
                        <button class="btn btn-sm btn-primary w-100" onclick="addScheduleSlot('sunday')">
                            <i class="fas fa-plus"></i> Add Slot
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-bullhorn"></i> Campaign Management</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Campaign Name</label>
                        <input type="text" class="form-control" id="campaignName" placeholder="My Campaign">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">From Email (optional)</label>
                        <input type="email" class="form-control" id="campaignFrom" placeholder="custom@yourdomain.com">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Provider</label>
                        <select class="form-select" id="campaignProvider">
                            <option value="gmail">Gmail</option>
                            <option value="outlook">Outlook</option>
                            <option value="smtp">Generic SMTP</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-6">
                        <label class="form-label">Daily Limit (0 = unlimited)</label>
                        <input type="number" class="form-control" id="campaignDailyLimit" value="0" min="0">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Delay Between Emails (ms)</label>
                        <input type="number" class="form-control" id="campaignDelayMs" placeholder="Auto (2000 for Gmail)" min="100">
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-3">
                    <div>
                        <button class="btn btn-success me-2" onclick="createOrUpdateCampaign()">
                            <i class="fas fa-rocket"></i> Create/Update Campaign
                        </button>
                        <button class="btn btn-outline-light me-2" onclick="listCampaigns()">
                            <i class="fas fa-list"></i> List Campaigns
                        </button>
                        <button class="btn btn-outline-info" onclick="duplicateCampaign()">
                            <i class="fas fa-copy"></i> Duplicate
                        </button>
                    </div>
                    <div>
                        <button class="btn btn-warning me-2" onclick="pauseResumeCampaign('pause')">
                            <i class="fas fa-pause"></i> Pause
                        </button>
                        <button class="btn btn-primary me-2" onclick="pauseResumeCampaign('resume')">
                            <i class="fas fa-play"></i> Resume
                        </button>
                        <button class="btn btn-danger" onclick="pauseResumeCampaign('stop')">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </div>
                
                <div id="campaignsList" class="mt-3"></div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-chart-bar"></i> Dashboard</h5>
                <button class="btn btn-sm btn-outline-light" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="dashboardContent">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>Click Refresh to load dashboard data</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let quill;
        let contacts = [];
        let scheduleSlots = {
            monday: [], tuesday: [], wednesday: [], thursday: [],
            friday: [], saturday: [], sunday: []
        };
        let isHtmlMode = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initEditor();
            loadLocalConfig();
            updateRecommendations();
        });

        function initEditor() {
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });
        }

        function toggleEditorMode() {
            const editorContainer = document.getElementById('editorContainer');
            const htmlEditor = document.getElementById('htmlEditor');
            const toggleBtn = document.getElementById('toggleEditor');
            
            if (isHtmlMode) {
                // Switch to WYSIWYG
                quill.root.innerHTML = document.getElementById('htmlContent').value;
                editorContainer.style.display = 'block';
                htmlEditor.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-code"></i> HTML Mode';
                isHtmlMode = false;
            } else {
                // Switch to HTML
                document.getElementById('htmlContent').value = quill.root.innerHTML;
                editorContainer.style.display = 'none';
                htmlEditor.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Visual Mode';
                isHtmlMode = true;
            }
        }

        function copyHtml() {
            const html = isHtmlMode ? 
                document.getElementById('htmlContent').value : 
                quill.root.innerHTML;
            navigator.clipboard.writeText(html).then(() => {
                showAlert('HTML copied to clipboard!', 'success');
            });
        }

        function updateRecommendations() {
            const provider = document.getElementById('emailProvider').value;
            const container = document.getElementById('providerRecommendations');
            
            const recommendations = {
                gmail: {
                    dailyLimit: '500 emails/day for new accounts, up to 2,000 for established accounts',
                    rate: 'Max 2 emails/second (recommend 2-5 second delay)',
                    setup: 'Enable 2FA and use App Password',
                    dns: 'Setup SPF: v=spf1 include:_spf.google.com ~all',
                    tips: 'Warm up gradually, avoid spam trigger words'
                },
                outlook: {
                    dailyLimit: '300 emails/day for personal, up to 10,000 for business',
                    rate: 'Max 30 emails/minute (recommend 3-5 second delay)',
                    setup: 'Use app password for SMTP authentication',
                    dns: 'Setup SPF: v=spf1 include:spf.protection.outlook.com ~all',
                    tips: 'Monitor reputation, use DKIM/DMARC'
                },
                smtp: {
                    dailyLimit: 'Depends on your provider settings',
                    rate: 'Varies by provider (recommend 1-2 second delay)',
                    setup: 'Configure SMTP settings correctly',
                    dns: 'Setup SPF/DKIM/DMARC for your domain',
                    tips: 'Check provider documentation for limits'
                }
            };

            const rec = recommendations[provider];
            container.innerHTML = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> ${provider.toUpperCase()} Recommendations</h6>
                    <ul class="mb-0">
                        <li><strong>Daily Limit:</strong> ${rec.dailyLimit}</li>
                        <li><strong>Rate Limit:</strong> ${rec.rate}</li>
                        <li><strong>Setup:</strong> ${rec.setup}</li>
                        <li><strong>DNS:</strong> ${rec.dns}</li>
                        <li><strong>Tips:</strong> ${rec.tips}</li>
                    </ul>
                </div>
            `;
        }

        function saveLocalConfig() {
            const config = {
                repoOwner: document.getElementById('repoOwner').value,
                repoName: document.getElementById('repoName').value,
                repoBranch: document.getElementById('repoBranch').value,
                githubPat: document.getElementById('githubPat').value,
                encryptionKey: document.getElementById('encryptionKey').value
            };
            localStorage.setItem('pgiSendConfig', JSON.stringify(config));
            showAlert('Configuration saved locally!', 'success');
        }

        function loadLocalConfig() {
            const config = localStorage.getItem('pgiSendConfig');
            if (config) {
                const data = JSON.parse(config);
                document.getElementById('repoOwner').value = data.repoOwner || '';
                document.getElementById('repoName').value = data.repoName || '';
                document.getElementById('repoBranch').value = data.repoBranch || 'main';
                document.getElementById('githubPat').value = data.githubPat || '';
                document.getElementById('encryptionKey').value = data.encryptionKey || '';
            }
        }

        function exportConfig() {
            const config = {
                repoOwner: document.getElementById('repoOwner').value,
                repoName: document.getElementById('repoName').value,
                repoBranch: document.getElementById('repoBranch').value,
                encryptionKey: document.getElementById('encryptionKey').value,
                contacts: contacts,
                scheduleSlots: scheduleSlots
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pgi-send-config.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importConfig(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    if (config.repoOwner) document.getElementById('repoOwner').value = config.repoOwner;
                    if (config.repoName) document.getElementById('repoName').value = config.repoName;
                    if (config.repoBranch) document.getElementById('repoBranch').value = config.repoBranch;
                    if (config.encryptionKey) document.getElementById('encryptionKey').value = config.encryptionKey;
                    if (config.contacts) {
                        contacts = config.contacts;
                        renderContactsTable();
                    }
                    if (config.scheduleSlots) {
                        scheduleSlots = config.scheduleSlots;
                        renderScheduleSlots();
                    }
                    
                    showAlert('Configuration imported successfully!', 'success');
                } catch (error) {
                    showAlert('Error importing configuration: ' + error.message, 'danger');
                }
            };
            reader.readAsText(file);
        }

        async function bootstrapRepository() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const pat = document.getElementById('githubPat').value;
            
            if (!owner || !repo || !pat) {
                showAlert('Please fill in repository details and PAT', 'warning');
                return;
            }

            try {
                showAlert('Bootstrapping repository...', 'info');
                
                // Create workflow file
                await createOrUpdateFile('.github/workflows/mailer.yml', getWorkflowContent(), 'Bootstrap: Add GitHub Actions workflow');
                
                // Create package.json
                await createOrUpdateFile('mailer/package.json', getPackageJsonContent(), 'Bootstrap: Add package.json');
                
                // Create send.js
                await createOrUpdateFile('mailer/send.js', getSendJsContent(), 'Bootstrap: Add send.js');
                
                showAlert('Repository bootstrapped successfully! Check GitHub Secrets in repo settings.', 'success');
                
            } catch (error) {
                showAlert('Bootstrap error: ' + error.message, 'danger');
            }
        }

        async function verifyRepository() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const pat = document.getElementById('githubPat').value;
            
            if (!owner || !repo || !pat) {
                showAlert('Please fill in repository details', 'warning');
                return;
            }

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`, {
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('repoStatus').innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> Repository verified: ${data.full_name}
                            <br><small>Private: ${data.private}, Default branch: ${data.default_branch}</small>
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                document.getElementById('repoStatus').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Repository verification failed: ${error.message}
                    </div>
                `;
            }
        }

        async function createOrUpdateFile(path, content, message) {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const branch = document.getElementById('repoBranch').value;
            const pat = document.getElementById('githubPat').value;

            // Try to get existing file
            let sha = null;
            try {
                const getResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (getResponse.ok) {
                    const existingFile = await getResponse.json();                    sha = existingFile.sha;
                }
            } catch (error) {
                // File doesn't exist, will create new
            }

            // Create or update file
            const body = {
                message: message,
                content: btoa(unescape(encodeURIComponent(content))),
                branch: branch
            };
            
            if (sha) {
                body.sha = sha;
            }

            const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${pat}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(`Failed to create/update ${path}: ${error.message}`);
            }
        }

        function importContacts() {
            const input = document.getElementById('contactsInput').value.trim();
            if (!input) return;

            const newContacts = [];
            const lines = input.split('\n');
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                if (line.includes('@')) {
                    if (line.includes(',')) {
                        // CSV format
                        const parts = line.split(',').map(p => p.trim().replace(/"/g, ''));
                        if (parts.length >= 1) {
                            newContacts.push({
                                email: parts[0],
                                prenom: parts[1] || '',
                                nom: parts[2] || '',
                                checked: true
                            });
                        }
                    } else {
                        // Just email
                        newContacts.push({
                            email: line,
                            prenom: '',
                            nom: '',
                            checked: true
                        });
                    }
                }
            });

            // Merge and deduplicate
            const existingEmails = new Set(contacts.map(c => c.email.toLowerCase()));
            newContacts.forEach(contact => {
                if (!existingEmails.has(contact.email.toLowerCase())) {
                    contacts.push(contact);
                    existingEmails.add(contact.email.toLowerCase());
                }
            });

            // Sort alphabetically
            contacts.sort((a, b) => a.email.localeCompare(b.email));
            
            renderContactsTable();
            document.getElementById('contactsInput').value = '';
            showAlert(`Imported ${newContacts.length} new contacts`, 'success');
        }

        function addManualContact() {
            const email = document.getElementById('manualEmail').value.trim();
            const prenom = document.getElementById('manualPrenom').value.trim();
            const nom = document.getElementById('manualNom').value.trim();
            
            if (!email) {
                showAlert('Email is required', 'warning');
                return;
            }
            
            if (contacts.some(c => c.email.toLowerCase() === email.toLowerCase())) {
                showAlert('Email already exists', 'warning');
                return;
            }
            
            contacts.push({ email, prenom, nom, checked: true });
            contacts.sort((a, b) => a.email.localeCompare(b.email));
            
            renderContactsTable();
            document.getElementById('manualEmail').value = '';
            document.getElementById('manualPrenom').value = '';
            document.getElementById('manualNom').value = '';
            
            showAlert('Contact added successfully', 'success');
        }

        function renderContactsTable() {
            const tbody = document.getElementById('contactsTable');
            const count = document.getElementById('contactsCount');
            
            count.textContent = `${contacts.length} contacts (${contacts.filter(c => c.checked).length} selected)`;
            
            tbody.innerHTML = contacts.map((contact, index) => `
                <tr>
                    <td>
                        <input type="checkbox" ${contact.checked ? 'checked' : ''} 
                               onchange="toggleContact(${index})">
                    </td>
                    <td>
                        <span class="masked-email">${maskEmail(contact.email)}</span>
                    </td>
                    <td>${contact.prenom}</td>
                    <td>${contact.nom}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeContact(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function maskEmail(email) {
            const [local, domain] = email.split('@');
            if (local.length <= 2) return email;
            return local[0] + '*'.repeat(local.length - 2) + local[local.length - 1] + '@' + domain;
        }

        function toggleContact(index) {
            contacts[index].checked = !contacts[index].checked;
            renderContactsTable();
        }

        function removeContact(index) {
            contacts.splice(index, 1);
            renderContactsTable();
        }

        function selectAll() {
            contacts.forEach(c => c.checked = true);
            renderContactsTable();
        }

        function unselectAll() {
            contacts.forEach(c => c.checked = false);
            renderContactsTable();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            contacts.forEach(c => c.checked = checkbox.checked);
            renderContactsTable();
        }

        function exportSelectedContacts() {
            const selected = contacts.filter(c => c.checked);
            const csv = 'email,prenom,nom\n' + selected.map(c => `${c.email},${c.prenom},${c.nom}`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'selected-contacts.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function addScheduleSlot(day) {
            const slotId = Date.now();
            scheduleSlots[day].push({
                id: slotId,
                start: '09:00',
                end: '17:00',
                every: 30,
                batch: 1,
                enabled: true
            });
            renderScheduleSlots();
        }

        function renderScheduleSlots() {
            Object.keys(scheduleSlots).forEach(day => {
                const container = document.getElementById(`schedule-${day}`);
                container.innerHTML = scheduleSlots[day].map(slot => `
                    <div class="slot-item">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" ${slot.enabled ? 'checked' : ''} 
                                   onchange="toggleSlot('${day}', ${slot.id})">
                            <label class="form-check-label">Enabled</label>
                            <button class="btn btn-sm btn-outline-danger float-end" onclick="removeSlot('${day}', ${slot.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="row g-1">
                            <div class="col-6">
                                <input type="time" class="form-control form-control-sm" value="${slot.start}" 
                                       onchange="updateSlot('${day}', ${slot.id}, 'start', this.value)">
                            </div>
                            <div class="col-6">
                                <input type="time" class="form-control form-control-sm" value="${slot.end}" 
                                       onchange="updateSlot('${day}', ${slot.id}, 'end', this.value)">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" value="${slot.every}" min="1" 
                                       placeholder="Every (min)" onchange="updateSlot('${day}', ${slot.id}, 'every', parseInt(this.value))">
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control form-control-sm" value="${slot.batch}" min="1" 
                                       placeholder="Batch" onchange="updateSlot('${day}', ${slot.id}, 'batch', parseInt(this.value))">
                            </div>
                        </div>
                    </div>
                `).join('');
            });
        }

        function updateSlot(day, id, field, value) {
            const slot = scheduleSlots[day].find(s => s.id === id);
            if (slot) slot[field] = value;
        }

        function toggleSlot(day, id) {
            const slot = scheduleSlots[day].find(s => s.id === id);
            if (slot) slot.enabled = !slot.enabled;
        }

        function removeSlot(day, id) {
            scheduleSlots[day] = scheduleSlots[day].filter(s => s.id !== id);
            renderScheduleSlots();
        }

        async function createOrUpdateCampaign() {
            const name = document.getElementById('campaignName').value.trim();
            if (!name) {
                showAlert('Campaign name is required', 'warning');
                return;
            }

            const selectedContacts = contacts.filter(c => c.checked);
            if (selectedContacts.length === 0) {
                showAlert('Please select at least one contact', 'warning');
                return;
            }

            const subject = document.getElementById('emailSubject').value.trim();
            const html = isHtmlMode ? 
                document.getElementById('htmlContent').value : 
                quill.root.innerHTML;

            if (!subject || !html) {
                showAlert('Subject and email content are required', 'warning');
                return;
            }

            try {
                const campaignData = {
                    name: name,
                    subject: subject,
                    html: html,
                    from: document.getElementById('campaignFrom').value.trim(),
                    provider: document.getElementById('campaignProvider').value,
                    dailyLimit: parseInt(document.getElementById('campaignDailyLimit').value) || 0,
                    delayMs: parseInt(document.getElementById('campaignDelayMs').value) || null,
                    recipients: selectedContacts,
                    schedule: scheduleSlots,
                    createdAt: new Date().toISOString(),
                    status: 'active'
                };

                const encrypted = await encryptData(JSON.stringify(campaignData));
                await createOrUpdateFile(`campaigns/${name}.json`, encrypted, `Campaign: ${name}`);
                
                showAlert('Campaign created/updated successfully!', 'success');
                
            } catch (error) {
                showAlert('Error creating campaign: ' + error.message, 'danger');
            }
        }

        async function listCampaigns() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const pat = document.getElementById('githubPat').value;

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/campaigns`, {
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const files = await response.json();
                    const campaigns = files.filter(f => f.name.endsWith('.json'));
                    
                    document.getElementById('campaignsList').innerHTML = `
                        <h6>Available Campaigns (${campaigns.length})</h6>
                        <div class="list-group">
                            ${campaigns.map(c => `
                                <div class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                                    <span>${c.name.replace('.json', '')}</span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-info me-1" onclick="loadCampaign('${c.name.replace('.json', '')}')">
                                            <i class="fas fa-download"></i> Load
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" onclick="duplicateCampaign('${c.name.replace('.json', '')}')">
                                            <i class="fas fa-copy"></i> Duplicate
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('campaignsList').innerHTML = '<p class="text-muted">No campaigns folder found or empty</p>';
                }
            } catch (error) {
                showAlert('Error listing campaigns: ' + error.message, 'danger');
            }
        }

        async function loadCampaign(name) {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const pat = document.getElementById('githubPat').value;

            try {
                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/campaigns/${name}.json`, {
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const file = await response.json();
                    const encryptedContent = atob(file.content);
                    const decryptedContent = await decryptData(encryptedContent);
                    const campaign = JSON.parse(decryptedContent);

                    // Load campaign data into form
                    document.getElementById('campaignName').value = campaign.name;
                    document.getElementById('emailSubject').value = campaign.subject;
                    document.getElementById('campaignFrom').value = campaign.from || '';
                    document.getElementById('campaignProvider').value = campaign.provider;
                    document.getElementById('campaignDailyLimit').value = campaign.dailyLimit || 0;
                    document.getElementById('campaignDelayMs').value = campaign.delayMs || '';

                    // Load content
                    if (isHtmlMode) {
                        document.getElementById('htmlContent').value = campaign.html;
                    } else {
                        quill.root.innerHTML = campaign.html;
                    }

                    // Load contacts
                    contacts = campaign.recipients || [];
                    renderContactsTable();

                    // Load schedule
                    if (campaign.schedule) {
                        scheduleSlots = campaign.schedule;
                        renderScheduleSlots();
                    }

                    showAlert(`Campaign "${name}" loaded successfully!`, 'success');
                } else {
                    throw new Error('Campaign not found');
                }
            } catch (error) {
                showAlert('Error loading campaign: ' + error.message, 'danger');
            }
        }

        async function pauseResumeCampaign(action) {
            const name = document.getElementById('campaignName').value.trim();
            if (!name) {
                showAlert('Please specify campaign name', 'warning');
                return;
            }

            try {
                // Load existing campaign
                const owner = document.getElementById('repoOwner').value;
                const repo = document.getElementById('repoName').value;
                const pat = document.getElementById('githubPat').value;

                const response = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/campaigns/${name}.json`, {
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const file = await response.json();
                    const encryptedContent = atob(file.content);
                    const decryptedContent = await decryptData(encryptedContent);
                    const campaign = JSON.parse(decryptedContent);

                    // Update status
                    const statusMap = {
                        pause: 'paused',
                        resume: 'active', 
                        stop: 'stopped'
                    };
                    campaign.status = statusMap[action];

                    // Save updated campaign
                    const encrypted = await encryptData(JSON.stringify(campaign));
                    await createOrUpdateFile(`campaigns/${name}.json`, encrypted, `Campaign ${action}: ${name}`);

                    showAlert(`Campaign ${action}d successfully!`, 'success');
                } else {
                    throw new Error('Campaign not found');
                }
            } catch (error) {
                showAlert(`Error ${action}ing campaign: ${error.message}`, 'danger');
            }
        }

        async function refreshDashboard() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const pat = document.getElementById('githubPat').value;

            if (!owner || !repo || !pat) {
                showAlert('Please configure repository settings first', 'warning');
                return;
            }

            try {
                document.getElementById('dashboardContent').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

                // Get campaigns
                const campaignsResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/campaigns`, {
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }).catch(() => ({ ok: false }));

                // Get states
                const statesResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/state`, {
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }).catch(() => ({ ok: false }));

                let dashboardHtml = '<div class="row g-4">';

                if (campaignsResponse.ok) {
                    const campaignFiles = await campaignsResponse.json();
                    const campaigns = campaignFiles.filter(f => f.name.endsWith('.json'));

                    dashboardHtml += `
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-bullhorn"></i> Campaigns Overview</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Total Campaigns:</strong> ${campaigns.length}</p>
                                    <div class="list-group list-group-flush">
                                        ${campaigns.slice(0, 5).map(c => `
                                            <div class="list-group-item list-group-item-dark">
                                                ${c.name.replace('.json', '')}
                                            </div>
                                        `).join('')}
                                        ${campaigns.length > 5 ? `<div class="list-group-item list-group-item-dark text-muted">... and ${campaigns.length - 5} more</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    dashboardHtml += `
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-bullhorn"></i> Campaigns Overview</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">No campaigns found</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                if (statesResponse.ok) {
                    const stateFiles = await statesResponse.json();
                    dashboardHtml += `
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-chart-line"></i> Execution States</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Active States:</strong> ${stateFiles.length}</p>
                                    <div class="list-group list-group-flush">
                                        ${stateFiles.slice(0, 5).map(s => `
                                            <div class="list-group-item list-group-item-dark">
                                                ${s.name.replace('.json', '')}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    dashboardHtml += `
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-chart-line"></i> Execution States</h6>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">No execution states found</p>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Recent Activity
                const workflowResponse = await fetch(`https://api.github.com/repos/${owner}/${repo}/actions/runs?per_page=5`, {
                    headers: {
                        'Authorization': `Bearer ${pat}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }).catch(() => ({ ok: false }));

                if (workflowResponse.ok) {
                    const workflows = await workflowResponse.json();
                    dashboardHtml += `
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-history"></i> Recent Workflow Runs</h6>
                                </div>
                                <div class="card-body">
                                    ${workflows.workflow_runs.length > 0 ? `
                                        <div class="table-responsive">
                                            <table class="table table-dark table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Status</th>
                                                        <th>Conclusion</th>
                                                        <th>Started</th>
                                                        <th>Duration</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${workflows.workflow_runs.map(run => {
                                                        const started = new Date(run.created_at);
                                                        const finished = run.updated_at ? new Date(run.updated_at) : null;
                                                        const duration = finished ? Math.round((finished - started) / 1000) : 'N/A';
                                                        
                                                        return `
                                                            <tr>
                                                                <td><span class="badge bg-${run.status === 'completed' ? 'success' : 'warning'}">${run.status}</span></td>
                                                                <td><span class="badge bg-${run.conclusion === 'success' ? 'success' : 'danger'}">${run.conclusion || 'N/A'}</span></td>
                                                                <td>${started.toLocaleString()}</td>
                                                                <td>${duration}s</td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    ` : '<p class="text-muted">No workflow runs found</p>'}
                                </div>
                            </div>
                        </div>
                    `;
                }

                dashboardHtml += '</div>';
                document.getElementById('dashboardContent').innerHTML = dashboardHtml;

            } catch (error) {
                document.getElementById('dashboardContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error loading dashboard: ${error.message}
                    </div>
                `;
            }
        }

        async function encryptData(data) {
            const key = document.getElementById('encryptionKey').value;
            if (!key) throw new Error('Encryption key is required');

            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(key),
                'PBKDF2',
                false,
                ['deriveKey']
            );

            const salt = crypto.getRandomValues(new Uint8Array(16));
            const cryptoKey = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['encrypt']
            );

            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                cryptoKey,
                encoder.encode(data)
            );

            const result = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
            result.set(salt, 0);
            result.set(iv, salt.length);
            result.set(new Uint8Array(encrypted), salt.length + iv.length);

            return btoa(String.fromCharCode.apply(null, result));
        }

        async function decryptData(encryptedData) {
            const key = document.getElementById('encryptionKey').value;
            if (!key) throw new Error('Encryption key is required');

            const data = new Uint8Array(atob(encryptedData).split('').map(c => c.charCodeAt(0)));
            const salt = data.slice(0, 16);
            const iv = data.slice(16, 28);
            const encrypted = data.slice(28);

            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                encoder.encode(key),
                'PBKDF2',
                false,
                ['deriveKey']
            );

            const cryptoKey = await crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: 100000,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            );

            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                cryptoKey,
                encrypted
            );

            return new TextDecoder().decode(decrypted);
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function getWorkflowContent() {
            return `name: PGI Send Mailer

on:
  schedule:
    - cron: '*/5 * * * *'
  push:
    paths:
      - 'campaigns/**'
  workflow_dispatch:

concurrency:
  group: pgi-mailer
  cancel-in-progress: false

env:
  TZ: Europe/Paris

jobs:
  send-emails:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: \${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          cd mailer
          npm install
          
      - name: Run email sender
        env:
          GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}
          PGI_ENC_KEY: \${{ secrets.PGI_ENC_KEY }}
          GMAIL_USER: \${{ secrets.GMAIL_USER }}
          GMAIL_PASS: \${{ secrets.GMAIL_PASS }}
          GMAIL_FROM: \${{ secrets.GMAIL_FROM }}
          OUTLOOK_USER: \${{ secrets.OUTLOOK_USER }}
          OUTLOOK_PASS: \${{ secrets.OUTLOOK_PASS }}
          OUTLOOK_FROM: \${{ secrets.OUTLOOK_FROM }}
          SMTP_HOST: \${{ secrets.SMTP_HOST }}
          SMTP_PORT: \${{ secrets.SMTP_PORT }}
          SMTP_SECURE: \${{ secrets.SMTP_SECURE }}
          SMTP_USER: \${{ secrets.SMTP_USER }}
          SMTP_PASS: \${{ secrets.SMTP_PASS }}
          SMTP_FROM: \${{ secrets.SMTP_FROM }}
        run: |
          cd mailer
          node send.js`;
        }

        function getPackageJsonContent() {
            return `{
  "name": "pgi-send-mailer",
  "version": "1.0.0",
  "description": "PGI Send email campaign mailer",
  "main": "send.js",
  "scripts": {
    "start": "node send.js"
  },
  "dependencies": {
    "nodemailer": "^6.9.7"
  }
}`;
        }

        function getSendJsContent() {
            return `const fs = require('fs').promises;
const path = require('path');
const crypto = require('crypto');
const nodemailer = require('nodemailer');

const REPO_OWNER = process.env.GITHUB_REPOSITORY?.split('/')[0] || '';
const REPO_NAME = process.env.GITHUB_REPOSITORY?.split('/')[1] || '';
const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
const ENC_KEY = process.env.PGI_ENC_KEY;

// Day names mapping
const DAY_NAMES = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

async function main() {
    try {
        console.log('🚀 PGI Send Mailer starting...');
        
        if (!ENC_KEY) {
            throw new Error('PGI_ENC_KEY environment variable is required');
        }

        // Ensure directories exist
        await ensureDir('campaigns');
        await ensureDir('state');

        // Get all campaign files
        const campaignFiles = await getCampaignFiles();
        console.log(\`📧 Found \${campaignFiles.length} campaign(s)\`);

        for (const campaignFile of campaignFiles) {
            await processCampaign(campaignFile);
        }

        console.log('✅ PGI Send Mailer completed');
    } catch (error) {
        console.error('❌ Error in main:', error.message);
        process.exit(1);
    }
}

async function ensureDir(dirPath) {
    try {
        await fs.access(dirPath);
    } catch {
        await fs.mkdir(dirPath, { recursive: true });
    }
}

async function getCampaignFiles() {
    try {
        const files = await fs.readdir('campaigns');
        return files.filter(f => f.endsWith('.json'));
    } catch {
        return [];
    }
}

async function processCampaign(campaignFile) {
    const campaignName = path.basename(campaignFile, '.json');
    console.log(\`\\n📋 Processing campaign: \${campaignName}\`);

    try {
        // Load and decrypt campaign
        const encryptedContent = await fs.readFile(path.join('campaigns', campaignFile), 'utf8');
        const campaign = JSON.parse(await decrypt(encryptedContent));

        if (campaign.status !== 'active') {
            console.log(\`⏸️  Campaign \${campaignName} is \${campaign.status}, skipping\`);
            return;
        }

        // Load or create state
        const statePath = path.join('state', \`\${campaignName}.json\`);
        let state = await loadState(statePath);

        const recipients = campaign.recipients.filter(r => r.checked);
        if (!recipients || recipients.length === 0) {
            console.log(\`⚠️  No recipients for campaign \${campaignName}\`);
            return;
        }

        if (state.cursor >= recipients.length) {
            console.log(\`✅ Campaign \${campaignName} already completed\`);
            return;
        }

        const now = new Date();
        const today = now.toISOString().split('T')[0];
        const currentDay = DAY_NAMES[now.getDay()];
        const currentTime = \`\${now.getHours().toString().padStart(2, '0')}:\${now.getMinutes().toString().padStart(2, '0')}\`;

        // Reset daily count if new day
        if (state.lastRunDay !== today) {
            state.perDay[today] = 0;
            state.lastRunDay = today;
        }

        const sentToday = state.perDay[today] || 0;
        const dailyLimit = campaign.dailyLimit || 0;

        if (dailyLimit > 0 && sentToday >= dailyLimit) {
            console.log(\`📊 Daily limit reached for \${campaignName} (\${sentToday}/\${dailyLimit})\`);
            return;
        }

        // Get active slots for current day
        const daySchedule = campaign.schedule?.[currentDay] || [];
        const activeSlots = daySchedule.filter(slot => 
            slot.enabled && 
            currentTime >= slot.start && 
            currentTime <= slot.end
        );

        if (activeSlots.length === 0) {
            console.log(\`⏰ No active time slots for \${campaignName} on \${currentDay} at \${currentTime}\`);
            return;
        }

        // Process each active slot
        let totalSent = 0;
        
        for (let i = 0; i < activeSlots.length; i++) {
            const slot = activeSlots[i];
            const slotKey = \`\${currentDay}#\${i}\`;
            
            const ticksSent = await processSlot(campaign, state, slot, slotKey, now, recipients, sentToday + totalSent);
            totalSent += ticksSent;
            
            if (dailyLimit > 0 && sentToday + totalSent >= dailyLimit) {
                console.log(\`📊 Daily limit reached after processing slot\`);
                break;
            }
        }

        // Update state
        state.perDay[today] = sentToday + totalSent;
        state.lastRun = now.toISOString();
        
        if (state.cursor >= recipients.length) {
            state.completed = true;
            console.log(\`🎉 Campaign \${campaignName} completed!\`);
        }

        await saveState(statePath, state);
        
        if (totalSent > 0) {
            console.log(\`📤 Total sent for \${campaignName}: \${totalSent}\`);
        }

    } catch (error) {
        console.error(\`❌ Error processing campaign \${campaignName}:, error.message\`);
        
        // Update state with error
        try {
            const statePath = path.join('state', \`\${campaignName}.json\`);
            const state = await loadState(statePath);
            state.lastError = error.message;
            state.lastErrorAt = new Date().toISOString();
            await saveState(statePath, state);
        } catch (stateError) {
            console.error('Failed to save error state:', stateError.message);
        }
    }
}

async function processSlot(campaign, state, slot, slotKey, now, recipients, currentSentToday) {
    console.log(\`⏰ Processing slot: \${slot.start}-\${slot.end}, every \${slot.every}min, batch \${slot.batch}\`);
    
    // Initialize slot state if needed
    if (!state.lastTickAt[slotKey]) {
        // Find first aligned tick time
        const [startHour, startMin] = slot.start.split(':').map(Number);
        const slotStart = new Date(now);
        slotStart.setHours(startHour, startMin, 0, 0);
        
        // Find next aligned tick
        let alignedTick = new Date(slotStart);
        while (alignedTick <= now) {
            alignedTick = new Date(alignedTick.getTime() + slot.every * 60000);
        }
        
        state.lastTickAt[slotKey] = alignedTick.toISOString();
        console.log(\`🔧 Initialized slot \${slotKey} with first tick at \${alignedTick.toISOString()}\`);
        return 0; // Don't send on initialization
    }

    const lastTick = new Date(state.lastTickAt[slotKey]);
    const timeSinceLastTick = now - lastTick;
    const tickIntervalMs = slot.every * 60000;
    
    // Calculate how many ticks are due
    const ticksDue = Math.floor(timeSinceLastTick / tickIntervalMs);
    
    if (ticksDue <= 0) {
        console.log(\`⏳ No ticks due for slot \${slotKey} (next in \${Math.ceil((tickIntervalMs - timeSinceLastTick) / 1000)}s)\`);
        return 0;
    }

    console.log(\`⚡ \${ticksDue} tick(s) due for slot \${slotKey}\`);

    // Calculate how many emails to send
    let toSend = ticksDue * slot.batch;
    
    // Apply limits
    const remaining = recipients.length - state.cursor;
    const dailyLimit = campaign.dailyLimit || 0;
    const dailyRemaining = dailyLimit > 0 ? dailyLimit - currentSentToday : Infinity;
    
    toSend = Math.min(toSend, remaining, dailyRemaining);
    
    if (toSend <= 0) {
        console.log(\`🚫 No emails to send (remaining: \${remaining}, daily remaining: \${dailyRemaining})\`);
        // Still update last tick time
        const newLastTick = new Date(lastTick.getTime() + ticksDue * tickIntervalMs);
        state.lastTickAt[slotKey] = newLastTick.toISOString();
        return 0;
    }

    console.log(\`📨 Sending \${toSend} email(s) for slot \${slotKey}\`);

    // Send emails
    let sent = 0;
    const delayMs = campaign.delayMs || getDefaultDelay(campaign.provider);
    
    for (let i = 0; i < toSend && state.cursor < recipients.length; i++) {
        const recipient = recipients[state.cursor];
        
        try {
            await sendEmail(campaign, recipient);
            state.cursor++;
            sent++;
            
            console.log(\`✉️  Sent to \${recipient.email.split('@')[0]}***@\${recipient.email.split('@')[1]} (\${state.cursor}/\${recipients.length})\`);
            
            // Delay between emails (except for last one)
            if (i < toSend - 1 && delayMs > 0) {
                await sleep(delayMs);
            }
            
        } catch (error) {
            console.error(\`❌ Failed to send to \${recipient.email}: \${error.message}\`);
            
            // Retry once
            try {
                console.log(\`🔄 Retrying \${recipient.email}...\`);
                await sleep(1000);
                await sendEmail(campaign, recipient);
                state.cursor++;
                sent++;
                console.log(\`✉️  Retry successful for \${recipient.email.split('@')[0]}***@\${recipient.email.split('@')[1]}\`);
            } catch (retryError) {
                console.error(\`❌ Retry failed for \${recipient.email}: \${retryError.message}\`);
                // Skip this recipient
                state.cursor++;
                state.lastError = retryError.message;
                state.lastErrorAt = new Date().toISOString();
            }
            
            if (delayMs > 0) {
                await sleep(delayMs);
            }
        }
    }

    // Update last tick time
    const newLastTick = new Date(lastTick.getTime() + ticksDue * tickIntervalMs);
    state.lastTickAt[slotKey] = newLastTick.toISOString();
    
    return sent;
}

async function sendEmail(campaign, recipient) {
    const transporter = createTransporter(campaign.provider);
    
    // Personalize content
    let subject = campaign.subject;
    let html = campaign.html;
    
    if (recipient.prenom) {
        subject = subject.replace(/{{prenom}}/g, recipient.prenom);
        html = html.replace(/{{prenom}}/g, recipient.prenom);
    }
    
    if (recipient.nom) {
        subject = subject.replace(/{{nom}}/g, recipient.nom);
        html = html.replace(/{{nom}}/g, recipient.nom);
    }
    
    subject = subject.replace(/{{email}}/g, recipient.email);
    html = html.replace(/{{email}}/g, recipient.email);

    const from = campaign.from || getDefaultFrom(campaign.provider);
    
    const mailOptions = {
        from: from,
        to: recipient.email,
        subject: subject,
        html: html,
        headers: {
            'List-Unsubscribe': '<mailto:unsubscribe@example.com>',
            'List-Unsubscribe-Post': 'List-Unsubscribe=One-Click'
        }
    };

    await transporter.sendMail(mailOptions);
}

function createTransporter(provider) {
    switch (provider) {
        case 'gmail':
            return nodemailer.createTransporter({
                service: 'gmail',
                auth: {
                    user: process.env.GMAIL_USER,
                    pass: process.env.GMAIL_PASS
                }
            });
            
        case 'outlook':
            return nodemailer.createTransporter({
                service: 'hotmail',
                auth: {
                    user: process.env.OUTLOOK_USER,
                    pass: process.env.OUTLOOK_PASS
                }
            });
            
        case 'smtp':
        default:
            return nodemailer.createTransporter({
                host: process.env.SMTP_HOST,
                port: parseInt(process.env.SMTP_PORT) || 587,
                secure: process.env.SMTP_SECURE === 'true',
                auth: {
                    user: process.env.SMTP_USER,
                    pass: process.env.SMTP_PASS
                }
            });
    }
}

function getDefaultFrom(provider) {
    switch (provider) {
        case 'gmail':
            return process.env.GMAIL_FROM || process.env.GMAIL_USER;
        case 'outlook':
            return process.env.OUTLOOK_FROM || process.env.OUTLOOK_USER;
        case 'smtp':
        default:
            return process.env.SMTP_FROM || process.env.SMTP_USER;
    }
}

function getDefaultDelay(provider) {
    switch (provider) {
        case 'gmail':
            return 2000; // 2 seconds
        case 'outlook':
            return 3000; // 3 seconds
        case 'smtp':
        default:
            return 1000; // 1 second
    }
}

async function loadState(statePath) {
    try {
        const content = await fs.readFile(statePath, 'utf8');
        return JSON.parse(content);
    } catch {
        // Create new state
        return {
            cursor: 0,
            perDay: {},
            lastTickAt: {},
            lastRun: null,
            lastRunDay: null,
            completed: false,
            lastError: null,
            lastErrorAt: null
        };
    }
}

async function saveState(statePath, state) {
    await fs.writeFile(statePath, JSON.stringify(state, null, 2));
}

async function decrypt(encryptedData) {
    const data = Buffer.from(encryptedData, 'base64');
    const salt = data.subarray(0, 16);
    const iv = data.subarray(16, 28);
    const encrypted = data.subarray(28);

    const key = crypto.pbkdf2Sync(ENC_KEY, salt, 100000, 32, 'sha256');
    
    const decipher = crypto.createDecipherGCM('aes-256-gcm');
    const authTag = encrypted.subarray(-16);
    const ciphertext = encrypted.subarray(0, -16);
    
    decipher.setAuthTag(authTag);
    
    let decrypted = decipher.update(ciphertext, null, 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Run the main function
main();`;
        }

        async function bootstrapFiles() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const pat = document.getElementById('githubPat').value;
            
            if (!owner || !repo || !pat) {
                showAlert('Please fill in all repository details', 'warning');
                return;
            }

            try {
                showAlert('Creating automation files...', 'info');

                // Create workflow file
                await createOrUpdateFile('.github/workflows/mailer.yml', getWorkflowContent(), 'Add PGI Send workflow');
                
                // Create package.json
                await createOrUpdateFile('mailer/package.json', getPackageJsonContent(), 'Add mailer package.json');
                
                // Create send.js
                await createOrUpdateFile('mailer/send.js', getSendJsContent(), 'Add mailer send.js');

                showAlert('✅ Automation files created successfully! Your repository is now configured for PGI Send.', 'success');

            } catch (error) {
                showAlert('Error creating files: ' + error.message, 'danger');
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Quill editor
            quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'script': 'sub'}, { 'script': 'super' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'direction': 'rtl' }],
                        [{ 'size': ['small', false, 'large', 'huge'] }],
                        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'font': [] }],
                        [{ 'align': [] }],
                        ['clean'],
                        ['link', 'image']
                    ]
                }
            });

            // Initialize schedule slots
            renderScheduleSlots();

            // Set default encryption key placeholder
            document.getElementById('encryptionKey').placeholder = 'Enter a strong encryption key (min. 16 characters)';

            // Auto-refresh dashboard every 30 seconds if it's visible
            setInterval(() => {
                const dashboardTab = document.getElementById('dashboard-tab');
                if (dashboardTab && dashboardTab.classList.contains('active')) {
                    refreshDashboard();
                }
            }, 30000);
        });
    </script>
</body>
</html>

