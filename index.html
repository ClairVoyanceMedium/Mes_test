<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  
  <title>Chat IA Spirituel - ClairVoyanceMedium.com</title>
  <meta name="description" content="ClairVoyanceGPT - Assistant spirituel IA pour d√©senvo√ªtement, protection et guidance. Frederick du Cabinet ClairVoyanceMedium.com vous accompagne.">
  
  <!-- Favicon -->
  <link rel="icon" href="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/GmyGlKk.webp">
  <meta name="theme-color" content="#8B0000">
  
  <!-- Google Analytics 4 - Enhanced -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2RSFE6WL4M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2RSFE6WL4M', {
      'anonymize_ip': true,
      'send_page_view': true,
      'cookie_flags': 'SameSite=None;Secure',
      'user_properties': {
        'device_category': /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
        'browser_language': navigator.language,
        'screen_resolution': `${screen.width}x${screen.height}`
      }
    });
    gtag('config', 'GTM-P3J6SXCH', {'anonymize_ip': true});

    // Enhanced GA4 ecommerce + engagement groups
    gtag('set', 'user_properties', {
      platform: /iPhone|iPad|iPod/.test(navigator.userAgent) ? 'ios' :
                /Android/.test(navigator.userAgent) ? 'android' : 'desktop',
      session_source: document.referrer || 'direct'
    });
  </script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg:#000;
      --text:#fff;
      --gold:#FFD700;
      --tab-gold:#BBAE98;
      --orange:#FF8C00;
      --orange-light:#FFA500;
      --silver:#C0C0C0;
      --accent:#87CEEB;
      --blue-sky:#87CEEB;
      --neon-blue:#66FFFF;
      /* ‚úÖ Bandeau bleu l√©g√®rement plus clair */
      --banner-blue:#8DDFFF;
    }
    
    *{margin:0;padding:0;box-sizing:border-box;}
    
    html{
      height:100%;
      overflow-x:hidden;
      -webkit-text-size-adjust:100%;
      -ms-text-size-adjust:100%;
    }
    
    body{
      font-family:'Cinzel',serif;
      background:var(--bg);
      color:var(--text);
      text-align:center;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      padding-top:95px;
      min-height:100vh;
      position:relative;
    }
    
    nav{
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:1000;
      background:rgba(0,0,0,0.30);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      padding:0.6118rem 0.4370rem;
      box-shadow:0 2px 15px rgba(255,215,0,0.3);
    }
    
    nav ul{
      list-style:none;
      padding:0;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:0.3496rem;
      max-width:1200px;
      margin:0 auto;
    }
    
    nav ul li:nth-child(4n+1),
    nav ul li:nth-child(4n+2),
    nav ul li:nth-child(4n+3){
      margin-right:0.2622rem;
    }
    
    nav ul li a{
      font-family:'Cinzel',serif;
      font-size:clamp(0.74727rem, 1.8354vw, 0.91333rem);
      color:var(--tab-gold);
      text-decoration:none;
      padding:0.54188rem 0.7866rem;
      background:rgba(17,17,17,0.45);
      border:3px solid var(--tab-gold);
      border-radius:0;
      transition:all .3s ease;
      display:inline-block;
      text-align:center;
      min-height:37.596px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    nav ul li a:hover{
      background:var(--tab-gold);
      color:#111;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(187,174,152,0.5);
    }
    
    @keyframes blinkTab{
      0%, 100%{
        box-shadow:0 0 15px var(--orange);
        border-color:var(--orange);
        transform:scale(1);
      }
      50%{
        box-shadow:0 0 25px var(--orange-light);
        border-color:var(--orange-light);
        transform:scale(1.03);
      }
    }
    
    nav ul li a.blink{
      animation:blinkTab 1.2s ease-in-out infinite;
      background:#000;
      border-color:var(--orange);
      color:var(--tab-gold) !important;
    }
    
    nav ul li a.fixed{
      background:#000;
      border-color:var(--orange);
      box-shadow:0 0 20px var(--orange);
      color:var(--tab-gold) !important;
      animation:none;
    }

    /* ‚úÖ Onglet nav illumin√© quand cit√© dans la r√©ponse IA - clignotement marketing */
    nav ul li a.ai-cited{
      background:#000 !important;
      border-color:var(--banner-blue) !important;
      color:#fff !important;
      animation:blinkCitedMarketing 1.5s ease-in-out infinite !important;
    }

    /* ‚úÖ Clignotement marketing : alternances d'intensit√© irr√©guli√®res pour attirer l'≈ìil */
    @keyframes blinkCitedMarketing{
      0%   { box-shadow:0 0 8px var(--banner-blue), 0 0 18px rgba(141,223,255,0.4);  border-color:var(--banner-blue); transform:scale(1); }
      12%  { box-shadow:0 0 32px var(--banner-blue), 0 0 65px rgba(141,223,255,0.9), 0 0 100px rgba(141,223,255,0.5); border-color:#E8F8FF; transform:scale(1.05); }
      22%  { box-shadow:0 0 6px var(--banner-blue),  0 0 12px rgba(141,223,255,0.3);  border-color:var(--banner-blue); transform:scale(1); }
      35%  { box-shadow:0 0 45px var(--banner-blue), 0 0 85px rgba(141,223,255,1),   0 0 120px rgba(141,223,255,0.6); border-color:#fff; transform:scale(1.07); }
      48%  { box-shadow:0 0 5px var(--banner-blue),  0 0 10px rgba(141,223,255,0.2);  border-color:var(--banner-blue); transform:scale(1); }
      62%  { box-shadow:0 0 28px var(--banner-blue), 0 0 55px rgba(141,223,255,0.85), 0 0 90px rgba(141,223,255,0.45); border-color:#CCF4FF; transform:scale(1.04); }
      74%  { box-shadow:0 0 7px var(--banner-blue),  0 0 14px rgba(141,223,255,0.3);  border-color:var(--banner-blue); transform:scale(1); }
      88%  { box-shadow:0 0 38px var(--banner-blue), 0 0 75px rgba(141,223,255,0.95), 0 0 110px rgba(141,223,255,0.55); border-color:#E0FAFF; transform:scale(1.06); }
      100% { box-shadow:0 0 8px var(--banner-blue),  0 0 18px rgba(141,223,255,0.4);  border-color:var(--banner-blue); transform:scale(1); }
    }
    
    .scrolling-banner{
      position:relative;
      width:100%;
      background:#000;
      padding:0.8rem 0;
      overflow:hidden;
      cursor:pointer;
      /* ‚úÖ Bleu l√©g√®rement plus clair */
      border-top:1px solid rgba(141,223,255,0.35);
      border-bottom:1px solid rgba(141,223,255,0.35);
    }
    
    .scrolling-banner:hover{
      background:rgba(141,223,255,0.05);
    }
    
    .scrolling-content{
      display:flex;
      width:max-content;
      animation:scroll-left 20s linear infinite;
    }
    
    @keyframes scroll-left{
      0%{transform:translateX(0);}
      100%{transform:translateX(-50%);}
    }
    
    /* ‚úÖ Bleu bandeau un ton plus clair : #8DDFFF au lieu de #66FFFF */
    .scrolling-text{
      display:inline-block;
      white-space:nowrap;
      font-family:'Cinzel',serif;
      font-size:clamp(1.1rem, 2.5vw, 1.4rem);
      font-weight:700;
      color:var(--banner-blue);
      text-shadow:0 0 10px var(--banner-blue), 0 0 20px var(--banner-blue), 0 0 30px rgba(141,223,255,0.7);
      padding:0 3rem;
      letter-spacing:0.15em;
      text-transform:uppercase;
    }
    
    header{
      padding:1.2rem 0;
      background:#111;
      box-shadow:0 4px 10px rgba(0,0,0,.8);
    }
    
    .logo{
      width:1400px;
      max-width:97%;
      height:auto;
      display:block;
      margin:0 auto;
    }
    
    .chat-intro{
      max-width:900px;
      margin:0.6rem auto 0.8rem;
      padding:0 1rem;
      font-size:clamp(1.4rem, 5vw, 2.2rem);
      background:linear-gradient(145deg, #C0C0C0, #E8E8E8, #A8A8A8);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-weight:700;
    }
    
    .chat-subtitle{
      max-width:800px;
      margin:1.5rem auto 4rem;
      padding:0 1.5rem;
      font-size:clamp(0.95rem, 2.2vw, 1.15rem);
      color:var(--tab-gold);
      line-height:1.6;
      font-style:italic;
    }
    
    #chat-container{
      max-width:900px;
      margin:1rem auto 2rem;
      padding:0 1rem;
    }
    
    #chat-box{
      background:#111;
      border:3px solid var(--orange);
      box-shadow:0 0 22px var(--orange), 0 0 39px rgba(255,140,0,0.7);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:650px;
      border-radius:0;
      position:relative;
      transition:border-color 0.08s ease, box-shadow 0.08s ease;
    }

    /* ‚úÖ BLOQUER PULL-TO-REFRESH iOS + Android ‚Äî m√©thode CSS la plus fiable */
html, body {
  overscroll-behavior-y: none;       /* Chrome/Android : bloque le pull-to-refresh natif */
  -webkit-overflow-scrolling: auto;  /* iOS : d√©sactive le momentum scroll natif qui cause le refresh */
}
    #reset-chat-btn{
      position:absolute;
      top:8px;
      right:16px;
      z-index:20;
      background:transparent;
      border:1px solid rgba(255,255,255,0.35);
      color:rgba(255,255,255,0.55);
      font-size:0.85rem;
      width:26px;
      height:26px;
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s ease;
      padding:0;
      line-height:1;
      title:"R√©initialiser le chat";
    }
    #reset-chat-btn:hover{
      color:#fff;
      border-color:rgba(255,100,100,0.7);
      background:rgba(255,60,60,0.18);
    }

    /* ===== BOUTON PARAM√àTRES + PANEL VOIX ===== */
    #settings-btn{
      position:absolute;
      top:38px;
      right:16px;
      z-index:20;
      background:transparent;
      border:1px solid rgba(255,255,255,0.35);
      color:rgba(255,255,255,0.55);
      font-size:0.75rem;
      width:26px;
      height:26px;
      border-radius:50%;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.2s ease;
      padding:0;
      line-height:1;
    }
    #settings-btn:hover{
      color:var(--banner-blue);
      border-color:rgba(141,223,255,0.6);
      background:rgba(141,223,255,0.12);
    }
    #settings-panel{
      display:none;
      position:absolute;
      top:68px;
      right:8px;
      z-index:200;
      background:#111;
      border:1px solid rgba(141,223,255,0.3);
      border-radius:4px;
      padding:1rem;
      min-width:220px;
      max-width:calc(100% - 16px);
      box-shadow:0 4px 24px rgba(0,0,0,0.7);
      font-family:Georgia,serif;
    }
    #settings-panel.open{ display:block; }
    #settings-panel h4{
      font-family:'Cinzel',serif;
      color:var(--banner-blue);
      font-size:0.75rem;
      letter-spacing:0.12em;
      margin-bottom:0.7rem;
      text-transform:uppercase;
    }
    #voice-select{
      width:100%;
      background:#1a1a1a;
      border:1px solid rgba(141,223,255,0.25);
      color:#fff;
      font-family:Georgia,serif;
      font-size:0.8rem;
      padding:0.4rem 0.5rem;
      border-radius:2px;
      cursor:pointer;
      margin-bottom:0.6rem;
    }
    #voice-select:focus{ outline:none; border-color:var(--banner-blue); }
    #voice-test-btn{
      width:100%;
      background:transparent;
      border:1px solid rgba(141,223,255,0.3);
      color:rgba(141,223,255,0.8);
      font-family:'Cinzel',serif;
      font-size:0.72rem;
      padding:0.4rem;
      border-radius:2px;
      cursor:pointer;
      transition:all 0.2s;
      letter-spacing:0.08em;
    }
    #voice-test-btn:hover{
      background:rgba(141,223,255,0.1);
      color:#fff;
    }
    #settings-panel .settings-note{
      font-size:0.68rem;
      color:rgba(255,255,255,0.3);
      font-style:italic;
      margin-top:0.6rem;
      line-height:1.4;
    }
    .settings-row{
      margin:0.65rem 0 0.2rem;
    }
    .settings-row label{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:0.72rem;
      color:rgba(255,255,255,0.55);
      font-family:Georgia,serif;
      margin-bottom:0.3rem;
      letter-spacing:0.04em;
    }
    .settings-row label span{
      color:var(--banner-blue);
      font-size:0.68rem;
      min-width:52px;
      text-align:right;
    }
    .settings-row input[type=range]{
      width:100%;
      -webkit-appearance:none;
      appearance:none;
      height:4px;
      border-radius:2px;
      background:linear-gradient(to right, var(--banner-blue) 0%, var(--banner-blue) 50%, rgba(255,255,255,0.15) 50%);
      outline:none;
      cursor:pointer;
    }
    .settings-row input[type=range]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:14px;
      height:14px;
      border-radius:50%;
      background:var(--banner-blue);
      box-shadow:0 0 6px rgba(141,223,255,0.6);
      cursor:pointer;
      border:none;
    }
    .settings-row input[type=range]::-moz-range-thumb{
      width:14px;
      height:14px;
      border-radius:50%;
      background:var(--banner-blue);
      box-shadow:0 0 6px rgba(141,223,255,0.6);
      cursor:pointer;
      border:none;
    }
    
    #chat-messages{
      flex:1;
      padding:1.5rem;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      color:#fff;
      background:#0a0a0a;
    }
    
    #chat-messages::-webkit-scrollbar{width:10px;}
    #chat-messages::-webkit-scrollbar-track{background:#1a1a1a;}
    #chat-messages::-webkit-scrollbar-thumb{background:var(--orange);box-shadow:0 0 9px var(--orange);}
    
    #chat-messages p{
      margin-bottom:1rem;
      line-height:1.7;
      opacity:0;
      animation:fadeIn 0.6s forwards;
    }
    
    @keyframes fadeIn{to{opacity:1;}}
    
    .bot-message{
      text-align:left;
      color:#fff;
      background:rgba(255,140,0,0.15);
      padding:1rem;
      margin-bottom:1rem;
      border:2px solid var(--orange);
      box-shadow:0 0 17px rgba(255,140,0,0.55);
      max-width:90%;
      border-radius:0;
    }
    
    .user-message{
      text-align:right;
      color:#fff;
      margin-bottom:1rem;
      border:2px solid var(--silver);
      box-shadow:0 0 17px rgba(192,192,192,0.55);
      padding:1rem;
      max-width:90%;
      margin-left:auto;
      background:linear-gradient(145deg, rgba(192,192,192,0.1), rgba(211,211,211,0.08));
      border-radius:0;
    }

    /* ‚úÖ Curseur clignotant pour l'affichage mot par mot */
    .typing-cursor::after{
      content:'‚ñå';
      color:var(--banner-blue);
      animation:cursorBlink 0.7s ease-in-out infinite;
      margin-left:2px;
      font-size:0.9em;
    }

    @keyframes cursorBlink{
      0%, 100%{opacity:1;}
      50%{opacity:0;}
    }
    
    #chat-form{
      display:flex;
      flex-direction:column;
      border-top:3px solid var(--orange);
      padding:1rem;
      background:#111;
      gap:0.8rem;
    }
    
    .input-row{
      display:flex;
      gap:0.7rem;
      align-items:center;
    }
    
    #chat-input{
      flex:1;
      padding:1rem;
      border:2px solid var(--orange);
      outline:none;
      color:#fff;
      background:#0a0a0a;
      font-family:'Cinzel',serif;
      font-size:16px;
      box-shadow:0 0 13px rgba(255,140,0,0.45);
      border-radius:0;
      -webkit-appearance:none;
      -moz-appearance:none;
      appearance:none;
    }
    
    #chat-input::placeholder{
      color:#999;
      opacity:0.7;
      font-style:italic;
    }
    
    /* ‚úÖ Ic√¥ne sticky : orange au repos, BLEU pendant la lecture vocale */
    #voice-toggle{
      position:fixed;
      bottom:50px;
      right:30px;
      width:81px;
      height:81px;
      background:transparent;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.4s ease;
      z-index:999;
    }
    
    #voice-toggle.active,
    #voice-toggle:not(.disabled){
      filter:drop-shadow(0 0 15px rgba(255,140,0,0.6)) !important;
      -webkit-filter:drop-shadow(0 0 15px rgba(255,140,0,0.6)) !important;
      opacity:1 !important;
    }
    
    #voice-toggle:hover:not(.disabled):not(.speaking){
      transform:scale(1.1);
      filter:drop-shadow(0 0 25px rgba(255,165,0,0.9)) !important;
      -webkit-filter:drop-shadow(0 0 25px rgba(255,165,0,0.9)) !important;
    }
    
    #voice-toggle.disabled{
      opacity:0.4 !important;
      filter:grayscale(1) drop-shadow(0 0 5px rgba(100,100,100,0.3)) !important;
      -webkit-filter:grayscale(1) drop-shadow(0 0 5px rgba(100,100,100,0.3)) !important;
    }
    
    #voice-toggle svg{
      width:100%;
      height:100%;
    }

    /* ‚úÖ Animation BLEUE pour la lecture vocale - du d√©but √† la fin */
    @keyframes speakerPulseBlue{
      0%, 100%{
        filter:drop-shadow(0 0 18px rgba(141,223,255,0.95)) drop-shadow(0 0 35px rgba(102,220,255,0.7));
        -webkit-filter:drop-shadow(0 0 18px rgba(141,223,255,0.95)) drop-shadow(0 0 35px rgba(102,220,255,0.7));
        transform:scale(1);
      }
      25%{
        filter:drop-shadow(0 0 28px rgba(141,223,255,1)) drop-shadow(0 0 55px rgba(102,220,255,0.9));
        -webkit-filter:drop-shadow(0 0 28px rgba(141,223,255,1)) drop-shadow(0 0 55px rgba(102,220,255,0.9));
        transform:scale(1.06);
      }
      50%{
        filter:drop-shadow(0 0 40px rgba(135,206,235,1)) drop-shadow(0 0 70px rgba(141,223,255,0.85));
        -webkit-filter:drop-shadow(0 0 40px rgba(135,206,235,1)) drop-shadow(0 0 70px rgba(141,223,255,0.85));
        transform:scale(1.13);
      }
      75%{
        filter:drop-shadow(0 0 30px rgba(141,223,255,1)) drop-shadow(0 0 58px rgba(102,220,255,0.9));
        -webkit-filter:drop-shadow(0 0 30px rgba(141,223,255,1)) drop-shadow(0 0 58px rgba(102,220,255,0.9));
        transform:scale(1.08);
      }
    }

    /* ‚úÖ Animation syllabique : s'intensifie selon les syllabes */
    @keyframes speakerPulseBlueIntense{
      0%, 100%{
        filter:drop-shadow(0 0 22px rgba(141,223,255,1)) drop-shadow(0 0 45px rgba(102,220,255,0.8));
        -webkit-filter:drop-shadow(0 0 22px rgba(141,223,255,1)) drop-shadow(0 0 45px rgba(102,220,255,0.8));
        transform:scale(1.08);
      }
      50%{
        filter:drop-shadow(0 0 55px rgba(141,223,255,1)) drop-shadow(0 0 90px rgba(102,220,255,1));
        -webkit-filter:drop-shadow(0 0 55px rgba(141,223,255,1)) drop-shadow(0 0 90px rgba(102,220,255,1));
        transform:scale(1.18);
      }
    }
    
    /* ‚úÖ Remplacement de l'ancienne animation orange par le bleu pendant la parole */
    #voice-toggle.speaking:not(.disabled){
      animation:speakerPulseBlue 1.1s ease-in-out infinite !important;
      filter:none !important;
      -webkit-filter:none !important;
    }

    #voice-toggle.speaking.syllable-peak:not(.disabled){
      animation:speakerPulseBlueIntense 0.35s ease-in-out !important;
    }
    
    /* Conservation de l'ancien speakerPulse pour r√©f√©rence si besoin */
    @keyframes speakerPulse{
      0%, 100%{
        filter:drop-shadow(0 0 15px rgba(255,140,0,0.6));
        transform:scale(1);
      }
      50%{
        filter:drop-shadow(0 0 30px rgba(255,215,0,0.9));
        transform:scale(1.08);
      }
    }
    
    #chat-send{
      width:100%;
      background:linear-gradient(145deg,var(--orange-light),var(--orange));
      border:2px solid var(--orange);
      padding:1rem 1.8rem;
      cursor:pointer;
      color:#fff;
      font-weight:bold;
      font-family:'Cinzel',serif;
      box-shadow:0 0 20px rgba(255,140,0,0.65);
      font-size:1.1rem;
      transition:transform .2s;
      border-radius:0;
    }
    
    #chat-send:hover{
      transform:scale(1.03);
      box-shadow:0 0 28px rgba(255,140,0,0.85);
    }
    
    /* ‚úÖ Floating tab : contour bleu ciel clignotant marketing */
    .floating-tab{
      position:fixed;
      top:50%;
      right:20px;
      transform:translateY(-50%);
      z-index:9999;
      background:#000;
      color:var(--tab-gold);
      padding:1.2rem 2rem;
      border:3px solid var(--banner-blue);
      font-family:'Cinzel',serif;
      font-size:clamp(1rem, 2.5vw, 1.3rem);
      font-weight:bold;
      text-decoration:none;
      cursor:pointer;
      box-shadow:0 0 15px var(--banner-blue), 0 0 30px rgba(141,223,255,0.5);
      animation:blinkFloatingBlue 1.6s ease-in-out infinite;
      display:none;
      user-select:none;
      border-radius:0;
      will-change:transform, box-shadow;
      transition:box-shadow 0.3s ease;
    }

    .floating-tab.show{display:block;}

    .floating-tab .close-btn{
      position:absolute;
      top:-8px;
      right:-8px;
      width:24px;
      height:24px;
      background:var(--banner-blue);
      color:#000;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      font-weight:bold;
      border:2px solid #fff;
      z-index:10000;
    }

    /* ‚úÖ Clignotement marketing bleu ciel pour le floating tab */
    @keyframes blinkFloatingBlue{
      0%   { box-shadow:0 0 12px var(--banner-blue), 0 0 28px rgba(141,223,255,0.5);  border-color:var(--banner-blue); }
      18%  { box-shadow:0 0 40px var(--banner-blue), 0 0 75px rgba(141,223,255,0.95), 0 0 110px rgba(141,223,255,0.5); border-color:#E8FAFF; }
      30%  { box-shadow:0 0 8px var(--banner-blue),  0 0 16px rgba(141,223,255,0.3);  border-color:var(--banner-blue); }
      50%  { box-shadow:0 0 50px var(--banner-blue), 0 0 90px rgba(141,223,255,1),   0 0 130px rgba(141,223,255,0.6); border-color:#fff; }
      65%  { box-shadow:0 0 10px var(--banner-blue), 0 0 20px rgba(141,223,255,0.35); border-color:var(--banner-blue); }
      82%  { box-shadow:0 0 32px var(--banner-blue), 0 0 60px rgba(141,223,255,0.85), 0 0 95px rgba(141,223,255,0.45); border-color:#CCF4FF; }
      100% { box-shadow:0 0 12px var(--banner-blue), 0 0 28px rgba(141,223,255,0.5);  border-color:var(--banner-blue); }
    }
    
    .return-line{
      font-family:'Cinzel',serif;
      font-size:0.9rem;
      margin:4.5rem auto 1rem;
      text-align:center;
      padding:0 1rem;
    }
    
    .return-line a,
    .return-line a:link,
    .return-line a:visited,
    .return-line a:hover,
    .return-line a:active{
      color:#BBAE98 !important;
      text-decoration:underline;
      transition:all 0.3s ease;
      display:inline-block;
    }
    
    .return-line a:hover{
      opacity:0.8;
    }
    
    /* ‚úÖ Footer avec espacement correct entre les lignes */
    footer{
      margin-top:2rem;
      font-size:.9rem;
      color:#aaa;
      padding:1.5rem 1rem 2rem;
      background:#111;
    }

    footer a{
      color:#aaa !important;
      text-decoration:none;
    }
    
    footer a:hover{
      color:#fff !important;
    }
    
    @media(max-width:1024px){
      body{padding-top:120px;}
      .logo{width:1200px;}
    }
    
    @media(max-width:768px){
      body{padding-top:140px;}
      nav{padding:0.58121rem 0.33212rem;}
      nav ul{gap:0.33212rem;}
      nav ul li a{
        font-size:0.68085rem;
        padding:0.45665rem 0.66424rem;
        min-height:35.716px;
      }
      #chat-box{height:550px;}
      .logo{width:94%;}
      header{padding:1rem 0;}
      .chat-intro{margin:0.5rem auto 0.6rem;}
      .chat-subtitle{font-size:0.9rem;padding:0 1rem;margin:1.2rem auto 3.5rem;}
      .scrolling-text{font-size:1rem;padding:0 2rem;}
      .floating-tab{right:10px;padding:0.9rem 1.3rem;font-size:0.95rem;}
      #voice-toggle{bottom:50px;right:20px;width:75px;height:75px;}
      footer{padding:1.2rem 1rem 1.5rem;}
    }
    
    @media(max-width:480px){
      body{padding-top:180px;}
      nav ul{gap:0.29056rem;}
      nav ul li a{
        font-size:0.62272rem;
        padding:0.41515rem 0.58121rem;
        min-height:33.201px;
      }
      #chat-box{height:500px;}
      .logo{width:91%;}
      header{padding:0.8rem 0;}
      .chat-intro{margin:0.4rem auto 0.5rem;}
      .chat-subtitle{font-size:0.85rem;margin:1rem auto 3rem;}
      .scrolling-text{font-size:0.9rem;padding:0 1.5rem;}
      #voice-toggle{bottom:50px;right:15px;width:69px;height:69px;}
      footer{padding:1rem 0.5rem 1rem;}
    }
  </style>

  <style>
    /* ‚úÖ WIDGET SATISFACTION ‚Äî appara√Æt apr√®s 3min, animation d'entr√©e √©l√©gante */
    #satisfaction-widget{
      display:none;
      position:fixed;
      bottom:max(30px, env(safe-area-inset-bottom, 30px));
      left:50%;
      /* ‚úÖ iOS Fix : transform seul, sans will-change qui casse position:fixed sur Safari */
      -webkit-transform:translateX(-50%) translateY(40px);
      transform:translateX(-50%) translateY(40px);
      z-index:99999;
      background:linear-gradient(135deg,#0a0a0a 0%,#111 100%);
      border:2px solid var(--banner-blue);
      box-shadow:0 0 25px rgba(141,223,255,0.35), 0 0 60px rgba(141,223,255,0.15), 0 8px 32px rgba(0,0,0,0.7);
      padding:1.4rem 1.8rem 1.2rem;
      border-radius:4px;
      text-align:center;
      width:clamp(290px, 88vw, 440px);
      opacity:0;
      -webkit-transition:opacity 0.5s ease, -webkit-transform 0.5s cubic-bezier(0.22,1,0.36,1);
      transition:opacity 0.5s ease, transform 0.5s cubic-bezier(0.22,1,0.36,1);
      font-family:'Cinzel',serif;
      /* ‚úÖ Pas de will-change ‚Äî cause un stacking context qui masque le widget sur iOS Safari */
    }
    #satisfaction-widget.visible{
      opacity:1;
      -webkit-transform:translateX(-50%) translateY(0);
      transform:translateX(-50%) translateY(0);
    }
    #satisfaction-widget .sw-close{
      position:absolute;
      top:7px;right:10px;
      background:none;border:none;
      color:rgba(255,255,255,0.3);
      font-size:1rem;cursor:pointer;
      transition:color 0.2s;
      padding:2px 6px;
    }
    #satisfaction-widget .sw-close:hover{color:#fff;}
    #satisfaction-widget .sw-eyebrow{
      font-size:0.62rem;
      letter-spacing:0.18em;
      color:var(--banner-blue);
      text-transform:uppercase;
      margin-bottom:0.45rem;
      opacity:0.85;
    }
    #satisfaction-widget .sw-title{
      font-size:clamp(0.9rem,2.5vw,1.05rem);
      color:#fff;
      margin-bottom:0.3rem;
      line-height:1.35;
    }
    #satisfaction-widget .sw-sub{
      font-size:0.7rem;
      color:rgba(255,255,255,0.4);
      margin-bottom:1rem;
      font-family:Georgia,serif;
      font-style:italic;
    }
    #satisfaction-widget .sw-stars{
      display:flex;
      justify-content:center;
      gap:0.5rem;
      margin-bottom:1rem;
    }
    #satisfaction-widget .sw-star{
      font-size:2rem;
      cursor:pointer;
      color:rgba(255,255,255,0.15);
      transition:color 0.15s ease, transform 0.15s ease;
      user-select:none;
      line-height:1;
    }
    #satisfaction-widget .sw-star:hover,
    #satisfaction-widget .sw-star.hovered,
    #satisfaction-widget .sw-star.selected{
      color:#FFD700;
      transform:scale(1.2);
    }
    #satisfaction-widget .sw-comment{
      display:none;
      flex-direction:column;
      gap:0.6rem;
      margin-top:0.3rem;
    }
    #satisfaction-widget .sw-comment textarea{
      width:100%;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(141,223,255,0.25);
      border-radius:3px;
      color:#fff;
      font-family:Georgia,serif;
      font-size:0.8rem;
      padding:0.6rem;
      resize:none;
      height:70px;
      outline:none;
      box-sizing:border-box;
    }
    #satisfaction-widget .sw-comment textarea::placeholder{color:rgba(255,255,255,0.25);}
    #satisfaction-widget .sw-comment textarea:focus{border-color:var(--banner-blue);}
    #satisfaction-widget .sw-send{
      background:linear-gradient(135deg,var(--banner-blue),#4499CC);
      color:#000;
      border:none;
      border-radius:2px;
      padding:0.55rem 1.4rem;
      font-family:'Cinzel',serif;
      font-size:0.8rem;
      font-weight:bold;
      cursor:pointer;
      letter-spacing:0.08em;
      transition:opacity 0.2s;
      width:100%;
    }
    #satisfaction-widget .sw-send:hover{opacity:0.85;}
    #satisfaction-widget .sw-thanks{
      display:none;
      color:var(--banner-blue);
      font-size:0.95rem;
      padding:0.5rem 0;
      animation:fadeIn 0.4s ease;
    }
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  </style>
</head>
<body>
  <nav>
    <ul>
      <li><a href="https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/" target="_blank" rel="noopener noreferrer" data-keywords="t√©l√©phone|appel|30min|t√©l|telephoner|appeler|phone" data-exact="voyance t√©l√©phone">Voyance T√©l 30min/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp" target="_blank" rel="noopener noreferrer" data-keywords="email|questions|mail|courriel|√©crit|3questions" data-exact="voyance email">Voyance Email x3/12‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp" target="_blank" rel="noopener noreferrer" data-keywords="retour|ex|amour|reconqu√©rir|s√©paration|copain|copine" data-exact="retour ex">Retour Amour/175‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp" target="_blank" rel="noopener noreferrer" data-keywords="compatibilit√©|couple|relation|amoureuse" data-exact="compatibilit√©">Compatibilit√©/20‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp" target="_blank" rel="noopener noreferrer" data-keywords="purification|protection|sort|envo√ªtement|magie|sorcellerie|fatigue|cauchemars" data-exact="purification">Purification/150‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp" target="_blank" rel="noopener noreferrer" data-keywords="d√©funt|mort|message|deuil|d√©c√©d√©" data-exact="d√©funt">D√©funt/17‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp" target="_blank" rel="noopener noreferrer" data-keywords="sant√©|m√©decine|bien-√™tre|maladie" data-exact="sant√©">Sant√©/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp" target="_blank" rel="noopener noreferrer" data-keywords="main|chiromancie|ligne|paume" data-exact="main">Main/10‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp" target="_blank" rel="noopener noreferrer" data-keywords="ange|gardien|c√©leste|protection divine" data-exact="ange">Ange/10‚Ç¨</a></li>
    </ul>
  </nav>
  
  <div class="scrolling-banner" id="scrolling-banner">
    <div class="scrolling-content">
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
    </div>
  </div>
  
  <header>
    <picture>
      <source srcset="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
      <img src="https://i.imgur.com/GmyGlKk.jpg" alt="Logo ClairVoyanceMedium" class="logo" width="720" height="720" loading="eager" decoding="async" fetchpriority="high">
    </picture>
  </header>
  
  <div class="chat-intro">Chat IA Spirituel - ClairVoyanceGPT</div>
  
  <div class="chat-subtitle">Posez vos questions en toute confidentialit√© √† notre intelligence artificielle spirituelle guid√©e par Frederick, m√©dium depuis plus de 25 ans. Obtenez instantan√©ment des r√©ponses personnalis√©es sur l'amour, la protection, la voyance et bien plus encore.</div>
  
  <div id="chat-container">
    <div id="chat-box">
      <button type="button" id="reset-chat-btn" title="R√©initialiser le chat">üóë</button>
      <button type="button" id="settings-btn" title="Param√®tres voix">‚öô</button>
      <div id="settings-panel">
        <h4>‚ú¶ Voix de l'assistant</h4>
        <select id="voice-select">
          <option value="">Chargement des voix‚Ä¶</option>
        </select>

        <div class="settings-row">
          <label for="speed-slider">Vitesse <span id="speed-val">Normal</span></label>
          <input type="range" id="speed-slider" min="0.5" max="1.5" step="0.05" value="0.88">
        </div>

        <div class="settings-row">
          <label for="pitch-slider">Tonalit√© <span id="pitch-val">Normal</span></label>
          <input type="range" id="pitch-slider" min="0.5" max="2.0" step="0.05" value="1.15">
        </div>

        <button type="button" id="voice-test-btn">‚ñ∂ Tester</button>
        <p class="settings-note">Voix fran√ßaises en t√™te de liste. Pour en ajouter : R√©glages ‚Üí Accessibilit√© ‚Üí Contenu √©nonc√© ‚Üí Voix ‚Üí Fran√ßais.</p>
      </div>
      <div id="chat-messages"></div>
      <form id="chat-form">
        <div class="input-row">
          <input type="text" id="chat-input" placeholder="Votre question..." autocomplete="off">
        </div>
        <button type="submit" id="chat-send">Envoyer</button>
      </form>
    </div>
  </div>

  <!-- ‚úÖ WIDGET SATISFACTION ‚Äî d√©clench√© apr√®s 3min de conversation active -->
  <div id="satisfaction-widget" role="dialog" aria-label="√âvaluation">
    <button class="sw-close" id="sw-close-btn" title="Fermer">‚úï</button>
    <div class="sw-eyebrow">‚ú¶ Votre avis nous guide ‚ú¶</div>
    <div class="sw-title">Nos r√©v√©lations vous ont-elles √©clair√© ?</div>
    <div class="sw-sub">Quelques secondes pour nous aider √† mieux vous servir</div>
    <div class="sw-stars" id="sw-stars">
      <span class="sw-star" data-value="1">‚òÖ</span>
      <span class="sw-star" data-value="2">‚òÖ</span>
      <span class="sw-star" data-value="3">‚òÖ</span>
      <span class="sw-star" data-value="4">‚òÖ</span>
      <span class="sw-star" data-value="5">‚òÖ</span>
    </div>
    <div class="sw-comment" id="sw-comment">
      <textarea id="sw-textarea" placeholder="Un mot sur votre exp√©rience ? (facultatif)"></textarea>
      <button class="sw-send" id="sw-send-btn">Envoyer mon avis</button>
    </div>
    <div class="sw-thanks" id="sw-thanks" style="display:none;"></div>
  </div>
  
  <button type="button" id="voice-toggle" class="active" title="Assistant vocal">
    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="circleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#FFA500;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:1" />
        </linearGradient>
        <linearGradient id="circleGradientBlue" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#8DDFFF;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#66CCFF;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#4499CC;stop-opacity:1" />
        </linearGradient>
        <radialGradient id="glowGradient">
          <stop offset="0%" style="stop-color:#FFA500;stop-opacity:0.6" />
          <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:0" />
        </radialGradient>
        <radialGradient id="glowGradientBlue">
          <stop offset="0%" style="stop-color:#8DDFFF;stop-opacity:0.7" />
          <stop offset="100%" style="stop-color:#4499CC;stop-opacity:0" />
        </radialGradient>
        <filter id="softShadow">
          <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
          <feOffset dx="0" dy="2" result="offsetblur"/>
          <feComponentTransfer>
            <feFuncA type="linear" slope="0.4"/>
          </feComponentTransfer>
          <feMerge>
            <feMergeNode/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      
      <!-- Cercle glow orange (repos) / bleu (parole) g√©r√© via JS -->
      <circle id="svg-glow-bg" cx="50" cy="50" r="40" fill="url(#glowGradient)" opacity="0.5"/>
      <!-- Cercle principal orange (repos) / bleu (parole) -->
      <circle id="svg-main-circle" cx="50" cy="50" r="35" fill="url(#circleGradient)" filter="url(#softShadow)"/>
      <ellipse cx="50" cy="35" rx="25" ry="12" fill="#ffffff" opacity="0.2"/>
      
      <g fill="#ffffff">
        <path d="M35 40 L35 60 L42 60 L52 68 L52 32 L42 40 Z"/>
        <path class="wave1" d="M58 45 Q62 50 58 55" stroke="#ffffff" stroke-width="2.5" fill="none" opacity="0.8"/>
        <path class="wave2" d="M63 42 Q68 50 63 58" stroke="#ffffff" stroke-width="2.5" fill="none" opacity="0.6"/>
        <path class="wave3" d="M68 39 Q74 50 68 61" stroke="#ffffff" stroke-width="2.5" fill="none" opacity="0.4"/>
      </g>
    </svg>
  </button>
  
  <div class="return-line">
    <a href="https://www.clairvoyancemedium.com/" target="_blank" rel="noopener noreferrer">Retour vers le cabinet de voyance ClairVoyanceMedium.com</a>
  </div>
  
  <a id="floating-tab" class="floating-tab" href="#" target="_blank" rel="noopener noreferrer">
    <span class="close-btn">√ó</span>
    <span id="floating-text">Ce qu'il vous faut !</span>
  </a>
  
  <!-- ‚úÖ Footer exactement comme l'original -->
  <footer>
    <p>¬© 2006-<span id="current-year"></span> ClairVoyanceMedium.com - Tous droits r√©serv√©s</p>
    <p><a href="https://www.clairvoyancemedium.com/Conditions-Generales-des-Ventes-et-d-Utilisation-ccsaaaaaa.asp" target="_blank" rel="noopener noreferrer">Conditions G√©n√©rales</a></p>
  </footer>
  
  <script>
document.getElementById('current-year').textContent = new Date().getFullYear();

// ==========================================
// üî• TRACKING GA4 ULTRA MAXIMUM ABSOLU üî•
// ==========================================

function trackEvent(eventName, params = {}) {
  if (typeof gtag === 'function') {
    gtag('event', eventName, params);
    console.log('üìä GA4:', eventName, params);
  }
}

// ‚úÖ GA4 Enhanced : d√©tection plateforme + param√®tres enrichis
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
const isAndroid = /Android/.test(navigator.userAgent);
// ‚úÖ D√©tection tablette : √©cran large + touch (iPad, Android tablet, Surface)
const isTablet = (navigator.maxTouchPoints > 1) && (Math.min(screen.width, screen.height) >= 600);
const isAndroidTablet = isAndroid && isTablet;
const isIpadOS = isIOS && isTablet;
const isMobile = isIOS || isAndroid || /Mobile/.test(navigator.userAgent);
const devicePlatform = isIOS ? (isTablet ? 'ios_tablet' : 'ios') : isAndroid ? (isTablet ? 'android_tablet' : 'android') : 'desktop';

// ‚úÖ D√©lai boundary par plateforme ‚Äî calibr√© pr√©cis√©ment pour chaque moteur TTS
// Android phone  : boundary d√©clench√© ~118ms avant prononciation
// Android tablet : moteur TTS l√©g√®rement plus lent sur tablette ‚Üí 108ms
// iOS/iPad       : pas de boundary, utilise rAF
// Desktop        : boundary quasi-imm√©diat ‚Üí 30ms suffit
// ‚úÖ BOUNDARY : d√©lai minimal ‚Äî le boundary fire l√©g√®rement avant le mot
// 20ms suffit pour aligner texte/voix sans cr√©er de retard cumulatif
// ZERO progression : c'√©tait la cause du drift de 4-5 mots sur textes longs
const BOUNDARY_BASE_DELAY = isAndroidTablet ? 360 : isAndroid ? 420 : isIOS ? 0 : 5; // Android : 420ms ‚âà demi-mot ‚Üí texte l√©g√®rement apr√®s la voix
const BOUNDARY_STEP_MS = 0;   // supprim√© ‚Äî √©tait la source du retard cumulatif
const BOUNDARY_STEP_WORDS = 999; // d√©sactiv√©

trackEvent('page_view', {
  page_title: document.title,
  page_location: window.location.href,
  page_path: window.location.pathname,
  page_referrer: document.referrer,
  screen_resolution: `${screen.width}x${screen.height}`,
  viewport_size: `${window.innerWidth}x${window.innerHeight}`,
  device_type: isMobile ? 'mobile' : 'desktop',
  device_platform: devicePlatform,
  browser: navigator.userAgent,
  language: navigator.language,
  connection_type: (navigator.connection && navigator.connection.effectiveType) || 'unknown'
});

// ‚úÖ GA4 Enhanced : tracking temps de chargement
window.addEventListener('load', () => {
  if (window.performance) {
    const perf = window.performance.timing;
    const loadTime = perf.loadEventEnd - perf.navigationStart;
    trackEvent('page_load_performance', {
      load_time_ms: loadTime,
      dom_content_loaded: perf.domContentLoadedEventEnd - perf.navigationStart,
      dns_time: perf.domainLookupEnd - perf.domainLookupStart,
      device_platform: devicePlatform
    });
  }
});

document.addEventListener('visibilitychange', () => {
  // GA4 tracking
  trackEvent('page_visibility_change', {
    visibility_state: document.visibilityState,
    hidden: document.hidden
  });
  // ‚úÖ Timer cumulatif : sauvegarde/restauration en un seul handler
  if (document.hidden) {
    savePresenceTime();
  } else {
    sessionStartTime = Date.now();
    try { _cumulBase = parseInt(localStorage.getItem('sv_cumul_ms') || '0'); } catch(e) {}
  }
});

document.addEventListener('copy', (e) => {
  const selection = window.getSelection().toString();
  if (selection.length > 0) {
    trackEvent('text_copied', {
      text_length: selection.length,
      text_preview: selection.substring(0, 50)
    });
  }
});

window.addEventListener('orientationchange', () => {
  trackEvent('orientation_change', {
    orientation: screen.orientation ? screen.orientation.type : window.orientation
  });
});

let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    trackEvent('window_resized', {
      new_width: window.innerWidth,
      new_height: window.innerHeight
    });
  }, 500);
});

window.addEventListener('online', () => {
  trackEvent('connection_status_change', {status: 'online'});
});
window.addEventListener('offline', () => {
  trackEvent('connection_status_change', {status: 'offline'});
});

window.addEventListener('error', (e) => {
  trackEvent('javascript_error', {
    error_message: e.message,
    error_filename: e.filename,
    error_line: e.lineno
  });
});

document.addEventListener('contextmenu', (e) => {
  trackEvent('right_click', {
    element: e.target.tagName,
    element_id: e.target.id || 'none'
  });
});

let userName = '';
let userNameConfirmed = false;
let pendingName = '';
let messageCount = 0;
let voiceEnabled = true;
let recognition = null;
let currentBlinkingTab = null;
let currentFixedTab = null;
let fixedTabTimeout = null;
let nonUnderstoodCount = 0;
let currentUtterance = null;
let sessionStartTime = Date.now();

// ‚úÖ TEMPS CUMULATIF ‚Äî compte le temps r√©el pass√© sur le site, toutes sessions confondues
// sv_cumul_ms = total accumul√© lors des sessions pr√©c√©dentes
// getPresenceMs() = sv_cumul_ms + temps depuis l'arriv√©e sur cette page
let _cumulBase = 0;
try { _cumulBase = parseInt(localStorage.getItem('sv_cumul_ms') || '0'); } catch(e) {}

function getPresenceMs() {
  return _cumulBase + (Date.now() - sessionStartTime);
}

function savePresenceTime() {
  try { localStorage.setItem('sv_cumul_ms', getPresenceMs().toString()); } catch(e) {}
}

// Sauvegarde aussi quand la page se ferme
window.addEventListener('beforeunload', savePresenceTime);
let animationFrameId = null;

let randomBlinkInterval = null;
let randomBlinkActive = true;
let allNavLinks = [];

// ‚úÖ Identifiant de session vocale pour √©viter les conflits entre utterances
let currentSpeechSession = 0;

// ‚úÖ Animation bleue continue - √©tat global
let blueAnimActive = false;
let blueAnimFrame = null;
let syllableIntensity = 0;

// ‚úÖ iOS keepalive pour la synth√®se vocale
let iosKeepAliveTimer = null;

const PHONE_NUMBER = "+33695468923";
let lastFloatingUrl = null;   // ‚úÖ M√©morise le dernier lien flottant propos√©
let lastFloatingIsPhone = false;

const STORAGE_KEY = 'clairvoyance_chat_history';
const STORAGE_TIMESTAMP = 'clairvoyance_chat_timestamp';
const SESSION_KEY = 'clairvoyance_session_active';

// ‚úÖ Historique de conversation g√©r√© en m√©moire (pour le mot-par-mot)
let conversationHistory = [];

function saveConversation() {
  const data = {
    messages: conversationHistory,
    userName,
    userNameConfirmed,
    messageCount
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  localStorage.setItem(STORAGE_TIMESTAMP, Date.now().toString());
  localStorage.setItem(SESSION_KEY, 'true');
  
  trackEvent('conversation_saved', {
    message_count: messageCount
  });
}

function loadConversation() {
  const timestamp = localStorage.getItem(STORAGE_TIMESTAMP);
  const sessionActive = localStorage.getItem(SESSION_KEY);
  
  if (!timestamp || !sessionActive) return false;
  
  const age = Date.now() - parseInt(timestamp);
  const twentyFourHours = 24 * 60 * 60 * 1000;
  
  if (age > twentyFourHours || sessionActive !== 'true') {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STORAGE_TIMESTAMP);
    localStorage.removeItem(SESSION_KEY);
    return false;
  }
  
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return false;
  const data = JSON.parse(raw);
  if (!data || !data.messages) return false;
  
  conversationHistory = data.messages;
  
  const messagesDiv = document.getElementById('chat-messages');
  messagesDiv.innerHTML = '';
  conversationHistory.forEach(msg => {
    const p = document.createElement('p');
    p.className = msg.isBot ? 'bot-message' : 'user-message';
    p.textContent = msg.text;
    messagesDiv.appendChild(p);
  });
  
  userName = data.userName || '';
  userNameConfirmed = data.userNameConfirmed || false;
  messageCount = data.messageCount || 0;
  
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  trackEvent('conversation_restored', {
    message_count: messageCount,
    user_confirmed: userNameConfirmed,
    age_hours: Math.round(age / 3600000)
  });
  
  return true;
}

window.addEventListener('beforeunload', () => {
  const sessionDuration = Date.now() - sessionStartTime;
  localStorage.setItem(SESSION_KEY, 'false');
  trackEvent('session_end', {
    message_count: messageCount,
    duration_seconds: Math.round(sessionDuration / 1000),
    duration_minutes: Math.round(sessionDuration / 60000),
    user_confirmed: userNameConfirmed,
    user_name: userName || 'anonymous'
  });
});

const conversationRestored = loadConversation();

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(randomBlinkTabs, 500);
  });
} else {
  setTimeout(randomBlinkTabs, 500);
}

const TAB_URLS = [
  'https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/',
  'https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp',
  'https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp',
  'https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp',
  'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp',
  'https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp',
  'https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp',
  'https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp',
  'https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp'
];

const scrollingBanner = document.getElementById('scrolling-banner');

scrollingBanner.addEventListener('mouseenter', () => {
  trackEvent('scrolling_banner_hover');
});

scrollingBanner.addEventListener('click', () => {
  trackEvent('scrolling_banner_clicked', {
    destination: 'clairvoyancemedium.com',
    time_on_page: Math.round((Date.now() - sessionStartTime) / 1000)
  });
  window.open('https://www.clairvoyancemedium.com/', '_blank', 'noopener,noreferrer');
});

document.querySelectorAll('nav ul li a').forEach((link, index) => {
  link.addEventListener('mouseenter', () => {
    trackEvent('nav_tab_hover', {
      tab_text: link.textContent.trim(),
      tab_position: index + 1
    });
  });
  
  link.addEventListener('click', (e) => {
    trackEvent('navigation_click', {
      link_text: link.textContent.trim(),
      link_url: link.href,
      exact_match: link.getAttribute('data-exact'),
      position: index + 1,
      time_on_page: Math.round((Date.now() - sessionStartTime) / 1000)
    });
  });
});

document.querySelector('.return-line a').addEventListener('click', () => {
  trackEvent('return_link_click', {
    destination: 'clairvoyancemedium.com',
    time_on_page: Math.round((Date.now() - sessionStartTime) / 1000)
  });
});

document.querySelectorAll('footer a').forEach(link => {
  link.addEventListener('click', () => {
    trackEvent('footer_link_click', {
      link_text: link.textContent.trim(),
      link_url: link.href
    });
  });
});

let inputFocusTime = 0;

document.getElementById('chat-input').addEventListener('focus', () => {
  inputFocusTime = Date.now();
  trackEvent('chat_input_focus', {
    message_count: messageCount
  });
});

document.getElementById('chat-input').addEventListener('blur', () => {
  const focusDuration = Date.now() - inputFocusTime;
  trackEvent('chat_input_blur', {
    message_count: messageCount,
    focus_duration_seconds: Math.round(focusDuration / 1000)
  });
});

let typingTimeout;
let lastTypingTrack = 0;
let typingStartTime = 0;
let isTyping = false;

document.getElementById('chat-input').addEventListener('input', (e) => {
  clearTimeout(typingTimeout);
  const now = Date.now();
  
  if (!isTyping) {
    isTyping = true;
    typingStartTime = now;
  }
  
  if (now - lastTypingTrack > 3000 && e.target.value.length > 0) {
    trackEvent('user_typing', {
      input_length: e.target.value.length,
      message_count: messageCount,
      input_preview: e.target.value.substring(0, 30)
    });
    lastTypingTrack = now;
  }
  
  typingTimeout = setTimeout(() => {
    if (isTyping) {
      const typingDuration = Date.now() - typingStartTime;
      trackEvent('typing_stopped', {
        typing_duration: Math.round(typingDuration / 1000),
        final_length: e.target.value.length
      });
      isTyping = false;
    }
  }, 2000);
});

let isDragging = false;
let hasMoved = false;
let startX, startY;
// ‚úÖ Position m√©moris√©e en localStorage ‚Äî reste o√π on la pose, m√™me apr√®s rechargement
let offsetX = parseFloat(localStorage.getItem('floatingTabX') || '0');
let offsetY = parseFloat(localStorage.getItem('floatingTabY') || '0');
const floatingTab = document.getElementById('floating-tab');

// Appliquer la position m√©moris√©e imm√©diatement
floatingTab.style.transform = `translate(${offsetX}px, ${offsetY}px)`;

floatingTab.addEventListener('mousedown', dragStart);
floatingTab.addEventListener('touchstart', dragStart, {passive: false});

function dragStart(e) {
  if (e.target.classList.contains('close-btn')) {
    e.preventDefault();
    e.stopPropagation();
    floatingTab.classList.remove('show');
    trackEvent('floating_tab_closed', {
      url: floatingTab.href,
      time_displayed: Math.round((Date.now() - sessionStartTime) / 1000)
    });
    return;
  }

  isDragging = true;
  hasMoved = false;
  const touch = e.type === 'touchstart' ? e.touches[0] : e;
  startX = touch.clientX - offsetX;
  startY = touch.clientY - offsetY;
  floatingTab.style.transition = 'none';
  floatingTab.style.willChange = 'transform';
  // ‚úÖ Fix liens : NE PAS preventDefault ici ‚Äî sinon les clics/liens sont bloqu√©s
  // preventDefault sera appel√© dans drag() seulement si on bouge vraiment
}

document.addEventListener('mousemove', drag);
// ‚úÖ passive:false requis pour que preventDefault() fonctionne sur Android
document.addEventListener('touchmove', drag, {passive: false});

function drag(e) {
  if (!isDragging) return;

  const touch = e.type === 'touchmove' ? e.touches[0] : e;
  const newX = touch.clientX - startX;
  const newY = touch.clientY - startY;
  const movedPx = Math.sqrt(Math.pow(newX - offsetX, 2) + Math.pow(newY - offsetY, 2));

  // ‚úÖ Seuil 8px : en dessous = tap/clic, au-dessus = vrai drag
  if (movedPx > 8) {
    hasMoved = true;
    e.preventDefault(); // Bloque le scroll seulement pendant un vrai drag
  }
  if (!hasMoved) return; // Ne bouge pas le tab si c'est juste un tap

  const rect = floatingTab.getBoundingClientRect();
  const maxX = window.innerWidth - rect.width - 10;
  const maxY = window.innerHeight - rect.height - 10;
  const minY = -(window.innerHeight / 2 - rect.height / 2) + 10;

  offsetX = Math.max(-window.innerWidth + rect.width + 10, Math.min(0, newX));
  offsetY = Math.max(minY, Math.min(maxY - window.innerHeight / 2, newY));

  floatingTab.style.transform = `translate3d(${offsetX}px, ${offsetY}px, 0)`;
}

document.addEventListener('mouseup', dragEnd);
document.addEventListener('touchend', dragEnd);

function dragEnd(e) {
  if (!isDragging) return;
  isDragging = false;
  floatingTab.style.transition = 'box-shadow 0.3s ease';
  floatingTab.style.willChange = 'auto';

  if (hasMoved) {
    // ‚úÖ M√©morise la position finale ‚Äî ne bougera plus jusqu'au prochain drag
    localStorage.setItem('floatingTabX', offsetX);
    localStorage.setItem('floatingTabY', offsetY);
    trackEvent('floating_tab_dragged', {
      offset_x: Math.round(offsetX),
      offset_y: Math.round(offsetY)
    });
    e.preventDefault();
  }
}

// ==========================================
// üîµ ANIMATION BLEUE CONTINUE - rAF üîµ
// ==========================================

function startBlueAnimation(chatBox) {
  blueAnimActive = true;
  syllableIntensity = 0;
  _runBlueAnim(chatBox, Date.now());
}

function stopBlueAnimation(chatBox) {
  blueAnimActive = false;
  if (blueAnimFrame) {
    cancelAnimationFrame(blueAnimFrame);
    blueAnimFrame = null;
  }
  if (chatBox) {
    chatBox.style.borderColor = '';
    chatBox.style.boxShadow = '';
  }
  // ‚úÖ Remettre l'ic√¥ne sticky en orange apr√®s la parole
  const svgMain = document.getElementById('svg-main-circle');
  const svgGlow = document.getElementById('svg-glow-bg');
  if (svgMain) svgMain.setAttribute('fill', 'url(#circleGradient)');
  if (svgGlow) svgGlow.setAttribute('fill', 'url(#glowGradient)');
}

function _runBlueAnim(chatBox, startTime) {
  if (!blueAnimActive) return;

  const now = Date.now();
  const elapsed = now - startTime;

  // Trois ondes combin√©es pour un effet naturel et vivant
  const wave1 = Math.sin(elapsed * 0.003) * 0.5 + 0.5;       // oscillation lente
  const wave2 = Math.sin(elapsed * 0.0091 + 1.3) * 0.35 + 0.65; // oscillation rapide
  const wave3 = Math.sin(elapsed * 0.0053 + 2.7) * 0.25 + 0.75; // m√©dium
  // ‚úÖ Intensit√© syllabique : boost sur certaines syllabes
  const syllBoost = syllableIntensity * 0.4;

  const intensity = Math.min(1, wave1 * 0.38 + wave2 * 0.33 + wave3 * 0.29 + syllBoost);

  const baseGlow   = 14 + intensity * 28;
  const strongGlow = 30 + intensity * 52;
  const innerGlow  = 8  + intensity * 14;
  const opacity    = 0.55 + intensity * 0.45;

  if (chatBox) {
    chatBox.style.borderColor = `rgba(102, 220, 255, ${opacity})`;
    chatBox.style.boxShadow = [
      `0 0 ${baseGlow}px rgba(102, 220, 255, ${opacity})`,
      `0 0 ${strongGlow}px rgba(141, 223, 255, ${opacity * 0.75})`,
      `inset 0 0 ${innerGlow}px rgba(102, 220, 255, ${opacity * 0.25})`
    ].join(', ');
  }

  blueAnimFrame = requestAnimationFrame(() => _runBlueAnim(chatBox, startTime));
}

// D√©clenche un pic d'intensit√© syllabique (appel√© depuis le timing vocal)
function triggerSyllablePeak(intensity) {
  syllableIntensity = Math.min(1, intensity);
  const voiceBtn = document.getElementById('voice-toggle');
  if (voiceBtn && voiceBtn.classList.contains('speaking')) {
    voiceBtn.classList.add('syllable-peak');
    setTimeout(() => voiceBtn.classList.remove('syllable-peak'), 350);
  }
  // D√©croissance rapide
  setTimeout(() => { syllableIntensity = Math.max(0, syllableIntensity - 0.6); }, 200);
  setTimeout(() => { syllableIntensity = 0; }, 450);
}

// ==========================================
// üéôÔ∏è VOIX F√âMININE GRAVE - iOS & Android üéôÔ∏è
// ==========================================

// ‚úÖ S√©lection voix f√©minine fran√ßaise compatible iOS/Android
function getFrenchFemaleVoice(voices) {
  if (!voices || voices.length === 0) return null;

  const maleNames = ['Thomas','Nicolas','Jean','Pierre','Alain','Laurent','Philippe','Daniel'];

  // ‚úÖ PRIORIT√â 0 ‚Äî Voix choisie par l'utilisateur dans le panneau param√®tres
  // Fonctionne sur iOS ET Android ET tablette ‚Äî v√©rification en premier, toujours
  try {
    const savedVoiceName = localStorage.getItem('selected_voice_name');
    if (savedVoiceName) {
      const saved = voices.find(v => v.name === savedVoiceName);
      if (saved) return saved;
    }
  } catch(e) {}

  if (isIOS) {
    // iOS ‚Äî Am√©lie en priorit√©, puis voix fr-FR t√©l√©charg√©es
    let voice = voices.find(v => v.name.includes('Am√©lie') || v.name.includes('Amelie'));
    if (!voice) voice = voices.find(v =>
      (v.lang === 'fr-FR' || v.lang === 'fr_FR') && !maleNames.some(n => v.name.includes(n))
    );
    if (!voice) voice = voices.find(v => v.lang && v.lang.startsWith('fr') && !maleNames.some(n => v.name.includes(n)));

    try {
      const frVoices = voices.filter(v => v.lang && v.lang.startsWith('fr')).map(v => v.name).join('|');
      trackEvent('voice_selection_debug', {
        device_platform: devicePlatform,
        chosen_voice: voice ? voice.name : 'none',
        fr_voices_available: frVoices.substring(0, 100)
      });
    } catch(e) {}

    if (voice) return voice;
  }

  // Android / Desktop ‚Äî voix fr connues en priorit√©
  const femaleNames = [
    'Marie','Audrey','Julie','C√©line','Celine','Alice','Virginie',
    'L√©a','Lea','Zoe','Charlotte','Zosia','Laura','Sophie',
    'Google fran√ßais','Google French','fr-FR-Wavenet-C','fr-FR-Wavenet-A',
    'Am√©lie','Amelie'
  ];
  let voice = voices.find(v =>
    (v.lang === 'fr-FR' || v.lang === 'fr_FR' || v.lang.startsWith('fr')) &&
    femaleNames.some(n => v.name.includes(n)) &&
    !maleNames.some(n => v.name.includes(n))
  );
  if (!voice) voice = voices.find(v => v.lang === 'fr-FR' && !maleNames.some(n => v.name.includes(n)));
  if (!voice) voice = voices.find(v => v.lang && v.lang.startsWith('fr'));

  return voice;
}

// ==========================================
// üìù PONCTUATION : d√©coupage en chunks üìù
// ==========================================

// ‚úÖ Pr√©paration du texte pour la synth√®se :
// - "clairvoyancemedium.com" ‚Üí "clairvoyancemediumpointcom" (un seul bloc, z√©ro pause)
// - "24h/7jrs" ‚Üí "vingtquatreheuresursept"
// - Autres abr√©viations vocales pour fluidit√© parfaite
function prepareTextForSpeech(text) {
  return text
    // ‚úÖ clairvoyancemedium.com ‚Üí clairvoyancemediumpointcom (toutes casses)
    .replace(/clairvoyancemedium\.com/gi, 'clairvoyancemediumpointcom')
    // ‚úÖ 24h/7jrs ‚Üí vingtquatreheuresursept
    .replace(/24h\/7\s*j(rs|r)?/gi, 'vingtquatreheuresursept')
    // ‚úÖ 24h/24 ‚Üí vingtquatreheuresurvingtquatre
    .replace(/24h\/24/gi, 'vingtquatreheuresurvingtquatre')
    // ‚úÖ 7j/7 ‚Üí septjoursursept
    .replace(/7j\/7/gi, 'septjoursursept')
    // ‚úÖ Num√©ros de t√©l√©phone : 06 95 46 89 23 ‚Üí lus chiffre par chiffre naturellement
    .replace(/(\d{2})\s(\d{2})\s(\d{2})\s(\d{2})\s(\d{2})/g, '$1, $2, $3, $4, $5')
    // ‚úÖ ‚Ç¨ ‚Üí euros
    .replace(/(\d+)‚Ç¨/g, '$1 euros')
    // ‚úÖ /min ‚Üí par minute, /h ‚Üí par heure
    .replace(/\/min/gi, ' par minute')
    .replace(/\/h\b/gi, ' par heure');
}

// ‚úÖ D√©coupe le texte en segments avec pauses selon la ponctuation
function splitTextIntoChunks(text) {
  const chunks = [];
  // S√©pare sur ponctuation forte (. ! ? ‚Ä¶) et faible (, ; :)
  const parts = text.split(/(\.{1,3}|[!?‚Ä¶]+|[,;:]+)\s*/);

  let buffer = '';
  let pendingPause = 0;

  for (let i = 0; i < parts.length; i++) {
    const part = parts[i];
    if (!part) continue;

    if (/^(\.{1,3}|[!?‚Ä¶]+)$/.test(part)) {
      // Ponctuation forte ‚Üí pause longue
      if (buffer.trim()) {
        chunks.push({ text: buffer.trim(), pauseAfter: 650 });
        buffer = '';
      }
      pendingPause = 0;
    } else if (/^[,;:]+$/.test(part)) {
      // Ponctuation faible ‚Üí pause courte
      if (buffer.trim()) {
        chunks.push({ text: buffer.trim(), pauseAfter: 320 });
        buffer = '';
      }
      pendingPause = 0;
    } else {
      buffer += (buffer ? ' ' : '') + part;
    }
  }

  if (buffer.trim()) {
    chunks.push({ text: buffer.trim(), pauseAfter: 0 });
  }

  return chunks.filter(c => c.text.length > 0);
}

// ==========================================
// üîä PAROLE + AFFICHAGE MOT PAR MOT üîä
// ==========================================

// ‚úÖ Dur√©e estim√©e par mot selon la vitesse (ms)
function estimateMsPerWord(rate) {
  // ‚úÖ Vitesse r√©elle du TTS selon plateforme (pitch 0.65 grave)
  // ‚úÖ wpm recalibr√© : voix √©tait 4-5 mots en avance ‚Üí texte doit s'afficher plus vite
  // Android tablet : ~120wpm
  // iOS / iPad     : ~128wpm  
  // Desktop        : ~132wpm
  const wpm = isAndroidTablet ? 65 : isIOS ? 108 : 132; // Android rAF fallback tr√®s lent
  return Math.round(60000 / (wpm * Math.max(0.5, rate)));
}

// ‚úÖ Affichage mot par mot sans voix (fallback)
function displayWordsWithTiming(text, messageDiv, messagesDiv, onComplete) {
  const words = text.split(/\s+/).filter(w => w.length > 0);
  let i = 0;
  const ms = 210; // ms entre chaque mot sans voix

  function showNext() {
    if (!messageDiv) { if (onComplete) onComplete(); return; }
    if (i >= words.length) {
      messageDiv.classList.remove('typing-cursor');
      messageDiv.textContent = text;
      if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
      if (onComplete) onComplete();
      return;
    }
    messageDiv.textContent = words.slice(0, i + 1).join(' ');
    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
    i++;
    setTimeout(showNext, ms);
  }

  messageDiv.classList.add('typing-cursor');
  showNext();
}

// ‚úÖ Keepalive iOS : √©vite la coupure speech synthesis apr√®s ~15s
function startIosKeepAlive() {
  if (!isIOS) return;
  clearInterval(iosKeepAliveTimer);
  iosKeepAliveTimer = setInterval(() => {
    if (window.speechSynthesis.speaking) {
      window.speechSynthesis.pause();
      window.speechSynthesis.resume();
    } else {
      clearInterval(iosKeepAliveTimer);
    }
  }, 8000);
}

function stopIosKeepAlive() {
  clearInterval(iosKeepAliveTimer);
  iosKeepAliveTimer = null;
}

// ‚úÖ Fonction principale : parole + affichage mot par mot synchronis√©
// ‚úÖ UNE SEULE utterance = z√©ro gap, fluidit√© totale, sync parfaite voix/texte
function speakAndDisplay(fullText, messageDiv, messagesDiv, onComplete) {
  if (!voiceEnabled || !('speechSynthesis' in window)) {
    displayWordsWithTiming(fullText, messageDiv, messagesDiv, onComplete);
    return;
  }

  // ‚úÖ Texte affich√© = original sans URLs
  const displayText = fullText.replace(/https?:\/\/[^\s]+/g, '');
  // ‚úÖ Texte TTS = toutes substitutions (pointcom, vingtquatre, euros...)
  const speechText = prepareTextForSpeech(displayText);
  const allWords = displayText.split(/\s+/).filter(w => w.length > 0);

  // ‚úÖ FIX Android ponctuation : calculer pour chaque mot l'extra d√©lai d√ª √† la pause TTS suivante
  // La voix fait ~300ms sur virgule/; et ~650ms sur ./!/? ‚Äî on doit retarder le MOT AVANT la pause
  const wordPauseExtra = new Array(allWords.length).fill(0);
  (function buildPauseMap() {
    let wordIdx = 0;
    // Reparse le displayText pour identifier les pauses de ponctuation
    const parts = displayText.split(/(\.{1,3}|[!?‚Ä¶]+|[,;:]+)/);
    for (let i = 0; i < parts.length; i++) {
      const part = parts[i];
      if (!part) continue;
      if (/^(\.{1,3}|[!?‚Ä¶]+)$/.test(part)) {
        // Pause forte 650ms ‚Äî l'applique au dernier mot du segment pr√©c√©dent
        if (wordIdx > 0) wordPauseExtra[wordIdx - 1] += 580;
      } else if (/^[,;:]+$/.test(part)) {
        // Pause faible 300ms
        if (wordIdx > 0) wordPauseExtra[wordIdx - 1] += 260;
      } else {
        // Compte les mots dans ce segment
        const segWords = part.trim().split(/\s+/).filter(w => w.length > 0);
        wordIdx += segWords.length;
      }
    }
  })();

  // Annule toute parole en cours
  window.speechSynthesis.cancel();
  stopIosKeepAlive();

  const sessionId = ++currentSpeechSession;
  const chatBox = document.getElementById('chat-box');
  const voiceBtn = document.getElementById('voice-toggle');

  // ‚úÖ SYNCHRONISATION PARFAITE : texte appara√Æt exactement quand le mot est prononc√©
  const WORD_ANTICIPATION_MS = 0;

  function activateBlueIcon() {
    if (voiceBtn) {
      voiceBtn.classList.add('speaking');
      const svgMain = document.getElementById('svg-main-circle');
      const svgGlow = document.getElementById('svg-glow-bg');
      if (svgMain) svgMain.setAttribute('fill', 'url(#circleGradientBlue)');
      if (svgGlow) svgGlow.setAttribute('fill', 'url(#glowGradientBlue)');
    }
    startBlueAnimation(chatBox);
    startIosKeepAlive();
  }

  function deactivateIcon() {
    if (voiceBtn) {
      voiceBtn.classList.remove('speaking');
      voiceBtn.classList.remove('syllable-peak');
    }
    stopBlueAnimation(chatBox);
    stopIosKeepAlive();
  }

  function displayUpToWord(count) {
    if (!messageDiv || sessionId !== currentSpeechSession) return;
    const safe = Math.min(count, allWords.length);
    messageDiv.textContent = allWords.slice(0, safe).join(' ');
    if (safe < allWords.length) {
      messageDiv.classList.add('typing-cursor');
    } else {
      messageDiv.classList.remove('typing-cursor');
    }
    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // ‚úÖ UNE SEULE utterance = z√©ro gap inter-chunks, fluidit√© totale
  const utterance = new SpeechSynthesisUtterance(speechText);
  utterance.lang = 'fr-FR';

  // ‚úÖ iOS : getVoices() peut retourner [] si appel√© trop t√¥t ‚Äî on r√©essaie via voiceschanged
  let voices = window.speechSynthesis.getVoices();
  const femVoice = getFrenchFemaleVoice(voices);
  if (femVoice) {
    utterance.voice = femVoice;
  } else if (isIOS) {
    // iOS fallback : r√©essayer la s√©lection de voix via addEventListener (sans √©craser)
    const _iosVoiceRetry = () => {
      const v2 = window.speechSynthesis.getVoices();
      const fv2 = getFrenchFemaleVoice(v2);
      if (fv2) utterance.voice = fv2;
      window.speechSynthesis.removeEventListener('voiceschanged', _iosVoiceRetry);
    };
    window.speechSynthesis.addEventListener('voiceschanged', _iosVoiceRetry);
  }
  // ‚úÖ Pitch/Rate : priorit√© aux sliders du panel ‚öô, sinon valeurs par d√©faut plateforme
  const chosenVoiceName = (femVoice ? femVoice.name : '');
  const isAmelie = chosenVoiceName.includes('Am√©lie') || chosenVoiceName.includes('Amelie');

  let _savedSpeed = null, _savedPitch = null;
  try { _savedSpeed = localStorage.getItem('voice_speed'); _savedPitch = localStorage.getItem('voice_pitch'); } catch(e) {}

  const defaultRate  = isIOS ? (isAmelie ? 0.85 : 0.9) : (isAndroid ? 0.88 : 1.0);
  const defaultPitch = isIOS ? (isAmelie ? 1.15 : 1.0) : 0.9;

  utterance.pitch  = _savedPitch !== null ? parseFloat(_savedPitch) : defaultPitch;
  utterance.rate   = _savedSpeed !== null ? parseFloat(_savedSpeed) : defaultRate;
  utterance.volume = 1.0;

  currentUtterance = utterance;

  let wordTimers = [];
  let boundaryUsed = false;
  let displayedWordCount = 0;
  const msPerWord = estimateMsPerWord(utterance.rate);

  utterance.onstart = () => {
    if (sessionId !== currentSpeechSession) return;
    activateBlueIcon();

    trackEvent('voice_playback_start', {
      text_length: speechText.length,
      word_count: allWords.length,
      message_count: messageCount,
      voice_name: femVoice ? femVoice.name : 'default',
      voice_lang: femVoice ? femVoice.lang : 'none',
      device_platform: devicePlatform,
      is_tablet: isTablet
    });

    // ‚úÖ Fallback rAF : pr√©cision maximale sur TOUS appareils, zero drift
    (function startRafFallback() {
      const startTs = performance.now();
      let nextWordIdx = 0;
      const rafStepMs = 0;
      const rafStepWords = 999;

      function rafStep(now) {
        if (boundaryUsed || sessionId !== currentSpeechSession) return;
        if (nextWordIdx >= allWords.length) return;
        const elapsed = now - startTs;
        const drift = Math.floor(nextWordIdx / rafStepWords) * rafStepMs;
        const targetMs = nextWordIdx * msPerWord + drift;
        if (elapsed >= targetMs) {
          const word = allWords[nextWordIdx];
          const syllables = Math.max(1, (word.match(/[aeiou√©√®√™√´√†√¢√π√ª√Æ√Ø√¥≈ì]/gi) || []).length);
          if (syllables >= 3) triggerSyllablePeak(0.5 + Math.random() * 0.4);
          displayUpToWord(nextWordIdx + 1);
          nextWordIdx++;
        }
        if (nextWordIdx < allWords.length) {
          const rafId = requestAnimationFrame(rafStep);
          wordTimers.push({ cancel: () => cancelAnimationFrame(rafId) });
        }
      }
      const rafId = requestAnimationFrame(rafStep);
      wordTimers.push({ cancel: () => cancelAnimationFrame(rafId) });
    })();
  };

  // ‚úÖ Boundary events (Chrome/Android/Desktop) : sync mot par mot
  utterance.onboundary = (event) => {
    if (sessionId !== currentSpeechSession) return;
    if (event.name !== 'word') return;

    boundaryUsed = true;
    wordTimers.forEach(t => { if (typeof t === "number") clearTimeout(t); else if (t && t.cancel) t.cancel(); });
    wordTimers = [];

    const speechBefore = speechText.substring(0, event.charIndex);
    const speechWordIdx = speechBefore.trim() ? speechBefore.trim().split(/\s+/).length : 0;
    const newCount = Math.max(displayedWordCount, speechWordIdx + 1);

    const boundaryDelay = BOUNDARY_BASE_DELAY
      + Math.floor(speechWordIdx / BOUNDARY_STEP_WORDS) * BOUNDARY_STEP_MS
      + (wordPauseExtra[Math.min(speechWordIdx, wordPauseExtra.length - 1)] || 0);
      // ‚úÖ Extra d√©lai si ce mot pr√©c√®de une ponctuation forte/faible ‚Äî sync avec la pause TTS

    setTimeout(() => {
      if (sessionId !== currentSpeechSession) return;
      displayedWordCount = newCount;
      displayUpToWord(Math.min(newCount, allWords.length));
      const currentWordText = allWords[Math.min(speechWordIdx, allWords.length - 1)] || '';
      const syllCount = Math.max(1, (currentWordText.match(/[aeiou√©√®√™√´√†√¢√π√ª√Æ√Ø√¥≈ì]/gi) || []).length);
      if (syllCount >= 3) triggerSyllablePeak(0.4 + syllCount * 0.15);
    }, boundaryDelay);

    trackEvent('voice_word_boundary', {
      word_index: speechWordIdx,
      char_index: event.charIndex,
      word_text: (allWords[Math.min(speechWordIdx, allWords.length - 1)] || '').substring(0, 20)
    });
  };

  utterance.onend = () => {
    if (sessionId !== currentSpeechSession) return;
    wordTimers.forEach(t => { if (typeof t === "number") clearTimeout(t); else if (t && t.cancel) t.cancel(); });
    if (messageDiv) {
      messageDiv.textContent = fullText;
      messageDiv.classList.remove('typing-cursor');
    }
    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;
    deactivateIcon();
    if (onComplete) onComplete();

    trackEvent('voice_playback_complete', {
      word_count: allWords.length,
      message_count: messageCount,
      boundary_used: boundaryUsed
    });
  };

  utterance.onerror = (e) => {
    if (sessionId !== currentSpeechSession) return;
    wordTimers.forEach(t => { if (typeof t === "number") clearTimeout(t); else if (t && t.cancel) t.cancel(); });
    if (messageDiv) {
      messageDiv.textContent = fullText;
      messageDiv.classList.remove('typing-cursor');
    }
    deactivateIcon();
    if (onComplete) onComplete();

    trackEvent('voice_playback_error', {
      error: e.error,
      device_platform: devicePlatform
    });
  };

  // ‚úÖ D√©marrage : d√©lai minimal apr√®s cancel() ‚Äî iOS n√©cessite 120ms, autres 10ms
  setTimeout(() => {
    if (sessionId !== currentSpeechSession) return;
    window.speechSynthesis.speak(utterance);
  }, isIOS ? 120 : 10);
}

// ‚úÖ Fonction speak() conserv√©e pour compatibilit√©, redirige vers speakAndDisplay
function speak(text) {
  if (!voiceEnabled || !('speechSynthesis' in window)) return;
  speakAndDisplay(text, null, null, null);
}

// ‚úÖ Pr√©chargement des voix (iOS/Android) ‚Äî addEventListener pour ne pas √©craser les autres handlers
if ('speechSynthesis' in window) {
  window.speechSynthesis.addEventListener('voiceschanged', () => {
    window.speechSynthesis.getVoices(); // force le cache
  });
  setTimeout(() => { window.speechSynthesis.getVoices(); }, 100);
  setTimeout(() => { window.speechSynthesis.getVoices(); }, 500);
  setTimeout(() => { window.speechSynthesis.getVoices(); }, 1500);
}

if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    const confidence = event.results[0][0].confidence;
    document.getElementById('chat-input').value = transcript;
    
    trackEvent('voice_input_recognized', {
      transcript_length: transcript.length,
      confidence: confidence,
      transcript_preview: transcript.substring(0, 50),
      device_platform: devicePlatform
    });
    
    handleMessage();
  };
  
  recognition.onerror = (event) => {
    trackEvent('voice_input_error', {
      error: event.error,
      device_platform: devicePlatform
    });
  };
}

document.getElementById('voice-toggle').addEventListener('click', () => {
  const voiceBtn = document.getElementById('voice-toggle');
  
  if (voiceEnabled) {
    voiceEnabled = false;
    voiceBtn.classList.remove('active');
    voiceBtn.classList.add('disabled');
    if (recognition) {
      try { recognition.stop(); } catch(e) {}
    }
    if (currentUtterance) window.speechSynthesis.cancel();
    currentSpeechSession++; // invalide session en cours
    stopBlueAnimation(document.getElementById('chat-box'));
    stopIosKeepAlive();
    voiceBtn.classList.remove('speaking');
    voiceBtn.classList.remove('syllable-peak');
    const svgMain = document.getElementById('svg-main-circle');
    const svgGlow = document.getElementById('svg-glow-bg');
    if (svgMain) svgMain.setAttribute('fill', 'url(#circleGradient)');
    if (svgGlow) svgGlow.setAttribute('fill', 'url(#glowGradient)');
    
    trackEvent('voice_disabled', {
      message_count: messageCount,
      time_active: Math.round((Date.now() - sessionStartTime) / 1000)
    });
  } else {
    voiceEnabled = true;

    // ‚úÖ Fix iOS couleur orange : retire TOUS les styles inline qui overridaient le CSS
    // puis force le repaint en togglant les classes proprement
    voiceBtn.removeAttribute('style');
    voiceBtn.classList.remove('disabled');
    voiceBtn.classList.remove('speaking');
    voiceBtn.classList.remove('syllable-peak');

    // Forcer la couleur orange sur les √©l√©ments SVG directement (contourne le bug iOS)
    const svgMain = document.getElementById('svg-main-circle');
    const svgGlow = document.getElementById('svg-glow-bg');
    if (svgMain) svgMain.setAttribute('fill', 'url(#circleGradient)');
    if (svgGlow) svgGlow.setAttribute('fill', 'url(#glowGradient)');

    // Ajoute 'active' apr√®s le frame suivant pour d√©clencher le CSS orange
    requestAnimationFrame(() => {
      voiceBtn.classList.add('active');
    });

    if (recognition) {
      try { recognition.start(); } catch(e) {}
    }

    trackEvent('voice_enabled', {
      message_count: messageCount,
      device_platform: devicePlatform
    });
  }
});

// ==========================================
// üí¨ addMessage : mot par mot pour les bots üí¨
// ==========================================

function addMessage(text, isBot = false) {
  const messagesDiv = document.getElementById('chat-messages');
  const messageDiv = document.createElement('p');
  messageDiv.className = isBot ? 'bot-message' : 'user-message';

  // ‚úÖ Ajout √† l'historique m√©moire imm√©diatement (texte complet)
  conversationHistory.push({ text, isBot });

  if (isBot) {
    // ‚úÖ Bulle vide avec curseur, on la remplit mot par mot
    messageDiv.textContent = '';
    messageDiv.classList.add('typing-cursor');
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    if (voiceEnabled && 'speechSynthesis' in window) {
      // ‚úÖ Parole + affichage mot par mot synchronis√©
      speakAndDisplay(text, messageDiv, messagesDiv, () => {
        messageDiv.textContent = text;
        messageDiv.classList.remove('typing-cursor');
        saveConversation();
        trackEvent('bot_message_complete', {
          message_length: text.length,
          word_count: text.split(' ').length,
          message_number: messageCount,
          voice_used: true
        });
      });
    } else {
      // ‚úÖ Affichage mot par mot sans voix
      displayWordsWithTiming(text, messageDiv, messagesDiv, () => {
        saveConversation();
        trackEvent('bot_message_complete', {
          message_length: text.length,
          word_count: text.split(' ').length,
          message_number: messageCount,
          voice_used: false
        });
      });
    }

    trackEvent('bot_message_received', {
      message_length: text.length,
      word_count: text.split(' ').length,
      message_number: messageCount
    });
  } else {
    messageDiv.textContent = text;
    messagesDiv.appendChild(messageDiv);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    saveConversation();

    trackEvent('user_message_sent', {
      message_length: text.length,
      word_count: text.split(' ').length,
      message_number: messageCount + 1,
      user_confirmed: userNameConfirmed,
      message_full_text: text,
      time_since_page_load: Math.round((Date.now() - sessionStartTime) / 1000),
      device_platform: devicePlatform
    });
  }
}

// ==========================================
// ‚ú® BLINK TABS + FLOATING TAB ‚ú®
// ==========================================

function blinkTab(exactMatch) {
  randomBlinkActive = false;
  if (randomBlinkInterval) {
    clearInterval(randomBlinkInterval);
    randomBlinkInterval = null;
  }
  
  const navLinks = document.querySelectorAll('nav ul li a');
  navLinks.forEach(link => {
    link.classList.remove('blink');
    link.classList.remove('fixed');
    link.classList.remove('ai-cited');
  });
  
  currentBlinkingTab = null;
  
  if (fixedTabTimeout) {
    clearTimeout(fixedTabTimeout);
  }
  
  navLinks.forEach(link => {
    const linkExact = link.getAttribute('data-exact');
    if (linkExact && linkExact.toLowerCase() === exactMatch.toLowerCase()) {
      // ‚úÖ Onglet illumin√© en bleu quand cit√© par l'IA
      link.classList.add('ai-cited');
      currentFixedTab = link;
      link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      trackEvent('tab_highlighted', {
        tab_name: exactMatch,
        tab_text: link.textContent.trim(),
        tab_url: link.href,
        highlight_type: 'ai_cited'
      });
    }
  });
  
  fixedTabTimeout = setTimeout(() => {
    if (currentFixedTab) {
      currentFixedTab.classList.remove('fixed');
      currentFixedTab.classList.remove('ai-cited');
      currentFixedTab = null;
    }
    randomBlinkActive = true;
    randomBlinkTabs();
    
    trackEvent('tab_highlight_ended', {
      duration_seconds: 40
    });
  }, 40000);
}

function randomBlinkTabs() {
  if (allNavLinks.length === 0) {
    allNavLinks = Array.from(document.querySelectorAll('nav ul li a'));
  }
  
  function blinkRandom() {
    if (!randomBlinkActive) return;
    
    if (currentBlinkingTab) {
      currentBlinkingTab.classList.remove('blink');
    }
    
    const randomIndex = Math.floor(Math.random() * allNavLinks.length);
    const randomTab = allNavLinks[randomIndex];
    
    randomTab.classList.add('blink');
    currentBlinkingTab = randomTab;
  }
  
  blinkRandom();
  randomBlinkInterval = setInterval(blinkRandom, 2000);
}

function showFloatingTab(url, isPhoneNumber = false) {
  const floatingText = document.getElementById('floating-text');
  const nameStr = userName ? ` ${userName}` : '';

  // ‚úÖ M√©morise toujours le dernier lien pour pouvoir le renvoyer
  lastFloatingUrl = url;
  lastFloatingIsPhone = isPhoneNumber;

  if (isPhoneNumber) {
    floatingTab.href = `tel:${url}`;
    floatingText.textContent = `0695468923 ‚Ä¢ 24h/7j`;
  } else {
    floatingTab.href = url;
    floatingText.textContent = `Ce qu'il vous faut${nameStr} !`;
  }
  
  floatingTab.classList.add('show');
  floatingTab.onclick = null;
  
  trackEvent('floating_tab_displayed', {
    url: url,
    is_phone: isPhoneNumber,
    user_name: userName || 'anonymous',
    triggered_by_message: messageCount
  });
}

// ==========================================
// üß† BASE DE CONNAISSANCES üß†
// ==========================================

const knowledgeBase = [
  {
    keywords: "t√©l√©phone|appel|30min|t√©l|telephoner|appeler|phone|joindre",
    exactMatch: "voyance t√©l√©phone",
    answer: (name) => `${name}, Frederick du Cabinet ClairVoyanceMedium.com vous propose une consultation t√©l√©phonique de 30 minutes pour 30‚Ç¨. Disponible 24h/24 et 7j/7. Appelez maintenant le 06 95 46 89 23 !`,
    url: "+33695468923",
    isExternal: true,
    isPhone: true
  },
  {
    keywords: "email|questions|mail|courriel|√©crit|3questions|question|courrier",
    exactMatch: "voyance email",
    answer: (name) => `${name}, posez 3 questions par email √† Frederick du Cabinet ClairVoyanceMedium.com. R√©ponses d√©taill√©es sous 48h pour seulement 12‚Ç¨.`,
    url: "https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp",
    isExternal: true,
    isPhone: false
  },
  {
    keywords: "retour|ex|amour|reconqu√©rir|s√©paration|copain|copine|conjoint",
    exactMatch: "retour ex",
    answer: (name) => `${name}, Frederick du Cabinet ClairVoyanceMedium.com peut vous aider √† reconqu√©rir votre ex gr√¢ce √† un rituel de retour amour puissant. Consultez l'onglet qui vient de s'illuminer en haut de page.`,
    url: "https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp",
    isExternal: false,
    isPhone: false
  }
];

function removeAccents(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function levenshteinDistance(a, b) {
    const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
    for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
    for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
    for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
            const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + indicator);
        }
    }
    return matrix[b.length][a.length];
}

function phoneticNormalize(str) {
    return removeAccents(str)
        .replace(/ph/g, "f")
        .replace(/k/g, "c")
        .replace(/qu/g, "k")
        .replace(/ss/g, "s")
        .replace(/√©e/g, "e")
        .replace(/ai/g, "e")
        .replace(/au/g, "o")
        .replace(/ou/g, "u")
        .replace(/oi/g, "oa")
        .replace(/y/g, "i")
        .replace(/w/g, "v")
        .replace(/x/g, "ks")
        .replace(/z/g, "s")
        .replace(/j/g, "g")
        .replace(/ch/g, "sh");
}

function findBestMatch(userInput) {
    const userLower = phoneticNormalize(userInput.toLowerCase());
    const userWords = userLower.split(/\s+/);
    let bestMatch = null;
    let maxScore = 0;
    
    const hasEmail = /(email|mail|√©crit|courriel|mel)/i.test(userInput);
    const hasTelephone = /(t√©l√©phone|tel|appel|appeler|telephoner|phone|fon)/i.test(userInput);
    
    knowledgeBase.forEach(item => {
        let score = 0;
        const keywords = item.keywords.split('|');
        
        if (hasEmail && item.exactMatch === 'voyance t√©l√©phone') return;
        if (hasTelephone && item.exactMatch === 'voyance email') return;
        
        keywords.forEach(keyword => {
            const normalizedKeyword = phoneticNormalize(keyword.trim().toLowerCase());
            
            if (userLower.includes(normalizedKeyword)) {
                score += normalizedKeyword.length * 10;
            }
            
            userWords.forEach(userWord => {
                if (userWord.length >= 1) {
                    const distance = levenshteinDistance(userWord, normalizedKeyword);
                    const similarity = 1 - distance / Math.max(userWord.length, normalizedKeyword.length);
                    
                    if (similarity >= 0.35) {
                        score += similarity * normalizedKeyword.length * 5;
                    }
                }
            });
        });
        
        if (score > maxScore) {
            maxScore = score;
            bestMatch = item;
        }
    });
    
    return maxScore > 0.8 ? bestMatch : null;
}

// ==========================================
// üí¨ LOGIQUE DU CHAT - INCHANG√âE üí¨
// ==========================================

function handleMessage() {
  const input = document.getElementById('chat-input');
  const userMsg = input.value.trim();
  
  if (!userMsg) return;
  
  addMessage(userMsg, false);
  input.value = '';
  messageCount++;
  
  setTimeout(() => {
    const lowerMsg = userMsg.toLowerCase().trim();
    
    if (lowerMsg === "merci" || lowerMsg === "merci beaucoup" || lowerMsg === "je vous remercie") {
      addMessage("Je vous en prie, je suis l√† pour vous aider !", true);
      trackEvent('politeness_detected', {type: 'thanks'});
      return;
    }
    
    if (lowerMsg === "bonsoir") {
      addMessage(`Bonsoir ${userName || ''} ! Comment puis-je vous √©clairer ce soir ?`, true);
      trackEvent('politeness_detected', {type: 'evening'});
      return;
    }
    
    if (!userNameConfirmed) {
      if (lowerMsg === "bonjour" || lowerMsg.startsWith("bonjour")) {
        addMessage("Bonjour ! Je suis ClairVoyanceGPT, votre assistant spirituel cr√©√© par Frederick du Cabinet ClairVoyanceMedium.com. Avant de commencer cette consultation, pouvez-vous m'indiquer votre pr√©nom ?", true);
        trackEvent('politeness_detected', {type: 'greeting'});
        return;
      }
      
      if (pendingName) {
        if (lowerMsg === "oui" || lowerMsg === "oui c'est √ßa" || lowerMsg === "oui c'est bien √ßa") {
          userName = pendingName;
          userNameConfirmed = true;
          pendingName = '';
          addMessage(`Parfait ${userName} ! Comment puis-je vous aider aujourd'hui ?`, true);
          
          trackEvent('user_name_confirmed', {
            user_name: userName
          });
          return;
        } else if (lowerMsg === "non") {
          pendingName = '';
          addMessage("Alors donnez-moi votre pr√©nom s'il vous pla√Æt.", true);
          trackEvent('user_name_rejected');
          return;
        }
      }
      
      const nameMatch = userMsg.match(/([A-Z√Ä-√ñ√ò-√ùa-z√†-√∂√∏-√ø]{2,})/);
      if (nameMatch) {
        pendingName = nameMatch[1].charAt(0).toUpperCase() + nameMatch[1].slice(1).toLowerCase();
        addMessage(`Tr√®s bien ${pendingName}, c'est bien votre pr√©nom ?`, true);
        
        trackEvent('user_name_detected', {
          pending_name: pendingName
        });
        return;
      }
      
      addMessage("Je n'ai pas bien saisi votre pr√©nom. Pouvez-vous me le donner clairement s'il vous pla√Æt ?", true);
      return;
    }
    
    const goodbyeTriggers = ["au revoir", "aurevoir", "√† bient√¥t", "bye", "ciao"];
    if (goodbyeTriggers.some(phrase => lowerMsg === phrase || lowerMsg.endsWith(phrase))) {
      addMessage(`${userName}, √† tr√®s bient√¥t ! Frederick du Cabinet ClairVoyanceMedium.com et son √©quipe restent √† votre √©coute 24h/24.`, true);
      trackEvent('conversation_goodbye', {
        user_name: userName,
        message_count: messageCount
      });
      return;
    }
    
    // ‚úÖ D√©tection demande de renvoi du dernier lien flottant
    const relinkKeywords = /(renvoie|renvoi|renvoyer|redonner|redonne|reprendre|rappelle|rappel|perdu|ferm√©|ferm√© par erreur|lien|bandeau|onglet flottant|onglet)/i;
    if (relinkKeywords.test(lowerMsg) && lastFloatingUrl) {
      showFloatingTab(lastFloatingUrl, lastFloatingIsPhone);
      addMessage(`Voici le lien${lastFloatingIsPhone ? " t√©l√©phone" : ""} que je vous ai propos√©${userName ? ", " + userName : ""} ‚Ä¢ il r√©appara√Æt pour vous.`, true);
      return;
    }

    const phoneKeywords = /(t√©l√©phone|tel|appel|appeler|telephoner|phone|joindre|contacter par t√©l√©phone)/i;
    if (phoneKeywords.test(lowerMsg) && userNameConfirmed) {
      showFloatingTab(PHONE_NUMBER, true);
    }
    
    const match = findBestMatch(userMsg);
    
    if (match) {
      const response = match.answer(userName);
      addMessage(response, true);
      
      blinkTab(match.exactMatch);
      
      trackEvent('knowledge_match_found', {
        exact_match: match.exactMatch,
        keywords: match.keywords,
        user_query_full: userMsg
      });
      
      // ‚úÖ FIX : le floating tab s'affiche pour TOUS les matches avec une URL
      if (match.isPhone) {
        showFloatingTab(match.url, true);
      } else if (match.url && match.url.startsWith('http')) {
        showFloatingTab(match.url, false);
      }
      
      nonUnderstoodCount = 0;
    } else {
      nonUnderstoodCount++;
      
      trackEvent('knowledge_match_not_found', {
        user_query_full: userMsg,
        attempt_number: nonUnderstoodCount
      });
      
      if (nonUnderstoodCount === 1) {
        addMessage(`${userName}, je n'ai pas bien compris votre question. Pourriez-vous la reformuler ou v√©rifier l'orthographe s'il vous pla√Æt ?`, true);
      } else if (nonUnderstoodCount === 2) {
        addMessage(`${userName}, je ne comprends toujours pas. Essayez avec des mots simples : amour, voyance, protection, fatigue, d√©funt ?`, true);
      } else {
        addMessage(`${userName}, il semble difficile de nous comprendre. Peut-√™tre qu'un √©change direct serait plus efficace ? Frederick du Cabinet ClairVoyanceMedium.com propose : t√©l√©phone (30‚Ç¨/30min), email (12‚Ç¨/3Q), ou rituel complet. Que pr√©f√©rez-vous ?`, true);
        trackEvent('help_offer_displayed');
        nonUnderstoodCount = 0;
      }
    }
  }, 800);
}

document.getElementById('chat-send').addEventListener('click', (e) => {
  e.preventDefault();
  trackEvent('send_button_clicked', {
    message_count: messageCount + 1
  });
  handleMessage();
});

document.getElementById('chat-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    trackEvent('enter_key_pressed', {
      message_count: messageCount + 1
    });
    handleMessage();
  }
});

document.getElementById('chat-form').addEventListener('submit', (e) => {
  e.preventDefault();
  handleMessage();
});

if (!conversationRestored) {
  setTimeout(() => {
    const welcomeMessage = "Bienvenue sur ClairVoyanceGPT, l'assistant spirituel de Frederick du Cabinet ClairVoyanceMedium.com, m√©dium reconnu depuis plus de 25 ans. Avant de commencer cet √©change, pouvez-vous m'indiquer dans un premier temps uniquement votre pr√©nom ?";
    addMessage(welcomeMessage, true);
    trackEvent('welcome_message_displayed', {
      device_platform: devicePlatform
    });
  }, 500);
}

// ‚úÖ Bouton reset chat : efface tout apr√®s confirmation via modal custom (sans URL)
document.getElementById('reset-chat-btn').addEventListener('click', () => {
  // Affiche modal custom propre (pas confirm() qui montre l'URL)
  showResetModal();
});

function showResetModal() {
  const modal = document.getElementById('reset-modal');
  if (modal) { modal.style.display = 'flex'; return; }

  // Cr√©e le modal une seule fois
  const m = document.createElement('div');
  m.id = 'reset-modal';
  m.style.cssText = 'display:flex;position:fixed;inset:0;z-index:99999;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);';
  m.innerHTML = `
    <div style="background:#111;border:2px solid #FF8C00;border-radius:4px;padding:1.8rem 2rem;text-align:center;max-width:320px;width:90%;font-family:Cinzel,serif;">
      <div style="color:#FF8C00;font-size:1.05rem;font-weight:bold;margin-bottom:0.7rem;">R√©initialiser le chat ?</div>
      <div style="color:rgba(255,255,255,0.65);font-size:0.82rem;font-family:Georgia,serif;margin-bottom:1.3rem;">La conversation en cours sera effac√©e.</div>
      <div style="display:flex;gap:0.8rem;justify-content:center;">
        <button id="reset-cancel" style="background:transparent;border:1px solid rgba(255,255,255,0.25);color:rgba(255,255,255,0.6);padding:0.5rem 1.3rem;border-radius:2px;cursor:pointer;font-family:Cinzel,serif;font-size:0.8rem;">Annuler</button>
        <button id="reset-confirm" style="background:#FF8C00;border:none;color:#000;padding:0.5rem 1.3rem;border-radius:2px;cursor:pointer;font-family:Cinzel,serif;font-size:0.8rem;font-weight:bold;">R√©initialiser</button>
      </div>
    </div>`;
  document.body.appendChild(m);

  document.getElementById('reset-cancel').onclick = () => { m.style.display = 'none'; };
  document.getElementById('reset-confirm').onclick = () => {
    m.style.display = 'none';
    doReset();
  };
}

function doReset() {
  // Capture les donn√©es GA4 AVANT de reset
  const msgCount = messageCount;
  const uName = userName;
  const uNameGiven = userName ? 'yes' : 'no';
  const timeSec = Math.round((Date.now() - sessionStartTime) / 1000);
  const convChars = conversationHistory.reduce((acc, msg) => acc + msg.text.length, 0);

  // Stoppe la voix en cours
  if ('speechSynthesis' in window) window.speechSynthesis.cancel();
  stopBlueAnimation(document.getElementById('chat-box'));
  stopIosKeepAlive();
  currentSpeechSession++;

  // Vide l'affichage et la m√©moire
  const messagesDiv = document.getElementById('chat-messages');
  messagesDiv.innerHTML = '';
  conversationHistory = [];
  userName = '';
  userNameConfirmed = false;
  pendingName = '';
  messageCount = 0;

  try { localStorage.removeItem('chatConversation'); } catch(e) {}

  trackEvent('chat_reset', {
    device_platform: devicePlatform,
    is_tablet: isTablet,
    messages_exchanged: msgCount,
    user_name_given: uNameGiven,
    user_name: uName || 'anonymous',
    time_before_reset_sec: timeSec,
    conversation_length_chars: convChars
  });

  // ‚úÖ Fix iOS message vide : affiche le texte IMM√âDIATEMENT dans le DOM
  // puis lance la voix en parall√®le. Si iOS ne parle pas (contexte geste perdu),
  // le texte est quand m√™me visible ‚Äî jamais de carr√© vide.
  const welcomeMessage = "Bienvenue sur ClairVoyanceGPT, l'assistant spirituel de Frederick du Cabinet ClairVoyanceMedium.com, m√©dium reconnu depuis plus de 25 ans. Avant de commencer cet √©change, pouvez-vous m'indiquer dans un premier temps uniquement votre pr√©nom ?";

  const msgDiv = document.createElement('p');
  msgDiv.className = 'bot-message';
  msgDiv.textContent = welcomeMessage; // ‚úÖ Texte visible imm√©diatement
  messagesDiv.appendChild(msgDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  conversationHistory.push({ text: welcomeMessage, isBot: true });

  // Lance la voix en parall√®le (0ms ‚Äî dans le m√™me cycle d'√©v√©nement que le clic)
  if (voiceEnabled && 'speechSynthesis' in window) {
    msgDiv.textContent = '';
    msgDiv.classList.add('typing-cursor');
    speakAndDisplay(welcomeMessage, msgDiv, messagesDiv, () => {
      msgDiv.textContent = welcomeMessage;
      msgDiv.classList.remove('typing-cursor');
      saveConversation();
    });
  }
}



// ==========================================
// üö´ BLOQUER PULL-TO-REFRESH iOS + Android üö´
// ==========================================
// CSS overscroll-behavior g√®re Chrome/Android.
// Ce JS bloque les cas r√©siduels iOS Safari o√π CSS seul ne suffit pas.
let lastTouchY = 0;

document.addEventListener('touchstart', (e) => {
  if (e.touches.length !== 1) return;
  lastTouchY = e.touches[0].clientY;
}, {passive: true}); // passive:true ici = scroll normal autoris√©

document.addEventListener('touchmove', (e) => {
  const touchY = e.touches[0].clientY;
  const deltaY = touchY - lastTouchY;
  lastTouchY = touchY;

  // ‚úÖ Bloque le pull-down quand on est en haut de la page (√©vite le refresh iOS)
  if (deltaY > 0 && (window.scrollY <= 0 || document.documentElement.scrollTop <= 0)) {
    e.preventDefault();
  }
}, {passive: false}); // passive:false requis pour que preventDefault fonctionne

// ==========================================
// üìä SCROLL TRACKING üìä
// ==========================================

let scrollTimeout;
let lastScrollTrack = 0;
let maxScrollReached = 0;
let lastScrollY = 0;

window.addEventListener('scroll', () => {
  clearTimeout(scrollTimeout);
  const now = Date.now();
  const currentScroll = window.scrollY;
  const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
  const scrollPercentage = Math.round((currentScroll / maxScroll) * 100);
  
  if (currentScroll > maxScrollReached) {
    maxScrollReached = currentScroll;
  }
  
  if (now - lastScrollTrack > 5000) {
    trackEvent('page_scrolled', {
      scroll_position: currentScroll,
      scroll_percentage: scrollPercentage,
      max_scroll_reached: maxScrollReached,
      scroll_direction: currentScroll > (lastScrollY || 0) ? 'down' : 'up'
    });
    lastScrollTrack = now;
    lastScrollY = currentScroll;
  }
});

// ==========================================
// ‚è±Ô∏è ENGAGEMENT TEMPOREL ‚è±Ô∏è
// ==========================================

setTimeout(() => { trackEvent('engagement_5s',   {device_platform: devicePlatform}); }, 5000);
setTimeout(() => { trackEvent('engagement_15s',  {device_platform: devicePlatform}); }, 15000);
setTimeout(() => { trackEvent('engagement_30s',  {device_platform: devicePlatform}); }, 30000);
setTimeout(() => { trackEvent('engagement_45s',  {device_platform: devicePlatform}); }, 45000);
setTimeout(() => { trackEvent('engagement_60s',  {device_platform: devicePlatform}); }, 60000);
setTimeout(() => { trackEvent('engagement_90s',  {device_platform: devicePlatform}); }, 90000);
setTimeout(() => { trackEvent('engagement_120s', {device_platform: devicePlatform}); }, 120000);
setTimeout(() => { trackEvent('engagement_180s', {device_platform: devicePlatform}); }, 180000);
setTimeout(() => { trackEvent('engagement_300s', {device_platform: devicePlatform}); }, 300000);

// ==========================================
// ‚öô PANNEAU PARAM√àTRES VOIX ‚öô
// ==========================================
(function initSettingsPanel() {
  const settingsBtn = document.getElementById('settings-btn');
  const panel       = document.getElementById('settings-panel');
  const voiceSelect = document.getElementById('voice-select');
  const testBtn     = document.getElementById('voice-test-btn');
  const speedSlider = document.getElementById('speed-slider');
  const pitchSlider = document.getElementById('pitch-slider');
  const speedVal    = document.getElementById('speed-val');
  const pitchVal    = document.getElementById('pitch-val');

  if (!settingsBtn || !panel) return;

  // ‚îÄ‚îÄ Labels lisibles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function speedLabel(v) {
    const f = parseFloat(v);
    if (f <= 0.6)  return 'Tr√®s lent';
    if (f <= 0.75) return 'Lent';
    if (f <= 0.95) return 'Normal';
    if (f <= 1.15) return 'Rapide';
    return 'Tr√®s rapide';
  }
  function pitchLabel(v) {
    const f = parseFloat(v);
    if (f <= 0.7)  return 'Tr√®s grave';
    if (f <= 0.95) return 'Grave';
    if (f <= 1.2)  return 'Normal';
    if (f <= 1.5)  return 'Aigu';
    return 'Tr√®s aigu';
  }

  // ‚îÄ‚îÄ Charger valeurs sauvegard√©es ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function loadSettings() {
    try {
      const s = localStorage.getItem('voice_speed');
      const p = localStorage.getItem('voice_pitch');
      if (s) { speedSlider.value = s; }
      if (p) { pitchSlider.value = p; }
    } catch(e) {}
    updateLabels();
    updateSliderFill(speedSlider);
    updateSliderFill(pitchSlider);
  }

  function updateLabels() {
    if (speedVal) speedVal.textContent = speedLabel(speedSlider.value);
    if (pitchVal) pitchVal.textContent = pitchLabel(pitchSlider.value);
  }

  // ‚îÄ‚îÄ Gradient du slider proportionnel √† la valeur ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateSliderFill(slider) {
    const min = parseFloat(slider.min);
    const max = parseFloat(slider.max);
    const val = parseFloat(slider.value);
    const pct = ((val - min) / (max - min) * 100).toFixed(1);
    slider.style.background = `linear-gradient(to right, var(--banner-blue) 0%, var(--banner-blue) ${pct}%, rgba(255,255,255,0.15) ${pct}%)`;
  }

  speedSlider.addEventListener('input', () => {
    updateLabels();
    updateSliderFill(speedSlider);
    try { localStorage.setItem('voice_speed', speedSlider.value); } catch(e) {}
    trackEvent('voice_speed_changed', { speed: speedSlider.value, device_platform: devicePlatform });
  });
  pitchSlider.addEventListener('input', () => {
    updateLabels();
    updateSliderFill(pitchSlider);
    try { localStorage.setItem('voice_pitch', pitchSlider.value); } catch(e) {}
    trackEvent('voice_pitch_changed', { pitch: pitchSlider.value, device_platform: devicePlatform });
  });

  // ‚îÄ‚îÄ Ouvrir/fermer le panneau ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  settingsBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) { populateVoices(); loadSettings(); }
  });
  document.addEventListener('click', (e) => {
    if (!panel.contains(e.target) && e.target !== settingsBtn) panel.classList.remove('open');
  });

  // ‚îÄ‚îÄ Liste des voix ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function populateVoices() {
    const voices = window.speechSynthesis.getVoices();
    const frVoices    = voices.filter(v => v.lang && v.lang.startsWith('fr'));
    const otherVoices = voices.filter(v => v.lang && !v.lang.startsWith('fr'));
    const allVoices   = [...frVoices, ...otherVoices];

    if (allVoices.length === 0) {
      voiceSelect.innerHTML = '<option value="">Aucune voix disponible</option>';
      return;
    }
    let savedName = '';
    try { savedName = localStorage.getItem('selected_voice_name') || ''; } catch(e) {}

    voiceSelect.innerHTML = allVoices.map(v => {
      const label = `${v.name} (${v.lang})`;
      const sel   = v.name === savedName ? ' selected' : '';
      return `<option value="${v.name}"${sel}>${label}</option>`;
    }).join('');

    if (!savedName) {
      const autoVoice = getFrenchFemaleVoice(voices);
      if (autoVoice) {
        for (const opt of voiceSelect.options) {
          if (opt.value === autoVoice.name) { opt.selected = true; break; }
        }
      }
    }
  }

  window.speechSynthesis.addEventListener('voiceschanged', populateVoices);

  voiceSelect.addEventListener('change', () => {
    const name = voiceSelect.value;
    try { localStorage.setItem('selected_voice_name', name); } catch(e) {}
    trackEvent('voice_manually_selected', { voice_name: name, device_platform: devicePlatform });
  });

  // ‚îÄ‚îÄ Tester avec les r√©glages en cours ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  testBtn.addEventListener('click', () => {
    window.speechSynthesis.cancel();
    const voices = window.speechSynthesis.getVoices();
    const voice  = voices.find(v => v.name === voiceSelect.value) || getFrenchFemaleVoice(voices);
    const utt    = new SpeechSynthesisUtterance('Bonjour, je suis votre assistante spirituelle. Comment puis-je vous aider ?');
    utt.lang  = 'fr-FR';
    if (voice) utt.voice = voice;
    utt.rate  = parseFloat(speedSlider.value);
    utt.pitch = parseFloat(pitchSlider.value);
    window.speechSynthesis.speak(utt);
    trackEvent('voice_test_played', { voice_name: voice ? voice.name : 'default', speed: utt.rate, pitch: utt.pitch, device_platform: devicePlatform });
  });

  loadSettings();
})();


(function initSatisfactionWidget() {
  try {
    const widget   = document.getElementById('satisfaction-widget');
    const stars    = document.querySelectorAll('.sw-star');
    const comment  = document.getElementById('sw-comment');
    const sendBtn  = document.getElementById('sw-send-btn');

    if (!widget || !stars.length || !sendBtn) return;

    let selectedRating = 0;
    let widgetShown = false;
    let widgetShownAt = null;

    function safeLS(key, val) {
      try {
        if (val === undefined) return localStorage.getItem(key);
        localStorage.setItem(key, val); return val;
      } catch(e) { return null; }
    }

    const RATING_EVERY_N_VISITS = 7;
    const WIDGET_DELAY_MS = 600000;
    let visitCount = parseInt(safeLS('sv_visit_count') || '0') + 1;
    safeLS('sv_visit_count', visitCount);
    const lastRatedAt = parseInt(safeLS('sv_last_rated') || '0');

    function shouldShow() {
      if (widgetShown) return false;
      if (!lastRatedAt) return true;
      const visitsSince = visitCount - parseInt(safeLS('sv_rated_at_visit') || '0');
      return visitsSince >= RATING_EVERY_N_VISITS;
    }

    function markRated() {
      safeLS('sv_last_rated', Date.now().toString());
      safeLS('sv_rated_at_visit', visitCount.toString());
    }

    function showWidget() {
      try {
        if (!shouldShow()) return;
        widgetShown = true;
        widgetShownAt = Date.now();
        widget.style.display = 'block';
        setTimeout(() => { try { widget.classList.add('visible'); } catch(e) {} }, 60);
        trackEvent('satisfaction_widget_shown', {
          device_platform: devicePlatform, is_tablet: isTablet,
          messages_at_display: messageCount, user_name: userName || 'anonymous',
          time_on_page_sec: Math.round(getPresenceMs() / 1000),
          visit_count: visitCount
        });
      } catch(e) {}
    }

    function checkAndShow() {
      try { if (getPresenceMs() >= WIDGET_DELAY_MS) showWidget(); // ‚úÖ Temps cumulatif toutes sessions } catch(e) {}
    }

    setTimeout(checkAndShow, WIDGET_DELAY_MS);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) checkAndShow(); });
    const _iv = setInterval(() => { checkAndShow(); if (widgetShown) clearInterval(_iv); }, 30000);

    let touchHandled = false;
    stars.forEach((star) => {
      star.addEventListener('mouseenter', () => {
        const idx = parseInt(star.dataset.value) - 1;
        stars.forEach((s,i) => s.classList.toggle('hovered', i <= idx));
      });
      star.addEventListener('mouseleave', () => stars.forEach(s => s.classList.remove('hovered')));
      star.addEventListener('touchstart', (e) => {
        e.preventDefault(); touchHandled = true;
        selectRating(parseInt(star.dataset.value));
      }, {passive:false});
      star.addEventListener('click', () => {
        if (touchHandled) { touchHandled = false; return; }
        selectRating(parseInt(star.dataset.value));
      });
    });

    function selectRating(value) {
      selectedRating = value;
      stars.forEach((s,i) => { s.classList.toggle('selected', i < value); s.classList.remove('hovered'); });
      trackEvent('satisfaction_star_clicked', { rating: value, device_platform: devicePlatform, user_name: userName || 'anonymous' });
      if (comment) comment.style.display = 'flex';
      const ta = document.getElementById('sw-textarea');
      if (ta) ta.placeholder = value <= 2 ? "Dites-nous comment nous am√©liorer‚Ä¶" : value === 3 ? "Qu‚Äôest-ce qui aurait pu √™tre mieux ?" : "Un mot sur votre exp√©rience ? (facultatif)";
    }

    function submitRating() {
      if (selectedRating === 0) return;
      const ta = document.getElementById('sw-textarea');
      const commentText = ta ? ta.value.trim() : '';
      markRated();
      trackEvent('satisfaction_submitted', {
        rating: selectedRating,
        rating_label: ['','Tr√®s insatisfait','Insatisfait','Neutre','Satisfait','Tr√®s satisfait'][selectedRating],
        has_comment: commentText.length > 0 ? 'yes' : 'no',
        comment_length: commentText.length,
        comment_preview: commentText.substring(0, 50),
        device_platform: devicePlatform, user_name: userName || 'anonymous',
        messages_exchanged: messageCount,
        time_on_page_sec: Math.round((Date.now() - sessionStartTime) / 1000),
        visit_count: visitCount
      });
      ['sw-stars',].forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
      if (comment) comment.style.display = 'none';
      ['sw-eyebrow','sw-sub'].forEach(cls => {
        const el = widget.querySelector('.' + cls.replace('sw-','sw-'));
        if (el) el.style.display = 'none';
      });
      widget.querySelectorAll('.sw-eyebrow,.sw-sub').forEach(el => el.style.display = 'none');
      const titleEl = widget.querySelector('.sw-title');
      if (titleEl) {
        titleEl.textContent = selectedRating >= 4 ? '‚ùÜ Merci pour votre confiance ‚ùÜ' : '‚ùÜ Merci, nous allons nous am√©liorer ‚ùÜ';
        titleEl.style.fontSize = '1.15rem';
        titleEl.style.padding = '1.2rem 0';
        titleEl.style.color = 'var(--banner-blue)';
      }
      widget.style.top = '50%';
      widget.style.bottom = 'auto';
      widget.style.transform = 'translate(-50%, -50%)';
      widget.style.webkitTransform = 'translate(-50%, -50%)';
      setTimeout(() => { widget.classList.remove('visible'); setTimeout(() => { widget.style.display = 'none'; }, 500); }, 3000);
    }

    sendBtn.addEventListener('click', submitRating);
    const textarea = document.getElementById('sw-textarea');
    if (textarea) textarea.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submitRating(); }});
    const closeBtn2 = document.getElementById('sw-close-btn');
    if (closeBtn2) closeBtn2.addEventListener('click', () => {
      widget.classList.remove('visible');
      setTimeout(() => { widget.style.display = 'none'; }, 500);
      trackEvent('satisfaction_widget_closed', { rating_given: selectedRating, closed_without_rating: selectedRating === 0 ? 'yes' : 'no', device_platform: devicePlatform });
    });

  } catch(e) { console.warn('Widget satisfaction error:', e); }
})();

// ‚úÖ GA4 Enhanced : milestone de conversation
function trackConversationMilestone(count) {
  trackEvent('conversation_milestone', {
    message_count: count,
    user_confirmed: userNameConfirmed,
    user_name: userName || 'anonymous',
    session_duration: Math.round((Date.now() - sessionStartTime) / 1000)
  });
}

// ==========================================
// üí§ INACTIVIT√â üí§
// ==========================================

let inactivityTimer;
const inactivityTime = 60000;

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    trackEvent('user_inactive', {
      inactive_duration_seconds: 60,
      last_message_count: messageCount
    });
  }, inactivityTime);
}

['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
  document.addEventListener(event, resetInactivityTimer, true);
});

resetInactivityTimer();

console.log('‚úÖ VERSION V26 - audit complet ‚úì sliders vitesse+pitch ‚úì saved prio0 Android+iOS ‚úì');

</script>
</body>
</html>
