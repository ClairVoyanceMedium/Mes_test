<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PGI Send — 2025++ (GitHub Pages + Actions)</title>
<style>
  :root{
    --bg:#f8f9fb; --panel:#ffffff; --text:#15161a; --muted:#4b4f59;
    --accent:#FF6B3B;           /* orange saumon */
    --neon:#19ffdc;             /* fluo bouton */
    --neon2:#7afcff;            /* fluo alt */
    --danger:#ff3b6b; --ok:#24d17e; --warn:#ffcf40;
    --border:#e9edf3; --input:#f1f3f7; --shadow:0 10px 25px rgba(16,26,36,.08);
  }
  [data-theme="dark"]{
    --bg:#0f0f12; --panel:#17171c; --text:#f1f3f9; --muted:#a9abb6;
    --border:#25262d; --input:#101116; --shadow:0 10px 30px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  header{
    display:flex;align-items:center;justify-content:space-between;gap:16px;
    padding:18px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:5
  }
  .brand{display:flex;align-items:center;gap:14px}
  .logo{width:36px;height:36px;border-radius:10px;background:
      radial-gradient(120% 120% at 10% 10%, var(--neon) 0%, transparent 40%),
      radial-gradient(120% 120% at 90% 90%, var(--accent) 0%, transparent 40%),
      linear-gradient(135deg, #111, #222)}
  h1{font-size:18px;margin:0}
  .tag{font-size:12px;color:var(--muted)}
  .wrap{max-width:1200px;margin:0 auto;padding:22px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
  @media(max-width:1000px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
  .card h2{margin:0 0 8px 0;font-size:17px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  label{font-size:13px;color:var(--muted)}
  input[type=text],input[type=password],input[type=number],input[type=time],input[type=email],textarea,select{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text);outline:none
  }
  textarea{min-height:110px;resize:vertical}
  .btn{
    appearance:none;border:none;border-radius:12px;padding:11px 15px;color:#0b0d10;font-weight:800;
    background:linear-gradient(135deg,var(--neon),var(--neon2));
    box-shadow:0 10px 22px rgba(25,255,220,.22), inset 0 -2px 0 rgba(0,0,0,.1);cursor:pointer
  }
  .btn.secondary{background:linear-gradient(135deg,#ffd2c2,var(--accent));color:#1b0d0b;box-shadow:0 10px 22px rgba(255,107,59,.22)}
  .btn.ghost{background:transparent;color:var(--text);border:1px dashed var(--border)}
  .btn.danger{background:linear-gradient(135deg,#ff98b0,var(--danger));color:#23040c}
  .btn.ok{background:linear-gradient(135deg,#b9ffd7,var(--ok));color:#052116}
  .muted{color:var(--muted)} .sep{height:1px;background:var(--border);margin:10px 0}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .tbtn{padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--input);cursor:pointer}
  .editor{border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .editor .area{min-height:260px;padding:14px;background:var(--panel)}
  .codeview{display:none}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top}
  th{font-size:12px;color:var(--muted);text-align:left}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
  .switch{display:inline-flex;align-items:center;gap:8px}
  .switch input{appearance:none;width:42px;height:24px;border-radius:20px;background:#dfe3ea;position:relative;outline:none;cursor:pointer}
  [data-theme="dark"] .switch input{background:#2a2d38}
  .switch input:checked{background:var(--accent)}
  .switch input:before{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:.2s}
  .switch input:checked:before{transform:translateX(18px)}
  .hint{font-size:12px;color:var(--muted)}
  .recs{font-size:13px;line-height:1.45;background:rgba(255,107,59,.08);border:1px dashed var(--accent);padding:10px;border-radius:10px}
  .list{max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:12px}
  .badge{font-size:12px;background:var(--accent);color:#160a07;border-radius:8px;padding:2px 8px;font-weight:800}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .slot{border:1px dashed var(--border);padding:10px;border-radius:10px}
  .slot .row{gap:8px}
  .flex{display:flex;gap:10px}
  .grow{flex:1}
  .right{margin-left:auto}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <div>
      <h1>PGI Send</h1>
      <div class="tag">GitHub Pages + Actions • 0€ • 2025++</div>
    </div>
  </div>
  <label class="switch" title="Mode clair / sombre">
    <span>Mode sombre</span>
    <input id="themeToggle" type="checkbox" />
  </label>
</header>

<div class="wrap">

  <div class="grid">
    <!-- COL 1 -->
    <section class="card">
      <h2>1) Dépôt GitHub & sécurité</h2>
      <div class="row">
        <div class="grow"><label>Propriétaire (owner)</label><input id="ghOwner" type="text" placeholder="ex : ton-compte" /></div>
        <div class="grow"><label>Dépôt (repo)</label><input id="ghRepo" type="text" placeholder="ex : pgi-send" /></div>
        <div style="width:140px"><label>Branche</label><input id="ghBranch" type="text" value="main" /></div>
      </div>
      <div class="row">
        <div class="grow">
          <label>Token personnel GitHub (PAT) <span class="pill">scope: repo + workflow</span></label>
          <input id="ghToken" type="password" placeholder="ghp_..." />
          <div class="hint">Stocké localement (localStorage). Non envoyé ailleurs.</div>
        </div>
        <div class="grow">
          <label>Clé de chiffrement des contacts (PGI_ENC_KEY)</label>
          <input id="encKey" type="password" placeholder="Même valeur que dans Secrets du dépôt" />
          <div class="hint">Ajoute cette même valeur dans <b>Settings → Secrets → Actions</b> sous le nom <b>PGI_ENC_KEY</b>.</div>
        </div>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnBootstrap">Créer / mettre à jour l’automatisation</button>
        <button class="btn ghost" id="btnCheck">Vérifier le dépôt</button>
        <button class="btn" id="btnSaveCfg">Sauver la configuration locale</button>
      </div>
      <div id="repoStatus" class="hint"></div>
    </section>

    <!-- COL 2 -->
    <section class="card">
      <h2>2) Fournisseur & recommandations</h2>
      <div class="row">
        <div class="grow">
          <label>Fournisseur d’envoi</label>
          <select id="provider">
            <option value="gmail">Gmail</option>
            <option value="outlook">Outlook</option>
            <option value="smtp">SMTP générique / autre fournisseur</option>
          </select>
        </div>
        <div class="grow"><label>Adresse d’expéditeur (From)</label><input id="fromEmail" type="email" placeholder="ex : contact@tondomaine.com" /></div>
        <div class="grow"><label>Objet de la newsletter</label><input id="subject" type="text" placeholder="Vous avez reçu un message" /></div>
      </div>
      <div class="sep"></div>
      <div id="providerRecs" class="recs"></div>
      <div class="hint">Identifiants SMTP côté <b>Secrets</b> du dépôt : GMAIL_* / OUTLOOK_* / SMTP_* + <b>PGI_ENC_KEY</b>. Jamais stockés ici.</div>
    </section>
  </div>

  <section class="card">
    <h2>3) Éditeur de contenu (visuel + HTML brut)</h2>
    <div class="toolbar">
      <button class="tbtn" onclick="execCmd('bold')"><b>B</b></button>
      <button class="tbtn" onclick="execCmd('italic')"><i>I</i></button>
      <button class="tbtn" onclick="execCmd('underline')"><u>U</u></button>
      <button class="tbtn" onclick="execCmd('insertUnorderedList')">• Liste</button>
      <button class="tbtn" onclick="execCmd('insertOrderedList')">1. Liste</button>
      <button class="tbtn" onclick="makeLink()">Lien</button>
      <button class="tbtn" onclick="insertImage()">Image (URL)</button>
      <button class="tbtn" onclick="applyHeading('h2')">H2</button>
      <button class="tbtn" onclick="applyHeading('p')">Parag.</button>
      <button class="tbtn" onclick="undo()">Annuler</button>
      <button class="tbtn" onclick="redo()">Rétablir</button>
      <button class="tbtn" onclick="toggleHtml()">HTML</button>
      <button class="tbtn" onclick="copyRaw()">Copier HTML</button>
    </div>
    <div class="editor">
      <div id="editor" class="area" contenteditable="true" spellcheck="false">
        <h2 style="margin:0 0 12px 0">Exemple PGI Send</h2>
        <p>Bienvenue. Ajoutez <b>images cliquables</b>, <a href="#">liens</a>, boutons. Le HTML sera envoyé <b>à l’identique</b>.</p>
        <p><a href="https://clairvoyancemedium.com" style="background:#FF6B3B;color:#1b0d0b;padding:10px 16px;border-radius:10px;text-decoration:none;font-weight:800">Bouton exemple</a></p>
      </div>
      <textarea id="editorCode" class="area codeview" placeholder="HTML brut ici..."></textarea>
    </div>
  </section>

  <section class="card">
    <h2>4) Contacts (import, tri, cases à cocher, ajout manuel)</h2>
    <div class="row">
      <div class="grow">
        <label>Coller des emails (CSV ou simple liste “email,prenom,nom”)</label>
        <textarea id="contactsPaste" placeholder="email1@ex.com,Jean,Dupont
email2@ex.com,Marie,Durand"></textarea>
      </div>
      <div style="width:280px">
        <label>Importer un fichier .csv</label>
        <input id="contactsFile" type="file" accept=".csv" />
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnParse">Analyser & dédupliquer</button>
          <button class="btn ghost" id="btnClear">Vider</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin:10px 0">
      <div class="grow flex">
        <div class="grow">
          <label>Ajouter un email à la volée</label>
          <input id="addEmail" type="text" placeholder="email@ex.com, Prénom, Nom (facultatif)" />
        </div>
        <button class="btn secondary" onclick="addOne()">Ajouter</button>
      </div>
      <div class="pill right"><span id="stats">0 contacts</span></div>
    </div>

    <div class="list">
      <table id="tblContacts">
        <thead><tr>
          <th style="width:34px"><input type="checkbox" id="chkAll" /></th>
          <th>Email</th><th>Prénom</th><th>Nom</th><th>État</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn ok" onclick="exportSelection()">Exporter CSV (sélection)</button>
      <div class="hint">Les contacts sont chiffrés (AES-256-GCM) dans les fichiers de campagne.</div>
    </div>
  </section>

  <section class="card">
    <h2>5) Planification avancée (par jour, à la minute près)</h2>
    <div class="hint">Règle des <b>slots</b> : <b>de</b> HH:MM <b>à</b> HH:MM • <b>X mails</b> toutes les <b>Y minutes</b>. Plusieurs slots par jour possibles.</div>
    <div class="calendar" id="cal"></div>
  </section>

  <section class="card">
    <h2>6) Campagne & automatisation</h2>
    <div class="row">
      <div class="grow"><label>Nom de la campagne</label><input id="campaignName" type="text" placeholder="Promo Septembre" /></div>
      <div style="width:200px"><label>Limite / jour (optionnel)</label><input id="dailyLimit" type="number" min="0" placeholder="ex : 100" /></div>
      <div style="width:220px"><label>Délai entre mails (ms)</label><input id="delayMs" type="number" min="0" value="2000" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn secondary" id="btnSaveCampaign">Créer / mettre à jour la campagne</button>
      <button class="btn" id="btnListCampaigns">Lister campagnes</button>
      <button class="btn ghost" id="btnPause">Pause</button>
      <button class="btn ghost" id="btnResume">Reprendre</button>
      <button class="btn danger" id="btnStop">Arrêt définitif</button>
    </div>
    <div class="hint">Le dépôt contiendra <code>campaigns/*.json</code> (chiffré), <code>state/</code> (suivi persistant), et <code>.github/workflows/</code> (automatisation).</div>
  </section>

  <section class="card">
    <h2>7) Tableau de bord</h2>
    <div id="dash" class="row"></div>
  </section>

</div>

<script>
/* ============================
   THEME
============================ */
const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('change',()=> {
  document.documentElement.setAttribute('data-theme', themeToggle.checked?'dark':'light');
  localStorage.setItem('pgi_theme', themeToggle.checked?'dark':'light');
});
(function initTheme(){
  const t = localStorage.getItem('pgi_theme');
  if(t){ document.documentElement.setAttribute('data-theme', t); themeToggle.checked=(t==='dark'); }
})();

/* ============================
   GLOBAL STATE
============================ */
let CONTACTS = [];   // [{email,prenom,nom,checked:true}]
let CURRENT_CAMPAIGN_ID = null;
const DAYS = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];

/* ============================
   UTILITAIRES
============================ */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const enc = str => btoa(unescape(encodeURIComponent(str)));
const dec = b64 => decodeURIComponent(escape(atob(b64)));
const fmt = (n) => n.toLocaleString('fr-FR');

function notify(msg, ok=true){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed'; el.style.right='16px'; el.style.bottom='16px';
  el.style.background = ok ? 'linear-gradient(135deg,#b9ffd7,#24d17e)' : 'linear-gradient(135deg,#ff9fb4,#ff3b6b)';
  el.style.color = '#05130c'; el.style.padding='10px 14px'; el.style.borderRadius='10px';
  el.style.boxShadow='var(--shadow)'; el.style.zIndex='9999'; el.style.fontWeight='800';
  document.body.appendChild(el); setTimeout(()=>el.remove(),3200);
}

/* ============================
   REPO CONFIG (local)
============================ */
const cfg = { owner: $('#ghOwner'), repo: $('#ghRepo'), branch: $('#ghBranch'), token: $('#ghToken'), encKey: $('#encKey') };
(function loadCfg(){
  try{
    const s = JSON.parse(localStorage.getItem('pgi_cfg')||'{}');
    cfg.owner.value=s.owner||''; cfg.repo.value=s.repo||''; cfg.branch.value=s.branch||'main';
    cfg.token.value=s.token||''; cfg.encKey.value=s.encKey||'';
  }catch(e){}
})();
$('#btnSaveCfg').onclick = ()=>{
  localStorage.setItem('pgi_cfg', JSON.stringify({
    owner:cfg.owner.value.trim(), repo:cfg.repo.value.trim(), branch:cfg.branch.value.trim(),
    token:cfg.token.value.trim(), encKey:cfg.encKey.value
  }));
  notify('Configuration locale enregistrée');
};

/* ============================
   RECOMMANDATIONS FOURNISSEUR
============================ */
function providerAdvice(v){
  if(v==='gmail') return `
  <b>Gmail — recommandations anti-spam / anti-ban</b><br>
  • Quota conseillé : 100 / jour (perso), jusqu’à ~500 (Workspace).<br>
  • Débit sûr : 1 mail / 60 s (tu peux réduire, mais prudence).<br>
  • SPF/DKIM/DMARC si domaine perso • Mot de passe d’application (2FA).<br>
  • Varie objet/contenu (merge tags), lien de désinscription, évite mots spam.
  `;
  if(v==='outlook') return `
  <b>Outlook / Microsoft 365 — recommandations</b><br>
  • Quota conseillé : 200–300 / jour (perso), 500+ en 365 selon policy.<br>
  • Débit sûr : 1 mail / 120 s • Évite HTML trop lourd / liens raccourcis.<br>
  • SPF/DKIM recommandés • Varie le contenu, images optimisées.
  `;
  return `
  <b>SMTP générique / autres (Zoho, Infomaniak, IONOS, Mailgun…)</b><br>
  • Respecte le quota de ton fournisseur (ex. Infomaniak 300/j, IONOS 250/j, Mailgun ≥ 10k/j).<br>
  • SPF/DKIM/DMARC configurés • Mentions légales + lien désinscription.<br>
  • Débit: 1 mail / 0.5–10 s selon tolérance (réglable via “Délai entre mails”).
  `;
}
const provider = $('#provider'); const recs = $('#providerRecs');
provider.onchange = ()=>{ recs.innerHTML = providerAdvice(provider.value); };
recs.innerHTML = providerAdvice(provider.value);

/* ============================
   WYSIWYG SIMPLE
============================ */
function syncToCode(){ $('#editorCode').value = $('#editor').innerHTML.trim(); }
function syncFromCode(){ $('#editor').innerHTML = $('#editorCode').value; }
function toggleHtml(){
  const code = $('#editorCode'); const ed = $('#editor');
  if(code.classList.contains('codeview')){
    syncToCode(); code.classList.remove('codeview'); ed.style.display='none'; code.style.display='block';
  }else{
    syncFromCode(); code.classList.add('codeview'); ed.style.display='block'; code.style.display='none';
  }
}
function execCmd(cmd){ document.execCommand(cmd,false,null); syncToCode(); }
function applyHeading(tag){ document.execCommand('formatBlock', false, tag); syncToCode(); }
function makeLink(){ const url = prompt("URL du lien ?"); if(url){ document.execCommand('createLink', false, url); syncToCode(); } }
function insertImage(){ const url = prompt("URL de l'image ?"); if(url){ document.execCommand('insertImage', false, url); syncToCode(); } }
function undo(){ document.execCommand('undo',false,null); syncToCode(); }
function redo(){ document.execCommand('redo',false,null); syncToCode(); }
function copyRaw(){ syncToCode(); const ta=$('#editorCode'); const prev=ta.style.display; ta.style.display='block'; ta.select(); document.execCommand('copy'); ta.style.display=prev; notify('HTML copié'); }

/* ============================
   CONTACTS
============================ */
const tblBody = $('#tblContacts tbody');
$('#chkAll').addEventListener('change', e=>{ CONTACTS.forEach(c=>c.checked=e.target.checked); renderContacts(); });
$('#btnClear').onclick = ()=>{ CONTACTS=[]; renderContacts(); $('#contactsPaste').value=''; $('#contactsFile').value=''; };
$('#btnParse').onclick = parseAndAdd;

function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out=[]; for(const l of lines){
    const parts = splitCSV(l);
    const email = (parts[0]||'').trim();
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) continue;
    out.push({ email:email.toLowerCase(), prenom:(parts[1]||'').trim(), nom:(parts[2]||'').trim(), checked:true });
  } return out;
}
function splitCSV(line){
  //  simple parser with quotes ; or , separators
  const res=[]; let cur='', inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch=='"'){ inQ=!inQ; continue; }
    if(!inQ && (ch==',' || ch==';')){ res.push(cur); cur=''; continue; }
    cur+=ch;
  } res.push(cur); return res;
}
function parseAndAdd(){
  const pasted = $('#contactsPaste').value.trim();
  const file = $('#contactsFile').files[0];
  if(pasted) CONTACTS = CONTACTS.concat(parseCSV(pasted));
  if(file){
    const r = new FileReader();
    r.onload = ()=>{ CONTACTS = CONTACTS.concat(parseCSV(r.result)); CONTACTS = dedup(CONTACTS); sortContacts(); renderContacts(); };
    r.readAsText(file);
  } else { CONTACTS = dedup(CONTACTS); sortContacts(); renderContacts(); }
}
function dedup(list){ const m=new Map(); for(const c of list){ if(!m.has(c.email)) m.set(c.email,c); } return Array.from(m.values()); }
function sortContacts(){ CONTACTS.sort((a,b)=>a.email.localeCompare(b.email,'fr')); }
function renderContacts(){
  tblBody.innerHTML='';
  CONTACTS.forEach((c,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="checkbox" ${c.checked?'checked':''} data-ix="${i}"></td>
      <td>${maskEmail(c.email)}</td>
      <td>${escapeHtml(c.prenom||'')}</td>
      <td>${escapeHtml(c.nom||'')}</td>
      <td>${c.checked?'<span class="badge">ON</span>':'<span class="pill">OFF</span>'}</td>`;
    tblBody.appendChild(tr);
  });
  tblBody.querySelectorAll('input[type=checkbox]').forEach(ch=>{
    ch.addEventListener('change', e=>{
      const ix = +e.target.getAttribute('data-ix'); CONTACTS[ix].checked = e.target.checked; renderContacts();
    });
  });
  $('#stats').textContent = `${fmt(CONTACTS.length)} contacts (sélectionnés: ${fmt(CONTACTS.filter(c=>c.checked).length)})`;
}
function addOne(){
  const v = $('#addEmail').value.trim(); if(!v) return;
  const parts = splitCSV(v); const email = parts[0]||'';
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return notify('Email invalide', false);
  CONTACTS.push({email:email.toLowerCase(), prenom:(parts[1]||''), nom:(parts[2]||''), checked:true});
  CONTACTS = dedup(CONTACTS); sortContacts(); renderContacts(); $('#addEmail').value='';
}
function maskEmail(e){ const [u,d] = e.split('@'); const m = u.length>3 ? u.slice(0,2)+'***'+u.slice(-1) : u[0]+'*'; const dd = d.replace(/(^.).+(\..+$)/,(_,a,b)=>a+'***'+b); return m+'@'+dd; }
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
function exportSelection(){ const rows = CONTACTS.filter(c=>c.checked).map(c=>[c.email,c.prenom||'',c.nom||''].join(',')); const blob = new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='contacts_selection.csv'; a.click(); }

$('#addEmail').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); addOne(); }});

/* ============================
   PLANIFICATION (slots par jour)
============================ */
const cal = $('#cal');
const daySlots = [[],[],[],[],[],[],[]]; // 0..6 (Lun..Dim)
function renderCalendar(){
  cal.innerHTML='';
  for(let d=0; d<7; d++){
    const box = document.createElement('div');
    box.className='slot';
    box.innerHTML = `<div class="row" style="align-items:center;justify-content:space-between">
        <div><b>${DAYS[d]}</b></div>
        <button class="tbtn" onclick="addSlot(${d})">+ Ajouter un créneau</button>
      </div>
      <div id="slots_${d}"></div>`;
    cal.appendChild(box);
    redrawSlots(d);
  }
}
function addSlot(d){ daySlots[d].push({ start:'09:00', end:'12:00', every:2, batch:2, active:true }); redrawSlots(d); }
function delSlot(d,i){ daySlots[d].splice(i,1); redrawSlots(d); }
function redrawSlots(d){
  const wrap = $('#slots_'+d); wrap.innerHTML='';
  daySlots[d].forEach((s,i)=>{
    const row = document.createElement('div');
    row.className='row';
    row.innerHTML = `
      <div class="grow"><label>De</label><input type="time" value="${s.start}" data-k="start" data-d="${d}" data-i="${i}"></div>
      <div class="grow"><label>À</label><input type="time" value="${s.end}" data-k="end" data-d="${d}" data-i="${i}"></div>
      <div style="width:140px"><label>Toutes les (min)</label><input type="number" min="1" value="${s.every}" data-k="every" data-d="${d}" data-i="${i}"></div>
      <div style="width:160px"><label>Quantité / tick</label><input type="number" min="1" value="${s.batch}" data-k="batch" data-d="${d}" data-i="${i}"></div>
      <div style="width:120px"><label>Actif</label><select data-k="active" data-d="${d}" data-i="${i}"><option value="true" ${s.active?'selected':''}>Oui</option><option value="false" ${!s.active?'selected':''}>Non</option></select></div>
      <div style="width:52px"><button class="tbtn" onclick="delSlot(${d},${i})">🗑</button></div>`;
    wrap.appendChild(row);
  });
  wrap.querySelectorAll('input,select').forEach(el=>{
    el.addEventListener('input', e=>{
      const d=+el.getAttribute('data-d'), i=+el.getAttribute('data-i'), k=el.getAttribute('data-k');
      daySlots[d][i][k] = (k==='every'||k==='batch') ? +el.value : (k==='active'? (el.value==='true'): el.value);
    });
  });
}
renderCalendar();

/* ============================
   CRYPTO (AES-256-GCM via WebCrypto)
============================ */
async function deriveKey(passphrase, saltB){
  const enc = new TextEncoder().encode(passphrase);
  const keyMat = await crypto.subtle.importKey('raw', enc, 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', salt:saltB, iterations:100000, hash:'SHA-256'},
    keyMat, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']
  );
}
function b64ab(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function abFromB64(b64){ return Uint8Array.from(atob(b64), c=>c.charCodeAt(0)).buffer; }
async function encryptContacts(contacts, passphrase){
  const payload = JSON.stringify(contacts);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const key = await deriveKey(passphrase, salt);
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, new TextEncoder().encode(payload));
  return { iv:b64ab(iv), salt:b64ab(salt), data:b64ab(ct), algo:'AES-256-GCM', kdf:'PBKDF2-SHA256', it:100000, tagLen:128 };
}

/* ============================
   GITHUB API
============================ */
function ghHeaders(){ return { 'Authorization':'token '+cfg.token.value.trim(), 'Accept':'application/vnd.github+json' }; }
const ghBase = () => `https://api.github.com/repos/${encodeURIComponent(cfg.owner.value.trim())}/${encodeURIComponent(cfg.repo.value.trim())}`;
async function ghGet(path){
  const r = await fetch(`${ghBase()}/${path}?ref=${encodeURIComponent(cfg.branch.value.trim())}`, {headers:ghHeaders()});
  if(!r.ok) return null; return r.json();
}
async function ghPutFile(path, contentStr, message){
  const url = `${ghBase()}/contents/${encodeURIComponent(path)}`;
  let sha = null; const curr = await ghGet(`contents/${encodeURIComponent(path)}`); if(curr && curr.sha) sha = curr.sha;
  const body = { message, content: enc(contentStr), branch: cfg.branch.value.trim() };
  if(sha) body.sha = sha;
  const r = await fetch(url,{ method:'PUT', headers:{...ghHeaders(),'Content-Type':'application/json'}, body:JSON.stringify(body)});
  if(!r.ok){ const t=await r.text(); throw new Error(`PUT ${path} → ${r.status}: ${t}`); }
  return r.json();
}
async function ghListDir(path){
  const r = await ghGet(`contents/${encodeURIComponent(path)}`); if(!r || !Array.isArray(r)) return [];
  return r.filter(x=>x.type==='file').map(x=>x.name);
}

/* ============================
   AUTOMATION FILES (bootstrap)
============================ */
function workflowYml(){
return `name: PGI Mailer
on:
  push:
    paths:
      - 'campaigns/**'
  schedule:
    - cron: '*/5 * * * *'
concurrency:
  group: pgi-mailer
  cancel-in-progress: false
env:
  TZ: Europe/Paris
jobs:
  send:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install deps
        working-directory: mailer
        run: npm install
      - name: Send batch
        working-directory: mailer
        env:
          PROVIDER: \${{ vars.PROVIDER }}
          GMAIL_USER: \${{ secrets.GMAIL_USER }}
          GMAIL_PASS: \${{ secrets.GMAIL_PASS }}
          GMAIL_FROM: \${{ secrets.GMAIL_FROM }}
          OUTLOOK_USER: \${{ secrets.OUTLOOK_USER }}
          OUTLOOK_PASS: \${{ secrets.OUTLOOK_PASS }}
          OUTLOOK_FROM: \${{ secrets.OUTLOOK_FROM }}
          SMTP_HOST: \${{ secrets.SMTP_HOST }}
          SMTP_PORT: \${{ secrets.SMTP_PORT }}
          SMTP_SECURE: \${{ secrets.SMTP_SECURE }}
          SMTP_USER: \${{ secrets.SMTP_USER }}
          SMTP_PASS: \${{ secrets.SMTP_PASS }}
          SMTP_FROM: \${{ secrets.SMTP_FROM }}
          PGI_ENC_KEY: \${{ secrets.PGI_ENC_KEY }}
        run: node send.js
      - name: Persist state
        run: |
          git config user.name "PGI Send"
          git config user.email "bot@pgi-send.local"
          git add state/*
          if ! git diff --cached --quiet; then
            git commit -m "PGI state update [skip ci]"
            git push
          fi
`;
}
function pkgJson(){
return `{
  "name": "pgi-send-mailer",
  "version": "1.0.1",
  "type": "module",
  "dependencies": {
    "nodemailer": "^6.9.14",
    "date-fns-tz": "^2.0.0"
  }
}`;
}
function sendJs(){
return `import fs from 'fs/promises';
import path from 'path';
import crypto from 'crypto';
import nodemailer from 'nodemailer';
import { utcToZonedTime, format } from 'date-fns-tz';

const ROOT = process.cwd();
const CAMP_DIR = path.join(ROOT,'..','campaigns');
const STATE_DIR = path.join(ROOT,'..','state');
const TZ = 'Europe/Paris';

async function ensureDirs(){ await fs.mkdir(CAMP_DIR,{recursive:true}); await fs.mkdir(STATE_DIR,{recursive:true}); }
function todayKey(d=new Date()){ const z = utcToZonedTime(d, TZ); return format(z,'yyyy-MM-dd',{timeZone:TZ}); }
async function listCampaigns(){ try{ const files = await fs.readdir(CAMP_DIR); return files.filter(f=>f.endsWith('.json')).map(f=>path.join(CAMP_DIR,f)); }catch{ return []; } }
async function readJson(p){ return JSON.parse(await fs.readFile(p,'utf8')); }
async function writeJson(p, obj){ await fs.writeFile(p, JSON.stringify(obj,null,2)); }
function parseHM(s){ const [h,m]=s.split(':').map(n=>+n); return {h,m}; }

function isNowInSlot(slot, now){
  const {h:sh,m:sm}=parseHM(slot.start), {h:eh,m:em}=parseHM(slot.end);
  const z = utcToZonedTime(now,TZ); const H=z.getHours(), M=z.getMinutes();
  const startM = sh*60+sm, endM = eh*60+em, curM=H*60+M;
  return slot.active && curM>=startM && curM<=endM;
}
function nextAlignedTick(slot, now){
  const {h:sh,m:sm} = parseHM(slot.start);
  const z = utcToZonedTime(now,TZ);
  const base = new Date(z); base.setHours(sh,sm,0,0);
  const every = Math.max(1, +slot.every|0);
  let t = new Date(base);
  while(t <= z){ t = new Date(t.getTime() + every*60000); }
  return t;
}

function buildTransport(provider){
  if(provider==='gmail'){
    return nodemailer.createTransport({ host:'smtp.gmail.com', port:465, secure:true, auth:{ user:process.env.GMAIL_USER, pass:process.env.GMAIL_PASS }});
  }
  if(provider==='outlook'){
    return nodemailer.createTransport({ host:'smtp.office365.com', port:587, secure:false, auth:{ user:process.env.OUTLOOK_USER, pass:process.env.OUTLOOK_PASS }});
  }
  return nodemailer.createTransport({
    host: process.env.SMTP_HOST,
    port: +(process.env.SMTP_PORT||587),
    secure: String(process.env.SMTP_SECURE||'false')==='true',
    auth: { user: process.env.SMTP_USER, pass: process.env.SMTP_PASS }
  });
}
function fromAddress(provider, specified){
  if(specified) return specified;
  if(provider==='gmail') return process.env.GMAIL_FROM || process.env.GMAIL_USER;
  if(provider==='outlook') return process.env.OUTLOOK_FROM || process.env.OUTLOOK_USER;
  return process.env.SMTP_FROM || process.env.SMTP_USER;
}
function b64ToBuf(b64){ return Buffer.from(b64,'base64'); }
function decryptRecipients(encBundle){
  const pass = process.env.PGI_ENC_KEY;
  if(!pass) throw new Error('PGI_ENC_KEY absente');
  const salt = b64ToBuf(encBundle.salt);
  const iv = b64ToBuf(encBundle.iv);
  const data = b64ToBuf(encBundle.data);
  const key = crypto.pbkdf2Sync(Buffer.from(pass,'utf8'), salt, encBundle.it||100000, 32, 'sha256');
  const tagLen = (encBundle.tagLen||128)/8;
  const tag = data.slice(data.length-tagLen);
  const ct = data.slice(0, data.length-tagLen);
  const decipher = crypto.createDecipheriv('aes-256-gcm', key, iv);
  decipher.setAuthTag(tag);
  const dec = Buffer.concat([decipher.update(ct), decipher.final()]);
  return JSON.parse(dec.toString('utf8'));
}

async function loadState(id){
  const p = path.join(STATE_DIR, id+'.json');
  try{ return JSON.parse(await fs.readFile(p,'utf8')); }
  catch{ return { id, cursor:0, perDay:{}, completed:false, nextTickAt:null, lastTickAt:null, status:'active', lastError:null }; }
}
async function saveState(st){ const p = path.join(STATE_DIR, st.id+'.json'); await writeJson(p, st); }

function providerDefaultDelay(provider){ if(provider==='gmail') return 2000; if(provider==='outlook') return 3000; return 1000; }
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
function personalize(html,item){
  return html.replaceAll('{{email}}', item.email)
             .replaceAll('{{prenom}}', item.prenom||'')
             .replaceAll('{{nom}}', item.nom||'');
}

async function sendOne(tr, from, to, subject, html){
  await tr.sendMail({ from, to, subject, html });
}

async function run(){
  await ensureDirs();
  const files = await listCampaigns();
  if(!files.length){ console.log('No campaigns'); return; }

  for(const f of files){
    const camp = await readJson(f);
    const id = camp.id;
    const state = await loadState(id);

    if(camp.status==='stopped'){ state.completed=true; await saveState(state); continue; }
    if(camp.status==='paused'){ await saveState(state); continue; }
    if(state.completed){ continue; }

    // decrypt recipients
    let recipients = [];
    try{ recipients = decryptRecipients(camp.encryptedRecipients); }
    catch(e){ state.lastError = 'Decrypt error: '+e.message; await saveState(state); continue; }

    recipients = recipients.filter(x=>x.checked);
    if(state.cursor >= recipients.length){ state.completed=true; await saveState(state); continue; }

    const now = new Date();
    const z = utcToZonedTime(now,TZ);
    const dow = (z.getDay()+6)%7; // 0=Mon..6=Sun
    const slots = (camp.slots||{})[dow]||[];
    const activeSlots = slots.filter(s=>s.active && isNowInSlot(s, now));
    if(!activeSlots.length){ continue; }

    // take first active slot
    const slot = activeSlots[0];

    const key = todayKey(now);
    state.perDay[key] = state.perDay[key]||0;
    const dailyLimit = +camp.dailyLimit || Infinity;
    const remainToday = Math.max(0, dailyLimit - state.perDay[key]);

    // ==== compensation multi-ticks (cron 5 min) ====
    const everyMin = Math.max(1, +slot.every|0);
    let nextTick = state.nextTickAt ? new Date(state.nextTickAt) : null;
    if (!nextTick) nextTick = nextAlignedTick(slot, now);

    const nowTs = z.getTime();
    if (nowTs + 1000 < nextTick.getTime()) { await saveState(state); continue; }

    const msPerTick = everyMin * 60000;
    let dueTicks = 1;
    if (state.lastTickAt) {
      const last = new Date(state.lastTickAt);
      const diff = nowTs - last.getTime();
      const add = Math.floor(diff / msPerTick);
      if (add > 0) dueTicks = add;
    }
    dueTicks = Math.min(dueTicks, 10); // garde-fou

    const batch = Math.max(1, +slot.batch|0);
    let toSend = Math.min(batch * dueTicks, recipients.length - state.cursor, remainToday);
    if (toSend <= 0) { await saveState(state); continue; }

    const provider = camp.provider || 'gmail';
    const tr = buildTransport(provider);
    const subj = camp.subject || 'Vous avez reçu un message';
    const from = fromAddress(provider, camp.fromEmail);
    const html = camp.html || '<p>(vide)</p>';
    const delay = +camp.delayMs>0 ? +camp.delayMs : providerDefaultDelay(provider);

    let ok=0, fail=0;
    for(let i=0;i<toSend;i++){
      const item = recipients[state.cursor];
      const to = item.email;
      try{ await sendOne(tr, from, to, subj, personalize(html,item)); ok++; }
      catch(e){ fail++; state.lastError = 'Send fail to '+to+': '+e.message; }
      state.cursor++; state.perDay[key] = (state.perDay[key]||0)+1;
      await sleep(delay);
    }

    if(state.cursor>=recipients.length){ state.completed=true; }
    state.lastTickAt = z.toISOString();
    const nt = new Date(z.getTime() + everyMin*60000);
    state.nextTickAt = nt.toISOString();
    await saveState(state);
    console.log(\`Campaign \${id}: sent ok=\${ok} fail=\${fail}; cursor=\${state.cursor}/\${recipients.length}\`);
  }
}

await run().catch(e=>{ console.error('Fatal',e); });
`;
}

/* ============================
   BOOTSTRAP BUTTONS
============================ */
$('#btnBootstrap').onclick = async ()=>{
  try{
    if(!cfg.owner.value || !cfg.repo.value || !cfg.token.value) return notify('Owner / Repo / Token requis', false);
    await ghPutFile('.github/workflows/mailer.yml', workflowYml(), 'PGI: bootstrap workflow');
    await ghPutFile('mailer/package.json', pkgJson(), 'PGI: add package.json');
    await ghPutFile('mailer/send.js', sendJs(), 'PGI: add send.js');
    await ghPutFile('README.md', '# PGI Send\n\nAutomatisation d\\'envoi email via GitHub Actions.\n\n- Crée tes campagnes dans `campaigns/`\n- Secrets nécessaires: GMAIL_*, OUTLOOK_* ou SMTP_* + PGI_ENC_KEY', 'PGI: readme');
    notify('Automatisation prête (workflow + mailer)');
  }catch(e){ notify('Erreur bootstrap: '+e.message, false); }
};

$('#btnCheck').onclick = async ()=>{
  try{
    const files = await ghListDir('campaigns');
    $('#repoStatus').innerHTML = files.length ? 'Campagnes existantes : '+files.join(', ') : 'Aucune campagne';
    notify('Dépôt OK');
  }catch(e){ notify('Erreur: '+e.message,false); }
};

/* ============================
   BUILD CAMPAIGN JSON + PUSH
============================ */
$('#btnSaveCampaign').onclick = async ()=>{
  try{
    const name = $('#campaignName').value.trim() || 'Campagne';
    if(!CONTACTS.length) return notify('Ajoute des contacts', false);
    const selected = CONTACTS; // on chiffre tout (avec flags checked)

    if(!cfg.encKey.value) return notify('Clé de chiffrement requise (PGI_ENC_KEY)', false);
    const encPack = await encryptContacts(selected, cfg.encKey.value);

    const camp = {
      id: 'cmp_'+Date.now(),
      name,
      provider: $('#provider').value,
      fromEmail: $('#fromEmail').value.trim(),
      subject: $('#subject').value.trim() || 'Vous avez reçu un message',
      html: $('#editor').innerHTML.trim(),
      dailyLimit: +($('#dailyLimit').value||0),
      delayMs: +($('#delayMs').value||0),
      slots: daySlots, // 0..6 arrays of slots
      createdAt: new Date().toISOString(),
      status: 'active',
      encryptedRecipients: encPack,
      meta: { algo: 'AES-256-GCM', ui:'PGI Send v1.0.1' }
    };
    const path = `campaigns/${camp.id}.json`;
    await ghPutFile(path, JSON.stringify(camp,null,2), `PGI: create campaign ${camp.name}`);
    CURRENT_CAMPAIGN_ID = camp.id;
    notify('Campagne créée et poussée');
  }catch(e){ notify('Erreur campagne: '+e.message, false); }
};

$('#btnListCampaigns').onclick = async ()=>{
  try{
    const files = await ghListDir('campaigns'); const dash = $('#dash'); dash.innerHTML='';
    if(!files.length){ dash.textContent='Aucune campagne.'; return; }
    for(const f of files){
      const p = await ghGet('contents/'+encodeURIComponent('campaigns/'+f));
      const json = JSON.parse(atob(p.content));
      const card = document.createElement('div'); card.className='card'; card.style.flex='1 1 360px';
      card.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center">
        <div><b>${escapeHtml(json.name)}</b> <span class="pill">${f.replace('.json','')}</span></div>
        <div class="pill">${json.status||'active'}</div>
      </div>
      <div class="hint">Créée: ${new Date(json.createdAt).toLocaleString('fr-FR')}</div>
      <div class="row" style="margin-top:8px">
        <button class="btn" onclick="loadCampaign('${f}')">Charger</button>
        <button class="btn ghost" onclick="duplicateCampaign('${f}')">Dupliquer</button>
      </div>`;
      $('#dash').appendChild(card);
    }
  }catch(e){ notify('Erreur listage: '+e.message,false); }
};

window.loadCampaign = async (fname)=>{
  try{
    const p = await ghGet('contents/'+encodeURIComponent('campaigns/'+fname));
    const json = JSON.parse(atob(p.content));
    CURRENT_CAMPAIGN_ID = json.id;
    $('#campaignName').value = json.name||'';
    $('#provider').value = json.provider||'gmail'; provider.onchange();
    $('#fromEmail').value = json.fromEmail||'';
    $('#subject').value = json.subject||'';
    $('#editor').innerHTML = json.html||'';
    $('#dailyLimit').value = json.dailyLimit||'';
    $('#delayMs').value = json.delayMs||'';
    for(let i=0;i<7;i++){ daySlots[i] = (json.slots||[])[i]||[]; }
    renderCalendar();
    notify('Campagne chargée');
  }catch(e){ notify('Erreur: '+e.message,false); }
};

window.duplicateCampaign = async (fname)=>{
  try{
    const p = await ghGet('contents/'+encodeURIComponent('campaigns/'+fname));
    const json = JSON.parse(atob(p.content));
    json.id = 'cmp_'+Date.now();
    json.name = (json.name||'Campagne')+' (copie)';
    json.createdAt = new Date().toISOString();
    const path = `campaigns/${json.id}.json`;
    await ghPutFile(path, JSON.stringify(json,null,2), `PGI: duplicate ${json.name}`);
    notify('Copie créée');
  }catch(e){ notify('Erreur: '+e.message,false); }
};

/* ============================
   PAUSE / RESUME / STOP
============================ */
async function updateStatus(status){
  if(!CURRENT_CAMPAIGN_ID) return notify('Charge une campagne (ou crée-en une)', false);
  try{
    const path = `campaigns/${CURRENT_CAMPAIGN_ID}.json`;
    const p = await ghGet('contents/'+encodeURIComponent(path));
    const json = JSON.parse(atob(p.content));
    json.status = status;
    await ghPutFile(path, JSON.stringify(json,null,2), `PGI: ${status} campaign`);
    notify('Statut mis à jour: '+status);
  }catch(e){ notify('Erreur statut: '+e.message,false); }
}
$('#btnPause').onclick = ()=>updateStatus('paused');
$('#btnResume').onclick = ()=>updateStatus('active');
$('#btnStop').onclick = ()=>updateStatus('stopped');
</script>
</body>
</html>
