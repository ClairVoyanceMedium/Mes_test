<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, minimal-ui, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  
  <title>Chat IA Spirituel - ClairVoyanceMedium.com</title>
  <meta name="description" content="ClairVoyanceGPT - Assistant spirituel IA pour d√©senvo√ªtement, protection et guidance. Frederick du Cabinet ClairVoyanceMedium.com vous accompagne.">
  
  <!-- Favicon -->
  <link rel="icon" href="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/GmyGlKk.webp">
  <meta name="theme-color" content="#8B0000">
  
  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2RSFE6WL4M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2RSFE6WL4M', {'anonymize_ip': true});
    gtag('config', 'GTM-P3J6SXCH', {'anonymize_ip': true});
  </script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg:#000;
      --text:#fff;
      --gold:#FFD700;
      --tab-gold:#BBAE98;
      --orange:#FF8C00;
      --orange-light:#FFA500;
      --silver:#C0C0C0;
      --accent:#87CEEB;
      --blue-sky:#87CEEB;
      --neon-blue:#00FFFF;
    }
    
    *{margin:0;padding:0;box-sizing:border-box;}
    
    body{
      font-family:'Cinzel',serif;
      background:var(--bg);
      color:var(--text);
      text-align:center;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      padding-top:95px;
    }
    
    nav{
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:1000;
      background:rgba(0,0,0,0.30);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      padding:0.6118rem 0.4370rem;
      box-shadow:0 2px 15px rgba(255,215,0,0.3);
    }
    
    nav ul{
      list-style:none;
      padding:0;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:0.3496rem;
      max-width:1200px;
      margin:0 auto;
    }
    
    nav ul li:nth-child(4n+1),
    nav ul li:nth-child(4n+2),
    nav ul li:nth-child(4n+3){
      margin-right:0.2622rem;
    }
    
    nav ul li a{
      font-family:'Cinzel',serif;
      font-size:clamp(0.74727rem, 1.8354vw, 0.91333rem);
      color:var(--tab-gold);
      text-decoration:none;
      padding:0.54188rem 0.7866rem;
      background:rgba(17,17,17,0.45);
      border:3px solid var(--tab-gold);
      border-radius:0;
      transition:all .3s ease;
      display:inline-block;
      text-align:center;
      min-height:37.596px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    nav ul li a:hover{
      background:var(--tab-gold);
      color:#111;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(187,174,152,0.5);
    }
    
    @keyframes blinkTab{
      0%, 100%{
        box-shadow:0 0 15px var(--orange);
        border-color:var(--orange);
        transform:scale(1);
      }
      50%{
        box-shadow:0 0 25px var(--orange-light);
        border-color:var(--orange-light);
        transform:scale(1.03);
      }
    }
    
    nav ul li a.blink{
      animation:blinkTab 1.2s ease-in-out infinite;
      background:#000;
      border-color:var(--orange);
      color:var(--tab-gold) !important;
    }
    
    nav ul li a.fixed{
      background:#000;
      border-color:var(--orange);
      box-shadow:0 0 20px var(--orange);
      color:var(--tab-gold) !important;
      animation:none;
    }
    
    .scrolling-banner{
      position:relative;
      width:100%;
      background:#000;
      padding:0.8rem 0;
      overflow:hidden;
      cursor:pointer;
      border-top:1px solid rgba(0,255,255,0.3);
      border-bottom:1px solid rgba(0,255,255,0.3);
    }
    
    .scrolling-banner:hover{
      background:rgba(0,255,255,0.05);
    }
    
    .scrolling-content{
      display:flex;
      width:max-content;
      animation:scroll-left 20s linear infinite;
    }
    
    @keyframes scroll-left{
      0%{transform:translateX(0);}
      100%{transform:translateX(-50%);}
    }
    
    .scrolling-text{
      display:inline-block;
      white-space:nowrap;
      font-family:'Cinzel',serif;
      font-size:clamp(1.1rem, 2.5vw, 1.4rem);
      font-weight:700;
      color:#00FFFF;
      text-shadow:0 0 10px #00FFFF, 0 0 20px #00FFFF, 0 0 30px #00FFFF;
      padding:0 3rem;
      letter-spacing:0.15em;
      text-transform:uppercase;
    }
    
    header{
      padding:2rem 0;
      background:#111;
      box-shadow:0 4px 10px rgba(0,0,0,.8);
    }
    
    .logo{
      width:1400px;
      max-width:97%;
      height:auto;
      display:block;
      margin:0 auto;
    }
    
    .chat-intro{
      max-width:900px;
      margin:1rem auto 0.8rem;
      padding:0 1rem;
      font-size:clamp(1.4rem, 5vw, 2.2rem);
      background:linear-gradient(145deg, #C0C0C0, #E8E8E8, #A8A8A8);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-weight:700;
    }
    
    /* ENCORE PLUS D'ESPACE texte/chat */
    .chat-subtitle{
      max-width:800px;
      margin:0 auto 4rem;
      padding:0 1.5rem;
      font-size:clamp(0.95rem, 2.2vw, 1.15rem);
      color:var(--tab-gold);
      line-height:1.6;
      font-style:italic;
    }
    
    #chat-container{
      max-width:900px;
      margin:1rem auto 2rem;
      padding:0 1rem;
    }
    
    #chat-box{
      background:#111;
      border:3px solid var(--orange);
      box-shadow:0 0 22px var(--orange), 0 0 39px rgba(255,140,0,0.7);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:650px;
      border-radius:0;
      transition:border-color 0.1s ease, box-shadow 0.1s ease;
    }
    
    #chat-messages{
      flex:1;
      padding:1.5rem;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      color:#fff;
      background:#0a0a0a;
    }
    
    #chat-messages::-webkit-scrollbar{width:10px;}
    #chat-messages::-webkit-scrollbar-track{background:#1a1a1a;}
    #chat-messages::-webkit-scrollbar-thumb{background:var(--orange);box-shadow:0 0 9px var(--orange);}
    
    #chat-messages p{
      margin-bottom:1rem;
      line-height:1.7;
      opacity:0;
      animation:fadeIn 0.6s forwards;
    }
    
    @keyframes fadeIn{to{opacity:1;}}
    
    .bot-message{
      text-align:left;
      color:#fff;
      background:rgba(255,140,0,0.15);
      padding:1rem;
      margin-bottom:1rem;
      border:2px solid var(--orange);
      box-shadow:0 0 17px rgba(255,140,0,0.55);
      max-width:90%;
      border-radius:0;
    }
    
    .user-message{
      text-align:right;
      color:#fff;
      margin-bottom:1rem;
      border:2px solid var(--silver);
      box-shadow:0 0 17px rgba(192,192,192,0.55);
      padding:1rem;
      max-width:90%;
      margin-left:auto;
      background:linear-gradient(145deg, rgba(192,192,192,0.1), rgba(211,211,211,0.08));
      border-radius:0;
    }
    
    #chat-form{
      display:flex;
      flex-direction:column;
      border-top:3px solid var(--orange);
      padding:1rem;
      background:#111;
      gap:0.8rem;
    }
    
    .input-row{
      display:flex;
      gap:0.7rem;
      align-items:center;
    }
    
    #chat-input{
      flex:1;
      padding:1rem;
      border:2px solid var(--orange);
      outline:none;
      color:#fff;
      background:#0a0a0a;
      font-family:'Cinzel',serif;
      font-size:0.9rem;
      box-shadow:0 0 13px rgba(255,140,0,0.45);
      border-radius:0;
    }
    
    #chat-input::placeholder{
      color:#999;
      opacity:0.7;
      font-style:italic;
    }
    
    #voice-toggle{
      position:fixed;
      bottom:50px;
      right:30px;
      width:81px;
      height:81px;
      background:transparent;
      border:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.4s ease;
      z-index:999;
    }
    
    #voice-toggle.active,
    #voice-toggle:not(.disabled){
      filter:drop-shadow(0 0 15px rgba(255,140,0,0.6)) !important;
      -webkit-filter:drop-shadow(0 0 15px rgba(255,140,0,0.6)) !important;
      opacity:1 !important;
    }
    
    #voice-toggle:hover:not(.disabled){
      transform:scale(1.1);
      filter:drop-shadow(0 0 25px rgba(255,165,0,0.9)) !important;
      -webkit-filter:drop-shadow(0 0 25px rgba(255,165,0,0.9)) !important;
    }
    
    #voice-toggle.disabled{
      opacity:0.4 !important;
      filter:grayscale(1) drop-shadow(0 0 5px rgba(100,100,100,0.3)) !important;
      -webkit-filter:grayscale(1) drop-shadow(0 0 5px rgba(100,100,100,0.3)) !important;
    }
    
    #voice-toggle svg{
      width:100%;
      height:100%;
    }
    
    @keyframes speakerPulse{
      0%, 100%{
        filter:drop-shadow(0 0 15px rgba(255,140,0,0.6));
        transform:scale(1);
      }
      50%{
        filter:drop-shadow(0 0 30px rgba(255,215,0,0.9));
        transform:scale(1.08);
      }
    }
    
    #voice-toggle.speaking:not(.disabled){
      animation:speakerPulse 1.2s ease-in-out infinite;
    }
    
    #chat-send{
      width:100%;
      background:linear-gradient(145deg,var(--orange-light),var(--orange));
      border:2px solid var(--orange);
      padding:1rem 1.8rem;
      cursor:pointer;
      color:#fff;
      font-weight:bold;
      font-family:'Cinzel',serif;
      box-shadow:0 0 20px rgba(255,140,0,0.65);
      font-size:1.1rem;
      transition:transform .2s;
      border-radius:0;
    }
    
    #chat-send:hover{
      transform:scale(1.03);
      box-shadow:0 0 28px rgba(255,140,0,0.85);
    }
    
    .floating-tab{
      position:fixed;
      top:50%;
      right:20px;
      transform:translateY(-50%);
      z-index:9999;
      background:#000;
      color:var(--tab-gold);
      padding:1.2rem 2rem;
      border:3px solid var(--orange);
      font-family:'Cinzel',serif;
      font-size:clamp(1rem, 2.5vw, 1.3rem);
      font-weight:bold;
      text-decoration:none;
      cursor:pointer;
      box-shadow:0 0 15px var(--orange);
      animation:blinkFloating 1.5s ease-in-out infinite;
      display:none;
      user-select:none;
      border-radius:0;
      will-change:transform;
      transition:box-shadow 0.3s ease;
    }
    
    .floating-tab.show{display:block;}
    
    .floating-tab .close-btn{
      position:absolute;
      top:-8px;
      right:-8px;
      width:24px;
      height:24px;
      background:var(--orange);
      color:#fff;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      border:2px solid #fff;
      z-index:10000;
    }
    
    @keyframes blinkFloating{
      0%, 100%{box-shadow:0 0 15px var(--orange);}
      50%{box-shadow:0 0 25px var(--orange-light);}
    }
    
    .return-line{
      font-family:'Cinzel',serif;
      font-size:0.9rem;
      margin:4.5rem auto 1rem;
      text-align:center;
      padding:0 1rem;
    }
    
    .return-line a,
    .return-line a:link,
    .return-line a:visited,
    .return-line a:hover,
    .return-line a:active{
      color:#BBAE98 !important;
      text-decoration:underline;
      transition:all 0.3s ease;
      display:inline-flex;
      align-items:center;
      gap:0.5rem;
    }
    
    .return-line a:before{
      content:"‚Üê";
      font-size:1.4rem;
    }
    
    .return-line a:hover{
      opacity:0.8;
      transform:translateX(-5px);
    }
    
    footer{
      margin-top:2rem;
      font-size:.9rem;
      color:#aaa;
      padding:1.5rem 1rem 2rem;
      background:#111;
    }
    
    footer a{
      color:#aaa !important;
      text-decoration:none;
    }
    
    footer a:hover{
      color:#fff !important;
    }
    
    @media(max-width:1024px){
      body{padding-top:120px;}
      .logo{width:1200px;}
    }
    
    @media(max-width:768px){
      body{padding-top:140px;}
      nav{padding:0.58121rem 0.33212rem;}
      nav ul{gap:0.33212rem;}
      nav ul li a{
        font-size:0.68085rem;
        padding:0.45665rem 0.66424rem;
        min-height:35.716px;
      }
      #chat-box{height:550px;}
      .logo{width:94%;}
      .chat-intro{margin:0.8rem auto 0.6rem;}
      .chat-subtitle{font-size:0.9rem;padding:0 1rem;margin-bottom:3.5rem;}
      .scrolling-text{font-size:1rem;padding:0 2rem;}
      .floating-tab{right:10px;padding:0.9rem 1.3rem;font-size:0.95rem;}
      #voice-toggle{bottom:50px;right:20px;width:75px;height:75px;}
      footer{padding:1.2rem 1rem 1.5rem;}
    }
    
    @media(max-width:480px){
      body{padding-top:180px;}
      nav ul{gap:0.29056rem;}
      nav ul li a{
        font-size:0.62272rem;
        padding:0.41515rem 0.58121rem;
        min-height:33.201px;
      }
      #chat-box{height:500px;}
      .logo{width:91%;}
      .chat-intro{margin:0.6rem auto 0.5rem;}
      .chat-subtitle{font-size:0.85rem;margin-bottom:3rem;}
      .scrolling-text{font-size:0.9rem;padding:0 1.5rem;}
      #voice-toggle{bottom:50px;right:15px;width:69px;height:69px;}
      footer{padding:1rem 0.5rem 1rem;}
    }
  </style>
</head>
<body>
  <nav>
    <ul>
      <li><a href="https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/" target="_blank" rel="noopener noreferrer" data-keywords="t√©l√©phone|appel|30min|t√©l|telephoner|appeler|phone" data-exact="voyance t√©l√©phone" data-url="https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/">Voyance T√©l 30min/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp" target="_blank" rel="noopener noreferrer" data-keywords="email|questions|mail|courriel|√©crit|3questions" data-exact="voyance email" data-url="https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp">Voyance Email x3/12‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp" target="_blank" rel="noopener noreferrer" data-keywords="retour|ex|amour|reconqu√©rir|s√©paration|copain|copine" data-exact="retour ex" data-url="https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp">Retour Amour/175‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp" target="_blank" rel="noopener noreferrer" data-keywords="compatibilit√©|couple|relation|amoureuse" data-exact="compatibilit√©" data-url="https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp">Compatibilit√©/20‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp" target="_blank" rel="noopener noreferrer" data-keywords="purification|protection|sort|envo√ªtement|magie|sorcellerie|fatigue|cauchemars" data-exact="purification" data-url="https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp">Purification/150‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp" target="_blank" rel="noopener noreferrer" data-keywords="d√©funt|mort|message|deuil|d√©c√©d√©" data-exact="d√©funt" data-url="https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp">D√©funt/17‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp" target="_blank" rel="noopener noreferrer" data-keywords="sant√©|m√©decine|bien-√™tre|maladie" data-exact="sant√©" data-url="https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp">Sant√©/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp" target="_blank" rel="noopener noreferrer" data-keywords="main|chiromancie|ligne|paume" data-exact="main" data-url="https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp">Main/10‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp" target="_blank" rel="noopener noreferrer" data-keywords="ange|gardien|c√©leste|protection divine" data-exact="ange" data-url="https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp">Ange/10‚Ç¨</a></li>
    </ul>
  </nav>
  
  <!-- BANDEAU D√âFILANT - NOUVELLE PAGE -->
  <div class="scrolling-banner" id="scrolling-banner">
    <div class="scrolling-content">
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
      <span class="scrolling-text">ClairVoyanceMedium.com ‚Ä¢ Voyance ‚Ä¢ M√©dium ‚Ä¢ Conseils</span>
    </div>
  </div>
  
  <header>
    <picture>
      <source srcset="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
      <img src="https://i.imgur.com/GmyGlKk.jpg" alt="Logo ClairVoyanceMedium" class="logo" width="720" height="720" loading="eager" decoding="async" fetchpriority="high">
    </picture>
  </header>
  
  <div class="chat-intro">Chat IA Spirituel - ClairVoyanceGPT</div>
  
  <div class="chat-subtitle">Posez vos questions en toute confidentialit√© √† notre intelligence artificielle spirituelle guid√©e par Frederick, m√©dium depuis plus de 25 ans. Obtenez instantan√©ment des r√©ponses personnalis√©es sur l'amour, la protection, la voyance et bien plus encore.</div>
  
  <div id="chat-container">
    <div id="chat-box">
      <div id="chat-messages"></div>
      <form id="chat-form">
        <div class="input-row">
          <input type="text" id="chat-input" placeholder="Votre question..." autocomplete="off">
        </div>
        <button type="submit" id="chat-send">Envoyer</button>
      </form>
    </div>
  </div>
  
  <button type="button" id="voice-toggle" class="active" title="Assistant vocal">
    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="circleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
          <stop offset="50%" style="stop-color:#FFA500;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:1" />
        </linearGradient>
        <radialGradient id="glowGradient">
          <stop offset="0%" style="stop-color:#FFA500;stop-opacity:0.6" />
          <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:0" />
        </radialGradient>
        <filter id="softShadow">
          <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
          <feOffset dx="0" dy="2" result="offsetblur"/>
          <feComponentTransfer>
            <feFuncA type="linear" slope="0.4"/>
          </feComponentTransfer>
          <feMerge>
            <feMergeNode/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>
      
      <circle cx="50" cy="50" r="40" fill="url(#glowGradient)" opacity="0.5"/>
      <circle cx="50" cy="50" r="35" fill="url(#circleGradient)" filter="url(#softShadow)"/>
      <ellipse cx="50" cy="35" rx="25" ry="12" fill="#ffffff" opacity="0.2"/>
      
      <g fill="#ffffff">
        <path d="M35 40 L35 60 L42 60 L52 68 L52 32 L42 40 Z"/>
        <path class="wave1" d="M58 45 Q62 50 58 55" stroke="#ffffff" stroke-width="2.5" fill="none" opacity="0.8"/>
        <path class="wave2" d="M63 42 Q68 50 63 58" stroke="#ffffff" stroke-width="2.5" fill="none" opacity="0.6"/>
        <path class="wave3" d="M68 39 Q74 50 68 61" stroke="#ffffff" stroke-width="2.5" fill="none" opacity="0.4"/>
      </g>
    </svg>
  </button>
  
  <!-- LIEN RETOUR - NOUVELLE PAGE -->
  <div class="return-line">
    <a href="https://www.clairvoyancemedium.com/" target="_blank" rel="noopener noreferrer">Retour vers le cabinet de voyance ClairVoyanceMedium.com</a>
  </div>
  
  <a id="floating-tab" class="floating-tab" href="#" target="_blank" rel="noopener noreferrer">
    <span class="close-btn">√ó</span>
    <span id="floating-text">Ce qu'il vous faut !</span>
  </a>
  
  <footer>
    <p>¬© 2006-<span id="current-year"></span> ClairVoyanceMedium.com - Tous droits r√©serv√©s</p>
    <p><a href="https://www.clairvoyancemedium.com/Conditions-Generales-des-Ventes-et-d-Utilisation-ccsaaaaaa.asp" target="_blank" rel="noopener noreferrer">Conditions G√©n√©rales</a></p>
  </footer>
  
  <script>
document.getElementById('current-year').textContent = new Date().getFullYear();

function trackEvent(eventName, params = {}) {
  if (typeof gtag === 'function') {
    gtag('event', eventName, params);
    console.log('üìä GA4:', eventName, params);
  }
}

trackEvent('page_view', {
  page_title: document.title,
  page_location: window.location.href,
  page_path: window.location.pathname,
  page_referrer: document.referrer,
  screen_resolution: `${screen.width}x${screen.height}`,
  viewport_size: `${window.innerWidth}x${window.innerHeight}`,
  device_type: /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
  browser: navigator.userAgent,
  language: navigator.language
});

document.addEventListener('visibilitychange', () => {
  trackEvent('page_visibility_change', {
    visibility_state: document.visibilityState,
    hidden: document.hidden
  });
});

document.addEventListener('copy', (e) => {
  const selection = window.getSelection().toString();
  if (selection.length > 0) {
    trackEvent('text_copied', {
      text_length: selection.length,
      text_preview: selection.substring(0, 50)
    });
  }
});

window.addEventListener('orientationchange', () => {
  trackEvent('orientation_change', {
    orientation: screen.orientation ? screen.orientation.type : window.orientation
  });
});

let resizeTimeout;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    trackEvent('window_resized', {
      new_width: window.innerWidth,
      new_height: window.innerHeight
    });
  }, 500);
});

window.addEventListener('online', () => {
  trackEvent('connection_status_change', {status: 'online'});
});
window.addEventListener('offline', () => {
  trackEvent('connection_status_change', {status: 'offline'});
});

window.addEventListener('error', (e) => {
  trackEvent('javascript_error', {
    error_message: e.message,
    error_filename: e.filename,
    error_line: e.lineno
  });
});

document.addEventListener('contextmenu', (e) => {
  trackEvent('right_click', {
    element: e.target.tagName,
    element_id: e.target.id || 'none'
  });
});

let userName = '';
let userNameConfirmed = false;
let pendingName = '';
let messageCount = 0;
let voiceEnabled = true;
let recognition = null;
let currentBlinkingTab = null;
let currentFixedTab = null;
let fixedTabTimeout = null;
let nonUnderstoodCount = 0;
let currentUtterance = null;
let sessionStartTime = Date.now();

let randomBlinkInterval = null;
let randomBlinkActive = true;
let allNavLinks = [];

const PHONE_NUMBER = "+33695468923";
const PHONE_DISPLAY = "06 95 46 89 23";

const STORAGE_KEY = 'clairvoyance_chat_history';
const STORAGE_TIMESTAMP = 'clairvoyance_chat_timestamp';
const SESSION_KEY = 'clairvoyance_session_active';

function saveConversation() {
  const data = {
    messages: Array.from(document.getElementById('chat-messages').children).map(p => ({
      text: p.textContent,
      isBot: p.className === 'bot-message'
    })),
    userName,
    userNameConfirmed,
    messageCount
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  localStorage.setItem(STORAGE_TIMESTAMP, Date.now().toString());
  localStorage.setItem(SESSION_KEY, 'true');
  
  trackEvent('conversation_saved', {
    message_count: messageCount
  });
}

function loadConversation() {
  const timestamp = localStorage.getItem(STORAGE_TIMESTAMP);
  const sessionActive = localStorage.getItem(SESSION_KEY);
  
  if (!timestamp || !sessionActive) return false;
  
  const age = Date.now() - parseInt(timestamp);
  const twentyFourHours = 24 * 60 * 60 * 1000;
  
  if (age > twentyFourHours || sessionActive !== 'true') {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STORAGE_TIMESTAMP);
    localStorage.removeItem(SESSION_KEY);
    return false;
  }
  
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
  if (!data) return false;
  
  const messagesDiv = document.getElementById('chat-messages');
  messagesDiv.innerHTML = '';
  data.messages.forEach(msg => {
    const p = document.createElement('p');
    p.className = msg.isBot ? 'bot-message' : 'user-message';
    p.textContent = msg.text;
    messagesDiv.appendChild(p);
  });
  
  userName = data.userName || '';
  userNameConfirmed = data.userNameConfirmed || false;
  messageCount = data.messageCount || 0;
  
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  trackEvent('conversation_restored', {
    message_count: messageCount,
    user_confirmed: userNameConfirmed,
    age_hours: Math.round(age / 3600000)
  });
  
  return true;
}

window.addEventListener('beforeunload', () => {
  const sessionDuration = Date.now() - sessionStartTime;
  localStorage.setItem(SESSION_KEY, 'false');
  trackEvent('session_end', {
    message_count: messageCount,
    duration_seconds: Math.round(sessionDuration / 1000),
    duration_minutes: Math.round(sessionDuration / 60000),
    user_confirmed: userNameConfirmed,
    user_name: userName || 'anonymous'
  });
});

const conversationRestored = loadConversation();

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(randomBlinkTabs, 500);
  });
} else {
  setTimeout(randomBlinkTabs, 500);
}

const TAB_URLS = [
  'https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/',
  'https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp',
  'https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp',
  'https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp',
  'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp',
  'https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp',
  'https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp',
  'https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp',
  'https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp'
];

// BANDEAU D√âFILANT - OUVRE NOUVELLE PAGE
const scrollingBanner = document.getElementById('scrolling-banner');

scrollingBanner.addEventListener('mouseenter', () => {
  trackEvent('scrolling_banner_hover');
});

scrollingBanner.addEventListener('click', () => {
  trackEvent('scrolling_banner_clicked', {
    destination: 'clairvoyancemedium.com',
    time_on_page: Math.round((Date.now() - sessionStartTime) / 1000)
  });
  window.open('https://www.clairvoyancemedium.com/', '_blank', 'noopener,noreferrer');
});

document.querySelectorAll('nav ul li a').forEach((link, index) => {
  link.addEventListener('mouseenter', () => {
    trackEvent('nav_tab_hover', {
      tab_text: link.textContent.trim(),
      tab_position: index + 1
    });
  });
  
  link.addEventListener('click', (e) => {
    const linkText = link.textContent.trim();
    const linkURL = link.href;
    const exactMatch = link.getAttribute('data-exact');
    
    trackEvent('navigation_click', {
      link_text: linkText,
      link_url: linkURL,
      exact_match: exactMatch,
      position: index + 1,
      time_on_page: Math.round((Date.now() - sessionStartTime) / 1000)
    });
  });
});

document.querySelector('.return-line a').addEventListener('click', () => {
  trackEvent('return_link_click', {
    destination: 'clairvoyancemedium.com',
    time_on_page: Math.round((Date.now() - sessionStartTime) / 1000)
  });
});

document.querySelectorAll('footer a').forEach(link => {
  link.addEventListener('click', () => {
    trackEvent('footer_link_click', {
      link_text: link.textContent.trim(),
      link_url: link.href
    });
  });
});

let inputFocusTime = 0;

document.getElementById('chat-input').addEventListener('focus', () => {
  inputFocusTime = Date.now();
  trackEvent('chat_input_focus', {
    message_count: messageCount
  });
});

document.getElementById('chat-input').addEventListener('blur', () => {
  const focusDuration = Date.now() - inputFocusTime;
  trackEvent('chat_input_blur', {
    message_count: messageCount,
    focus_duration_seconds: Math.round(focusDuration / 1000)
  });
});

let typingTimeout;
let lastTypingTrack = 0;
let typingStartTime = 0;
let isTyping = false;

document.getElementById('chat-input').addEventListener('input', (e) => {
  clearTimeout(typingTimeout);
  const now = Date.now();
  
  if (!isTyping) {
    isTyping = true;
    typingStartTime = now;
  }
  
  if (now - lastTypingTrack > 3000 && e.target.value.length > 0) {
    trackEvent('user_typing', {
      input_length: e.target.value.length,
      message_count: messageCount,
      input_preview: e.target.value.substring(0, 30)
    });
    lastTypingTrack = now;
  }
  
  typingTimeout = setTimeout(() => {
    if (isTyping) {
      const typingDuration = Date.now() - typingStartTime;
      trackEvent('typing_stopped', {
        typing_duration: Math.round(typingDuration / 1000),
        final_length: e.target.value.length
      });
      isTyping = false;
    }
  }, 2000);
});

let isDragging = false;
let hasMoved = false;
let startX, startY, offsetX = 0, offsetY = 0;
const floatingTab = document.getElementById('floating-tab');

floatingTab.addEventListener('mousedown', dragStart);
floatingTab.addEventListener('touchstart', dragStart, {passive: false});

function dragStart(e) {
  if (e.target.classList.contains('close-btn')) {
    e.preventDefault();
    e.stopPropagation();
    floatingTab.classList.remove('show');
    
    trackEvent('floating_tab_closed', {
      url: floatingTab.href,
      time_displayed: Math.round((Date.now() - sessionStartTime) / 1000)
    });
    return;
  }
  
  isDragging = true;
  hasMoved = false;
  const touch = e.type === 'touchstart' ? e.touches[0] : e;
  startX = touch.clientX - offsetX;
  startY = touch.clientY - offsetY;
  
  floatingTab.style.transition = 'none';
}

document.addEventListener('mousemove', drag);
document.addEventListener('touchmove', drag, {passive: false});

function drag(e) {
  if (!isDragging) return;
  
  const touch = e.type === 'touchmove' ? e.touches[0] : e;
  const moveX = touch.clientX - startX;
  const moveY = touch.clientY - startY;
  
  if (Math.abs(moveX - offsetX) > 5 || Math.abs(moveY - offsetY) > 5) {
    hasMoved = true;
    e.preventDefault();
  }
  
  offsetX = moveX;
  offsetY = moveY;
  
  floatingTab.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
}

document.addEventListener('mouseup', dragEnd);
document.addEventListener('touchend', dragEnd);

function dragEnd(e) {
  if (isDragging) {
    isDragging = false;
    floatingTab.style.transition = 'box-shadow 0.3s ease';
    
    if (!hasMoved) {
      return;
    } else {
      e.preventDefault();
      trackEvent('floating_tab_dragged', {
        offset_x: offsetX,
        offset_y: offsetY,
        final_position: `${offsetX},${offsetY}`
      });
    }
  }
}

let audioContext = null;
let analyser = null;
let animationFrameId = null;

function speak(text) {
  if (!voiceEnabled || !('speechSynthesis' in window)) return;
  
  let textToSpeak = text.replace(/https?:\/\/[^\s]+/g, '');
  
  window.speechSynthesis.cancel();
  
  const utterance = new SpeechSynthesisUtterance(textToSpeak);
  utterance.lang = 'fr-FR';
  
  const voices = window.speechSynthesis.getVoices();
  
  let voice = voices.find(v => 
    v.lang === 'fr-FR' && 
    (v.name.includes('Thomas') || v.name.includes('Amelie'))
  );
  
  if (!voice) {
    voice = voices.find(v => v.lang.startsWith('fr'));
  }
  
  if (voice) {
    utterance.voice = voice;
  }
  
  utterance.pitch = 0.75;
  utterance.rate = 0.95;
  utterance.volume = 1.0;
  
  const chatBox = document.getElementById('chat-box');
  const voiceBtn = document.getElementById('voice-toggle');
  
  utterance.onstart = () => {
    voiceBtn.classList.add('speaking');
    simulateSpeechRhythm(textToSpeak);
    
    trackEvent('voice_playback_start', {
      text_length: textToSpeak.length,
      word_count: textToSpeak.split(' ').length,
      message_count: messageCount
    });
  };
  
  utterance.onend = () => {
    voiceBtn.classList.remove('speaking');
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }
    chatBox.style.borderColor = '';
    chatBox.style.boxShadow = '';
    
    trackEvent('voice_playback_end', {
      text_length: textToSpeak.length
    });
  };
  
  utterance.onerror = (e) => {
    voiceBtn.classList.remove('speaking');
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }
    chatBox.style.borderColor = '';
    chatBox.style.boxShadow = '';
    
    trackEvent('voice_playback_error', {
      error: e.error
    });
  };
  
  currentUtterance = utterance;
  window.speechSynthesis.speak(utterance);
}

function simulateSpeechRhythm(text) {
  const chatBox = document.getElementById('chat-box');
  
  const words = text.split(/\s+/);
  let wordIndex = 0;
  const msPerWord = 395;
  
  function pulseWord() {
    if (!window.speechSynthesis.speaking || wordIndex >= words.length) {
      chatBox.style.borderColor = '';
      chatBox.style.boxShadow = '';
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
      }
      return;
    }
    
    const word = words[wordIndex];
    const syllables = Math.max(1, Math.ceil(word.length / 3));
    
    let syllableCount = 0;
    const syllableDuration = msPerWord / syllables;
    
    function animateSyllable() {
      if (!window.speechSynthesis.speaking) {
        chatBox.style.borderColor = '';
        chatBox.style.boxShadow = '';
        return;
      }
      
      if (syllableCount >= syllables) {
        wordIndex++;
        setTimeout(pulseWord, 40);
        return;
      }
      
      const phase = (syllableCount % 2 === 0) ? 1 : 0.5;
      const intensity = 0.7 + (Math.random() * 0.3) * phase;
      
      const baseGlow = 25 + (intensity * 35);
      const strongGlow = 40 + (intensity * 55);
      const opacity = 0.7 + (intensity * 0.3);
      
      chatBox.style.borderColor = `rgba(135, 206, 235, ${opacity})`;
      chatBox.style.boxShadow = `
        0 0 ${baseGlow}px rgba(135, 206, 235, ${opacity}),
        0 0 ${strongGlow}px rgba(176, 224, 230, ${opacity * 0.85})
      `;
      
      syllableCount++;
      setTimeout(animateSyllable, syllableDuration);
    }
    
    animateSyllable();
  }
  
  pulseWord();
}

if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = () => {
    window.speechSynthesis.getVoices();
  };
  setTimeout(() => {
    window.speechSynthesis.getVoices();
  }, 100);
}

if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    const confidence = event.results[0][0].confidence;
    document.getElementById('chat-input').value = transcript;
    
    trackEvent('voice_input_recognized', {
      transcript_length: transcript.length,
      confidence: confidence,
      transcript_preview: transcript.substring(0, 50)
    });
    
    handleMessage();
  };
  
  recognition.onerror = (event) => {
    console.log('Erreur reconnaissance vocale:', event.error);
    trackEvent('voice_input_error', {
      error: event.error
    });
  };
}

document.getElementById('voice-toggle').addEventListener('click', () => {
  const voiceBtn = document.getElementById('voice-toggle');
  
  if (voiceEnabled) {
    voiceEnabled = false;
    voiceBtn.classList.remove('active');
    voiceBtn.classList.add('disabled');
    if (recognition) {
      try { recognition.stop(); } catch(e) {}
    }
    if (currentUtterance) window.speechSynthesis.cancel();
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }
    const chatBox = document.getElementById('chat-box');
    chatBox.style.borderColor = '';
    chatBox.style.boxShadow = '';
    voiceBtn.classList.remove('speaking');
    
    trackEvent('voice_disabled', {
      message_count: messageCount,
      time_active: Math.round((Date.now() - sessionStartTime) / 1000)
    });
  } else {
    voiceEnabled = true;
    
    voiceBtn.classList.remove('disabled');
    voiceBtn.classList.add('active');
    voiceBtn.removeAttribute('style');
    
    voiceBtn.style.cssText = 'filter: drop-shadow(0 0 15px rgba(255,140,0,0.6)) !important; opacity: 1 !important;';
    
    setTimeout(() => {
      voiceBtn.classList.remove('disabled');
      voiceBtn.classList.add('active');
      voiceBtn.style.filter = 'drop-shadow(0 0 15px rgba(255,140,0,0.6))';
      voiceBtn.style.webkitFilter = 'drop-shadow(0 0 15px rgba(255,140,0,0.6))';
      voiceBtn.style.opacity = '1';
    }, 10);
    
    setTimeout(() => {
      voiceBtn.classList.remove('disabled');
      voiceBtn.classList.add('active');
      voiceBtn.style.filter = 'drop-shadow(0 0 15px rgba(255,140,0,0.6))';
      voiceBtn.style.webkitFilter = 'drop-shadow(0 0 15px rgba(255,140,0,0.6))';
      voiceBtn.style.opacity = '1';
    }, 100);
    
    if (recognition) {
      try { 
        recognition.start(); 
      } catch(e) {
        console.log('Reconnaissance vocale d√©j√† active');
      }
    }
    
    trackEvent('voice_enabled', {
      message_count: messageCount
    });
  }
});

function addMessage(text, isBot = false) {
  const messagesDiv = document.getElementById('chat-messages');
  const messageDiv = document.createElement('p');
  messageDiv.className = isBot ? 'bot-message' : 'user-message';
  messageDiv.textContent = text;
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  if (isBot && voiceEnabled) speak(text);
  
  if (!isBot) {
    trackEvent('user_message_sent', {
      message_length: text.length,
      word_count: text.split(' ').length,
      message_number: messageCount + 1,
      user_confirmed: userNameConfirmed,
      message_full_text: text,
      time_since_page_load: Math.round((Date.now() - sessionStartTime) / 1000)
    });
  } else {
    trackEvent('bot_message_received', {
      message_length: text.length,
      word_count: text.split(' ').length,
      message_number: messageCount
    });
  }
  
  saveConversation();
}

function blinkTab(exactMatch) {
  randomBlinkActive = false;
  if (randomBlinkInterval) {
    clearInterval(randomBlinkInterval);
    randomBlinkInterval = null;
  }
  
  const navLinks = document.querySelectorAll('nav ul li a');
  navLinks.forEach(link => {
    link.classList.remove('blink');
    link.classList.remove('fixed');
  });
  
  currentBlinkingTab = null;
  
  if (fixedTabTimeout) {
    clearTimeout(fixedTabTimeout);
  }
  
  navLinks.forEach(link => {
    const linkExact = link.getAttribute('data-exact');
    if (linkExact && linkExact.toLowerCase() === exactMatch.toLowerCase()) {
      link.classList.add('fixed');
      currentFixedTab = link;
      link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      trackEvent('tab_highlighted', {
        tab_name: exactMatch,
        tab_text: link.textContent.trim(),
        tab_url: link.href
      });
    }
  });
  
  fixedTabTimeout = setTimeout(() => {
    if (currentFixedTab) {
      currentFixedTab.classList.remove('fixed');
      currentFixedTab = null;
    }
    randomBlinkActive = true;
    randomBlinkTabs();
    
    trackEvent('tab_highlight_ended', {
      duration_seconds: 40
    });
  }, 40000);
}

function randomBlinkTabs() {
  if (allNavLinks.length === 0) {
    allNavLinks = Array.from(document.querySelectorAll('nav ul li a'));
  }
  
  function blinkRandom() {
    if (!randomBlinkActive) return;
    
    if (currentBlinkingTab) {
      currentBlinkingTab.classList.remove('blink');
    }
    
    const randomIndex = Math.floor(Math.random() * allNavLinks.length);
    const randomTab = allNavLinks[randomIndex];
    
    randomTab.classList.add('blink');
    currentBlinkingTab = randomTab;
  }
  
  blinkRandom();
  randomBlinkInterval = setInterval(blinkRandom, 2000);
}

function showFloatingTab(url, isPhoneNumber = false) {
  const floatingText = document.getElementById('floating-text');
  
  if (isPhoneNumber) {
    floatingTab.href = `tel:${url}`;
    floatingText.textContent = `0695468923 ‚Ä¢ 24h/7j`;
  } else {
    floatingTab.href = url;
    floatingText.textContent = `Ce qu'il vous faut ${userName} !`;
  }
  
  floatingTab.classList.add('show');
  floatingTab.onclick = null;
  
  trackEvent('floating_tab_displayed', {
    url: url,
    is_phone: isPhoneNumber,
    user_name: userName || 'anonymous',
    triggered_by_message: messageCount
  });
}

// ==========================================
// üî• BASE DE CONNAISSANCES - 100% PR√äTE üî•
// ==========================================
// Remplacez ce tableau demo par votre base compl√®te
const knowledgeBase = [
  {
    keywords: "t√©l√©phone|appel|30min|t√©l|telephoner|appeler|phone",
    exactMatch: "voyance t√©l√©phone",
    answer: (name) => `${name}, notre consultation t√©l√©phonique vous permet d'√©changer directement avec Frederick du Cabinet ClairVoyanceMedium.com. 30 minutes d'√©change personnalis√© pour 30‚Ç¨. Disponible 24h/24 et 7j/7.`,
    url: "https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/",
    isExternal: false,
    isPhone: true
  },
  {
    keywords: "email|questions|mail|courriel|√©crit|3questions",
    exactMatch: "voyance email",
    answer: (name) => `${name}, posez 3 questions par email √† Frederick du Cabinet ClairVoyanceMedium.com. R√©ponses d√©taill√©es et personnalis√©es sous 48h. Id√©al pour une consultation √©crite approfondie. Seulement 12‚Ç¨ pour 3 questions.`,
    url: "https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp",
    isExternal: false
  }
];
    
function removeAccents(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function levenshteinDistance(a, b) {
    const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
    for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
    for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
    for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
            const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + indicator);
        }
    }
    return matrix[b.length][a.length];
}

function phoneticNormalize(str) {
    return removeAccents(str)
        .replace(/ph/g, "f")
        .replace(/k/g, "c")
        .replace(/qu/g, "k")
        .replace(/ss/g, "s")
        .replace(/√©e/g, "e")
        .replace(/ai/g, "e")
        .replace(/au/g, "o")
        .replace(/ou/g, "u")
        .replace(/oi/g, "oa")
        .replace(/y/g, "i")
        .replace(/w/g, "v")
        .replace(/x/g, "ks")
        .replace(/z/g, "s")
        .replace(/j/g, "g")
        .replace(/ch/g, "sh");
}

function findBestMatch(userInput) {
    const userLower = phoneticNormalize(userInput.toLowerCase());
    const userWords = userLower.split(/\s+/);
    let bestMatch = null;
    let maxScore = 0;
    
    const hasEmail = /(email|mail|√©crit|courriel|mel)/i.test(userInput);
    const hasTelephone = /(t√©l√©phone|tel|appel|appeler|telephoner|phone|fon)/i.test(userInput);
    
    knowledgeBase.forEach(item => {
        let score = 0;
        const keywords = item.keywords.split('|');
        
        if (hasEmail && item.exactMatch === 'voyance t√©l√©phone') return;
        if (hasTelephone && item.exactMatch === 'voyance email') return;
        
        keywords.forEach(keyword => {
            const normalizedKeyword = phoneticNormalize(keyword.trim().toLowerCase());
            
            if (userLower.includes(normalizedKeyword)) {
                score += normalizedKeyword.length * 10;
            }
            
            userWords.forEach(userWord => {
                if (userWord.length >= 1) {
                    const distance = levenshteinDistance(userWord, normalizedKeyword);
                    const similarity = 1 - distance / Math.max(userWord.length, normalizedKeyword.length);
                    
                    if (similarity >= 0.35) {
                        score += similarity * normalizedKeyword.length * 5;
                    }
                }
            });
        });
        
        if (score > maxScore) {
            maxScore = score;
            bestMatch = item;
        }
    });
    
    return maxScore > 0.8 ? bestMatch : null;
}

function handleMessage() {
  const input = document.getElementById('chat-input');
  const userMsg = input.value.trim();
  
  if (!userMsg) return;
  
  addMessage(userMsg, false);
  input.value = '';
  messageCount++;
  
  setTimeout(() => {
    const lowerMsg = userMsg.toLowerCase().trim();
    
    if (lowerMsg === "merci" || lowerMsg === "merci beaucoup" || lowerMsg === "je vous remercie") {
      addMessage("Je vous en prie, je suis l√† pour vous aider !", true);
      trackEvent('politeness_detected', {type: 'thanks', message: lowerMsg});
      return;
    }
    
    if (lowerMsg === "bonsoir") {
      addMessage(`Bonsoir ${userName || ''} ! Comment puis-je vous √©clairer ce soir ?`, true);
      trackEvent('politeness_detected', {type: 'evening_greeting'});
      return;
    }
    
    if (!userNameConfirmed) {
      if (lowerMsg === "bonjour" || lowerMsg.startsWith("bonjour")) {
        addMessage("Bonjour ! Je suis ClairVoyanceGPT, votre assistant spirituel cr√©√© par Frederick du Cabinet ClairVoyanceMedium.com. Avant de commencer cette consultation, pouvez-vous m'indiquer votre pr√©nom ?", true);
        trackEvent('politeness_detected', {type: 'greeting'});
        return;
      }
      
      if (pendingName) {
        if (lowerMsg === "oui" || lowerMsg === "oui c'est √ßa" || lowerMsg === "oui c'est bien √ßa") {
          userName = pendingName;
          userNameConfirmed = true;
          pendingName = '';
          addMessage(`Parfait ${userName} ! Comment puis-je vous aider aujourd'hui ?`, true);
          
          trackEvent('user_name_confirmed', {
            user_name: userName,
            confirmation_attempt: 1
          });
          return;
        } else if (lowerMsg === "non") {
          pendingName = '';
          addMessage("Alors donnez-moi votre pr√©nom s'il vous pla√Æt.", true);
          trackEvent('user_name_rejected');
          return;
        }
      }
      
      const nameMatch = userMsg.match(/([A-Z√Ä-√ñ√ò-√ùa-z√†-√∂√∏-√ø]{2,})/);
      if (nameMatch) {
        pendingName = nameMatch[1].charAt(0).toUpperCase() + nameMatch[1].slice(1).toLowerCase();
        addMessage(`Tr√®s bien ${pendingName}, c'est bien votre pr√©nom ?`, true);
        
        trackEvent('user_name_detected', {
          pending_name: pendingName,
          name_length: pendingName.length
        });
        return;
      }
      
      addMessage("Je n'ai pas bien saisi votre pr√©nom. Pouvez-vous me le donner clairement s'il vous pla√Æt ?", true);
      return;
    }
    
    const goodbyeTriggers = ["au revoir", "aurevoir", "√† bient√¥t", "bye", "ciao"];
    if (goodbyeTriggers.some(phrase => lowerMsg === phrase || lowerMsg.endsWith(phrase))) {
      addMessage(`${userName}, √† tr√®s bient√¥t ! Frederick du Cabinet ClairVoyanceMedium.com et son √©quipe restent √† votre √©coute 24h/24.`, true);
      trackEvent('conversation_goodbye', {
        user_name: userName,
        message_count: messageCount,
        goodbye_phrase: lowerMsg
      });
      return;
    }
    
    const phoneKeywords = /(t√©l√©phone|tel|appel|appeler|telephoner|phone|joindre|contacter par t√©l√©phone)/i;
    if (phoneKeywords.test(lowerMsg) && userNameConfirmed) {
      showFloatingTab(PHONE_NUMBER, true);
    }
    
    const match = findBestMatch(userMsg);
    
    if (match) {
      const response = match.answer(userName);
      addMessage(response, true);
      
      blinkTab(match.exactMatch);
      
      trackEvent('knowledge_match_found', {
        exact_match: match.exactMatch,
        keywords: match.keywords,
        user_query_full: userMsg,
        response_length: response.length
      });
      
      if (match.isPhone) {
        showFloatingTab(match.url, true);
      } else if (match.isExternal && !TAB_URLS.includes(match.url)) {
        showFloatingTab(match.url, false);
      }
      
      nonUnderstoodCount = 0;
    } else {
      nonUnderstoodCount++;
      
      trackEvent('knowledge_match_not_found', {
        user_query_full: userMsg,
        attempt_number: nonUnderstoodCount,
        query_length: userMsg.length
      });
      
      if (nonUnderstoodCount === 1) {
        addMessage(`${userName}, je n'ai pas bien compris votre question. Pourriez-vous la reformuler ou v√©rifier l'orthographe s'il vous pla√Æt ?`, true);
      } else if (nonUnderstoodCount === 2) {
        addMessage(`${userName}, je ne comprends toujours pas. Essayez avec des mots simples : amour, voyance, protection, fatigue, d√©funt ?`, true);
      } else {
        addMessage(`${userName}, il semble difficile de nous comprendre. Peut-√™tre qu'un √©change direct serait plus efficace ? Frederick du Cabinet ClairVoyanceMedium.com propose : t√©l√©phone (30‚Ç¨/30min), email (12‚Ç¨/3Q), ou rituel complet. Que pr√©f√©rez-vous ?`, true);
        trackEvent('help_offer_displayed', {
          after_attempts: nonUnderstoodCount
        });
        nonUnderstoodCount = 0;
      }
    }
  }, 800);
}

document.getElementById('chat-send').addEventListener('click', (e) => {
  e.preventDefault();
  const inputValue = document.getElementById('chat-input').value;
  trackEvent('send_button_clicked', {
    message_count: messageCount + 1,
    has_content: inputValue.length > 0,
    content_length: inputValue.length
  });
  handleMessage();
});

document.getElementById('chat-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    const inputValue = e.target.value;
    trackEvent('enter_key_pressed', {
      message_count: messageCount + 1,
      content_length: inputValue.length
    });
    handleMessage();
  }
});

document.getElementById('chat-form').addEventListener('submit', (e) => {
  e.preventDefault();
  handleMessage();
});

if (!conversationRestored) {
  setTimeout(() => {
    const welcomeMessage = "Bienvenue sur ClairVoyanceGPT, l'assistant spirituel de Frederick du Cabinet ClairVoyanceMedium.com, m√©dium reconnu depuis plus de 25 ans. Avant de commencer cet √©change, pouvez-vous m'indiquer dans un premier temps uniquement votre pr√©nom ?";
    addMessage(welcomeMessage, true);
    
    trackEvent('welcome_message_displayed', {
      message_length: welcomeMessage.length
    });
    
    if (voiceEnabled && 'speechSynthesis' in window) {
      const tryAutoplay = () => {
        try {
          speak(welcomeMessage);
          trackEvent('voice_autoplay_success');
        } catch (err) {
          console.log('Autoplay bloqu√©, affichage bouton');
          showVoiceButton();
          trackEvent('voice_autoplay_blocked', {
            error: err.message
          });
        }
      };
      
      if (document.readyState === 'complete') {
        tryAutoplay();
      } else {
        window.addEventListener('load', tryAutoplay);
      }
    }
  }, 500);
}

function showVoiceButton() {
  const messagesDiv = document.getElementById('chat-messages');
  const btnDiv = document.createElement('div');
  btnDiv.style.textAlign = 'center';
  btnDiv.style.margin = '1rem 0';
  btnDiv.innerHTML = `
    <button id="enable-voice-btn" style="
      padding:0.8rem 1.5rem;
      background:#000;
      color:#BBAE98;
      border:3px solid #FF8C00;
      font-family:'Cinzel',serif;
      font-size:1rem;
      cursor:pointer;
      animation:blinkVoiceBtn 1.5s ease-in-out infinite;
      border-radius:0;
    ">
      üîä Activer l'assistant vocal
    </button>
    <style>
      @keyframes blinkVoiceBtn {
        0%, 100% { box-shadow: 0 0 10px #FF8C00; border-color: #FF8C00; }
        50% { box-shadow: 0 0 20px #FFA500; border-color: #FFA500; }
      }
    </style>
  `;
  messagesDiv.appendChild(btnDiv);
  
  document.getElementById('enable-voice-btn').addEventListener('click', () => {
    const welcomeMsg = "Bienvenue sur ClairVoyanceGPT, l'assistant spirituel de Frederick du Cabinet ClairVoyanceMedium.com, m√©dium reconnu depuis plus de 25 ans. Avant de commencer cet √©change, pouvez-vous m'indiquer dans un premier temps uniquement votre pr√©nom ?";
    speak(welcomeMsg);
    btnDiv.remove();
    trackEvent('voice_button_clicked_manual');
  });
}

let lastTouchY = 0;
let preventPullToRefresh = false;

document.addEventListener('touchstart', (e) => {
  if (e.touches.length !== 1) return;
  lastTouchY = e.touches[0].clientY;
  preventPullToRefresh = window.pageYOffset === 0;
}, {passive: false});

document.addEventListener('touchmove', (e) => {
  const touchY = e.touches[0].clientY;
  const touchYDelta = touchY - lastTouchY;
  lastTouchY = touchY;
  
  if (preventPullToRefresh) {
    if (touchYDelta > 0) {
      e.preventDefault();
      return;
    }
    preventPullToRefresh = false;
  }
}, {passive: false});

let scrollTimeout;
let lastScrollTrack = 0;
let maxScrollReached = 0;
let lastScrollY = 0;

window.addEventListener('scroll', () => {
  clearTimeout(scrollTimeout);
  const now = Date.now();
  const currentScroll = window.scrollY;
  const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
  const scrollPercentage = Math.round((currentScroll / maxScroll) * 100);
  
  if (currentScroll > maxScrollReached) {
    maxScrollReached = currentScroll;
  }
  
  if (now - lastScrollTrack > 5000) {
    trackEvent('page_scrolled', {
      scroll_position: currentScroll,
      scroll_percentage: scrollPercentage,
      max_scroll_reached: maxScrollReached,
      scroll_direction: currentScroll > (lastScrollY || 0) ? 'down' : 'up'
    });
    lastScrollTrack = now;
    lastScrollY = currentScroll;
  }
});

setTimeout(() => { trackEvent('engagement_5s'); }, 5000);
setTimeout(() => { trackEvent('engagement_15s'); }, 15000);
setTimeout(() => { trackEvent('engagement_30s'); }, 30000);
setTimeout(() => { trackEvent('engagement_45s'); }, 45000);
setTimeout(() => { trackEvent('engagement_60s'); }, 60000);
setTimeout(() => { trackEvent('engagement_90s'); }, 90000);
setTimeout(() => { trackEvent('engagement_120s'); }, 120000);
setTimeout(() => { trackEvent('engagement_180s'); }, 180000);
setTimeout(() => { trackEvent('engagement_300s'); }, 300000);

let inactivityTimer;
const inactivityTime = 60000;

function resetInactivityTimer() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    trackEvent('user_inactive', {
      inactive_duration_seconds: 60,
      last_message_count: messageCount
    });
  }, inactivityTime);
}

['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
  document.addEventListener(event, resetInactivityTimer, true);
});

resetInactivityTimer();

console.log('‚úÖ SYST√àME 100% PR√äT - Base de connaissances, tracking GA4, illumination onglets, floating tab !');

</script>
</body>
</html>
