<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  
  <title>Chat IA Spirituel - ClairVoyanceMedium.com</title>
  <meta name="description" content="ClairVoyanceGPT - Assistant spirituel IA pour d√©senvo√ªtement, protection et guidance. Frederick du Cabinet ClairVoyanceMedium.com vous accompagne.">
  
  <!-- Favicon -->
  <link rel="icon" href="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/GmyGlKk.webp">
  <meta name="theme-color" content="#8B0000">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2RSFE6WL4M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2RSFE6WL4M', {'anonymize_ip': true});
    gtag('config', 'GTM-P3J6SXCH', {'anonymize_ip': true});
  </script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg:#000;
      --text:#fff;
      --gold:#FFD700;
      --tab-gold:#BBAE98;
      --orange:#FF8C00;
      --orange-light:#FFA500;
      --silver:#C0C0C0;
      --accent:#87CEEB;
      --blue-sky:#87CEEB;
    }
    
    *{margin:0;padding:0;box-sizing:border-box;}
    
    body{
      font-family:'Cinzel',serif;
      background:var(--bg);
      color:var(--text);
      text-align:center;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      padding-top:100px;
    }
    
    /* NAVIGATION STICKY - DISPOSITION IMBRIQU√âE ADAPTATIVE */
    nav{
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:1000;
      background:rgba(0,0,0,0.30);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      padding:0.7rem 0.5rem;
      box-shadow:0 2px 15px rgba(255,215,0,0.3);
    }
    
    nav ul{
      list-style:none;
      padding:0;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:0.4rem;
      max-width:1200px;
      margin:0 auto;
    }
    
    /* Effet imbriqu√© ligne par ligne */
    nav ul li:nth-child(4n+1),
    nav ul li:nth-child(4n+2),
    nav ul li:nth-child(4n+3){
      margin-right:0.3rem;
    }
    
    /* ANGLES CARR√âS - TAILLE -5% */
    nav ul li a{
      font-family:'Cinzel',serif;
      font-size:clamp(0.855rem, 2.1vw, 1.045rem);
      color:var(--tab-gold);
      text-decoration:none;
      padding:0.62rem 0.90rem;
      background:rgba(17,17,17,0.45);
      border:2px solid var(--tab-gold);
      border-radius:0;
      transition:all .3s ease;
      display:inline-block;
      text-align:center;
      min-height:43px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    nav ul li a:hover{
      background:var(--tab-gold);
      color:#111;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(187,174,152,0.5);
    }
    
    /* CLIGNOTEMENT ONGLETS */
    @keyframes blinkTab{
      0%, 100%{
        box-shadow:0 0 15px var(--orange);
        border-color:var(--orange);
        transform:scale(1);
      }
      50%{
        box-shadow:0 0 25px var(--orange-light);
        border-color:var(--orange-light);
        transform:scale(1.03);
      }
    }
    
    nav ul li a.blink{
      animation:blinkTab 1.2s ease-in-out infinite;
      background:#000;
      border:3px solid var(--orange);
      color:var(--tab-gold) !important;
    }
    
    header{
      padding:1.5rem 0;
      background:#111;
      box-shadow:0 4px 10px rgba(0,0,0,.8);
    }
    
    .logo{
      width:900px;
      max-width:92%;
      height:auto;
      display:block;
      margin:0 auto;
    }
    
    .chat-intro{
      max-width:900px;
      margin:1.5rem auto 2rem;
      padding:0 1rem;
      font-size:clamp(1.4rem, 5vw, 2.2rem);
      background:linear-gradient(145deg, #C0C0C0, #E8E8E8, #A8A8A8);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-weight:700;
    }
    
    #chat-container{
      max-width:900px;
      margin:1rem auto 2rem;
      padding:0 1rem;
    }
    
    #chat-box{
      background:#111;
      border:3px solid var(--orange);
      box-shadow:0 0 22px var(--orange), 0 0 39px rgba(255,140,0,0.7);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:650px;
      border-radius:0;
      transition:border-color 0.1s ease, box-shadow 0.1s ease;
    }
    
    /* Plus d'animation CSS statique - g√©r√© par JavaScript dynamiquement */
    
    #chat-messages{
      flex:1;
      padding:1.5rem;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      color:#fff;
      background:#0a0a0a;
    }
    
    #chat-messages::-webkit-scrollbar{width:10px;}
    #chat-messages::-webkit-scrollbar-track{background:#1a1a1a;}
    #chat-messages::-webkit-scrollbar-thumb{background:var(--orange);box-shadow:0 0 9px var(--orange);}
    
    #chat-messages p{
      margin-bottom:1rem;
      line-height:1.7;
      opacity:0;
      animation:fadeIn 0.6s forwards;
    }
    
    @keyframes fadeIn{to{opacity:1;}}
    
    .bot-message{
      text-align:left;
      color:#fff;
      background:rgba(255,140,0,0.15);
      padding:1rem;
      margin-bottom:1rem;
      border:2px solid var(--orange);
      box-shadow:0 0 17px rgba(255,140,0,0.55);
      max-width:90%;
      border-radius:0;
    }
    
    .user-message{
      text-align:right;
      color:#fff;
      margin-bottom:1rem;
      border:2px solid var(--silver);
      box-shadow:0 0 17px rgba(192,192,192,0.55);
      padding:1rem;
      max-width:90%;
      margin-left:auto;
      background:linear-gradient(145deg, rgba(192,192,192,0.1), rgba(211,211,211,0.08));
      border-radius:0;
    }
    
    #chat-form{
      display:flex;
      flex-direction:column;
      border-top:3px solid var(--orange);
      padding:1rem;
      background:#111;
      gap:0.8rem;
    }
    
    .input-row{
      display:flex;
      gap:0.7rem;
      align-items:center;
    }
    
    #chat-input{
      flex:1;
      padding:1rem;
      border:2px solid var(--orange);
      outline:none;
      color:#fff;
      background:#0a0a0a;
      font-family:'Cinzel',serif;
      font-size:0.9rem;
      box-shadow:0 0 13px rgba(255,140,0,0.45);
      border-radius:0;
    }
    
    #chat-input::placeholder{
      color:#999;
      opacity:0.7;
      font-style:italic;
    }
    
    #voice-toggle{
      width:50px;
      height:50px;
      background:linear-gradient(145deg,#87CEEB,#5eb6d1);
      color:#fff;
      border:none;
      border-radius:50%;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(135,206,235,0.8);
      font-size:1.4rem;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform 0.2s;
    }
    
    #voice-toggle:hover{transform:scale(1.1);}
    #voice-toggle.disabled{background:linear-gradient(145deg,#808080,#666);opacity:0.7;}
    
    #chat-send{
      width:100%;
      background:linear-gradient(145deg,var(--orange-light),var(--orange));
      border:2px solid var(--orange);
      padding:1rem 1.8rem;
      cursor:pointer;
      color:#fff;
      font-weight:bold;
      font-family:'Cinzel',serif;
      box-shadow:0 0 20px rgba(255,140,0,0.65);
      font-size:1.1rem;
      transition:transform .2s;
      border-radius:0;
    }
    
    #chat-send:hover{
      transform:scale(1.03);
      box-shadow:0 0 28px rgba(255,140,0,0.85);
    }
    
    /* BOUTON FLOTTANT FLUIDE - D√âPLA√áABLE PARTOUT */
    .floating-tab{
      position:fixed;
      top:50%;
      right:20px;
      transform:translateY(-50%);
      z-index:9999;
      background:#000;
      color:var(--tab-gold);
      padding:1.2rem 2rem;
      border:3px solid var(--orange);
      font-family:'Cinzel',serif;
      font-size:clamp(1rem, 2.5vw, 1.3rem);
      font-weight:bold;
      text-decoration:none;
      cursor:pointer;
      box-shadow:0 0 15px var(--orange);
      animation:blinkFloating 1.5s ease-in-out infinite;
      display:none;
      user-select:none;
      border-radius:0;
      will-change:transform;
      transition:box-shadow 0.3s ease;
    }
    
    .floating-tab.show{display:block;}
    
    .floating-tab .close-btn{
      position:absolute;
      top:-8px;
      right:-8px;
      width:24px;
      height:24px;
      background:var(--orange);
      color:#fff;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      border:2px solid #fff;
      z-index:10000;
    }
    
    @keyframes blinkFloating{
      0%, 100%{box-shadow:0 0 15px var(--orange);}
      50%{box-shadow:0 0 25px var(--orange-light);}
    }
    
    /* LIEN RETOUR - COULEUR TAB-GOLD (#BBAE98) */
    .return-line{
      font-family:'Cinzel',serif;
      font-size:0.9rem;
      margin:4.5rem auto 1rem;
      text-align:center;
      padding:0 1rem;
    }
    
    .return-line a,
    .return-line a:link,
    .return-line a:visited,
    .return-line a:hover,
    .return-line a:active{
      color:#BBAE98 !important;
      text-decoration:underline;
      transition:all 0.3s ease;
      display:inline-flex;
      align-items:center;
      gap:0.5rem;
    }
    
    .return-line a:before{
      content:"‚Üê";
      font-size:1.4rem;
    }
    
    .return-line a:hover{
      opacity:0.8;
      transform:translateX(-5px);
    }
    
    /* FOOTER - CONDITIONS G√âN√âRALES EN GRIS */
    footer{
      margin-top:2rem;
      font-size:.9rem;
      color:#aaa;
      padding:2rem 1rem;
      background:#111;
    }
    
    footer a{
      color:#aaa !important;
      text-decoration:none;
    }
    
    footer a:hover{
      color:#fff !important;
    }
    
    @media(max-width:1024px){
      body{padding-top:130px;}
    }
    
    @media(max-width:768px){
      body{padding-top:150px;}
      nav{padding:0.7rem 0.4rem;}
      nav ul{gap:0.4rem;}
      nav ul li a{font-size:0.82rem;padding:0.55rem 0.8rem;}
      #chat-box{height:550px;}
      .logo{width:95%;}
      .floating-tab{right:10px;padding:0.9rem 1.3rem;font-size:0.95rem;}
    }
    
    @media(max-width:480px){
      body{padding-top:190px;}
      nav ul{gap:0.35rem;}
      nav ul li a{font-size:0.75rem;padding:0.5rem 0.7rem;min-height:40px;}
      #chat-box{height:500px;}
    }
  </style>
</head>
<body>
  <!-- ONGLETS FIXES STICKY EN HAUT -->
  <nav>
    <ul>
      <li><a href="https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/" target="_blank" rel="noopener noreferrer" data-keywords="t√©l√©phone|appel|30min|t√©l|telephoner|appeler|phone" data-exact="voyance t√©l√©phone" data-url="https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/" onclick="trackClick('TabVoyanceTel', 'Navigation', 30);">Voyance T√©l 30min/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp" target="_blank" rel="noopener noreferrer" data-keywords="email|questions|mail|courriel|√©crit|3questions" data-exact="voyance email" data-url="https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp" onclick="trackClick('TabVoyanceEmail', 'Navigation', 12);">Voyance Email 3Q/12‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp" target="_blank" rel="noopener noreferrer" data-keywords="retour|ex|amour|reconqu√©rir|s√©paration|copain|copine" data-exact="retour ex" data-url="https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp" onclick="trackClick('TabRetourEx', 'Navigation', 175);">Retour Ex/175‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp" target="_blank" rel="noopener noreferrer" data-keywords="compatibilit√©|couple|relation|amoureuse" data-exact="compatibilit√©" data-url="https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp" onclick="trackClick('TabCompatibilite', 'Navigation', 20);">Compatibilit√©/20‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp" target="_blank" rel="noopener noreferrer" data-keywords="purification|protection|sort|envo√ªtement|magie|sorcellerie|fatigue|cauchemars" data-exact="purification" data-url="https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp" onclick="trackClick('TabPurification', 'Navigation', 150);">Purification/150‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp" target="_blank" rel="noopener noreferrer" data-keywords="d√©funt|mort|message|deuil|d√©c√©d√©" data-exact="d√©funt" data-url="https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp" onclick="trackClick('TabDefunt', 'Navigation', 17);">D√©funt/17‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp" target="_blank" rel="noopener noreferrer" data-keywords="sant√©|m√©decine|bien-√™tre|maladie" data-exact="sant√©" data-url="https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp" onclick="trackClick('TabSante', 'Navigation', 30);">Sant√©/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp" target="_blank" rel="noopener noreferrer" data-keywords="main|chiromancie|ligne|paume" data-exact="main" data-url="https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp" onclick="trackClick('TabMain', 'Navigation', 10);">Main/10‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp" target="_blank" rel="noopener noreferrer" data-keywords="ange|gardien|c√©leste|protection divine" data-exact="ange" data-url="https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp" onclick="trackClick('TabAnge', 'Navigation', 10);">Ange/10‚Ç¨</a></li>
    </ul>
  </nav>
  
  <!-- LOGO -->
  <header>
    <picture>
      <source srcset="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
      <img src="https://i.imgur.com/GmyGlKk.jpg" alt="Logo ClairVoyanceMedium" class="logo" width="720" height="720" loading="eager" decoding="async" fetchpriority="high">
    </picture>
  </header>
  
  <div class="chat-intro">Chat IA Spirituel - ClairVoyanceGPT</div>
  
  <!-- CHAT -->
  <div id="chat-container">
    <div id="chat-box">
      <div id="chat-messages"></div>
      <form id="chat-form">
        <div class="input-row">
          <input type="text" id="chat-input" placeholder="Votre question..." autocomplete="off">
          <button type="button" id="voice-toggle" title="Assistant vocal">üé§</button>
        </div>
        <button type="submit" id="chat-send" onclick="trackClick('ChatMessageSent', 'Engagement', 1);">Envoyer</button>
      </form>
    </div>
  </div>
  
  <div class="return-line">
    <a href="https://www.clairvoyancemedium.com/">Retour vers le cabinet de voyance ClairVoyanceMedium.com</a>
  </div>
  
  <!-- BOUTON FLOTTANT -->
  <a id="floating-tab" class="floating-tab" href="#" target="_blank" rel="noopener noreferrer" onclick="trackClick('FloatingTabClicked', 'Conversion', 1);">
    <span class="close-btn" onclick="event.preventDefault();event.stopPropagation();document.getElementById('floating-tab').classList.remove('show');trackClick('FloatingTabClosed', 'Interaction', 0);return false;">√ó</span>
    <span id="floating-text">Ce qu'il vous faut !</span>
  </a>
  
  <footer>
    <p>¬© 2006-<span id="current-year"></span> ClairVoyanceMedium.com - Tous droits r√©serv√©s</p>
    <p><a href="https://www.clairvoyancemedium.com/Conditions-Generales-des-Ventes-et-d-Utilisation-ccsaaaaaa.asp" target="_blank" rel="noopener noreferrer">Conditions G√©n√©rales</a></p>
  </footer>
  
  <script>
document.getElementById('current-year').textContent = new Date().getFullYear();

function trackClick(label, category, value) {
  if (typeof gtag === 'function') {
    gtag('event', label, {'event_category': category, 'event_label': label, 'value': value});
  }
}

let userName = '';
let userNameConfirmed = false;
let pendingName = '';
let messageCount = 0;
let voiceEnabled = true;
let recognition = null;
let currentBlinkingTab = null;
let nonUnderstoodCount = 0;
let currentUtterance = null;

const PHONE_NUMBER = "+33695468923";
const PHONE_DISPLAY = "06 95 46 89 23";

// GESTION M√âMOIRE 24H
const STORAGE_KEY = 'clairvoyance_chat_history';
const STORAGE_TIMESTAMP = 'clairvoyance_chat_timestamp';
const SESSION_KEY = 'clairvoyance_session_active';

// Sauvegarder conversation
function saveConversation() {
  const data = {
    messages: Array.from(document.getElementById('chat-messages').children).map(p => ({
      text: p.textContent,
      isBot: p.className === 'bot-message'
    })),
    userName,
    userNameConfirmed,
    messageCount
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  localStorage.setItem(STORAGE_TIMESTAMP, Date.now().toString());
  localStorage.setItem(SESSION_KEY, 'true');
}

// Charger conversation si < 24h ET session active
function loadConversation() {
  const timestamp = localStorage.getItem(STORAGE_TIMESTAMP);
  const sessionActive = localStorage.getItem(SESSION_KEY);
  
  if (!timestamp || !sessionActive) return false;
  
  const age = Date.now() - parseInt(timestamp);
  const twentyFourHours = 24 * 60 * 60 * 1000;
  
  // Si > 24h OU session ferm√©e ‚Üí reset
  if (age > twentyFourHours || sessionActive !== 'true') {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STORAGE_TIMESTAMP);
    localStorage.removeItem(SESSION_KEY);
    return false;
  }
  
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
  if (!data) return false;
  
  // Restaurer conversation
  const messagesDiv = document.getElementById('chat-messages');
  messagesDiv.innerHTML = '';
  data.messages.forEach(msg => {
    const p = document.createElement('p');
    p.className = msg.isBot ? 'bot-message' : 'user-message';
    p.textContent = msg.text;
    messagesDiv.appendChild(p);
  });
  
  userName = data.userName || '';
  userNameConfirmed = data.userNameConfirmed || false;
  messageCount = data.messageCount || 0;
  
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  return true;
}

// D√©tecter sortie du site (fermeture onglet/navigation)
window.addEventListener('beforeunload', () => {
  localStorage.setItem(SESSION_KEY, 'false');
});

// Au chargement : restaurer si possible
const conversationRestored = loadConversation();

// LISTE DES URLs DES ONGLETS (pour filtrer)
const TAB_URLS = [
  'https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/',
  'https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp',
  'https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp',
  'https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp',
  'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp',
  'https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp',
  'https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp',
  'https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp',
  'https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp'
];

// DRAG AND DROP FLUIDE - NE PAS BLOQUER LE CLIC
let isDragging = false;
let hasMoved = false;
let startX, startY, offsetX = 0, offsetY = 0;
const floatingTab = document.getElementById('floating-tab');

floatingTab.addEventListener('mousedown', dragStart);
floatingTab.addEventListener('touchstart', dragStart, {passive: false});

function dragStart(e) {
  if (e.target.classList.contains('close-btn')) {
    e.preventDefault();
    e.stopPropagation();
    floatingTab.classList.remove('show');
    return;
  }
  
  isDragging = true;
  hasMoved = false;
  const touch = e.type === 'touchstart' ? e.touches[0] : e;
  startX = touch.clientX - offsetX;
  startY = touch.clientY - offsetY;
  
  floatingTab.style.transition = 'none';
}

document.addEventListener('mousemove', drag);
document.addEventListener('touchmove', drag, {passive: false});

function drag(e) {
  if (!isDragging) return;
  
  const touch = e.type === 'touchmove' ? e.touches[0] : e;
  const moveX = touch.clientX - startX;
  const moveY = touch.clientY - startY;
  
  // Si mouvement > 5px, consid√©rer comme drag (pas clic)
  if (Math.abs(moveX - offsetX) > 5 || Math.abs(moveY - offsetY) > 5) {
    hasMoved = true;
    e.preventDefault();
  }
  
  offsetX = moveX;
  offsetY = moveY;
  
  floatingTab.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
}

document.addEventListener('mouseup', dragEnd);
document.addEventListener('touchend', dragEnd);

function dragEnd(e) {
  if (isDragging) {
    isDragging = false;
    floatingTab.style.transition = 'box-shadow 0.3s ease';
    
    // Si pas de mouvement significatif, laisser le clic se propager
    if (!hasMoved) {
      // Le href natif fonctionnera
      return;
    } else {
      // Bloquer le clic si c'√©tait un drag
      e.preventDefault();
    }
  }
}

// Variables globales pour l'analyse audio
let audioContext = null;
let analyser = null;
let animationFrameId = null;

// VOIX HOMME GRAVE AVEC ANIMATION VIOLET R√âACTIVE √Ä L'INTENSIT√â
function speak(text) {
  if (!voiceEnabled || !('speechSynthesis' in window)) return;
  
  let textToSpeak = text.replace(/https?:\/\/[^\s]+/g, '');
  
  window.speechSynthesis.cancel();
  
  const utterance = new SpeechSynthesisUtterance(textToSpeak);
  utterance.lang = 'fr-FR';
  
  const voices = window.speechSynthesis.getVoices();
  const maleVoice = voices.find(v => 
    v.lang.startsWith('fr') && (
      v.name.toLowerCase().includes('thomas') ||
      v.name.toLowerCase().includes('daniel') ||
      v.name.toLowerCase().includes('male')
    )
  );
  
  if (maleVoice) utterance.voice = maleVoice;
  
  utterance.pitch = 0.4;
  utterance.rate = 1.2;
  utterance.volume = 1.0;
  
  const chatBox = document.getElementById('chat-box');
  
  // Initialiser le contexte audio pour l'analyse
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
  }
  
  // Fonction d'animation bas√©e sur le volume
  function animateViolet() {
    if (!analyser) return;
    
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(dataArray);
    
    // Calculer le volume moyen
    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
    
    // Normaliser entre 0 et 1
    const intensity = Math.min(average / 128, 1);
    
    // Appliquer le violet avec intensit√© variable
    if (intensity > 0.05) {
      const baseGlow = 20 + (intensity * 40); // 20-60px
      const strongGlow = 35 + (intensity * 60); // 35-95px
      const opacity = 0.6 + (intensity * 0.4); // 0.6-1.0
      
      chatBox.style.borderColor = `rgba(186, 85, 211, ${opacity})`;
      chatBox.style.boxShadow = `
        0 0 ${baseGlow}px rgba(186, 85, 211, ${opacity}),
        0 0 ${strongGlow}px rgba(186, 85, 211, ${opacity * 0.7})
      `;
    }
    
    animationFrameId = requestAnimationFrame(animateViolet);
  }
  
  // D√©but de la parole ‚Üí Animation VIOLET
  utterance.onstart = () => {
    // Note: L'analyse audio avec SpeechSynthesis est complexe car on ne peut pas 
    // facilement capturer le flux audio. On utilise une approximation visuelle.
    animateViolet();
  };
  
  // Fin de la parole ‚Üí Retour ORANGE
  utterance.onend = () => {
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }
    chatBox.style.borderColor = '';
    chatBox.style.boxShadow = '';
  };
  
  // Erreur ‚Üí Retour ORANGE
  utterance.onerror = () => {
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }
    chatBox.style.borderColor = '';
    chatBox.style.boxShadow = '';
  };
  
  currentUtterance = utterance;
  window.speechSynthesis.speak(utterance);
  
  // Fallback: animation simul√©e bas√©e sur le texte
  simulateSpeechIntensity(textToSpeak.length);
}

// Simulation d'intensit√© bas√©e sur la longueur du texte
function simulateSpeechIntensity(textLength) {
  const chatBox = document.getElementById('chat-box');
  const duration = (textLength * 50); // ~50ms par caract√®re
  let startTime = Date.now();
  
  function animate() {
    if (!window.speechSynthesis.speaking) {
      chatBox.style.borderColor = '';
      chatBox.style.boxShadow = '';
      return;
    }
    
    const elapsed = Date.now() - startTime;
    const progress = elapsed / duration;
    
    // Simulation de variation d'intensit√© (sinuso√Ødale)
    const wave = Math.sin(progress * Math.PI * 8) * 0.5 + 0.5;
    const randomVariation = Math.random() * 0.3;
    const intensity = 0.4 + (wave * 0.4) + randomVariation;
    
    const baseGlow = 20 + (intensity * 40);
    const strongGlow = 35 + (intensity * 60);
    const opacity = 0.6 + (intensity * 0.4);
    
    chatBox.style.borderColor = `rgba(186, 85, 211, ${opacity})`;
    chatBox.style.boxShadow = `
      0 0 ${baseGlow}px rgba(186, 85, 211, ${opacity}),
      0 0 ${strongGlow}px rgba(186, 85, 211, ${opacity * 0.7})
    `;
    
    animationFrameId = requestAnimationFrame(animate);
  }
  
  animate();
}

if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = () => {
    window.speechSynthesis.getVoices();
  };
}

// RECONNAISSANCE VOCALE
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('chat-input').value = transcript;
    handleMessage();
  };
}

document.getElementById('voice-toggle').addEventListener('click', () => {
  voiceEnabled = !voiceEnabled;
  document.getElementById('voice-toggle').classList.toggle('disabled', !voiceEnabled);
  if (voiceEnabled && recognition) {
    try { recognition.start(); } catch(e) {}
  } else {
    if (recognition) recognition.stop();
    if (currentUtterance) window.speechSynthesis.cancel();
    // Arr√™ter l'animation et restaurer le style
    if (animationFrameId) {
      cancelAnimationFrame(animationFrameId);
      animationFrameId = null;
    }
    const chatBox = document.getElementById('chat-box');
    chatBox.style.borderColor = '';
    chatBox.style.boxShadow = '';
  }
});

function addMessage(text, isBot = false) {
  const messagesDiv = document.getElementById('chat-messages');
  const messageDiv = document.createElement('p');
  messageDiv.className = isBot ? 'bot-message' : 'user-message';
  messageDiv.textContent = text;
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  if (isBot && voiceEnabled) speak(text);
  
  // Sauvegarder apr√®s chaque message
  saveConversation();
}

// CLIGNOTER ONGLETS - PAS DE CONFUSION
function blinkTab(exactMatch) {
  if (currentBlinkingTab) {
    currentBlinkingTab.classList.remove('blink');
  }
  
  const navLinks = document.querySelectorAll('nav ul li a');
  navLinks.forEach(link => {
    const linkExact = link.getAttribute('data-exact');
    if (linkExact && linkExact.toLowerCase() === exactMatch.toLowerCase()) {
      link.classList.add('blink');
      currentBlinkingTab = link;
      link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      trackClick('TabBlinked_' + exactMatch.replace(/\s+/g, '_'), 'ChatInteraction', 0);
    }
  });
}

// ONGLET FLOTTANT CLIQUABLE - CORRECTION HREF
function showFloatingTab(url, isPhoneNumber = false) {
  const floatingText = document.getElementById('floating-text');
  
  if (isPhoneNumber) {
    floatingTab.href = `tel:${url}`;
    floatingText.textContent = `0695468923 ‚Ä¢ 24h/7j`;
  } else {
    floatingTab.href = url;
    floatingText.textContent = `Ce qu'il vous faut ${userName} !`;
  }
  
  floatingTab.classList.add('show');
  
  // IMPORTANT : Supprimer onclick qui bloque le href
  floatingTab.onclick = null;
  
  trackClick('FloatingTabDisplayed', 'Interaction', 0);
}

// BASE DE CONNAISSANCES - AJOUT FACILE
const knowledgeBase = [
    // ==========================================
    // 9 ONGLETS STICKY - PRIORIT√â MAXIMALE
    // ==========================================
    
    { 
      keywords: "purification|d√©senvo√ªtement|protection|nettoyage √©nerg√©tique|purifier|d√©senvoutement|desenvoutement|purif", 
      exactMatch: "purification", 
      answer: (name) => `${name}, je ressens dans votre recherche une lourdeur qui vous p√®se. Cette fatigue inexpliqu√©e, ces cauchemars r√©currents, cette sensation d'√™tre drain√© de votre √©nergie - ce ne sont pas des co√Øncidences. Laissez-moi vous expliquer ce qui se passe vraiment.

Vous vivez peut-√™tre sous l'influence d'√©nergies n√©gatives ou d'une attaque occulte. Votre corps et votre esprit vous envoient des signaux d'alarme que vous ne pouvez plus ignorer. Chaque jour d'attente permet √† ces √©nergies de s'enraciner plus profond√©ment dans votre champ √©nerg√©tique.

Je vous conseille vivement d'opter pour une purification √©nerg√©tique compl√®te d√®s maintenant. Frederick a d√©velopp√© une expertise unique en 25 ans pour identifier et neutraliser ces attaques invisibles. Voici ce qui va concr√®tement changer dans votre vie, ${name} :

**Les transformations que vous allez vivre :**
‚úì D√®s 48-72h : sensation de l√©g√®ret√© retrouv√©e, comme si un poids invisible disparaissait
‚úì Premi√®re semaine : votre √©nergie vitale revient progressivement, vous vous r√©veillez enfin repos√©
‚úì Vos cauchemars cessent et vos nuits redeviennent paisibles et r√©paratrices
‚úì Cette malchance chronique qui vous poursuivait commence √† se dissiper
‚úì Votre clart√© mentale revient - vous pouvez enfin penser clairement
‚úì Plus de 2800 purifications r√©alis√©es avec 96% de succ√®s mesurable

Le meilleur conseil que je puisse vous donner, ${name} : n'attendez pas que la situation empire. Frederick a constat√© que les personnes qui agissent rapidement se r√©tablissent en quelques jours, tandis que celles qui attendent peuvent mettre des semaines. Chaque jour compte. Un onglet s'illumine en haut de la page - c'est votre premier pas vers la lib√©ration que vous m√©ritez.`, 
      url: 'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp', 
      isExternal: false 
    },
    
    { 
      keywords: "voyance t√©l√©phone|consultation t√©l√©phonique|appel voyant|parler voyance|t√©l√©phone voyant|voyance par tel|voyance tel", 
      exactMatch: "voyance t√©l√©phone", 
      answer: (name) => `${name}, vous cherchez √† parler directement avec un voyant authentique, et c'est une excellente d√©cision. La voix porte une √©nergie que l'√©crit ne peut pas transmettre. Permettez-moi de vous expliquer pourquoi la consultation t√©l√©phonique avec Frederick peut vraiment transformer votre situation.

Vous √™tes face √† des questions br√ªlantes qui ne peuvent pas attendre. Peut-√™tre un choix crucial √† faire, une relation qui vous tourmente, une d√©cision professionnelle urgente. Vous avez besoin de r√©ponses claires MAINTENANT, pas dans plusieurs jours.

Je vous recommande vivement la voyance par t√©l√©phone avec Frederick. √âcoutez bien pourquoi c'est la solution id√©ale pour vous, ${name}, et ce que vous allez concr√®tement obtenir :

**Les avantages imm√©diats de la consultation t√©l√©phonique :**
‚úì Connexion √©nerg√©tique directe - Frederick capte votre √©nergie d√®s les 30 premi√®res secondes
‚úì R√©ponses instantan√©es √† vos questions sans attendre des heures ou des jours
‚úì Vous pouvez poser des questions de suivi naturellement pendant l'√©change
‚úì Le ton de sa voix vous rassure - vous sentez imm√©diatement son authenticit√©
‚úì Plusieurs dur√©es disponibles (5, 10, 20, 30, 45 minutes) selon vos besoins et votre budget
‚úì Plus de 1500 consultations t√©l√©phoniques avec 96% de satisfaction client

Le meilleur pour vous serait de choisir la dur√©e selon la complexit√© de votre situation, ${name}. Une question urgente ? 5-10 minutes suffisent. Vie compliqu√©e avec plusieurs aspects ? 30-45 minutes vous offrent l'espace n√©cessaire. Frederick ne remplit jamais artificiellement - il va droit √† l'essentiel. Un onglet s'illumine en haut de la page. Le num√©ro appara√Æt √† votre droite pour que vous puissiez l'appeler directement et obtenir enfin les r√©ponses qui vous lib√©reront de cette incertitude.`, 
      url: 'https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/', 
      isExternal: false,
      showPhoneButton: true
    },
    
    { 
      keywords: "voyance email|consultation email|voyance par mail|email voyant|mail voyance|voyance √©crite|consultation √©crite", 
      exactMatch: "voyance email", 
      answer: (name) => `${name}, vous pr√©f√©rez l'√©crit au vocal - c'est un choix tr√®s intelligent pour plusieurs raisons. L'email vous offre quelque chose d'unique : une trace permanente des r√©ponses que vous pourrez relire autant de fois que n√©cessaire. Laissez-moi vous guider.

Peut-√™tre n'√™tes-vous pas √† l'aise au t√©l√©phone, ou vous voulez pouvoir m√©diter sur les r√©ponses tranquillement, ou vous souhaitez partager cette consultation avec un proche de confiance. Peut-√™tre voulez-vous simplement garder cette preuve √©crite pour v√©rifier les pr√©dictions au fil du temps.

Je vous conseille absolument la consultation par email avec Frederick. Voici ce que cette approche va vous apporter de concret et pourquoi c'est parfait pour vous, ${name} :

**Les b√©n√©fices exclusifs de la voyance √©crite :**
‚úì R√©ponse sous 4h maximum (souvent 2h) - Frederick traite les emails en priorit√©
‚úì Vous relisez quand vous voulez : √† 3h du matin si l'anxi√©t√© vous r√©veille, avant une d√©cision importante
‚úì R√©ponses d√©taill√©es et structur√©es - Frederick prend le temps d'expliquer le POURQUOI
‚úì Vous gardez cette trace pour toujours dans votre bo√Æte email
‚úì Vous pouvez partager avec vos proches pour avoir leur avis sur les r√©ponses
‚úì Aucun stress t√©l√©phonique - vous formulez vos questions calmement, √† t√™te repos√©e
‚úì Plus de 2200 consultations email avec 95% de satisfaction mesur√©e

Le meilleur conseil que je puisse vous donner, ${name} : formulez vos questions avec pr√©cision. Plus vous √™tes clair, plus Frederick peut √™tre pr√©cis dans ses r√©ponses. Choisissez entre 1 question (pour tester) ou 3 questions (pour une vue d'ensemble compl√®te). Un onglet s'illumine en haut de la page pour cette consultation pos√©e et r√©fl√©chie qui vous donnera les r√©ponses √©crites dont vous avez tant besoin.`, 
      url: 'https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp', 
      isExternal: false 
    },
    
    { 
      keywords: "retour ex|reconqu√©rir ex|r√©cup√©rer ex|amour perdu|ex revienne|ramener ex|retour affectif|rituel retour|magie blanche amour", 
      exactMatch: "retour ex", 
      answer: (name) => `${name}, je ressens une immense douleur dans votre recherche. Cette personne vous manque tellement que vous ne fonctionnez plus normalement. Chaque nuit sans elle ou sans lui est un supplice, chaque jour une √©preuve. Cette souffrance qui vous d√©chire le c≈ìur est r√©elle et insupportable. Laissez-moi vous aider vraiment.

Vous avez peut-√™tre tout essay√©, ${name}. Les messages rest√©s sans r√©ponse. Les appels ignor√©s. Les conseils des amis qui ne servent √† rien. Vous √™tes au bord du d√©sespoir et vous vous demandez s'il existe encore une chance. La r√©ponse est OUI - mais il faut agir intelligemment et rapidement.

Je vous conseille vivement d'explorer le rituel de retour affectif en magie blanche de Frederick. Voici pourquoi c'est votre meilleure option et ce qui va concr√®tement se passer :

**Les transformations que vous allez vivre semaine apr√®s semaine :**
‚úì Le rituel agit en 2 √† 4 semaines g√©n√©ralement selon la complexit√© de votre situation
‚úì Premiers signes en 7-10 jours : votre ex pense √† vous intens√©ment sans comprendre pourquoi
‚úì Il ou elle commence √† vous contacter "par hasard" - un message, un appel, une r√©action sur les r√©seaux
‚úì Les obstacles entre vous se dissolvent myst√©rieusement - la nouvelle relation s'effrite, les ranc≈ìurs s'apaisent
‚úì Les chemins se rouvrent naturellement vers une r√©conciliation possible
‚úì 87% de retours r√©ussis sur plus de 500 couples r√©concili√©s - ces chiffres parlent d'eux-m√™mes

Le meilleur pour vous serait de comprendre, ${name}, que la magie BLANCHE respecte le libre arbitre. Si l'amour √©tait r√©el entre vous, votre ex reviendra naturellement. Si c'√©tait superficiel, le rituel ne forcera rien - c'est honn√™te et √©thique. N'attendez pas qu'il ou elle rencontre quelqu'un d'autre ou que les √©nergies se figent dans la s√©paration. Un onglet s'illumine en haut de la page pour d√©clencher ce retour avant qu'il ne soit vraiment trop tard.`, 
      url: 'https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp', 
      isExternal: false 
    },
    
    { 
      keywords: "compatibilit√©|compatible couple|affinit√© amoureuse|sommes nous faits|√¢mes s≈ìurs|destin√©s ensemble|entente couple|harmonie relation", 
      exactMatch: "compatibilit√©", 
      answer: (name) => `${name}, cette question vous hante : "Sommes-nous vraiment faits l'un pour l'autre ?" Vous avez des doutes qui grandissent, des signaux contradictoires qui vous perturbent. Parfois c'est merveilleux, parfois c'est l'enfer. Vous ne savez plus si c'est de l'amour v√©ritable ou une illusion confortable qui s'effondrera t√¥t ou tard. Je vais vous aider √† obtenir une r√©ponse claire et honn√™te.

Peut-√™tre investissez-vous du temps et de l'√©nergie dans une relation qui n'a pas d'avenir √† long terme. Ou au contraire, peut-√™tre doutez-vous d'une relation magnifique par peur, ${name}. Cette incertitude vous emp√™che de vous engager pleinement ou de partir sereinement.

Je vous recommande absolument une analyse de compatibilit√© compl√®te avec Frederick. Voici ce que cette consultation va vous r√©v√©ler et comment elle va transformer votre situation :

**La v√©rit√© sur votre relation que vous allez enfin d√©couvrir :**
‚úì Frederick analyse vos deux th√®mes astraux complets - pas juste vos signes solaires
‚úì Il compare vos √©nergies profondes, vos √¢mes, vos destin√©es karmiques
‚úì Vous saurez si vous √™tes VRAIMENT compatibles pour construire ensemble
‚úì Il identifie vos forces de couple (√† cultiver) ET vos faiblesses (√† surveiller)
‚úì Il r√©v√®le si cette relation vous √©l√®ve vers votre meilleur vous-m√™me ou vous d√©truit lentement
‚úì Vous obtenez une r√©ponse CERTAINE - pas un "peut-√™tre" frustrant qui vous laisse dans le doute

Le meilleur conseil que je puisse vous donner, ${name} : la v√©rit√© peut rassurer magnifiquement ou alerter douloureusement. Parfois Frederick dit "Oui, vous √™tes faits l'un pour l'autre" - soulagement immense. Parfois "Non, cette relation est toxique pour vous" - douleur n√©cessaire mais lib√©ratrice. Dans les deux cas, vous SAVEZ enfin et vous pouvez agir en cons√©quence. Combien de gens g√¢chent 10, 20 ans avec la mauvaise personne ? Ne faites pas cette erreur. Un onglet s'illumine en haut de la page pour cette v√©rit√© qui va tout clarifier.`, 
      url: 'https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp', 
      isExternal: false 
    },
    
    { 
      keywords: "d√©funt|mort|d√©c√©d√©|au-del√†|communication d√©funt|message mort|spiritisme|m√©dium d√©funt|parler mort|contact d√©funt", 
      exactMatch: "d√©funt", 
      answer: (name) => `${name}, je ressens votre immense douleur de deuil √† travers votre recherche. Perdre quelqu'un qu'on aime cr√©e un vide qui semble impossible √† combler. Cette personne vous manque terriblement et il y a tant de choses non dites, tant de questions sans r√©ponse. Laissez-moi vous aider √† trouver la paix dont vous avez d√©sesp√©r√©ment besoin.

Votre d√©funt a des messages pour vous - des choses qu'il ou elle n'a pas pu dire avant de partir. Des pardons √† demander. Des regrets √† exprimer. Des r√©v√©lations importantes. Des "je t'aime" qui sont rest√©s coinc√©s. Ces mots attendent d'√™tre transmis et vous avez besoin de les entendre pour enfin respirer, ${name}.

Je vous conseille vivement d'√©tablir cette communication avec l'au-del√† √† travers Frederick. Voici ce que cette connexion va transformer en vous et pourquoi c'est essentiel pour votre gu√©rison :

**La gu√©rison profonde que vous allez exp√©rimenter :**
‚úì Vous recevez enfin les mots que vous attendiez d√©sesp√©r√©ment depuis son d√©part
‚úì Vous comprenez que la mort n'est qu'un passage, pas une fin - il ou elle existe toujours
‚úì Votre deuil se transforme radicalement : de la douleur paralysante √† une paix sereine
‚úì Vous cessez de vous torturer avec les "si j'avais su..." ou "j'aurais d√ª lui dire..."
‚úì Vous obtenez des r√©ponses aux questions qui vous hantent et vous emp√™chent d'avancer
‚úì Vous recevez sa permission de continuer √† vivre pleinement - c'est ce qu'il ou elle veut pour vous

Le meilleur pour vous serait de ne pas porter ce fardeau toute votre vie, ${name}. Frederick sert de pont authentique entre ce monde et l'autre depuis 25 ans. Il ne devine pas - il RE√áOIT vraiment. Les morts parlent quand on sait les √©couter. Ne laissez pas ce message non d√©livr√© vous hanter √©ternellement. Un onglet s'illumine en haut de la page pour cette communication qui va apaiser votre c≈ìur bris√© et vous permettre enfin de tourner la page avec amour.`, 
      url: 'https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp', 
      isExternal: false 
    },
    
    { 
      keywords: "sant√©|maladie|douleur|sympt√¥me|mal|souffrance physique|probl√®me sant√©|corps|m√©decine naturelle|gu√©rison", 
      exactMatch: "sant√©", 
      answer: (name) => `${name}, ces douleurs vous √©puisent jour apr√®s jour et personne ne semble vraiment vous comprendre. Les m√©decins ont fait des examens, tout semble "normal", mais VOUS, vous souffrez r√©ellement. Cette invalidation de votre douleur ajoute √† votre d√©tresse. Laissez-moi vous expliquer ce qui se passe vraiment et comment Frederick peut enfin vous aider.

Vous avez consult√© des sp√©cialistes, ${name}. Fait des analyses. Des scanners. Des IRM peut-√™tre. Les r√©sultats sont normaux ou peu concluants. On vous dit "c'est le stress" ou "c'est psychosomatique". Mais vous savez au fond de vous que c'est plus que √ßa. Quelque chose cloche vraiment et personne ne trouve quoi.

Je vous conseille absolument d'explorer l'approche √©nerg√©tique et holistique de Frederick. Voici ce qu'il va identifier et comment cela va transformer votre situation :

**Ce que la m√©decine conventionnelle ne voit pas et que Frederick d√©tecte :**
‚úì Les blocages √©nerg√©tiques au niveau de vos organes qui cr√©ent des douleurs physiques r√©elles
‚úì Les traumatismes √©motionnels stock√©s dans votre corps depuis des ann√©es
‚úì Les attaques √©nerg√©tiques ext√©rieures qui se manifestent en sympt√¥mes physiques
‚úì Les m√©moires cellulaires douloureuses qui cr√©ent des maladies r√©currentes
‚úì Frederick combine voyance ET m√©decine naturelle depuis 25 ans - approche unique
‚úì Plus de 1200 personnes soulag√©es durablement apr√®s que la m√©decine ait √©chou√©

Le meilleur conseil que je puisse vous donner, ${name} : Frederick ne remplace pas votre m√©decin, il le COMPL√àTE. Continuez votre suivi m√©dical mais ajoutez cette dimension √©nerg√©tique que la m√©decine ignore compl√®tement. Tant de gens souffrent inutilement parce qu'ils ne traitent que le corps physique en oubliant le corps √©nerg√©tique. Un onglet s'illumine en haut de la page pour enfin trouver la vraie cause de vos maux et le soulagement que vous m√©ritez.`, 
      url: 'https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp', 
      isExternal: false 
    },
    
    { 
      keywords: "main|ligne main|chiromancie|paume|ligne vie|ligne c≈ìur|ligne chance|palmistry|lire main", 
      exactMatch: "main", 
      answer: (name) => `${name}, vos mains racontent toute votre histoire depuis votre naissance. Chaque ligne, chaque sillon, chaque marque a une signification profonde que vous ne soup√ßonnez pas. Ces lignes ne sont pas al√©atoires - elles r√©v√®lent votre destin√©e √©crite dans votre chair m√™me. Laissez-moi vous expliquer.

Vous regardez vos mains parfois et vous vous demandez ce que ces lignes signifient vraiment. Votre ligne de vie semble courte ? Votre ligne de c≈ìur est cass√©e ? Votre ligne de chance est absente ? Chacune de ces observations vous inqui√®te mais personne ne peut vous dire ce qu'elles r√©v√®lent vraiment, ${name}.

Je vous recommande vivement une lecture compl√®te de vos mains par Frederick, expert en chiromancie depuis 25 ans. Voici ce qu'il va d√©coder et les r√©v√©lations que vous allez recevoir :

**Ce que vos mains r√©v√®lent sur votre destin√©e compl√®te :**
‚úì Votre ligne de vie : pas votre dur√©e de vie (contrairement √† la croyance) mais votre vitalit√©, votre √©nergie vitale, les √©v√©nements sant√© majeurs
‚úì Votre ligne de c≈ìur : vos histoires d'amour pass√©es ET futures, vos capacit√©s √©motionnelles, les blessures sentimentales
‚úì Votre ligne de t√™te : votre intelligence pratique, vos talents naturels, votre destin√©e professionnelle
‚úì Votre ligne de chance : votre potentiel de r√©ussite, d'argent, les p√©riodes fastes qui vous attendent
‚úì Les signes particuliers (√©toiles, croix, triangles) : √©v√©nements sp√©cifiques, talents cach√©s, dangers
‚úì Tout est inscrit depuis votre naissance - Frederick lit ce que vous ne voyez pas

Le meilleur pour vous serait de comprendre, ${name}, que vos mains √©voluent avec votre vie. Les lignes se modifient selon vos choix et votre √©volution. Frederick ne lit pas juste m√©caniquement - il VOIT votre √©nergie √† travers vos paumes. Un onglet s'illumine en haut de la page pour d√©couvrir ce que vos mains r√©v√®lent sur qui vous √™tes vraiment et ce qui vous attend.`, 
      url: 'https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp', 
      isExternal: false 
    },
    
    { 
      keywords: "ange gardien|archange|guide spirituel|ange protecteur|message ange|protection divine|guidance c√©leste|ange personnel", 
      exactMatch: "ange", 
      answer: (name) => `${name}, votre ange gardien vous parle chaque jour mais vous ne l'entendez pas. Il vous envoie des signes que vous ne voyez pas. Il essaie d√©sesp√©r√©ment de vous guider mais vous √™tes trop plong√© dans le monde mat√©riel pour capter ses messages subtils. Frederick peut servir de canal pour enfin entendre ce que votre ange essaie de vous dire depuis si longtemps. Laissez-moi vous expliquer.

Vous avez peut-√™tre l'impression d'√™tre seul face √† vos difficult√©s, ${name}. Perdu dans les d√©cisions importantes. Sans guidance claire sur votre chemin de vie. Mais vous n'√™tes JAMAIS seul - votre ange gardien est l√†, constamment √† vos c√¥t√©s, attendant patiemment que vous l'√©coutiez enfin.

Je vous conseille vivement de recevoir le message de votre ange gardien √† travers Frederick. Voici ce que cette connexion divine va transformer dans votre vie et pourquoi c'est essentiel maintenant :

**Ce que votre ange essaie de vous dire depuis longtemps :**
‚úì Sa pr√©sence constante et aimante √† vos c√¥t√©s - vous n'avez jamais √©t√© abandonn√©
‚úì Les messages pr√©cis qu'il essaie de vous transmettre sur vos d√©cisions actuelles
‚úì Les signes qu'il vous envoie (que vous ratez) : nombres r√©p√©titifs, co√Øncidences, intuitions
‚úì La guidance claire pour votre chemin de vie - votre mission d'√¢me r√©v√©l√©e
‚úì La protection qu'il vous offre contre les dangers que vous ne voyez pas venir
‚úì Comment √©tablir une communication directe avec lui d√©sormais (sans passer par Frederick)

Le meilleur conseil que je puisse vous donner, ${name} : une fois que vous connaissez le message de votre ange, votre vie change radicalement. Vous ne vous sentez plus jamais seul. Vous avez une guidance c√©leste constante. Les d√©cisions deviennent plus faciles car vous savez qu'il vous guide. Un onglet s'illumine en haut de la page pour cette connexion divine qui va illuminer votre chemin et vous apporter la paix int√©rieure dont vous avez tant besoin.`, 
      url: 'https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp', 
      isExternal: false 
    }
];
    
function removeAccents(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function levenshteinDistance(a, b) {
    const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
    for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
    for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
    for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
            const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + indicator);
        }
    }
    return matrix[b.length][a.length];
}

function phoneticNormalize(str) {
    return removeAccents(str)
        .replace(/ph/g, "f")
        .replace(/k/g, "c")
        .replace(/qu/g, "k")
        .replace(/ss/g, "s")
        .replace(/√©e/g, "e")
        .replace(/ai/g, "e")
        .replace(/au/g, "o")
        .replace(/ou/g, "u")
        .replace(/oi/g, "oa")
        .replace(/y/g, "i")
        .replace(/w/g, "v")
        .replace(/x/g, "ks")
        .replace(/z/g, "s")
        .replace(/j/g, "g")
        .replace(/ch/g, "sh");
}

function findBestMatch(userInput) {
    const userLower = phoneticNormalize(userInput.toLowerCase());
    const userWords = userLower.split(/\s+/);
    let bestMatch = null;
    let maxScore = 0;
    
    // MOTS EXCLUSIFS pour √©viter confusion
    const hasEmail = /\b(email|mail|√©crit|courriel|mel)\b/i.test(userInput);
    const hasTelephone = /\b(t√©l√©phone|tel|appel|appeler|telephoner|phone|fon)\b/i.test(userInput);
    
    knowledgeBase.forEach(item => {
        let score = 0;
        const keywords = item.keywords.split('|');
        
        // EXCLUSION : si email mentionn√©, ne PAS matcher t√©l√©phone
        if (hasEmail && item.exactMatch === 'voyance t√©l√©phone') return;
        if (hasTelephone && item.exactMatch === 'voyance email') return;
        
        keywords.forEach(keyword => {
            const normalizedKeyword = phoneticNormalize(keyword.trim().toLowerCase());
            
            if (userLower.includes(normalizedKeyword)) {
                score += normalizedKeyword.length * 10;
            }
            
            userWords.forEach(userWord => {
                // ACCEPTER MOTS DE 1 LETTRE (au lieu de 2)
                if (userWord.length >= 1) {
                    const distance = levenshteinDistance(userWord, normalizedKeyword);
                    const similarity = 1 - distance / Math.max(userWord.length, normalizedKeyword.length);
                    
                    // SEUIL ABAISS√â : 0.35 (65% d'erreur tol√©r√©)
                    if (similarity >= 0.35) {
                        score += similarity * normalizedKeyword.length * 5;
                    }
                }
            });
        });
        
        if (score > maxScore) {
            maxScore = score;
            bestMatch = item;
        }
    });
    
    return maxScore > 0.8 ? bestMatch : null;
}

function handleMessage() {
  const input = document.getElementById('chat-input');
  const userMsg = input.value.trim();
  
  if (!userMsg) return;
  
  addMessage(userMsg, false);
  input.value = '';
  messageCount++;
  
  setTimeout(() => {
    const lowerMsg = userMsg.toLowerCase().trim();
    
    // GESTION PR√âNOM
    if (!userNameConfirmed) {
      // Bonjour initial
      if (lowerMsg === "bonjour" || lowerMsg.startsWith("bonjour")) {
        addMessage("Bonjour ! Je suis ClairVoyanceGPT, votre assistant spirituel. Avant de commencer cette consultation, pouvez-vous m'indiquer votre pr√©nom ?", true);
        return;
      }
      
      // Confirmation pr√©nom en attente
      if (pendingName) {
        if (lowerMsg === "oui" || lowerMsg === "oui c'est √ßa" || lowerMsg === "oui c'est bien √ßa") {
          userName = pendingName;
          userNameConfirmed = true;
          pendingName = '';
          addMessage(`Parfait ${userName} ! Comment puis-je vous aider aujourd'hui ?`, true);
          return;
        } else if (lowerMsg === "non") {
          pendingName = '';
          addMessage("Alors donnez-moi votre pr√©nom s'il vous pla√Æt.", true);
          return;
        }
      }
      
      // Extraction pr√©nom
      const nameMatch = userMsg.match(/\b([A-Z√Ä-√ñ√ò-√ùa-z√†-√∂√∏-√ø]{2,})\b/);
      if (nameMatch) {
        pendingName = nameMatch[1].charAt(0).toUpperCase() + nameMatch[1].slice(1).toLowerCase();
        addMessage(`Tr√®s bien ${pendingName}, c'est bien votre pr√©nom ?`, true);
        return;
      }
      
      addMessage("Je n'ai pas bien saisi votre pr√©nom. Pouvez-vous me le donner clairement s'il vous pla√Æt ?", true);
      return;
    }
    
    // AU REVOIR
    const goodbyeTriggers = ["au revoir", "aurevoir", "√† bient√¥t", "bye", "ciao"];
    if (goodbyeTriggers.some(phrase => lowerMsg === phrase || lowerMsg.endsWith(phrase))) {
      addMessage(`${userName}, √† tr√®s bient√¥t ! Frederick et son √©quipe restent √† votre √©coute 24h/24.`, true);
      return;
    }
    
    // RECHERCHE DANS BASE
    const match = findBestMatch(userMsg);
    
    if (match) {
      const response = match.answer(userName);
      addMessage(response, true);
      
      blinkTab(match.exactMatch);
      
      // ONGLET FLOTTANT : uniquement liens HORS signets
      if (match.isPhone) {
        showFloatingTab(match.url, true);
      } else if (match.isExternal && !TAB_URLS.includes(match.url)) {
        showFloatingTab(match.url, false);
      }
      
      nonUnderstoodCount = 0;
    } else {
      nonUnderstoodCount++;
      
      if (nonUnderstoodCount === 1) {
        addMessage(`${userName}, je n'ai pas bien compris votre question. Pourriez-vous la reformuler ou v√©rifier l'orthographe s'il vous pla√Æt ?`, true);
      } else if (nonUnderstoodCount === 2) {
        addMessage(`${userName}, je ne comprends toujours pas. Essayez avec des mots simples : amour, voyance, protection, fatigue, d√©funt ?`, true);
      } else {
        addMessage(`${userName}, il semble difficile de nous comprendre. Peut-√™tre qu'un √©change direct serait plus efficace ? Frederick propose : t√©l√©phone (30‚Ç¨/30min), email (12‚Ç¨/3Q), ou rituel complet. Que pr√©f√©rez-vous ?`, true);
        nonUnderstoodCount = 0;
      }
    }
  }, 800);
}

document.getElementById('chat-send').addEventListener('click', (e) => {
  e.preventDefault();
  handleMessage();
});

document.getElementById('chat-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    handleMessage();
  }
});

document.getElementById('chat-form').addEventListener('submit', (e) => {
  e.preventDefault();
  handleMessage();
});

// Message d'accueil UNIQUEMENT si nouvelle conversation
if (!conversationRestored) {
  setTimeout(() => {
    const welcomeMessage = "Bienvenue sur ClairVoyanceGPT, l'assistant spirituel de Frederick, m√©dium reconnu depuis plus de 25 ans. Avant de commencer cet √©change, pouvez-vous m'indiquer dans un premier temps uniquement votre pr√©nom ?";
    addMessage(welcomeMessage, true);
    
    // Lecture vocale automatique avec fallback
    if (voiceEnabled && 'speechSynthesis' in window) {
      const tryAutoplay = () => {
        try {
          speak(welcomeMessage);
          trackClick('AutoplaySuccess', 'Voice', 0);
        } catch (err) {
          console.log('Autoplay bloqu√©, affichage bouton');
          showVoiceButton();
        }
      };
      
      // Tentative lecture imm√©diate
      if (document.readyState === 'complete') {
        tryAutoplay();
      } else {
        window.addEventListener('load', tryAutoplay);
      }
    }
  }, 500);
}

// Bouton fallback si autoplay bloqu√©
function showVoiceButton() {
  const messagesDiv = document.getElementById('chat-messages');
  const btnDiv = document.createElement('div');
  btnDiv.style.textAlign = 'center';
  btnDiv.style.margin = '1rem 0';
  btnDiv.innerHTML = `
    <button id="enable-voice-btn" style="
      padding:0.8rem 1.5rem;
      background:#000;
      color:#BBAE98;
      border:3px solid #FF8C00;
      font-family:'Cinzel',serif;
      font-size:1rem;
      cursor:pointer;
      animation:blinkVoiceBtn 1.5s ease-in-out infinite;
      border-radius:0;
    ">
      üé§ Activer l'assistant vocal
    </button>
    <style>
      @keyframes blinkVoiceBtn {
        0%, 100% { box-shadow: 0 0 10px #FF8C00; border-color: #FF8C00; }
        50% { box-shadow: 0 0 20px #FFA500; border-color: #FFA500; }
      }
    </style>
  `;
  messagesDiv.appendChild(btnDiv);
  
  document.getElementById('enable-voice-btn').addEventListener('click', () => {
    const welcomeMsg = "Bienvenue sur ClairVoyanceGPT, l'assistant spirituel de Frederick, m√©dium reconnu depuis plus de 25 ans. Avant de commencer cet √©change, pouvez-vous m'indiquer dans un premier temps uniquement votre pr√©nom ?";
    speak(welcomeMsg);
    btnDiv.remove();
    trackClick('VoiceButtonClicked', 'Engagement', 1);
  });
}

// BLOQUER PULL-TO-REFRESH (seulement en haut de page)
let lastTouchY = 0;
let preventPullToRefresh = false;

document.addEventListener('touchstart', (e) => {
  if (e.touches.length !== 1) return;
  lastTouchY = e.touches[0].clientY;
  preventPullToRefresh = window.pageYOffset === 0;
}, {passive: false});

document.addEventListener('touchmove', (e) => {
  const touchY = e.touches[0].clientY;
  const touchYDelta = touchY - lastTouchY;
  lastTouchY = touchY;
  
  if (preventPullToRefresh) {
    if (touchYDelta > 0) {
      e.preventDefault();
      return;
    }
    preventPullToRefresh = false;
  }
}, {passive: false});
</script>
</body>
</html>
