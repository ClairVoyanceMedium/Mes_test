<!-- Styles et structure HTML du chat -->
<style>
/* Styles g√©n√©raux du chat */
#chat-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 300px;
  max-height: 450px;
  display: flex;
  flex-direction: column;
  z-index: 999999;
  font-family: Arial, sans-serif;
  cursor: move;
  transition: transform 0.2s;
}
#chat-toggle {
  width: 60px;
  height: 60px;
  background: linear-gradient(145deg, #FFB6C1, #FF69B4);
  color: #fff;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(255,105,180,0.7);
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s;
  outline: none;
}
#chat-toggle:hover {
  transform: scale(1.05);
}
#chat-box {
  background: #111;
  border-radius: 10px;
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  margin-top: -10px;
  transition: all 0.3s ease;
}
#chat-messages {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  color: #fff;
}
#chat-messages p {
  margin-bottom: 0.5rem;
  line-height: 1.4;
  opacity: 0;
  animation: fadeIn 0.5s forwards;
}
@keyframes fadeIn {
  to { opacity: 1; }
}
.user-message {
  text-align: right;
  color: #ffd700;
  margin-bottom: 0.8rem;
}
.bot-message {
  text-align: left;
  color: #fff;
  background: rgba(255,255,255,0.05);
  padding: 0.5rem;
  border-radius: 5px;
  margin-bottom: 0.8rem;
  display: inline-block;
  max-width: 80%;
}
#chat-form {
  display: flex;
  border-top: 1px solid #333;
}
#chat-input {
  flex: 1;
  padding: 0.5rem;
  border: none;
  outline: none;
  color: #333;
  border-radius: 0 0 0 10px;
}
#chat-send {
  background: #87CEEB;
  border: none;
  padding: 0.5rem 1rem;
  cursor: pointer;
  color: #fff;
  font-weight: bold;
  border-radius: 0 0 10px 0;
  transition: background 0.2s;
}
#chat-send:hover {
  background: #5eb6d1;
}
#chat-box.hidden {
  display: none;
}
@media(max-width: 400px) {
  #chat-container {
    width: 90%;
    right: 5%;
    bottom: 5px;
  }
}
</style>

<div id="chat-container">
  <!-- Bouton de bascule du chat -->
  <button id="chat-toggle" aria-expanded="false" aria-label="Ouvrir le chat">üí¨</button>
  
  <!-- Bo√Æte de dialogue (initialement masqu√©e) -->
  <div id="chat-box" class="hidden" role="region" aria-label="Chat IA">
    <div id="chat-messages" aria-live="polite"></div>
    <form id="chat-form" aria-label="Formulaire de saisie pour le Tchat IA">
      <input type="text" id="chat-input" placeholder="Posez votre question..." aria-label="Tapez votre message ici" autocomplete="off">
      <button type="submit" id="chat-send" aria-label="Envoyer votre question">‚û§</button>
    </form>
  </div>
</div>

<!-- Script JavaScript pour le comportement du chat -->
<script>
// Fonction de tracking (impl√©mentation simplifi√©e)
function trackClick(label, category = 'Chat', value = null) {
  console.log("Tracking:", label, category, value);
}

// Base de connaissances sur les envo√ªtements et d√©tections
const knowledgeBase = [
  { question: "fatigue", answer: "Une fatigue incessante peut √™tre le signe d'un envo√ªtement. Pensez √† envisager un rituel de d√©senvo√ªtement pour purifier votre √©nergie." },
  { question: "cauchemars", answer: "Des cauchemars r√©currents peuvent √™tre dus √† une influence n√©gative. Un d√©senvo√ªtement pourrait ramener la paix dans vos nuits." },
  { question: "malchance", answer: "La malchance persistante est souvent li√©e √† des √©nergies n√©gatives. Une d√©tection (50‚Ç¨) ou un rituel de d√©senvo√ªtement (250‚Ç¨) pourrait clarifier votre situation." },
  { question: "tristesse", answer: "Une tristesse inexpliqu√©e peut √™tre li√©e √† des influences occultes. Un d√©senvo√ªtement pourrait restaurer votre joie de vivre." },
  { question: "col√®re", answer: "Une col√®re soudaine peut √™tre le signe d'une perturbation √©nerg√©tique. Un rituel de d√©senvo√ªtement pourrait apaiser ces √©nergies." },
  { question: "peur", answer: "Une peur irrationnelle peut provenir d'un envo√ªtement. Pensez √† une d√©tection ou √† un rituel de d√©senvo√ªtement pour vous lib√©rer de ces ombres." },
  // Vous pouvez enrichir cette base de connaissances avec d'autres entr√©es.
];

// Fonction calculant la distance de Levenshtein pour une correspondance approximative
function levenshtein(a, b) {
  const an = a ? a.length : 0, bn = b ? b.length : 0;
  if (!an) return bn;
  if (!bn) return an;
  let matrix = [];
  for (let i = 0; i <= bn; i++) {
    matrix[i] = [i];
  }
  for (let j = 0; j <= an; j++) {
    matrix[0][j] = j;
  }
  for (let i = 1; i <= bn; i++) {
    for (let j = 1; j <= an; j++) {
      const cost = b.charAt(i - 1) === a.charAt(j - 1) ? 0 : 1;
      matrix[i][j] = Math.min(matrix[i - 1][j] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j - 1] + cost);
    }
  }
  return matrix[bn][an];
}

// Recherche de la meilleure correspondance dans la base de connaissances
function findBestMatch(userInput) {
  userInput = userInput.toLowerCase();
  let bestScore = Infinity, bestAnswer = null;
  knowledgeBase.forEach(item => {
    const dist = levenshtein(userInput, item.question.toLowerCase());
    if (dist < bestScore) {
      bestScore = dist;
      bestAnswer = item.answer;
    }
  });
  return bestScore > 5 
    ? "Je ne comprends pas bien. Peut-√™tre ressentez-vous un malaise li√© √† un envo√ªtement ? Envisagez notre d√©tection (50‚Ç¨) ou un rituel de d√©senvo√ªtement (250‚Ç¨) pour clarifier votre situation." 
    : bestAnswer;
}

// Simuler une animation de saisie avant d'afficher la r√©ponse du bot
function simulateTyping(callback) {
  const typingMessage = document.createElement("p");
  typingMessage.className = "bot-message";
  typingMessage.textContent = "...";
  chatMessages.appendChild(typingMessage);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  setTimeout(() => {
    chatMessages.removeChild(typingMessage);
    callback();
  }, 800); // d√©lai de 800ms simulant la saisie
}

// Ajouter un message dans le chat
function addMessage(txt, cls) {
  const p = document.createElement("p");
  p.className = cls;
  p.textContent = txt;
  chatMessages.appendChild(p);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Mise en place de la d√©pla√ßabilit√© du conteneur de chat
let isDragging = false, currentX, currentY, initialX, initialY;
const chatContainer = document.getElementById("chat-container");

chatContainer.addEventListener("mousedown", startDragging);
chatContainer.addEventListener("touchstart", startDragging, { passive: false });

function startDragging(e) {
  isDragging = true;
  if (e.type === "mousedown") {
    initialX = e.clientX - (currentX || 0);
    initialY = e.clientY - (currentY || 0);
  } else if (e.type === "touchstart") {
    initialX = e.touches[0].clientX - (currentX || 0);
    initialY = e.touches[0].clientY - (currentY || 0);
  }
  document.addEventListener("mousemove", drag);
  document.addEventListener("touchmove", drag, { passive: false });
  document.addEventListener("mouseup", stopDragging);
  document.addEventListener("touchend", stopDragging);
}

function drag(e) {
  if (!isDragging) return;
  e.preventDefault();
  if (e.type === "mousemove") {
    currentX = e.clientX - initialX;
    currentY = e.clientY - initialY;
  } else if (e.type === "touchmove") {
    currentX = e.touches[0].clientX - initialX;
    currentY = e.touches[0].clientY - initialY;
  }
  chatContainer.style.right = "auto";
  chatContainer.style.bottom = "auto";
  chatContainer.style.left = `${currentX}px`;
  chatContainer.style.top = `${currentY}px`;
}

function stopDragging() {
  isDragging = false;
  document.removeEventListener("mousemove", drag);
  document.removeEventListener("touchmove", drag);
  document.removeEventListener("mouseup", stopDragging);
  document.removeEventListener("touchend", stopDragging);
}

// Initialisation de la position du chat
currentX = window.innerWidth - chatContainer.offsetWidth - 20;
currentY = window.innerHeight - chatContainer.offsetHeight - 20;
chatContainer.style.left = `${currentX}px`;
chatContainer.style.top = `${currentY}px`;

// Gestion de l'ouverture/fermeture du chat
const chatToggle = document.getElementById("chat-toggle");
const chatBox = document.getElementById("chat-box");
const chatMessages = document.getElementById("chat-messages");
const chatForm = document.getElementById("chat-form");
const chatInput = document.getElementById("chat-input");

chatToggle.addEventListener("click", () => {
  const isHidden = chatBox.classList.contains("hidden");
  chatBox.classList.toggle("hidden");
  chatToggle.setAttribute("aria-expanded", isHidden ? "true" : "false");
  if (isHidden) {
    trackClick("ChatOpen", "Interaction", 0);
    setTimeout(() => chatInput.focus(), 300);
  } else {
    trackClick("ChatClose", "Interaction", 0);
  }
});

// Gestion de l'envoi d'une question
chatForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const userMsg = chatInput.value.trim();
  if (!userMsg) return;
  addMessage(userMsg, "user-message");
  trackClick("ChatMessage", "Interaction", 0);
  chatInput.value = "";
  simulateTyping(() => {
    const answer = findBestMatch(userMsg);
    addMessage(answer, "bot-message");
  });
});
</script>
