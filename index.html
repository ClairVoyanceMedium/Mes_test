<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mailer GitHub‑only — Single‑File</title>
  <style>
    :root{--bg:#fff;--fg:#111;--muted:#666;--b:#e5e7eb;--pri:#111;--ok:#0a0;--err:#b00}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 10px}
    h2{font-size:18px;margin:16px 0 8px}
    fieldset{border:1px solid var(--b);border-radius:10px;margin:14px 0;padding:12px}
    legend{padding:0 6px}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input,textarea,select{width:100%;padding:9px 10px;border:1px solid #cbd5e1;border-radius:8px;font:inherit}
    textarea{min-height:130px}
    .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    .row3{display:grid;gap:12px;grid-template-columns:1fr 1fr 1fr}
    .muted{color:var(--muted);font-size:13px}
    .btn{background:var(--pri);color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#525252}
    .btn.small{padding:6px 10px;border-radius:8px;font-size:13px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid #cbd5e1;border-radius:999px;padding:6px 10px}
    .time{display:flex;gap:8px;align-items:center}
    .nowrap{white-space:nowrap}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    code{background:#f6f8fa;padding:2px 6px;border-radius:6px}
    .grid{display:grid;gap:8px}
    .divider{height:1px;background:#eee;margin:12px 0}
    .badge{display:inline-block;font-size:12px;border:1px solid #ddd;border-radius:999px;padding:2px 8px}
  </style>
</head>
<body>
  <h1>Mailer GitHub‑only — <span class="badge">1 fichier</span></h1>
  <p class="muted">UI statique hébergée sur GitHub Pages. Cette page <b>bootstrappe</b> automatiquement votre dépôt (workflow Actions + script d’envoi) et vous permet de <b>créer/planifier</b> des campagnes e‑mail. Les identifiants SMTP restent dans les <b>Secrets</b> du dépôt (jamais dans la page).</p>

  <fieldset>
    <legend>0) Connexion au dépôt</legend>
    <div class="row">
      <div>
        <label>Owner</label>
        <input id="owner" placeholder="ex: votre-pseudo" />
      </div>
      <div>
        <label>Repo</label>
        <input id="repo" placeholder="ex: mailer" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Branche</label>
        <input id="branch" value="main" />
      </div>
      <div>
        <label>Token personnel GitHub (PAT) — <span class="muted">scope: <code>contents:write</code> pour ce dépôt</span></label>
        <input id="pat" type="password" placeholder="ghp_…" />
      </div>
    </div>
    <button id="saveConn" class="btn secondary">Enregistrer localement</button>
    <span id="connStatus" class="muted"></span>
    <div class="muted" style="margin-top:6px">Le PAT est stocké dans votre navigateur (localStorage). Vous pouvez ne pas l’enregistrer et le coller à chaque session.</div>
  </fieldset>

  <fieldset>
    <legend>1) Bootstrap du dépôt (auto‑création des fichiers)</legend>
    <p class="muted">Cliquez pour créer/mettre à jour automatiquement : <code>.github/workflows/mailer.yml</code>, <code>mailer/package.json</code>, <code>mailer/send.js</code>. Ensuite, ajoutez vos <b>Secrets</b> d’envoi dans <i>Settings → Secrets → Actions</i>.</p>
    <div class="row">
      <button id="bootstrap" class="btn">Créer/Mettre à jour les fichiers</button>
      <button id="checkFiles" class="btn secondary">Vérifier la présence des fichiers</button>
    </div>
    <div id="bootLog" class="muted" style="margin-top:8px"></div>
  </fieldset>

  <fieldset>
    <legend>2) Paramètres de campagne</legend>
    <div class="row">
      <div>
        <label>Nom interne</label>
        <input id="name" placeholder="ex: Lancement Août" />
      </div>
      <div>
        <label>Fournisseur</label>
        <select id="provider">
          <option value="gmail">gmail</option>
          <option value="outlook">outlook</option>
          <option value="smtp">smtp</option>
        </select>
        <div class="muted">Configurez les Secrets correspondants dans le dépôt.</div>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Objet</label>
        <input id="subject" placeholder="Vous avez reçu un message" />
      </div>
      <div>
        <label>From (optionnel)</label>
        <input id="from" placeholder="Nom <expediteur@domaine.com>" />
      </div>
    </div>
    <label>HTML du message (utilisé tel quel, sans modification)</label>
    <textarea id="html" placeholder="Collez ici votre HTML complet…"></textarea>
    <label>Pièces jointes (URLs https, une par ligne) — optionnel</label>
    <textarea id="attachments" placeholder="https://exemple.com/fichier.pdf"></textarea>

    <div class="row3">
      <div>
        <label>Quota / jour</label>
        <input id="dailyLimit" type="number" value="100" min="1" />
      </div>
      <div>
        <label>Max par exécution</label>
        <input id="maxPerRun" type="number" value="25" min="1" />
      </div>
      <div>
        <label>Ordre d’envoi</label>
        <select id="order">
          <option value="alpha">alphabétique</option>
          <option value="asIs">tel que fourni</option>
        </select>
      </div>
    </div>
    <div class="row3">
      <div>
        <label>Date de début (Europe/Paris)</label>
        <input id="startDate" type="date" />
      </div>
      <div>
        <label>Jours autorisés</label>
        <div class="chips">
          <label class="chip"><input type="checkbox" class="day" value="1"> Lun</label>
          <label class="chip"><input type="checkbox" class="day" value="2" checked> Mar</label>
          <label class="chip"><input type="checkbox" class="day" value="3"> Mer</label>
          <label class="chip"><input type="checkbox" class="day" value="4" checked> Jeu</label>
          <label class="chip"><input type="checkbox" class="day" value="5" checked> Ven</label>
          <label class="chip"><input type="checkbox" class="day" value="6"> Sam</label>
          <label class="chip"><input type="checkbox" class="day" value="0"> Dim</label>
        </div>
      </div>
      <div>
        <label>Fenêtres horaires (Europe/Paris)</label>
        <div id="windows" class="grid"></div>
        <button id="addWin" class="btn secondary small" type="button">+ Ajouter fenêtre</button>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>3) Contacts</legend>
    <div class="row">
      <div>
        <label>Collez des e‑mails (1 par ligne) ou CSV (email,prenom,nom)</label>
        <textarea id="contacts" placeholder="alice@example.com\nbob@example.com, Bob, Martin"></textarea>
      </div>
      <div>
        <label>Statut</label>
        <div id="stats" class="muted">0 valides • 0 doublons supprimés</div>
        <div style="margin-top:8px"><button id="analyze" class="btn secondary" type="button">Analyser & Dédupliquer</button></div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>4) Créer & pousser la campagne</legend>
    <div class="row">
      <button id="create" class="btn">Créer la campagne (commit dans <code>campaigns/</code>)</button>
      <button id="download" class="btn secondary">Télécharger le JSON</button>
    </div>
    <div id="out" class="muted" style="margin-top:8px"></div>
  </fieldset>

  <div class="divider"></div>
  <p class="muted">Rappel : ajoutez vos Secrets dans le dépôt selon le fournisseur choisi. Gmail/Outlook ont des limites strictes — utilisez des quotas/jours/fenêtres pour étaler l’envoi.</p>

<script>
// ======= Utilitaires =======
const ls = window.localStorage;
const byId = id => document.getElementById(id);
const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/i;
const todayISO = () => new Date().toISOString().slice(0,10);

function b64(str){return btoa(unescape(encodeURIComponent(str)));}
function enc(obj){return b64(JSON.stringify(obj,null,2));}

function ghHeaders(pat){
  return {'Authorization':`Bearer ${pat}`,'Accept':'application/vnd.github+json'};
}

async function ghGet(owner,repo,path,branch,pat){
  const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`, {headers: ghHeaders(pat)});
  if(r.status===404) return null;
  if(!r.ok){throw new Error(`GET ${path}: ${r.status}`)}
  return r.json();
}

async function ghPut(owner,repo,path,branch,pat,content,message){
  // si existe, inclure sha pour update
  let sha = undefined;
  const existing = await ghGet(owner,repo,path,branch,pat);
  if(existing && existing.sha) sha = existing.sha;
  const r = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`,{
    method:'PUT',
    headers: ghHeaders(pat),
    body: JSON.stringify({message, content: b64(content), branch, sha})
  });
  if(!r.ok){const t = await r.text(); throw new Error(`PUT ${path}: ${t}`)}
  return r.json();
}

// ======= Contenus bootstrap embarqués =======
const WORKFLOW_YML = `name: Mailer\n\non:\n  push:\n    paths:\n      - 'campaigns/**'\n  schedule:\n    - cron: '*/5 * * * *'\n\npermissions:\n  contents: write\n\njobs:\n  send:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-node@v4\n        with:\n          node-version: '20'\n      - name: Install deps\n        working-directory: mailer\n        run: npm i\n      - name: Run sender\n        working-directory: mailer\n        env:\n          GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}\n          GMAIL_USER: \${{ secrets.GMAIL_USER }}\n          GMAIL_PASS: \${{ secrets.GMAIL_PASS }}\n          GMAIL_FROM: \${{ secrets.GMAIL_FROM }}\n          OUTLOOK_USER: \${{ secrets.OUTLOOK_USER }}\n          OUTLOOK_PASS: \${{ secrets.OUTLOOK_PASS }}\n          OUTLOOK_FROM: \${{ secrets.OUTLOOK_FROM }}\n          SMTP_HOST: \${{ secrets.SMTP_HOST }}\n          SMTP_PORT: \${{ secrets.SMTP_PORT }}\n          SMTP_SECURE: \${{ secrets.SMTP_SECURE }}\n          SMTP_USER: \${{ secrets.SMTP_USER }}\n          SMTP_PASS: \${{ secrets.SMTP_PASS }}\n          SMTP_FROM: \${{ secrets.SMTP_FROM }}\n        run: node send.js\n`;

const PACKAGE_JSON = `{
  "name": "gh-mailer",
  "version": "1.0.0",
  "private": true,
  "type": "commonjs",
  "dependencies": { "nodemailer": "^6.9.13" }
}`;

const SEND_JS = `const fs = require('fs');\nconst path = require('path');\nconst nodemailer = require('nodemailer');\n\nconst REPO_ROOT = process.cwd();\nconst CAMPAIGNS_DIR = path.join(REPO_ROOT, 'campaigns');\nconst STATE_DIR = path.join(REPO_ROOT, 'state');\n\nfunction ensureDirs(){\n  if(!fs.existsSync(CAMPAIGNS_DIR)) fs.mkdirSync(CAMPAIGNS_DIR,{recursive:true});\n  if(!fs.existsSync(STATE_DIR)) fs.mkdirSync(STATE_DIR,{recursive:true});\n}\n\nfunction loadJson(p){ try{ return JSON.parse(fs.readFileSync(p,'utf8')); }catch(e){ return null; } }\nfunction saveJson(p,obj){ fs.mkdirSync(path.dirname(p),{recursive:true}); fs.writeFileSync(p, JSON.stringify(obj,null,2)); }\n\nfunction nowParis(){ const s=new Date().toLocaleString('sv-SE',{timeZone:'Europe/Paris',hour12:false}); const [d,t]=s.split(' '); return {date:d,time:t}; }\nfunction weekdayNumParis(){ const map={Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6}; const s=new Date().toLocaleString('en-US',{timeZone:'Europe/Paris',weekday:'short'}); return map[s]; }\nfunction timeInRange(t,start,end){ return (t>=start && t<=end); }\n\nfunction buildTransport(provider){\n  if(provider==='gmail'){ return nodemailer.createTransport({ host:'smtp.gmail.com', port:465, secure:true, auth:{user:process.env.GMAIL_USER, pass:process.env.GMAIL_PASS} }); }\n  if(provider==='outlook'){ return nodemailer.createTransport({ host:'smtp.office365.com', port:587, secure:false, auth:{user:process.env.OUTLOOK_USER, pass:process.env.OUTLOOK_PASS} }); }\n  return nodemailer.createTransport({ host:process.env.SMTP_HOST, port:parseInt(process.env.SMTP_PORT||'587',10), secure:String(process.env.SMTP_SECURE||'false')==='true', auth:{user:process.env.SMTP_USER, pass:process.env.SMTP_PASS} });\n}\n\nasync function sendOne(transporter, from, to, subject, html, attachments){\n  const opts = { from: from||undefined, to, subject, html, attachments:(attachments||[]).map(url=>({ filename: require('path').basename(url.split('?')[0]), path:url })) };\n  return transporter.sendMail(opts);\n}\n\nfunction withinWindows(schedule){\n  const todayNum = weekdayNumParis();\n  if(Array.isArray(schedule?.days) && schedule.days.length>0 && !schedule.days.includes(todayNum)) return false;\n  const { time } = nowParis(); const hhmm = time.slice(0,5);\n  const wins = Array.isArray(schedule?.windows) && schedule.windows.length>0 ? schedule.windows : [{start:'00:00', end:'23:59'}];\n  return wins.some(w=> timeInRange(hhmm, w.start, w.end));\n}\n\nasync function main(){\n  ensureDirs();\n  const files = fs.existsSync(CAMPAIGNS_DIR)? fs.readdirSync(CAMPAIGNS_DIR).filter(f=>f.endsWith('.json')) : [];\n  if(files.length===0){ console.log('No campaigns'); return; }\n\n  for(const f of files){\n    const c = loadJson(path.join(CAMPAIGNS_DIR,f)); if(!c) continue;\n    const { date } = nowParis(); if(c.startDate && c.startDate > date){ console.log('['+c.id+'] startDate future, skip'); continue; }\n    if(!withinWindows(c.schedule)){ console.log('['+c.id+'] hors fenetre'); continue; }\n\n    const statePath = path.join(STATE_DIR, c.id+'.json');\n    const s = loadJson(statePath) || { id:c.id, cursor:0, sentTotal:0, perDay:{}, completed:false };\n    if(s.completed){ console.log('['+c.id+'] deja termine'); continue; }\n\n    const recipients = Array.isArray(c.recipients)? c.recipients : [];\n    if(s.cursor >= recipients.length){ s.completed=true; saveJson(statePath,s); console.log('['+c.id+'] termine'); continue; }\n\n    const today = nowParis().date; const todaySent = s.perDay[today]||0;\n    const dailyLimit = Math.max(1, c?.limits?.dailyLimit || 100);\n    const maxPerRun = Math.max(1, c?.limits?.maxPerRun || 25);\n    const canToday = Math.max(0, dailyLimit - todaySent);\n    if(canToday===0){ console.log('['+c.id+'] quota journalier atteint'); continue; }\n\n    const toSendNow = Math.min(maxPerRun, canToday, recipients.length - s.cursor);\n    if(toSendNow<=0){ console.log('['+c.id+'] rien a envoyer'); continue; }\n\n    const provider = c.provider || 'smtp';\n    const transporter = buildTransport(provider);\n    const from = c.from || process.env[provider.toUpperCase()+'_FROM'] || process.env[provider.toUpperCase()+'_USER'];\n\n    let ok=0, fail=0; const errors=[];\n    for(let i=0;i<toSendNow;i++){\n      const r = recipients[s.cursor + i]; const to = r.email;\n      try{ await sendOne(transporter, from, to, c.subject, c.html, c.attachments); ok++; }\n      catch(e){ fail++; errors.push({to, error:String(e)}); }\n    }\n\n    s.cursor += (ok+fail); s.sentTotal += ok; s.perDay[today] = todaySent + ok; if(s.cursor >= recipients.length) s.completed=true;\n    saveJson(statePath, s);\n    console.log('['+c.id+'] sent ok='+ok+' fail='+fail+' cursor='+s.cursor+'/'+recipients.length);\n\n    if(errors.length){ const errPath = path.join(STATE_DIR, c.id+'-'+today+'.errors.json'); saveJson(errPath, errors); }\n  }\n\n  const { execSync } = require('child_process');\n  try{\n    execSync('git config user.name "github-actions"');\n    execSync('git config user.email "github-actions@users.noreply.github.com"');\n    execSync('git add state');\n    const diff = execSync('git status --porcelain').toString().trim();\n    if(diff){ execSync('git commit -m "chore(state): update [skip ci]"'); execSync('git push'); }\n    else { console.log('No state changes to commit'); }\n  }catch(e){ console.log('Git push skipped/failed:', String(e.message||e)); }\n}\n\nmain().catch(e=>{ console.error(e); process.exit(1); });\n`;

// ======= Initialisation UI =======
(function initConn(){ byId('owner').value = ls.getItem('owner')||''; byId('repo').value = ls.getItem('repo')||''; byId('branch').value = ls.getItem('branch')||'main'; byId('pat').value = ls.getItem('pat')||''; })();
byId('saveConn').onclick = ()=>{ ls.setItem('owner', byId('owner').value.trim()); ls.setItem('repo', byId('repo').value.trim()); ls.setItem('branch', byId('branch').value.trim()||'main'); if(byId('pat').value.trim()) ls.setItem('pat', byId('pat').value.trim()); byId('connStatus').textContent='Enregistré'; setTimeout(()=>byId('connStatus').textContent='',2000); };

const windowsDiv = byId('windows');
function addWindowRow(start='09:00', end='12:00'){
  const wrap = document.createElement('div'); wrap.className='time';
  wrap.innerHTML = `<input type="time" class="winStart" value="${start}"> à <input type="time" class="winEnd" value="${end}"> <button type="button" class="btn secondary small del">Suppr</button>`;
  wrap.querySelector('.del').onclick = ()=>wrap.remove();
  windowsDiv.appendChild(wrap);
}
addWindowRow('09:00','12:00'); addWindowRow('14:00','17:00');
byId('addWin').onclick = ()=>addWindowRow('09:00','12:00');

// ======= Bootstrap dépôt =======
byId('checkFiles').onclick = async ()=>{
  const owner=byId('owner').value.trim(), repo=byId('repo').value.trim(), branch=byId('branch').value.trim()||'main', pat=byId('pat').value.trim();
  if(!owner||!repo||!pat){ byId('bootLog').innerHTML='<span class="err">owner/repo/PAT requis</span>'; return; }
  try{
    const paths=[ '.github/workflows/mailer.yml', 'mailer/package.json', 'mailer/send.js' ];
    const results = await Promise.all(paths.map(p=>ghGet(owner,repo,p,branch,pat)));
    const lines = results.map((r,i)=> `${paths[i]} : ${r?'OK':'manquant'}`).join('<br>');
    byId('bootLog').innerHTML = lines;
  }catch(e){ byId('bootLog').innerHTML = `<span class="err">${e.message}</span>`; }
};

byId('bootstrap').onclick = async ()=>{
  const owner=byId('owner').value.trim(), repo=byId('repo').value.trim(), branch=byId('branch').value.trim()||'main', pat=byId('pat').value.trim();
  if(!owner||!repo||!pat){ byId('bootLog').innerHTML='<span class="err">owner/repo/PAT requis</span>'; return; }
  try{
    await ghPut(owner,repo,'.github/workflows/mailer.yml',branch,pat,WORKFLOW_YML,'ci(actions): add mailer workflow');
    await ghPut(owner,repo,'mailer/package.json',branch,pat,PACKAGE_JSON,'chore(mailer): package.json');
    await ghPut(owner,repo,'mailer/send.js',branch,pat,SEND_JS,'feat(mailer): sender script');
    byId('bootLog').innerHTML = '<span class="ok">Fichiers créés/mis à jour. Ajoutez maintenant les <b>Secrets</b> SMTP et créez votre campagne.</span>';
  }catch(e){ byId('bootLog').innerHTML = `<span class="err">${e.message}</span>`; }
};

// ======= Contacts =======
function parseContacts(raw){
  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const rows = [];
  for(const l of lines){
    const parts = l.split(',').map(x=>x.trim()).filter(Boolean);
    if(parts.length===0) continue;
    const email = parts[0];
    if(emailRe.test(email)) rows.push({email, prenom: parts[1]||'', nom: parts[2]||''});
  }
  return rows;
}
let lastContacts=[];
byId('analyze').onclick = ()=>{
  const rows=parseContacts(byId('contacts').value);
  const seen=new Set(); const dedup=[]; let dups=0;
  for(const r of rows){ const k=r.email.toLowerCase(); if(seen.has(k)){dups++; continue;} seen.add(k); dedup.push(r); }
  if(byId('order').value==='alpha') dedup.sort((a,b)=>a.email.localeCompare(b.email));
  lastContacts = dedup; byId('stats').textContent = `${dedup.length} valides • ${dups} doublons supprimés`;
};

// ======= Campagne =======
function buildCampaign(){
  const id = `cmp_${Date.now()}`;
  const days = Array.from(document.querySelectorAll('.day:checked')).map(x=>parseInt(x.value,10));
  const starts = Array.from(document.querySelectorAll('.winStart')).map(el=>el.value);
  const ends = Array.from(document.querySelectorAll('.winEnd')).map(el=>el.value);
  const wins = starts.map((s,i)=>({start:s, end: ends[i]}));
  return {
    id,
    createdAt: new Date().toISOString(),
    tz: 'Europe/Paris',
    startDate: byId('startDate').value || todayISO(),
    name: byId('name').value.trim() || id,
    provider: byId('provider').value,
    subject: byId('subject').value.trim() || 'Vous avez reçu un message',
    from: byId('from').value.trim() || null,
    html: byId('html').value, // non modifié
    attachments: byId('attachments').value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean),
    limits: {
      dailyLimit: Math.max(1, parseInt(byId('dailyLimit').value,10) || 100),
      maxPerRun: Math.max(1, parseInt(byId('maxPerRun').value,10) || 25)
    },
    schedule: { days, windows: wins },
    order: byId('order').value,
    recipients: lastContacts
  };
}

async function commitCampaign(c){
  const owner=byId('owner').value.trim(), repo=byId('repo').value.trim(), branch=byId('branch').value.trim()||'main', pat=byId('pat').value.trim();
  if(!owner||!repo||!pat) throw new Error('owner/repo/PAT manquant');
  if(!Array.isArray(c.recipients) || c.recipients.length===0) throw new Error('Aucun contact valide. Cliquez d\'abord sur « Analyser ».');
  const path = `campaigns/${c.id}.json`;
  await ghPut(owner,repo,path,branch,pat,JSON.stringify(c,null,2),`feat(campaign): ${c.name}`);
}

byId('create').onclick = async ()=>{
  try{
    const c = buildCampaign();
    await commitCampaign(c);
    byId('out').innerHTML = '<span class="ok">Campagne poussée. Le workflow va s\'exécuter (et ensuite toutes les 5 min) dans les fenêtres autorisées sans dépasser votre quota/jour.</span>';
  }catch(e){ byId('out').innerHTML = `<span class="err">${e.message}</span>`; }
};

byId('download').onclick = ()=>{
  const c = buildCampaign();
  const blob = new Blob([JSON.stringify(c,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${c.id}.json`; a.click();
};
</script>
</body>
</html>
