<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Chat IA OptimisÃ© avec Tracking et Vocal</title>
  <style>
    #chat-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      z-index: 999999;
      font-family: Arial, sans-serif;
      cursor: move;
      transition: transform 0.2s;
    }
    #chat-toggle {
      width: 60px;
      height: 60px;
      background: linear-gradient(145deg, #FFB6C1, #FF69B4);
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(255,105,180,0.7);
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
      outline: none;
    }
    #chat-toggle:hover {
      transform: scale(1.05);
    }
    #voice-toggle {
      width: 50px;
      height: 50px;
      background: linear-gradient(145deg, #87CEEB, #5eb6d1);
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(135,206,235,0.7);
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      transition: transform 0.2s;
      outline: none;
    }
    #voice-toggle:hover {
      transform: scale(1.05);
    }
    #voice-toggle.listening {
      background: #FF4500;
      box-shadow: 0 0 10px #FF4500;
    }
    #chat-box {
      background: #111;
      border-radius: 10px;
      flex: 1;
      display: none;
      flex-direction: column;
      overflow: hidden;
      margin-top: 10px;
      border: 2px solid #FF1493;
      box-shadow: 0 0 10px #FF1493;
      transition: all 0.3s ease;
    }
    #chat-box.visible {
      display: flex;
    }
    #chat-messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      color: #fff;
      -webkit-overflow-scrolling: touch;
    }
    #chat-messages p {
      margin-bottom: 0.5rem;
      line-height: 1.4;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    .bot-message {
      text-align: left;
      color: #fff;
      background: rgba(255,255,255,0.05);
      padding: 0.5rem;
      border-radius: 5px;
      margin-bottom: 0.8rem;
      display: inline-block;
      max-width: 80%;
      border: 2px solid #FF69B4;
      box-shadow: 0 0 8px #FF69B4;
    }
    .user-message {
      text-align: right;
      color: #ffd700;
      margin-bottom: 0.8rem;
      border: 2px solid #AED6F1;
      box-shadow: 0 0 8px #AED6F1;
      padding: 0.5rem;
      border-radius: 5px;
      display: inline-block;
      max-width: 80%;
    }
    #chat-form {
      display: flex;
      border-top: 1px solid #333;
      align-items: center;
      padding: 0.5rem;
    }
    #chat-input {
      flex: 1;
      padding: 0.5rem;
      border: none;
      outline: none;
      color: #333;
      border-radius: 5px 0 0 5px;
      font-size: 1rem;
    }
    #chat-send {
      background: #87CEEB;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      color: #fff;
      font-weight: bold;
      border-radius: 0 5px 5px 0;
      transition: background 0.2s;
      font-size: 1.2rem;
    }
    #chat-send:hover {
      background: #5eb6d1;
    }
    @media(max-width: 400px) {
      #chat-container {
        width: 90%;
        right: 5%;
        bottom: 5%;
        max-height: 70vh;
      }
      #chat-toggle, #voice-toggle {
        width: 50px;
        height: 50px;
      }
      #chat-input {
        font-size: 0.9rem;
      }
      #chat-send {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div style="display: flex; justify-content: flex-end;">
      <button id="chat-toggle" aria-expanded="false" aria-label="Ouvrir ou fermer le chat">ðŸ’¬</button>
      <button id="voice-toggle" aria-label="Activer ou dÃ©sactiver lâ€™entrÃ©e vocale">ðŸŽ¤</button>
    </div>
    <div id="chat-box" role="region" aria-label="FenÃªtre de discussion avec lâ€™assistant IA">
      <div id="chat-messages" aria-live="polite"></div>
      <form id="chat-form" aria-label="Formulaire de saisie pour le chat IA">
        <input type="text" id="chat-input" placeholder="Posez votre question..." aria-label="Tapez votre message ici" autocomplete="off">
        <button type="submit" id="chat-send" aria-label="Envoyer votre message">âž¤</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Ã‰lÃ©ments DOM
      const chatContainer = document.getElementById("chat-container");
      const chatToggle = document.getElementById("chat-toggle");
      const chatBox = document.getElementById("chat-box");
      const chatMessages = document.getElementById("chat-messages");
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");
      const chatSend = document.getElementById("chat-send");
      const voiceToggle = document.getElementById("voice-toggle");

      // VÃ©rification DOM
      if (!chatContainer || !chatToggle || !chatBox || !chatMessages || !chatForm || !chatInput || !chatSend || !voiceToggle) {
        console.error("Erreur : Un ou plusieurs Ã©lÃ©ments DOM manquants");
        return;
      }

      // Tracking
      function trackClick(label, category = 'Chat', value = null) {
        console.log(`Tracking: Label=${label}, Category=${category}, Value=${value}`);
      }

      // Base de connaissances
      const knowledgeBase = [
        { question: "Fatigue|Ã‰puisement|Lassitude|ExtÃ©nuation|Torpeur|Affaiblissement", answer: "Et si cette fatigue Ã©crasante nâ€™Ã©tait pas un hasard, mais une entitÃ© obscure qui dÃ©vore ton Ã©nergie ? Frederick de ClairvoyanceMedium.com purifie ton aura pour te libÃ©rer â€“ combien de temps te laisseras-tu sombrer ?" },
        { question: "Cauchemars|Visions|NuitsHantÃ©es|SongeNoir|RÃªvesTroublÃ©s|PeursNocturnes", answer: "Ces cauchemars qui tâ€™assaillent pourraient Ãªtre lâ€™Å“uvre dâ€™une prÃ©sence malÃ©fique ; Frederick chasse ces ombres pour te rendre tes nuits â€“ supporteras-tu encore ces terreurs ?" },
        { question: "Chaos|Turbulence|Confusion|DÃ©sarroi|Tourbillon|AnxiÃ©tÃ©", answer: "Ce chaos qui tâ€™entoure pourrait cacher une malÃ©diction qui brise ton destin ; Frederick rÃ©tablit lâ€™ordre pour te sauver â€“ laisseras-tu la tempÃªte tâ€™emporter ?" },
        { question: "Oppression|Lourdeur|Ã‰touffement|Poids|Angoisse|Ã‰crasement", answer: "Cette oppression qui tâ€™Ã©touffe pourrait Ãªtre une force sombre qui Ã©crase ton Ã¢me ; Frederick te libÃ¨re de ce joug â€“ combien de temps ploieras-tu sous cette ombre ?" },
        { question: "Sort|MalÃ©diction|EnvoÃ»tement|CharmeNoir|MagieObscure|Sorcellerie", answer: "Fatigue, malchance, cauchemars : et si un sort te retenait captif ? Frederick brise ces liens occultes â€“ oseras-tu dÃ©fier cette emprise ?" },
        { question: "Ã‰chec|Revers|Chute|DÃ©route|Malheur|DÃ©faite", answer: "Tes Ã©checs rÃ©pÃ©tÃ©s pourraient Ãªtre un sort qui bloque ton chemin ; Frederick ouvre ta voie au succÃ¨s â€“ combien de fois trÃ©bucheras-tu encore ?" },
        { question: "Insomnie|Agitation|NuitsBlanches|SommeilFuyant|Veille|InquiÃ©tude", answer: "Ton insomnie pourrait Ãªtre une entitÃ© qui vole ton repos ; Frederick te rend la paix nocturne â€“ jusquâ€™Ã  quand tiendras-tu Ã©veillÃ© ?" },
        { question: "Douleur|Mal|Souffrance|BrÃ»lure|Peine|Tourment", answer: "Ces douleurs inexplicables pourraient trahir une attaque occulte ; Frederick te soulage â€“ combien de temps endureras-tu ce feu invisible ?" },
        { question: "Seul|IsolÃ©|Solitaire|DÃ©laissÃ©|AbandonnÃ©|Reclus", answer: "Et si ton isolement Ã©tait un sort qui tâ€™arrache aux autres ? Frederick te reconnecte Ã  la lumiÃ¨re â€“ resteras-tu seul dans ce vide ?" },
        { question: "CarriÃ¨re|Travail|Ambition|Stagnation|BlocagePro|Ã‰checPro", answer: "Ces obstacles dans ta carriÃ¨re pourraient Ãªtre une malÃ©diction ; Frederick libÃ¨re ton potentiel â€“ laisseras-tu ton avenir professionnel sâ€™Ã©teindre ?" },
        { question: "Malchance|Infortune|HasardNoir|DÃ©veine|SortFuneste|CalamitÃ©", answer: "Ta malchance pourrait Ãªtre un sort qui assombrit ta vie ; Frederick te ramÃ¨ne la chance â€“ combien de coups du sort encaisseras-tu ?" },
        { question: "Amour|Passion|Romance|CÅ“urBrisÃ©|DÃ©samour|SolitudeAffective", answer: "Si lâ€™amour te fuit, un sort pourrait fermer ton cÅ“ur ; Frederick lâ€™ouvre Ã  la tendresse â€“ supporteras-tu encore ce dÃ©sert sentimental ?" },
        { question: "Famille|Foyer|Discorde|TensionFamiliale|Fracture|Conflit", answer: "Ces tensions dans ton foyer pourraient Ãªtre une ombre occulte ; Frederick apaise ton clan â€“ laisseras-tu ta famille se dÃ©chirer ?" },
        { question: "Enfants|Petits|ProgÃ©niture|InquiÃ©tudeJeunes|TristesseEnfant|Souci", answer: "La peine de tes enfants pourrait rÃ©vÃ©ler une influence sombre ; Frederick purifie leur aura â€“ combien de temps les verras-tu souffrir ?" },
        { question: "Animaux|Compagnons|BÃªtes|NervositÃ©Animale|TroubleFaune|Instinct", answer: "Lâ€™agitation de tes animaux pourrait signaler une prÃ©sence obscure ; Frederick restaure la paix â€“ ignoreras-tu leur cri dâ€™alarme ?" },
        { question: "Maison|Habitat|Logis|AtmosphÃ¨reLourde|ObscuritÃ©Domicile|PeurIntÃ©rieure", answer: "Ton foyer oppressant pourrait Ãªtre infestÃ© dâ€™Ã©nergies noires ; Frederick le purifie â€“ vivras-tu encore dans cette prison ?" },
        { question: "Voiture|VÃ©hicule|Transport|PanneMystÃ©rieuse|DangerRoute|Incertitude", answer: "Les pannes de ta voiture pourraient Ãªtre un sort ; Frederick la libÃ¨re â€“ risqueras-tu encore ces trajets maudits ?" },
        { question: "PrÃ©sence|Ombre|Spectre|AuraNoire|Frisson|Intrusion", answer: "Ce sentiment dâ€™Ãªtre suivi pourrait Ãªtre une entitÃ© malveillante ; Frederick te protÃ¨ge â€“ combien de temps tolÃ©reras-tu cette ombre ?" },
        { question: "Peur|Crainte|Panique|Terror|Effroi|NervositÃ©", answer: "Ta peur pourrait Ãªtre un sort qui te glace ; Frederick te rÃ©chauffe â€“ laisseras-tu ce froid tâ€™envahir ?" },
        { question: "Froid|Gel|Frimas|Glace|ChillIntÃ©rieur|FroideurÃ‚me", answer: "Ce froid qui te saisit pourrait Ãªtre une ombre ; Frederick te rÃ©chauffe â€“ combien de temps resteras-tu gelÃ© ?" }
      ];

      // Traitement base de connaissances
      function removeAccents(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }

      const processedKnowledgeBase = knowledgeBase.map(item => ({
        question: item.question.toLowerCase().split("|").map(word => removeAccents(word.trim())).filter(word => word),
        answer: item.answer
      }));

      // Variables globales
      let nonUnderstoodCount = 0;
      const defaultNonUnderstood = "Je ne comprends pas bien.";
      let isVoiceInput = false;

      // Nettoyage entrÃ©e
      function cleanInput(input) {
        return input.toLowerCase().replace(/[^\w\s]/g, "").split(/\s+/).map(word => removeAccents(word)).filter(word => word);
      }

      // Recherche correspondance
      function findBestMatch(userInput) {
        const userWords = cleanInput(userInput);
        let bestMatch = null, maxOverlap = 0;
        processedKnowledgeBase.forEach(item => {
          const overlap = userWords.filter(word => item.question.includes(word)).length;
          if (overlap > maxOverlap) {
            maxOverlap = overlap;
            bestMatch = item;
          }
        });
        return maxOverlap > 0 ? bestMatch.answer : defaultNonUnderstood;
      }

      // RÃ©ponse
      function getResponse(userMsg) {
        const lowerMsg = userMsg.toLowerCase().trim();
        if (lowerMsg === "bonjour") {
          nonUnderstoodCount = 0;
          trackClick("Greeting");
          return "Je suis Ã  votre Ã©coute.";
        } else if (["merci", "merci beaucoup"].includes(lowerMsg)) {
          nonUnderstoodCount = 0;
          trackClick("Thanks");
          return "Je vous en prie.";
        } else if (["au revoir", "aurevoir", "Ã  bientÃ´t", "bye"].includes(lowerMsg)) {
          nonUnderstoodCount = 0;
          trackClick("Goodbye");
          return "Ã€ bientÃ´t et sachez que notre aide est toujours Ã  portÃ©e de main.";
        } else {
          const answer = findBestMatch(userMsg);
          if (answer === defaultNonUnderstood) {
            nonUnderstoodCount++;
            trackClick("NotUnderstood", "Interaction", nonUnderstoodCount);
            return nonUnderstoodCount < 3 
              ? "Je nâ€™ai pas saisi votre question. Pourriez-vous reformuler, sâ€™il vous plaÃ®t ?"
              : "Il semble que nous ayons du mal Ã  nous comprendre. Peut-Ãªtre est-il temps dâ€™envisager un dÃ©senvoÃ»tement pour rÃ©tablir lâ€™Ã©quilibre de vos Ã©nergies. Nos services dÃ©butent Ã  50â‚¬ pour une dÃ©tection et 250â‚¬ pour un rituel complet.";
          } else {
            nonUnderstoodCount = 0;
            trackClick("ResponseGiven");
            return answer;
          }
        }
      }

      // Animation saisie
      function simulateTyping(callback) {
        const typingMessage = document.createElement("p");
        typingMessage.className = "bot-message";
        typingMessage.textContent = "...";
        chatMessages.appendChild(typingMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        setTimeout(() => {
          chatMessages.removeChild(typingMessage);
          callback();
        }, 800);
      }

      // Ajout message
      function addMessage(txt, cls, speakResponse = false) {
        const p = document.createElement("p");
        p.className = cls;
        p.textContent = txt;
        chatMessages.appendChild(p);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        if (speakResponse && speechSynthesisSupported) speak(txt);
      }

      // DÃ©plaÃ§abilitÃ©
      let isDragging = false, currentX, currentY, initialX, initialY;
      chatContainer.addEventListener("mousedown", startDragging);
      chatContainer.addEventListener("touchstart", startDragging, { passive: false });

      function startDragging(e) {
        isDragging = true;
        e.preventDefault();
        initialX = (e.type === "mousedown" ? e.clientX : e.touches[0].clientX) - (currentX || 0);
        initialY = (e.type === "mousedown" ? e.clientY : e.touches[0].clientY) - (currentY || 0);
        document.addEventListener("mousemove", drag);
        document.addEventListener("touchmove", drag, { passive: false });
        document.addEventListener("mouseup", stopDragging);
        document.addEventListener("touchend", stopDragging);
      }

      function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        currentX = (e.type === "mousemove" ? e.clientX : e.touches[0].clientX) - initialX;
        currentY = (e.type === "mousemove" ? e.clientY : e.touches[0].clientY) - initialY;
        chatContainer.style.right = "auto";
        chatContainer.style.bottom = "auto";
        chatContainer.style.left = `${currentX}px`;
        chatContainer.style.top = `${currentY}px`;
      }

      function stopDragging() {
        isDragging = false;
        document.removeEventListener("mousemove", drag);
        document.removeEventListener("touchmove", drag);
        document.removeEventListener("mouseup", stopDragging);
        document.removeEventListener("touchend", stopDragging);
      }

      currentX = window.innerWidth - chatContainer.offsetWidth - 20;
      currentY = window.innerHeight - chatContainer.offsetHeight - 20;
      chatContainer.style.left = `${currentX}px`;
      chatContainer.style.top = `${currentY}px`;

      // Gestion ouverture/fermeture
      function toggleChat() {
        console.log("Toggle chat dÃ©clenchÃ©");
        const isHidden = !chatBox.classList.contains("visible");
        chatBox.classList.toggle("visible");
        chatToggle.setAttribute("aria-expanded", isHidden ? "true" : "false");
        trackClick(isHidden ? "ChatOpen" : "ChatClose");
        if (isHidden && !chatMessages.children.length) {
          addMessage("Bonjour, que puis-je pour vous ?", "bot-message");
        }
        if (isHidden) setTimeout(() => chatInput.focus(), 300);
      }

      chatToggle.addEventListener("click", toggleChat);
      chatToggle.addEventListener("touchend", (e) => { e.preventDefault(); toggleChat(); });

      // Gestion envoi texte
      function sendMessage() {
        console.log("Tentative dâ€™envoi de message");
        const userMsg = chatInput.value.trim();
        if (!userMsg) {
          console.log("Message vide, envoi annulÃ©");
          return;
        }
        isVoiceInput = false;
        addMessage(userMsg, "user-message");
        trackClick("ChatMessage");
        chatInput.value = "";
        console.log("Message envoyÃ© : ", userMsg);
        simulateTyping(() => {
          const answer = getResponse(userMsg);
          addMessage(answer, "bot-message");
        });
      }

      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        console.log("Formulaire soumis via submit");
        sendMessage();
      });

      chatSend.addEventListener("click", (e) => {
        e.preventDefault();
        console.log("Clic sur bouton envoyer");
        sendMessage();
      });

      chatSend.addEventListener("touchend", (e) => {
        e.preventDefault();
        console.log("Touchend sur bouton envoyer");
        sendMessage();
      });

      // Gestion vocal
      let speechSynthesisSupported = "speechSynthesis" in window;
      let speechRecognitionSupported = "SpeechRecognition" in window || "webkitSpeechRecognition" in window;
      let recognition = null;
      let isListening = false;

      if (speechRecognitionSupported) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = "fr-FR";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => {
          console.log("Reconnaissance vocale dÃ©marrÃ©e");
          isListening = true;
          voiceToggle.classList.add("listening");
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          console.log("RÃ©sultat vocal : ", transcript);
          isVoiceInput = true;
          addMessage(transcript, "user-message");
          trackClick("VoiceInput");
          simulateTyping(() => {
            const answer = getResponse(transcript);
            addMessage(answer, "bot-message", true);
          });
        };

        recognition.onend = () => {
          console.log("Reconnaissance vocale terminÃ©e");
          isListening = false;
          voiceToggle.classList.remove("listening");
          trackClick("VoiceStop");
        };

        recognition.onerror = (event) => {
          console.error("Erreur vocale : ", event.error);
          addMessage(`Erreur vocale : ${event.error}. RÃ©essayez.`, "bot-message");
          trackClick("VoiceError", "Interaction", event.error);
          isListening = false;
          voiceToggle.classList.remove("listening");
        };

        function toggleVoice() {
          console.log("Toggle vocal dÃ©clenchÃ©");
          if (!speechRecognitionSupported) {
            addMessage("La reconnaissance vocale nâ€™est pas supportÃ©e sur cet appareil.", "bot-message");
            trackClick("VoiceNotSupported");
            return;
          }
          if (isListening) {
            recognition.stop();
          } else {
            navigator.mediaDevices.getUserMedia({ audio: true })
              .then(() => {
                console.log("Permission micro accordÃ©e");
                recognition.start();
                trackClick("VoiceStart");
              })
              .catch(err => {
                console.error("Erreur permission : ", err);
                addMessage("Permission microphone refusÃ©e. Activez-la dans les paramÃ¨tres.", "bot-message");
                trackClick("VoicePermissionDenied", "Interaction", err.message);
              });
          }
        }

        voiceToggle.addEventListener("click", toggleVoice);
        voiceToggle.addEventListener("touchend", (e) => { e.preventDefault(); toggleVoice(); });
      } else {
        console.log("Reconnaissance vocale non supportÃ©e");
        voiceToggle.style.display = "none";
        addMessage("La reconnaissance vocale nâ€™est pas disponible sur cet appareil.", "bot-message");
      }

      function speak(text) {
        if (!speechSynthesisSupported) return;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = "fr-FR";
        utterance.volume = 1.0;
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        window.speechSynthesis.speak(utterance);
        trackClick("VoiceOutput");
        console.log("SynthÃ¨se : ", text);
      }
    });
  </script>
</body>
</html>
