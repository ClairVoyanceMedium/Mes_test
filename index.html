<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  
  <title>Chat IA Spirituel - ClairVoyanceMedium.com</title>
  <meta name="description" content="ClairVoyanceGPT - Assistant spirituel IA pour d√©senvo√ªtement, protection et guidance. Frederick du Cabinet ClairVoyanceMedium.com vous accompagne.">
  
  <!-- Favicon -->
  <link rel="icon" href="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/GmyGlKk.webp">
  <meta name="theme-color" content="#8B0000">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2RSFE6WL4M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2RSFE6WL4M', {'anonymize_ip': true});
    gtag('config', 'GTM-P3J6SXCH', {'anonymize_ip': true});
  </script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg:#000;
      --text:#fff;
      --gold:#FFD700;
      --tab-gold:#BBAE98;
      --burgundy:#FF6B6B;
      --burgundy-light:#FF8787;
      --silver:#C0C0C0;
      --accent:#87CEEB;
    }
    
    *{margin:0;padding:0;box-sizing:border-box;}
    
    body{
      font-family:'Cinzel',serif;
      background:var(--bg);
      color:var(--text);
      text-align:center;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      padding-top:180px;
    }
    
    /* NAVIGATION STICKY - DISPOSITION IMBRIQU√âE ADAPTATIVE */
    nav{
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:1000;
      background:rgba(0,0,0,0.30);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      padding:0.7rem 0.5rem;
      box-shadow:0 2px 15px rgba(255,215,0,0.3);
    }
    
    nav ul{
      list-style:none;
      padding:0;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:0.4rem;
      max-width:1200px;
      margin:0 auto;
    }
    
    /* Effet imbriqu√© ligne par ligne */
    nav ul li:nth-child(4n+1),
    nav ul li:nth-child(4n+2),
    nav ul li:nth-child(4n+3){
      margin-right:0.3rem;
    }
    
    /* ANGLES CARR√âS - TAILLE -5% */
    nav ul li a{
      font-family:'Cinzel',serif;
      font-size:clamp(0.855rem, 2.1vw, 1.045rem);
      color:var(--tab-gold);
      text-decoration:none;
      padding:0.62rem 0.90rem;
      background:rgba(17,17,17,0.45);
      border:2px solid var(--tab-gold);
      border-radius:0;
      transition:all .3s ease;
      display:inline-block;
      text-align:center;
      min-height:43px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    nav ul li a:hover{
      background:var(--tab-gold);
      color:#111;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(187,174,152,0.5);
    }
    
    /* CLIGNOTEMENT ONGLETS */
    @keyframes blinkTab{
      0%, 100%{
        box-shadow:0 0 15px var(--burgundy);
        border-color:var(--burgundy);
        transform:scale(1);
      }
      50%{
        box-shadow:0 0 25px var(--burgundy-light);
        border-color:var(--burgundy-light);
        transform:scale(1.03);
      }
    }
    
    nav ul li a.blink{
      animation:blinkTab 1.2s ease-in-out infinite;
      background:#000;
      border:3px solid var(--burgundy);
      color:var(--tab-gold) !important;
    }
    
    header{
      padding:1.5rem 0;
      background:#111;
      box-shadow:0 4px 10px rgba(0,0,0,.8);
    }
    
    .logo{
      width:720px;
      max-width:90%;
      height:auto;
      display:block;
      margin:0 auto;
    }
    
    .chat-intro{
      max-width:900px;
      margin:1.5rem auto 2rem;
      padding:0 1rem;
      font-size:clamp(1.4rem, 5vw, 2.2rem);
      background:linear-gradient(145deg, #C0C0C0, #E8E8E8, #A8A8A8);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-weight:700;
    }
    
    #chat-container{
      max-width:900px;
      margin:1rem auto 2rem;
      padding:0 1rem;
    }
    
    #chat-box{
      background:#111;
      border:3px solid var(--burgundy);
      box-shadow:0 0 22px var(--burgundy), 0 0 39px rgba(255,107,107,0.7);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:650px;
      border-radius:0;
    }
    
    #chat-messages{
      flex:1;
      padding:1.5rem;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      color:#fff;
      background:#0a0a0a;
    }
    
    #chat-messages::-webkit-scrollbar{width:10px;}
    #chat-messages::-webkit-scrollbar-track{background:#1a1a1a;}
    #chat-messages::-webkit-scrollbar-thumb{background:var(--burgundy);box-shadow:0 0 9px var(--burgundy);}
    
    #chat-messages p{
      margin-bottom:1rem;
      line-height:1.7;
      opacity:0;
      animation:fadeIn 0.6s forwards;
    }
    
    @keyframes fadeIn{to{opacity:1;}}
    
    .bot-message{
      text-align:left;
      color:#fff;
      background:rgba(255,107,107,0.15);
      padding:1rem;
      margin-bottom:1rem;
      border:2px solid var(--burgundy);
      box-shadow:0 0 17px rgba(255,107,107,0.55);
      max-width:90%;
      border-radius:0;
    }
    
    .user-message{
      text-align:right;
      color:#fff;
      margin-bottom:1rem;
      border:2px solid var(--silver);
      box-shadow:0 0 17px rgba(192,192,192,0.55);
      padding:1rem;
      max-width:90%;
      margin-left:auto;
      background:linear-gradient(145deg, rgba(192,192,192,0.1), rgba(211,211,211,0.08));
      border-radius:0;
    }
    
    #chat-form{
      display:flex;
      flex-direction:column;
      border-top:3px solid var(--burgundy);
      padding:1rem;
      background:#111;
      gap:0.8rem;
    }
    
    .input-row{
      display:flex;
      gap:0.7rem;
      align-items:center;
    }
    
    #chat-input{
      flex:1;
      padding:1rem;
      border:2px solid var(--burgundy);
      outline:none;
      color:#fff;
      background:#0a0a0a;
      font-family:'Cinzel',serif;
      font-size:0.9rem;
      box-shadow:0 0 13px rgba(255,107,107,0.45);
      border-radius:0;
    }
    
    #chat-input::placeholder{
      color:#999;
      opacity:0.7;
      font-style:italic;
    }
    
    #voice-toggle{
      width:50px;
      height:50px;
      background:linear-gradient(145deg,#87CEEB,#5eb6d1);
      color:#fff;
      border:none;
      border-radius:50%;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(135,206,235,0.8);
      font-size:1.4rem;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform 0.2s;
    }
    
    #voice-toggle:hover{transform:scale(1.1);}
    #voice-toggle.disabled{background:linear-gradient(145deg,#808080,#666);opacity:0.7;}
    
    #chat-send{
      width:100%;
      background:linear-gradient(145deg,var(--burgundy-light),var(--burgundy));
      border:2px solid var(--burgundy);
      padding:1rem 1.8rem;
      cursor:pointer;
      color:#fff;
      font-weight:bold;
      font-family:'Cinzel',serif;
      box-shadow:0 0 20px rgba(255,107,107,0.65);
      font-size:1.1rem;
      transition:transform .2s;
      border-radius:0;
    }
    
    #chat-send:hover{
      transform:scale(1.03);
      box-shadow:0 0 28px rgba(255,107,107,0.85);
    }
    
    /* BOUTON FLOTTANT FLUIDE - D√âPLA√áABLE PARTOUT */
    .floating-tab{
      position:fixed;
      top:50%;
      right:20px;
      transform:translateY(-50%);
      z-index:9999;
      background:#000;
      color:var(--tab-gold);
      padding:1.2rem 2rem;
      border:3px solid var(--burgundy);
      font-family:'Cinzel',serif;
      font-size:clamp(1rem, 2.5vw, 1.3rem);
      font-weight:bold;
      text-decoration:none;
      cursor:pointer;
      box-shadow:0 0 15px var(--burgundy);
      animation:blinkFloating 1.5s ease-in-out infinite;
      display:none;
      user-select:none;
      border-radius:0;
      will-change:transform;
      transition:box-shadow 0.3s ease;
    }
    
    .floating-tab.show{display:block;}
    
    .floating-tab .close-btn{
      position:absolute;
      top:-8px;
      right:-8px;
      width:24px;
      height:24px;
      background:var(--burgundy);
      color:#fff;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      border:2px solid #fff;
      z-index:10000;
    }
    
    @keyframes blinkFloating{
      0%, 100%{box-shadow:0 0 15px var(--burgundy);}
      50%{box-shadow:0 0 25px var(--burgundy-light);}
    }
    
    /* LIEN RETOUR - COULEUR TAB-GOLD (#BBAE98) */
    .return-line{
      font-family:'Cinzel',serif;
      font-size:0.9rem;
      margin:4.5rem auto 1rem;
      text-align:center;
      padding:0 1rem;
    }
    
    .return-line a,
    .return-line a:link,
    .return-line a:visited,
    .return-line a:hover,
    .return-line a:active{
      color:#BBAE98 !important;
      text-decoration:underline;
      transition:all 0.3s ease;
      display:inline-flex;
      align-items:center;
      gap:0.5rem;
    }
    
    .return-line a:before{
      content:"‚Üê";
      font-size:1.4rem;
    }
    
    .return-line a:hover{
      opacity:0.8;
      transform:translateX(-5px);
    }
    
    /* FOOTER - CONDITIONS G√âN√âRALES EN GRIS */
    footer{
      margin-top:2rem;
      font-size:.9rem;
      color:#aaa;
      padding:2rem 1rem;
      background:#111;
    }
    
    footer a{
      color:#aaa !important;
      text-decoration:none;
    }
    
    footer a:hover{
      color:#fff !important;
    }
    
    @media(max-width:1024px){
      body{padding-top:190px;}
    }
    
    @media(max-width:768px){
      body{padding-top:210px;}
      nav{padding:0.7rem 0.4rem;}
      nav ul{gap:0.4rem;}
      nav ul li a{font-size:0.82rem;padding:0.55rem 0.8rem;}
      #chat-box{height:550px;}
      .logo{width:95%;}
      .floating-tab{right:10px;padding:0.9rem 1.3rem;font-size:0.95rem;}
    }
    
    @media(max-width:480px){
      body{padding-top:250px;}
      nav ul{gap:0.35rem;}
      nav ul li a{font-size:0.75rem;padding:0.5rem 0.7rem;min-height:40px;}
      #chat-box{height:500px;}
    }
  </style>
</head>
<body>
  <!-- ONGLETS FIXES STICKY EN HAUT -->
  <nav>
    <ul>
      <li><a href="https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/" target="_blank" rel="noopener noreferrer" data-keywords="t√©l√©phone|appel|30min|t√©l|telephoner|appeler|phone" data-exact="voyance t√©l√©phone" data-url="https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/" onclick="trackClick('TabVoyanceTel', 'Navigation', 30);">Voyance T√©l 30min/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp" target="_blank" rel="noopener noreferrer" data-keywords="email|questions|mail|courriel|√©crit|3questions" data-exact="voyance email" data-url="https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp" onclick="trackClick('TabVoyanceEmail', 'Navigation', 12);">Voyance Email 3Q/12‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp" target="_blank" rel="noopener noreferrer" data-keywords="retour|ex|amour|reconqu√©rir|s√©paration|copain|copine" data-exact="retour ex" data-url="https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp" onclick="trackClick('TabRetourEx', 'Navigation', 175);">Retour Ex/175‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp" target="_blank" rel="noopener noreferrer" data-keywords="compatibilit√©|couple|relation|amoureuse" data-exact="compatibilit√©" data-url="https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp" onclick="trackClick('TabCompatibilite', 'Navigation', 20);">Compatibilit√©/20‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp" target="_blank" rel="noopener noreferrer" data-keywords="purification|protection|sort|envo√ªtement|magie|sorcellerie|fatigue|cauchemars" data-exact="purification" data-url="https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp" onclick="trackClick('TabPurification', 'Navigation', 150);">Purification/150‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp" target="_blank" rel="noopener noreferrer" data-keywords="d√©funt|mort|message|deuil|d√©c√©d√©" data-exact="d√©funt" data-url="https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp" onclick="trackClick('TabDefunt', 'Navigation', 17);">D√©funt/17‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp" target="_blank" rel="noopener noreferrer" data-keywords="sant√©|m√©decine|bien-√™tre|maladie" data-exact="sant√©" data-url="https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp" onclick="trackClick('TabSante', 'Navigation', 30);">Sant√©/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp" target="_blank" rel="noopener noreferrer" data-keywords="main|chiromancie|ligne|paume" data-exact="main" data-url="https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp" onclick="trackClick('TabMain', 'Navigation', 10);">Main/10‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp" target="_blank" rel="noopener noreferrer" data-keywords="ange|gardien|c√©leste|protection divine" data-exact="ange" data-url="https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp" onclick="trackClick('TabAnge', 'Navigation', 10);">Ange/10‚Ç¨</a></li>
    </ul>
  </nav>
  
  <!-- LOGO -->
  <header>
    <picture>
      <source srcset="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
      <img src="https://i.imgur.com/GmyGlKk.jpg" alt="Logo ClairVoyanceMedium" class="logo" width="720" height="720" loading="eager" decoding="async" fetchpriority="high">
    </picture>
  </header>
  
  <div class="chat-intro">Chat IA Spirituel - ClairVoyanceGPT</div>
  
  <!-- CHAT -->
  <div id="chat-container">
    <div id="chat-box">
      <div id="chat-messages"></div>
      <form id="chat-form">
        <div class="input-row">
          <input type="text" id="chat-input" placeholder="Votre question..." autocomplete="off">
          <button type="button" id="voice-toggle" title="Assistant vocal">üé§</button>
        </div>
        <button type="submit" id="chat-send" onclick="trackClick('ChatMessageSent', 'Engagement', 1);">Envoyer</button>
      </form>
    </div>
  </div>
  
  <div class="return-line">
    <a href="https://www.clairvoyancemedium.com/">Retour vers le cabinet de voyance ClairVoyanceMedium.com</a>
  </div>
  
  <!-- BOUTON FLOTTANT -->
  <a id="floating-tab" class="floating-tab" href="#" target="_blank" rel="noopener noreferrer" onclick="trackClick('FloatingTabClicked', 'Conversion', 1);">
    <span class="close-btn" onclick="event.preventDefault();event.stopPropagation();document.getElementById('floating-tab').classList.remove('show');trackClick('FloatingTabClosed', 'Interaction', 0);return false;">√ó</span>
    <span id="floating-text">Ce qu'il vous faut !</span>
  </a>
  
  <footer>
    <p>¬© 2006-<span id="current-year"></span> ClairVoyanceMedium.com - Tous droits r√©serv√©s</p>
    <p><a href="https://www.clairvoyancemedium.com/Conditions-Generales-des-Ventes-et-d-Utilisation-ccsaaaaaa.asp" target="_blank" rel="noopener noreferrer">Conditions G√©n√©rales</a></p>
  </footer>
  
  <script>
document.getElementById('current-year').textContent = new Date().getFullYear();

function trackClick(label, category, value) {
  if (typeof gtag === 'function') {
    gtag('event', label, {'event_category': category, 'event_label': label, 'value': value});
  }
}

let userName = '';
let userNameConfirmed = false;
let pendingName = '';
let messageCount = 0;
let voiceEnabled = true;
let recognition = null;
let currentBlinkingTab = null;
let nonUnderstoodCount = 0;

const PHONE_NUMBER = "+33695468923";
const PHONE_DISPLAY = "06 95 46 89 23";

// GESTION M√âMOIRE 24H
const STORAGE_KEY = 'clairvoyance_chat_history';
const STORAGE_TIMESTAMP = 'clairvoyance_chat_timestamp';
const SESSION_KEY = 'clairvoyance_session_active';

// Sauvegarder conversation
function saveConversation() {
  const data = {
    messages: Array.from(document.getElementById('chat-messages').children).map(p => ({
      text: p.textContent,
      isBot: p.className === 'bot-message'
    })),
    userName,
    userNameConfirmed,
    messageCount
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  localStorage.setItem(STORAGE_TIMESTAMP, Date.now().toString());
  localStorage.setItem(SESSION_KEY, 'true');
}

// Charger conversation si < 24h ET session active
function loadConversation() {
  const timestamp = localStorage.getItem(STORAGE_TIMESTAMP);
  const sessionActive = localStorage.getItem(SESSION_KEY);
  
  if (!timestamp || !sessionActive) return false;
  
  const age = Date.now() - parseInt(timestamp);
  const twentyFourHours = 24 * 60 * 60 * 1000;
  
  // Si > 24h OU session ferm√©e ‚Üí reset
  if (age > twentyFourHours || sessionActive !== 'true') {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STORAGE_TIMESTAMP);
    localStorage.removeItem(SESSION_KEY);
    return false;
  }
  
  const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
  if (!data) return false;
  
  // Restaurer conversation
  const messagesDiv = document.getElementById('chat-messages');
  messagesDiv.innerHTML = '';
  data.messages.forEach(msg => {
    const p = document.createElement('p');
    p.className = msg.isBot ? 'bot-message' : 'user-message';
    p.textContent = msg.text;
    messagesDiv.appendChild(p);
  });
  
  userName = data.userName || '';
  userNameConfirmed = data.userNameConfirmed || false;
  messageCount = data.messageCount || 0;
  
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  return true;
}

// D√©tecter sortie du site (fermeture onglet/navigation)
window.addEventListener('beforeunload', () => {
  localStorage.setItem(SESSION_KEY, 'false');
});

// Au chargement : restaurer si possible
const conversationRestored = loadConversation();

// LISTE DES URLs DES ONGLETS (pour filtrer)
const TAB_URLS = [
  'https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/',
  'https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp',
  'https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp',
  'https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp',
  'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp',
  'https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp',
  'https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp',
  'https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp',
  'https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp'
];

// DRAG AND DROP FLUIDE - NE PAS BLOQUER LE CLIC
let isDragging = false;
let hasMoved = false;
let startX, startY, offsetX = 0, offsetY = 0;
const floatingTab = document.getElementById('floating-tab');

floatingTab.addEventListener('mousedown', dragStart);
floatingTab.addEventListener('touchstart', dragStart, {passive: false});

function dragStart(e) {
  if (e.target.classList.contains('close-btn')) {
    e.preventDefault();
    e.stopPropagation();
    floatingTab.classList.remove('show');
    return;
  }
  
  isDragging = true;
  hasMoved = false;
  const touch = e.type === 'touchstart' ? e.touches[0] : e;
  startX = touch.clientX - offsetX;
  startY = touch.clientY - offsetY;
  
  floatingTab.style.transition = 'none';
}

document.addEventListener('mousemove', drag);
document.addEventListener('touchmove', drag, {passive: false});

function drag(e) {
  if (!isDragging) return;
  
  const touch = e.type === 'touchmove' ? e.touches[0] : e;
  const moveX = touch.clientX - startX;
  const moveY = touch.clientY - startY;
  
  // Si mouvement > 5px, consid√©rer comme drag (pas clic)
  if (Math.abs(moveX - offsetX) > 5 || Math.abs(moveY - offsetY) > 5) {
    hasMoved = true;
    e.preventDefault();
  }
  
  offsetX = moveX;
  offsetY = moveY;
  
  floatingTab.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
}

document.addEventListener('mouseup', dragEnd);
document.addEventListener('touchend', dragEnd);

function dragEnd(e) {
  if (isDragging) {
    isDragging = false;
    floatingTab.style.transition = 'box-shadow 0.3s ease';
    
    // Si pas de mouvement significatif, laisser le clic se propager
    if (!hasMoved) {
      // Le href natif fonctionnera
      return;
    } else {
      // Bloquer le clic si c'√©tait un drag
      e.preventDefault();
    }
  }
}

// VOIX HOMME GRAVE
function speak(text) {
  if (!voiceEnabled || !('speechSynthesis' in window)) return;
  
  let textToSpeak = text.replace(/https?:\/\/[^\s]+/g, '');
  
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(textToSpeak);
  utterance.lang = 'fr-FR';
  
  const voices = window.speechSynthesis.getVoices();
  const maleVoice = voices.find(v => 
    v.lang.startsWith('fr') && (
      v.name.toLowerCase().includes('thomas') ||
      v.name.toLowerCase().includes('daniel') ||
      v.name.toLowerCase().includes('male')
    )
  );
  
  if (maleVoice) utterance.voice = maleVoice;
  
  utterance.pitch = 0.4;
  utterance.rate = 1.2;
  utterance.volume = 1.0;
  
  window.speechSynthesis.speak(utterance);
}

if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = () => {
    window.speechSynthesis.getVoices();
  };
}

// RECONNAISSANCE VOCALE
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('chat-input').value = transcript;
    handleMessage();
  };
}

document.getElementById('voice-toggle').addEventListener('click', () => {
  voiceEnabled = !voiceEnabled;
  document.getElementById('voice-toggle').classList.toggle('disabled', !voiceEnabled);
  if (voiceEnabled && recognition) {
    try { recognition.start(); } catch(e) {}
  } else if (recognition) {
    recognition.stop();
  }
});

function addMessage(text, isBot = false) {
  const messagesDiv = document.getElementById('chat-messages');
  const messageDiv = document.createElement('p');
  messageDiv.className = isBot ? 'bot-message' : 'user-message';
  messageDiv.textContent = text;
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  if (isBot && voiceEnabled) speak(text);
  
  // Sauvegarder apr√®s chaque message
  saveConversation();
}

// CLIGNOTER ONGLETS - PAS DE CONFUSION
function blinkTab(exactMatch) {
  if (currentBlinkingTab) {
    currentBlinkingTab.classList.remove('blink');
  }
  
  const navLinks = document.querySelectorAll('nav ul li a');
  navLinks.forEach(link => {
    const linkExact = link.getAttribute('data-exact');
    if (linkExact && linkExact.toLowerCase() === exactMatch.toLowerCase()) {
      link.classList.add('blink');
      currentBlinkingTab = link;
      link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      trackClick('TabBlinked_' + exactMatch.replace(/\s+/g, '_'), 'ChatInteraction', 0);
    }
  });
}

// ONGLET FLOTTANT CLIQUABLE - CORRECTION HREF
function showFloatingTab(url, isPhoneNumber = false) {
  const floatingText = document.getElementById('floating-text');
  
  if (isPhoneNumber) {
    floatingTab.href = `tel:${url}`;
    floatingText.textContent = `0695468923 ‚Ä¢ 24h/7j`;
  } else {
    floatingTab.href = url;
    floatingText.textContent = `Ce qu'il vous faut ${userName} !`;
  }
  
  floatingTab.classList.add('show');
  
  // IMPORTANT : Supprimer onclick qui bloque le href
  floatingTab.onclick = null;
  
  trackClick('FloatingTabDisplayed', 'Interaction', 0);
}

// BASE DE CONNAISSANCES - AJOUT FACILE
// FORMAT POUR AJOUTER : { keywords: "mot1|mot2", exactMatch: "nom-onglet", answer: (name) => `Texte ${name}`, url: 'https://...', isExternal: true }
const knowledgeBase = [
    { 
      keywords: "fatigue|lassitude|√©puisement|faiblesse|torpeur|fatig|√©puis√©|crev√©", 
      exactMatch: "purification", 
      answer: (name) => `${name}, cette fatigue √©crasante est l'≈ìuvre d'une entit√© obscure qui d√©vore votre √©nergie. Ces signes s'aggravent avec le temps. N'attendez pas que la situation devienne irr√©versible. Frederick, avec 25 ans d'exp√©rience et plus de 2800 purifications r√©alis√©es (96% de satisfaction), peut vous lib√©rer. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp', 
      isExternal: true 
    },

      [
  // VOYANCE T√âL√âPHONE ‚Äî OFFRES & DUR√âES
  {
    keywords: "t√©l√©phone|appel|parler|direct|vocal|voix|consulter au t√©l√©phone|voyance t√©l√©phonique",
    exactMatch: "t√©l√©phone",
    answer: (name) => `${name}, vous cherchez des r√©ponses imm√©diates ? La voyance par t√©l√©phone vous connecte √† Frederick en direct. Choisissez votre dur√©e : 5 min (8‚Ç¨), 10 min (15‚Ç¨), 20 min (22‚Ç¨ ‚Äî le plus demand√©), 30 min (30‚Ç¨), ou 45 min (38‚Ç¨). Votre premi√®re r√©ponse arrive dans les minutes qui suivent. Commandez maintenant via l'onglet qui s'illumine en haut de page.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  {
    keywords: "5 minutes|rapide|court|question express|peu de temps|juste une question",
    exactMatch: "5 minutes",
    answer: (name) => `${name}, une question pr√©cise m√©rite une r√©ponse nette. La formule 5 minutes √† 8‚Ç¨ vous donne l'essentiel sans d√©tour. Frederick va droit au but. Parfait pour lever un doute imm√©diat. L'onglet clignote en haut ‚Äî cliquez avant que le cr√©neau soit pris.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-5-minutes-cbaaaaaZa.asp',
    isExternal: false
  },

  {
    keywords: "10 minutes|standard|normal|consultation courte|moyen|classique",
    exactMatch: "10 minutes",
    answer: (name) => `${name}, 10 minutes suffisent pour poser 2-3 questions structur√©es. Tarif 15‚Ç¨. Frederick entre en connexion, capte l'essentiel, vous √©claire sans fioriture. Ceux qui h√©sitent regrettent. L'onglet illumin√© en haut vous attend.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-10-minutes-cbaaaaaqa.asp',
    isExternal: false
  },

  {
    keywords: "20 minutes|plus demand√©|populaire|moyen+|recommand√©|best seller",
    exactMatch: "20 minutes",
    answer: (name) => `${name}, la formule 20 minutes √† 22‚Ç¨ est la plus choisie. Pourquoi ? Assez de temps pour explorer en profondeur sans tourner en rond. Frederick d√©ploie ses capacit√©s m√©diumniques compl√®tement. Vous repartez avec clart√© et direction. Le tarif monte bient√¥t ‚Äî profitez maintenant via l'onglet en haut.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-20-minutes-cbaaaaapa.asp',
    isExternal: false
  },

  {
    keywords: "30 minutes|long|approfondi|d√©taill√©|complet|plusieurs sujets",
    exactMatch: "30 minutes",
    answer: (name) => `${name}, 30 minutes √† 30‚Ç¨ permettent d'aborder plusieurs aspects : amour, travail, sant√©. Frederick prend le temps de creuser chaque zone d'ombre. Vous sortez transform√©, pas juste inform√©. L'onglet en haut pulse ‚Äî commandez avant rupture de cr√©neaux.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-30-minutes-cbaaaaaoa.asp',
    isExternal: false
  },

  {
    keywords: "45 minutes|tr√®s long|s√©ance compl√®te|tout voir|grand travail|session intense",
    exactMatch: "45 minutes",
    answer: (name) => `${name}, 45 minutes √† 38‚Ç¨ c'est une plong√©e totale. Frederick balaie tout : pass√©, pr√©sent, futurs possibles, blocages invisibles. Vous ressortez avec un plan d'action spirituel pr√©cis. Ne laissez pas passer ce tarif exceptionnel ‚Äî cliquez l'onglet maintenant.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-45min-cbaaaaafa.asp',
    isExternal: false
  },

  // OBJECTIONS ‚Äî PRIX
  {
    keywords: "cher|trop cher|prix √©lev√©|co√ªteux|expensive|budget|pas les moyens",
    exactMatch: "cher",
    answer: (name) => `${name}, 8‚Ç¨ pour 5 minutes c'est moins qu'un menu fast-food. La diff√©rence ? Ici vous investissez dans votre paix int√©rieure, pas dans des calories vides. Frederick facture au temps r√©el, aucun pi√®ge. Combien vaut une r√©ponse qui change votre vie ? L'onglet en haut clignote ‚Äî agissez.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  {
    keywords: "augmentation|hausse prix|tarif va monter|bient√¥t plus cher|profiter maintenant",
    exactMatch: "augmentation",
    answer: (name) => `${name}, les tarifs actuels sont temporaires. Frederick augmente ses prix sous 10 jours pour limiter les demandes croissantes. Aujourd'hui, 20 min = 22‚Ç¨. Demain, peut-√™tre 35‚Ç¨. Votre fen√™tre se referme. L'onglet en haut vous offre encore l'ancien tarif.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  // OBJECTIONS ‚Äî EFFICACIT√â / L√âGITIMIT√â
  {
    keywords: "√ßa marche|vraiment efficace|r√©sultats|preuve|fonctionne|concret|arnaque ou pas",
    exactMatch: "efficace",
    answer: (name) => `${name}, Frederick ne pr√©dit pas le loto ‚Äî il capte les √©nergies r√©elles de votre situation. Ses clients reviennent parce que ses visions se v√©rifient dans les semaines qui suivent. Pas de promesses magiques, juste des perceptions extrasensorielles v√©rifiables. Testez 5 min √† 8‚Ç¨ et jugez. L'onglet en haut vous attend.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  {
    keywords: "fiable|s√©rieux|cr√©dible|vrai voyant|arnaque|fake|charlatan|authentique",
    exactMatch: "fiable",
    answer: (name) => `${name}, Frederick exerce depuis 20 ans, aucun num√©ro surtax√©, aucun engagement mensuel, paiement s√©curis√©. Vous payez pour du temps r√©el, pas pour des promesses vides. Les t√©moignages parlent d'eux-m√™mes. Un vrai professionnel n'a pas besoin de vous pi√©ger. Commandez via l'onglet illumin√© maintenant.`,
    url: 'https://www.clairvoyancemedium.com/Temoignages-ccgaaaaaa.asp',
    isExternal: false
  },

  // OBJECTIONS ‚Äî COMPARAISON / DOUTE
  {
    keywords: "autre voyant|comparaison|concurrent|mieux ailleurs|pourquoi vous|diff√©rence",
    exactMatch: "autre voyant",
    answer: (name) => `${name}, ailleurs vous tombez sur des plateformes √† 2‚Ç¨/min avec des "voyants" interchangeables. Ici, c'est Frederick, un m√©dium reconnu, tarif fixe transparent, sans file d'attente floue. Vous ne payez pas une marque, vous payez une capacit√© m√©diumnique rare. L'onglet en haut clignote ‚Äî choisissez la clart√©.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  {
    keywords: "gratuit|voyance gratuite|essai gratuit|premi√®re consultation offerte|cadeau",
    exactMatch: "gratuit",
    answer: (name) => `${name}, le "gratuit" en voyance cache des num√©ros surtax√©s ou des arnaques psychologiques. Frederick ne joue pas ce jeu. 8‚Ç¨ pour 5 min = transparence totale. Vous voulez du s√©rieux ou du marketing ? L'onglet en haut pulse pour ceux qui veulent des r√©ponses vraies, pas des illusions.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  // OBJECTIONS ‚Äî CONFIDENTIALIT√â / PEUR JUGEMENT
  {
    keywords: "discret|confidentiel|secret|anonymat|peur jugement|honte|personne le saura",
    exactMatch: "confidentiel",
    answer: (name) => `${name}, ce qui se dit au t√©l√©phone avec Frederick reste entre vous deux. Aucune trace publique, aucun enregistrement partag√©, paiement s√©curis√© anonyme. Lib√©rez vos questions les plus intimes sans crainte. L'onglet en haut vous ouvre la porte ‚Äî franchissez-la.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  // OBJECTIONS ‚Äî D√âLAI / DISPONIBILIT√â
  {
    keywords: "quand|disponible|horaire|rendez-vous|attente|combien de temps|imm√©diat",
    exactMatch: "disponible",
    answer: (name) => `${name}, apr√®s commande, Frederick vous contacte sous 24-48h pour fixer l'appel. Pas d'attente interminable. Vous choisissez votre cr√©neau ensemble. Plus vous commandez t√¥t, plus vite vous √™tes appel√©. L'onglet en haut brille ‚Äî r√©servez votre place maintenant.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  {
    keywords: "urgent|imm√©diat|tout de suite|maintenant|rapidement|besoin vite",
    exactMatch: "urgent",
    answer: (name) => `${name}, la formule 5 minutes √† 8‚Ç¨ est parfaite pour une urgence. Commandez maintenant, Frederick organise l'appel en priorit√© d√®s r√©ception. Votre r√©ponse arrive dans les heures, pas dans des semaines. L'onglet en haut pulse ‚Äî cliquez.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-5-minutes-cbaaaaaZa.asp',
    isExternal: false
  },

  // OBJECTIONS ‚Äî PEUR DE L'ENGAGEMENT
  {
    keywords: "abonnement|engagement|annuler|r√©silier|pi√®ge|mensuel|reconduction",
    exactMatch: "abonnement",
    answer: (name) => `${name}, aucun abonnement, aucune reconduction tacite. Vous achetez un appel unique, vous le recevez, c'est termin√©. Vous revenez seulement si vous le souhaitez. Frederick ne retient personne. Commandez en toute libert√© via l'onglet en haut.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  // D√âCLENCHEURS √âMOTIONNELS ‚Äî AMOUR
  {
    keywords: "amour|relation|couple|retour ex|rupture|mariage|s√©paration|rencontre",
    exactMatch: "amour",
    answer: (name) => `${name}, l'amour en suspens vous ronge chaque jour. Frederick capte les √©nergies invisibles entre vous et l'autre : blocages, intentions cach√©es, timing cosmique. 20 minutes √† 22‚Ç¨ vous √©vitent des mois d'angoisse. Votre c≈ìur m√©rite la v√©rit√© ‚Äî l'onglet en haut vous l'offre maintenant.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-20-minutes-cbaaaaapa.asp',
    isExternal: false
  },

  // D√âCLENCHEURS √âMOTIONNELS ‚Äî TRAVAIL / ARGENT
  {
    keywords: "travail|emploi|carri√®re|argent|finance|business|reconversion|promotion|job",
    exactMatch: "travail",
    answer: (name) => `${name}, stagner professionnellement co√ªte plus cher qu'une consultation. Frederick identifie les opportunit√©s cach√©es et les pi√®ges √©nerg√©tiques dans votre parcours pro. 30 minutes √† 30‚Ç¨ peuvent d√©bloquer des ann√©es de frustration. L'onglet en haut clignote ‚Äî investissez sur vous.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-30-minutes-cbaaaaaoa.asp',
    isExternal: false
  },

  // D√âCLENCHEURS √âMOTIONNELS ‚Äî SANT√â / BIEN-√äTRE
  {
    keywords: "sant√©|maladie|gu√©rison|√©nergie|fatigue|stress|burn-out|bien-√™tre",
    exactMatch: "sant√©",
    answer: (name) => `${name}, les blocages √©nerg√©tiques cr√©ent des sympt√¥mes physiques. Frederick d√©tecte ce que la m√©decine classique ne voit pas : parasites √©nerg√©tiques, charges karmiques, influences n√©fastes. 20 minutes √† 22‚Ç¨ pour retrouver votre vitalit√©. L'onglet en haut pulse ‚Äî agissez avant que le corps c√®de.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-20-minutes-cbaaaaapa.asp',
    isExternal: false
  },

  // D√âCLENCHEURS √âMOTIONNELS ‚Äî DOUTE EXISTENTIEL
  {
    keywords: "sens|direction|perdu|pourquoi|mission|but|chemin de vie|destin√©e",
    exactMatch: "sens",
    answer: (name) => `${name}, tourner en rond sans savoir pourquoi d√©truit l'√¢me lentement. Frederick r√©v√®le votre mission de vie, les le√ßons karmiques en cours, le cap √† reprendre. 45 minutes √† 38‚Ç¨ pour enfin comprendre le plan invisible. L'onglet en haut vous tend la carte ‚Äî saisissez-la.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-45min-cbaaaaafa.asp',
    isExternal: false
  },

  // PAIEMENT / S√âCURIT√â
  {
    keywords: "paiement|payer|carte bancaire|s√©curis√©|paypal|virement|arnaque paiement",
    exactMatch: "paiement",
    answer: (name) => `${name}, paiement 100% s√©curis√© par plateforme bancaire certifi√©e. Aucun stockage de vos donn√©es. Vous validez, vous recevez confirmation imm√©diate. Frederick ne voit jamais vos infos bancaires. L'onglet en haut garantit votre transaction ‚Äî commandez sereinement.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  // QUESTIONS TECHNIQUES
  {
    keywords: "comment √ßa marche|d√©roulement|processus|√©tapes|proc√©dure|je fais quoi",
    exactMatch: "comment √ßa marche",
    answer: (name) => `${name}, simple comme bonjour : vous commandez la dur√©e voulue via l'onglet en haut, Frederick vous contacte sous 48h pour fixer l'appel ensemble, il vous appelle au cr√©neau choisi. Pas de plateforme compliqu√©e, juste un √©change direct. Commencez maintenant.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  {
    keywords: "pr√©parer|questions √† poser|comment poser|formuler|quoi demander",
    exactMatch: "pr√©parer",
    answer: (name) => `${name}, notez vos 2-3 questions principales avant l'appel. Soyez pr√©cis : "Vais-je retrouver du travail ?" plut√¥t que "Ma vie ?". Frederick capte mieux avec des intentions claires. 10 minutes √† 15‚Ç¨ suffisent si vous √™tes pr√©par√©. L'onglet en haut attend votre commande.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-par-telephone-10-minutes-cbaaaaaqa.asp',
    isExternal: false
  },

  // RELIGION / CROYANCES
  {
    keywords: "religion|dieu|p√©ch√©|diable|chr√©tien|musulman|compatible foi|interdit",
    exactMatch: "religion",
    answer: (name) => `${name}, la m√©diumnit√© capte des √©nergies universelles, pas des entit√©s religieuses. Frederick respecte toutes les croyances. Beaucoup de croyants consultent pour discerner la guidance divine des illusions humaines. Votre foi reste intacte. L'onglet en haut ne juge pas ‚Äî il √©claire.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  // GARANTIE / REMBOURSEMENT
  {
    keywords: "garantie|remboursement|satisfait ou rembours√©|pas content|d√©√ßu|ne marche pas",
    exactMatch: "garantie",
    answer: (name) => `${name}, Frederick garantit une lecture honn√™te de vos √©nergies. Si l'appel ne se connecte pas techniquement, remboursement int√©gral. Si vous n'aimez pas la v√©rit√© per√ßue, c'est votre choix de ne pas revenir ‚Äî pas un d√©faut de prestation. Commandez sans risque via l'onglet en haut.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  // GAP SELLING ‚Äî IDENTIT√â FUTURE
  {
    keywords: "apr√®s consultation|changement|transformation|r√©sultat|ce que je deviens",
    exactMatch: "apr√®s",
    answer: (name) => `${name}, apr√®s l'appel, vous ne serez plus la personne qui doute. Vous devenez celui qui sait, qui agit align√©, qui refuse les pi√®ges invisibles. Frederick ne vous donne pas des pr√©dictions ‚Äî il vous rend votre pouvoir de d√©cision. L'onglet en haut lance votre m√©tamorphose. Cliquez.`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  },

  // DOULEUR DE L'INACTION
  {
    keywords: "attendre|plus tard|r√©fl√©chir|h√©siter|pas s√ªr|je verrai|peut-√™tre",
    exactMatch: "attendre",
    answer: (name) => `${name}, chaque jour d'h√©sitation est un jour de plus dans le brouillard. Les tarifs montent, les cr√©neaux se remplissent, et vos probl√®mes s'enracinent. Frederick ne supplie personne ‚Äî il guide ceux qui choisissent d'avancer. L'onglet en haut clignote pour les d√©cideurs. √ätes-vous l'un d'eux ?`,
    url: 'https://www.clairvoyancemedium.com/Voyance-Telephone-cbbaaaaaa.asp',
    isExternal: false
  }
]
  
    { 
      keywords: "cauchemars|visions|nuits|songe|dormir|r√™ves|insomnie|nuit blanche", 
      exactMatch: "purification", 
      answer: (name) => `Vos nuits tourment√©es, ${name}, ne sont pas anodines. Une pr√©sence mal√©fique hante votre sommeil. Chaque jour qui passe renforce l'emprise de ces √©nergies. Agissez maintenant avant qu'il ne soit trop tard. Frederick peut chasser ces ombres. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp', 
      isExternal: true 
    },
    { 
      keywords: "sort|mal√©diction|envo√ªtement|magie|sorcellerie|sor|envout|mal√©fice", 
      exactMatch: "purification", 
      answer: (name) => `${name}, tous ces signes concordent : vous √™tes sous l'emprise d'un sort. L'envo√ªtement s'enracine dangereusement. Sans intervention rapide, les d√©g√¢ts pourraient devenir permanents. Frederick ma√Ætrise les rituels ancestraux pour briser ces liens. Plus de 1600 personnes d√©j√† lib√©r√©es (97% de succ√®s). Un onglet s'illumine en haut de la page. Cliquez dessus pour d√©marrer votre lib√©ration avant qu'il ne soit trop tard.`, 
      url: 'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp', 
      isExternal: true 
    },
    { 
      keywords: "t√©l√©phone|appel|telephoner|appeler|tel|phone", 
      exactMatch: "voyance t√©l√©phone", 
      answer: (name) => `${name}, vous cherchez des r√©ponses imm√©diates ? Consultation t√©l√©phonique avec Frederick : 30 minutes √† 30 euros, mais aussi 15‚Ç¨ les 10 minutes ou 22‚Ç¨ les 20 minutes sur le site. Ces tarifs exceptionnels sont temporaires. Plus de 1500 consultations r√©alis√©es, 96% de satisfaction. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/', 
      isExternal: false 
    },
    { 
      keywords: "numero|num√©ro|contacter|joindre|coordonn√©es", 
      exactMatch: "voyance t√©l√©phone", 
      answer: (name) => `${name}, voici le num√©ro de Frederick : ${PHONE_DISPLAY}. Disponible 24h/7j pour vous guider. Un bouton vient d'appara√Ætre √† droite. Cliquez dessus pour l'appeler directement.`, 
      url: PHONE_NUMBER, 
      isPhone: true 
    },
    { 
      keywords: "email|mail|question|√©crit|message|3questions|courriel", 
      exactMatch: "voyance email", 
      answer: (name) => `${name}, la voyance par email est id√©ale : 3 questions pour 12 euros, r√©ponse sous 4 heures. Plus de 2200 consultations r√©alis√©es, 95% de satisfaction ! Ces tarifs sont sur le point d'augmenter. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp', 
      isExternal: false 
    },
    { 
      keywords: "ex|s√©paration|rupture|retour|reconqu√©rir|copain|copine|revenir|r√©cup√©rer", 
      exactMatch: "retour ex", 
      answer: (name) => `Cette douleur, ${name}, est insupportable. Frederick a r√©concili√© plus de 500 couples en 25 ans. Son rituel de retour affectif agit en 2 √† 4 semaines. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp', 
      isExternal: false 
    },
    { 
      keywords: "compatibilit√©|compatible|affinit√©|couple|relation|amoureuse", 
      exactMatch: "compatibilit√©", 
      answer: (name) => `${name}, d√©couvrez si votre relation est align√©e avec les astres. Frederick analyse votre compatibilit√© amoureuse en profondeur. Chaque jour sans cette connaissance est un risque pour votre avenir √† deux. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp', 
      isExternal: false 
    },
    { 
      keywords: "d√©funt|mort|d√©c√©d√©|message|deuil|au-del√†|disparu|perdu quelqu'un", 
      exactMatch: "d√©funt", 
      answer: (name) => `${name}, perdre un √™tre cher laisse tant de questions sans r√©ponse. Le temps efface les souvenirs, mais Frederick communique avec l'au-del√†. Pour 17 euros, recevez un message authentique qui apaisera votre c≈ìur. N'attendez pas que le lien spirituel s'affaiblisse. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp', 
      isExternal: false 
    },
    { 
      keywords: "sant√©|maladie|douleur|gu√©rison|corps|souffrance|mal|malade", 
      exactMatch: "sant√©", 
      answer: (name) => `Ces maux, ${name}, ont peut-√™tre des racines √©nerg√©tiques ignor√©es par la m√©decine traditionnelle. Chaque jour sans r√©ponse laisse ces d√©s√©quilibres s'aggraver. Frederick identifie ces blocages avec 25 ans d'approche holistique. Analyse : 30 euros. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp', 
      isExternal: false 
    },
    { 
      keywords: "main|chiromancie|ligne|paume|lignes de la main", 
      exactMatch: "main", 
      answer: (name) => `Vos mains, ${name}, sont une carte vivante de votre destin√©e. Les lignes changent avec le temps ‚Äì ce que vous lisez aujourd'hui pourrait dispara√Ætre demain. Frederick d√©chiffre ces symboles depuis 25 ans. Pour 10 euros, d√©couvrez vos secrets avant qu'il ne soit trop tard. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp', 
      isExternal: false 
    },,
    { 
      keywords: "ange|gardien|c√©leste|protection divine|ange gardien", 
      exactMatch: "ange", 
      answer: (name) => `Votre ange, ${name}, tente de communiquer avec vous en ce moment m√™me. Ses messages s'affaiblissent si vous ne les √©coutez pas. Frederick capte ces vibrations divines. Pour 10 euros, recevez sa guidance avant que la connexion ne se perde. Un onglet s'illumine en haut de la page. Cliquez dessus pour encore profiter du tarif temporaire avant importante augmentation √† venir.`, 
      url: 'https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp', 
      isExternal: false 
    }
];

function removeAccents(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function levenshteinDistance(a, b) {
    const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
    for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
    for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
    for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
            const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + indicator);
        }
    }
    return matrix[b.length][a.length];
}

function phoneticNormalize(str) {
    return removeAccents(str)
        .replace(/ph/g, "f")
        .replace(/k/g, "c")
        .replace(/qu/g, "k")
        .replace(/ss/g, "s")
        .replace(/√©e/g, "e")
        .replace(/ai/g, "e")
        .replace(/au/g, "o")
        .replace(/ou/g, "u")
        .replace(/oi/g, "oa")
        .replace(/y/g, "i")
        .replace(/w/g, "v")
        .replace(/x/g, "ks")
        .replace(/z/g, "s")
        .replace(/j/g, "g")
        .replace(/ch/g, "sh");
}

function findBestMatch(userInput) {
    const userLower = phoneticNormalize(userInput.toLowerCase());
    const userWords = userLower.split(/\s+/);
    let bestMatch = null;
    let maxScore = 0;
    
    // MOTS EXCLUSIFS pour √©viter confusion
    const hasEmail = /\b(email|mail|√©crit|courriel|mel)\b/i.test(userInput);
    const hasTelephone = /\b(t√©l√©phone|tel|appel|appeler|telephoner|phone|fon)\b/i.test(userInput);
    
    knowledgeBase.forEach(item => {
        let score = 0;
        const keywords = item.keywords.split('|');
        
        // EXCLUSION : si email mentionn√©, ne PAS matcher t√©l√©phone
        if (hasEmail && item.exactMatch === 'voyance t√©l√©phone') return;
        if (hasTelephone && item.exactMatch === 'voyance email') return;
        
        keywords.forEach(keyword => {
            const normalizedKeyword = phoneticNormalize(keyword.trim().toLowerCase());
            
            if (userLower.includes(normalizedKeyword)) {
                score += normalizedKeyword.length * 10;
            }
            
            userWords.forEach(userWord => {
                // ACCEPTER MOTS DE 1 LETTRE (au lieu de 2)
                if (userWord.length >= 1) {
                    const distance = levenshteinDistance(userWord, normalizedKeyword);
                    const similarity = 1 - distance / Math.max(userWord.length, normalizedKeyword.length);
                    
                    // SEUIL ABAISS√â : 0.35 (65% d'erreur tol√©r√©)
                    if (similarity >= 0.35) {
                        score += similarity * normalizedKeyword.length * 5;
                    }
                }
            });
        });
        
        if (score > maxScore) {
            maxScore = score;
            bestMatch = item;
        }
    });
    
    return maxScore > 0.8 ? bestMatch : null;
}

function handleMessage() {
  const input = document.getElementById('chat-input');
  const userMsg = input.value.trim();
  
  if (!userMsg) return;
  
  addMessage(userMsg, false);
  input.value = '';
  messageCount++;
  
  setTimeout(() => {
    const lowerMsg = userMsg.toLowerCase().trim();
    
    // GESTION PR√âNOM
    if (!userNameConfirmed) {
      // Bonjour initial
      if (lowerMsg === "bonjour" || lowerMsg.startsWith("bonjour")) {
        addMessage("Bonjour ! Je suis ClairVoyanceGPT, votre assistant spirituel. Avant de commencer cette consultation, pouvez-vous m'indiquer votre pr√©nom ?", true);
        return;
      }
      
      // Confirmation pr√©nom en attente
      if (pendingName) {
        if (lowerMsg === "oui" || lowerMsg === "oui c'est √ßa" || lowerMsg === "oui c'est bien √ßa") {
          userName = pendingName;
          userNameConfirmed = true;
          pendingName = '';
          addMessage(`Parfait ${userName} ! Comment puis-je vous aider aujourd'hui ?`, true);
          return;
        } else if (lowerMsg === "non") {
          pendingName = '';
          addMessage("Alors donnez-moi votre pr√©nom s'il vous pla√Æt.", true);
          return;
        }
      }
      
      // Extraction pr√©nom
      const nameMatch = userMsg.match(/\b([A-Z√Ä-√ñ√ò-√ùa-z√†-√∂√∏-√ø]{2,})\b/);
      if (nameMatch) {
        pendingName = nameMatch[1].charAt(0).toUpperCase() + nameMatch[1].slice(1).toLowerCase();
        addMessage(`Tr√®s bien ${pendingName}, c'est bien votre pr√©nom ?`, true);
        return;
      }
      
      addMessage("Je n'ai pas bien saisi votre pr√©nom. Pouvez-vous me le donner clairement s'il vous pla√Æt ?", true);
      return;
    }
    
    // AU REVOIR
    const goodbyeTriggers = ["au revoir", "aurevoir", "√† bient√¥t", "bye", "ciao"];
    if (goodbyeTriggers.some(phrase => lowerMsg === phrase || lowerMsg.endsWith(phrase))) {
      addMessage(`${userName}, √† tr√®s bient√¥t ! Frederick et son √©quipe restent √† votre √©coute 24h/24.`, true);
      return;
    }
    
    // RECHERCHE DANS BASE
    const match = findBestMatch(userMsg);
    
    if (match) {
      const response = match.answer(userName);
      addMessage(response, true);
      
      blinkTab(match.exactMatch);
      
      // ONGLET FLOTTANT : uniquement liens HORS signets
      if (match.isPhone) {
        showFloatingTab(match.url, true);
      } else if (match.isExternal && !TAB_URLS.includes(match.url)) {
        showFloatingTab(match.url, false);
      }
      
      nonUnderstoodCount = 0;
    } else {
      nonUnderstoodCount++;
      
      if (nonUnderstoodCount === 1) {
        addMessage(`${userName}, je n'ai pas bien compris votre question. Pourriez-vous la reformuler ou v√©rifier l'orthographe s'il vous pla√Æt ?`, true);
      } else if (nonUnderstoodCount === 2) {
        addMessage(`${userName}, je ne comprends toujours pas. Essayez avec des mots simples : amour, voyance, protection, fatigue, d√©funt ?`, true);
      } else {
        addMessage(`${userName}, il semble difficile de nous comprendre. Peut-√™tre qu'un √©change direct serait plus efficace ? Frederick propose : t√©l√©phone (30‚Ç¨/30min), email (12‚Ç¨/3Q), ou rituel complet. Que pr√©f√©rez-vous ?`, true);
        nonUnderstoodCount = 0;
      }
    }
  }, 800);
}

document.getElementById('chat-send').addEventListener('click', (e) => {
  e.preventDefault();
  handleMessage();
});

document.getElementById('chat-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    handleMessage();
  }
});

document.getElementById('chat-form').addEventListener('submit', (e) => {
  e.preventDefault();
  handleMessage();
});

// Message d'accueil UNIQUEMENT si nouvelle conversation
if (!conversationRestored) {
  setTimeout(() => {
    const welcomeMessage = "Bienvenue sur ClairVoyanceGPT, l'assistant spirituel de Frederick, m√©dium reconnu depuis plus de 25 ans. Avant de commencer cet √©change, pouvez-vous m'indiquer dans un premier temps uniquement votre pr√©nom ?";
    addMessage(welcomeMessage, true);
    
    // Lecture vocale automatique avec fallback
    if (voiceEnabled && 'speechSynthesis' in window) {
      const tryAutoplay = () => {
        try {
          speak(welcomeMessage);
          trackClick('AutoplaySuccess', 'Voice', 0);
        } catch (err) {
          console.log('Autoplay bloqu√©, affichage bouton');
          showVoiceButton();
        }
      };
      
      // Tentative lecture imm√©diate
      if (document.readyState === 'complete') {
        tryAutoplay();
      } else {
        window.addEventListener('load', tryAutoplay);
      }
    }
  }, 500);
}

// Bouton fallback si autoplay bloqu√©
function showVoiceButton() {
  const messagesDiv = document.getElementById('chat-messages');
  const btnDiv = document.createElement('div');
  btnDiv.style.textAlign = 'center';
  btnDiv.style.margin = '1rem 0';
  btnDiv.innerHTML = `
    <button id="enable-voice-btn" style="
      padding:0.8rem 1.5rem;
      background:#000;
      color:#BBAE98;
      border:3px solid #FF6B6B;
      font-family:'Cinzel',serif;
      font-size:1rem;
      cursor:pointer;
      animation:blinkVoiceBtn 1.5s ease-in-out infinite;
      border-radius:0;
    ">
      üé§ Activer l'assistant vocal
    </button>
    <style>
      @keyframes blinkVoiceBtn {
        0%, 100% { box-shadow: 0 0 10px #FF6B6B; border-color: #FF6B6B; }
        50% { box-shadow: 0 0 20px #FF8787; border-color: #FF8787; }
      }
    </style>
  `;
  messagesDiv.appendChild(btnDiv);
  
  document.getElementById('enable-voice-btn').addEventListener('click', () => {
    const welcomeMsg = "Bienvenue sur ClairVoyanceGPT, l'assistant spirituel de Frederick, m√©dium reconnu depuis plus de 25 ans. Avant de commencer cet √©change, pouvez-vous m'indiquer dans un premier temps uniquement votre pr√©nom ?";
    speak(welcomeMsg);
    btnDiv.remove();
    trackClick('VoiceButtonClicked', 'Engagement', 1);
  });
}

// BLOQUER PULL-TO-REFRESH (seulement en haut de page)
let lastTouchY = 0;
let preventPullToRefresh = false;

document.addEventListener('touchstart', (e) => {
  if (e.touches.length !== 1) return;
  lastTouchY = e.touches[0].clientY;
  preventPullToRefresh = window.pageYOffset === 0;
}, {passive: false});

document.addEventListener('touchmove', (e) => {
  const touchY = e.touches[0].clientY;
  const touchYDelta = touchY - lastTouchY;
  lastTouchY = touchY;
  
  if (preventPullToRefresh) {
    if (touchYDelta > 0) {
      e.preventDefault();
      return;
    }
    preventPullToRefresh = false;
  }
}, {passive: false});
</script>
</body>
</html>


