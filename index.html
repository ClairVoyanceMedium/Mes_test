<!-- Styles et structure HTML du chat am√©lior√© -->
<style>
  /* Conteneur g√©n√©ral du chat avec effet n√©on sur la bo√Æte */
  #chat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    max-height: 450px;
    display: flex;
    flex-direction: column;
    z-index: 999999;
    font-family: Arial, sans-serif;
    cursor: move;
    transition: transform 0.2s;
  }
  /* Bouton de bascule */
  #chat-toggle {
    width: 60px;
    height: 60px;
    background: linear-gradient(145deg, #FFB6C1, #FF69B4);
    color: #fff;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255,105,180,0.7);
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    outline: none;
  }
  #chat-toggle:hover {
    transform: scale(1.05);
  }
  /* Bo√Æte de dialogue avec contour n√©on rose fluo */
  #chat-box {
    background: #111;
    border-radius: 10px;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-top: -10px;
    border: 2px solid #FF1493;
    box-shadow: 0 0 10px #FF1493;
    transition: all 0.3s ease;
  }
  /* Zone des messages avec effet fade-in */
  #chat-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    color: #fff;
  }
  #chat-messages p {
    margin-bottom: 0.5rem;
    line-height: 1.4;
    opacity: 0;
    animation: fadeIn 0.5s forwards;
  }
  @keyframes fadeIn {
    to { opacity: 1; }
  }
  /* Bulles de messages du bot avec effet n√©on rose */
  .bot-message {
    text-align: left;
    color: #fff;
    background: rgba(255,255,255,0.05);
    padding: 0.5rem;
    border-radius: 5px;
    margin-bottom: 0.8rem;
    display: inline-block;
    max-width: 80%;
    border: 2px solid #FF69B4;
    box-shadow: 0 0 8px #FF69B4;
    transition: border 0.3s, box-shadow 0.3s;
  }
  /* Bulles de messages de l'utilisateur avec effet n√©on bleu */
  .user-message {
    text-align: right;
    color: #ffd700;
    margin-bottom: 0.8rem;
    border: 2px solid #AED6F1;
    box-shadow: 0 0 8px #AED6F1;
    padding: 0.5rem;
    border-radius: 5px;
    display: inline-block;
    max-width: 80%;
    transition: border 0.3s, box-shadow 0.3s;
  }
  /* Formulaire de saisie */
  #chat-form {
    display: flex;
    border-top: 1px solid #333;
  }
  #chat-input {
    flex: 1;
    padding: 0.5rem;
    border: none;
    outline: none;
    color: #333;
    border-radius: 0 0 0 10px;
  }
  #chat-send {
    background: #87CEEB;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
    border-radius: 0 0 10px 0;
    transition: background 0.2s;
  }
  #chat-send:hover {
    background: #5eb6d1;
  }
  #chat-box.hidden {
    display: none;
  }
  @media(max-width: 400px) {
    #chat-container {
      width: 90%;
      right: 5%;
      bottom: 5px;
    }
  }
</style>

<div id="chat-container">
  <!-- Bouton de bascule du chat -->
  <button id="chat-toggle" aria-expanded="false" aria-label="Ouvrir le chat">üí¨</button>
  
  <!-- Bo√Æte de dialogue (initialement masqu√©e) -->
  <div id="chat-box" class="hidden" role="region" aria-label="Chat IA">
    <div id="chat-messages" aria-live="polite"></div>
    <form id="chat-form" aria-label="Formulaire de saisie pour le Tchat IA">
      <input type="text" id="chat-input" placeholder="Posez votre question..." aria-label="Tapez votre message ici" autocomplete="off">
      <button type="submit" id="chat-send" aria-label="Envoyer votre question">‚û§</button>
    </form>
  </div>
</div>

<!-- Script JavaScript pour un chat r√©actif et naturel -->
<script>
  // Fonction de tracking (simplifi√©e)
  function trackClick(label, category = 'Chat', value = null) {
    console.log("Tracking:", label, category, value);
  }

  // Base de connaissances sur les envo√ªtements et la d√©tection
  const knowledgeBase = [
    { question: "fatigue", answer: "Une fatigue incessante peut √™tre le signe d'un envo√ªtement. Pensez √† un rituel de d√©senvo√ªtement pour purifier votre √©nergie." },
    { question: "cauchemars", answer: "Des cauchemars r√©currents peuvent √™tre dus √† des influences n√©gatives. Un d√©senvo√ªtement pourrait ramener la paix dans vos nuits." },
    { question: "malchance", answer: "La malchance persistante est souvent li√©e √† des √©nergies n√©gatives. Une d√©tection (50‚Ç¨) ou un rituel (250‚Ç¨) pourrait clarifier votre situation." },
    { question: "tristesse", answer: "Une tristesse inexplicable peut √™tre li√©e √† des influences occultes. Un d√©senvo√ªtement pourrait restaurer votre joie de vivre." },
    { question: "col√®re", answer: "Une col√®re soudaine peut √™tre le signe d'une perturbation √©nerg√©tique. Un rituel de d√©senvo√ªtement pourrait apaiser ces √©nergies." },
    { question: "peur", answer: "Une peur irrationnelle peut provenir d'un envo√ªtement. Pensez √† une d√©tection ou √† un rituel pour vous lib√©rer de ces ombres." }
    // Vous pouvez enrichir cette base en ajoutant d'autres entr√©es.
  ];

  // Variable pour compter les incompr√©hensions cons√©cutives
  let nonUnderstoodCount = 0;
  const defaultNonUnderstood = "Je ne comprends pas bien."; // Cha√Æne utilis√©e pour tester la correspondance

  // Fonction pour v√©rifier si un mot est "connu"
  function containsUnknownWord(userMsg) {
    // S√©pare les mots en supprimant la ponctuation
    let words = userMsg.split(/\s+/);
    // Expression r√©guli√®re pour valider un mot (lettres, accents, tirets et apostrophes)
    const validRegex = /^[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'-]+$/;
    for (let word of words) {
      let cleanWord = word.replace(/[.,?!;:()"]/g, '');
      if (cleanWord && !validRegex.test(cleanWord)) {
        return true;
      }
    }
    return false;
  }

  // Calcul de la distance de Levenshtein pour une correspondance approximative
  function levenshtein(a, b) {
    const an = a ? a.length : 0, bn = b ? b.length : 0;
    if (!an) return bn;
    if (!bn) return an;
    let matrix = [];
    for (let i = 0; i <= bn; i++) {
      matrix[i] = [i];
    }
    for (let j = 0; j <= an; j++) {
      matrix[0][j] = j;
    }
    for (let i = 1; i <= bn; i++) {
      for (let j = 1; j <= an; j++) {
        const cost = b.charAt(i - 1) === a.charAt(j - 1) ? 0 : 1;
        matrix[i][j] = Math.min(
          matrix[i - 1][j] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j - 1] + cost
        );
      }
    }
    return matrix[bn][an];
  }

  // Recherche de la meilleure correspondance dans la base de connaissances
  function findBestMatch(userInput) {
    userInput = userInput.toLowerCase();
    let bestScore = Infinity, bestAnswer = null;
    knowledgeBase.forEach(item => {
      const dist = levenshtein(userInput, item.question.toLowerCase());
      if (dist < bestScore) {
        bestScore = dist;
        bestAnswer = item.answer;
      }
    });
    return bestScore > 5 ? defaultNonUnderstood : bestAnswer;
  }

  // Fonction qui renvoie la r√©ponse en fonction du message de l'utilisateur
  function getResponse(userMsg) {
    const lowerMsg = userMsg.toLowerCase().trim();
    // R√©ponses sp√©cifiques pour salutations et remerciements
    if (lowerMsg === "bonjour") {
      nonUnderstoodCount = 0;
      return "Je suis √† votre √©coute.";
    } else if (lowerMsg === "merci" || lowerMsg === "merci beaucoup") {
      nonUnderstoodCount = 0;
      return "Je vous en prie.";
    } else if (lowerMsg === "au revoir" || lowerMsg === "aurevoir" || lowerMsg === "√† bient√¥t" || lowerMsg === "bye") {
      nonUnderstoodCount = 0;
      return "√Ä bient√¥t et sachez que notre aide est toujours √† port√©e de main. Revenez quand vous le souhaitez. Chaque conseil, chaque r√©v√©lation que nous partageons est une √©toile qui illumine votre chemin vers la d√©livrance et la r√©ussite. Ne laissez jamais les gens et l‚Äôobscurit√© envahir votre √¢me ! √Ä tr√®s vite.";
    } else {
      // V√©rification des fautes ou mots inconnus
      if (containsUnknownWord(userMsg)) {
        nonUnderstoodCount++;
        if (nonUnderstoodCount < 3) {
          return "Je n'ai pas saisi certains mots de votre question. Pourriez-vous reformuler, s'il vous pla√Æt ?";
        } else {
          nonUnderstoodCount = 0;
          return "Il semble que nous ayons du mal √† nous comprendre. Peut-√™tre est-il temps d'envisager un d√©senvo√ªtement pour r√©tablir l'√©quilibre de vos √©nergies. Nos services d√©butent √† 50‚Ç¨ pour une d√©tection et 250‚Ç¨ pour un rituel complet.";
        }
      }
      // Recherche dans la base de connaissances
      let answer = findBestMatch(userMsg);
      if (answer === defaultNonUnderstood) {
        nonUnderstoodCount++;
        if (nonUnderstoodCount < 3) {
          return "Je n'ai pas saisi votre question. Pourriez-vous reformuler, s'il vous pla√Æt ?";
        } else {
          nonUnderstoodCount = 0;
          return "Il semble que nous ayons vraiment du mal √† nous comprendre. Il est grand temps d'envisager un d√©senvo√ªtement pour r√©tablir l'√©quilibre de vos √©nergies. Nos services d√©butent √† 50‚Ç¨ pour une d√©tection et 250‚Ç¨ pour un rituel complet.";
        }
      } else {
        nonUnderstoodCount = 0;
        return answer;
      }
    }
  }

  // Animation de saisie simul√©e pour une r√©ponse plus naturelle
  function simulateTyping(callback) {
    const typingMessage = document.createElement("p");
    typingMessage.className = "bot-message";
    typingMessage.textContent = "...";
    chatMessages.appendChild(typingMessage);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    setTimeout(() => {
      chatMessages.removeChild(typingMessage);
      callback();
    }, 800);
  }

  // Ajout d'un message dans le chat
  function addMessage(txt, cls) {
    const p = document.createElement("p");
    p.className = cls;
    p.textContent = txt;
    chatMessages.appendChild(p);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Mise en place de la d√©pla√ßabilit√© du conteneur de chat
  let isDragging = false, currentX, currentY, initialX, initialY;
  const chatContainer = document.getElementById("chat-container");

  chatContainer.addEventListener("mousedown", startDragging);
  chatContainer.addEventListener("touchstart", startDragging, { passive: false });

  function startDragging(e) {
    isDragging = true;
    if (e.type === "mousedown") {
      initialX = e.clientX - (currentX || 0);
      initialY = e.clientY - (currentY || 0);
    } else if (e.type === "touchstart") {
      initialX = e.touches[0].clientX - (currentX || 0);
      initialY = e.touches[0].clientY - (currentY || 0);
    }
    document.addEventListener("mousemove", drag);
    document.addEventListener("touchmove", drag, { passive: false });
    document.addEventListener("mouseup", stopDragging);
    document.addEventListener("touchend", stopDragging);
  }

  function drag(e) {
    if (!isDragging) return;
    e.preventDefault();
    if (e.type === "mousemove") {
      currentX = e.clientX - initialX;
      currentY = e.clientY - initialY;
    } else if (e.type === "touchmove") {
      currentX = e.touches[0].clientX - initialX;
      currentY = e.touches[0].clientY - initialY;
    }
    chatContainer.style.right = "auto";
    chatContainer.style.bottom = "auto";
    chatContainer.style.left = `${currentX}px`;
    chatContainer.style.top = `${currentY}px`;
  }

  function stopDragging() {
    isDragging = false;
    document.removeEventListener("mousemove", drag);
    document.removeEventListener("touchmove", drag);
    document.removeEventListener("mouseup", stopDragging);
    document.removeEventListener("touchend", stopDragging);
  }

  // Initialisation de la position du chat
  currentX = window.innerWidth - chatContainer.offsetWidth - 20;
  currentY = window.innerHeight - chatContainer.offsetHeight - 20;
  chatContainer.style.left = `${currentX}px`;
  chatContainer.style.top = `${currentY}px`;

  // Gestion de l'ouverture/fermeture du chat
  const chatToggle = document.getElementById("chat-toggle");
  const chatBox = document.getElementById("chat-box");
  const chatMessages = document.getElementById("chat-messages");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");

  chatToggle.addEventListener("click", () => {
    const isHidden = chatBox.classList.contains("hidden");
    chatBox.classList.toggle("hidden");
    chatToggle.setAttribute("aria-expanded", isHidden ? "true" : "false");
    if (isHidden) {
      trackClick("ChatOpen", "Interaction", 0);
      // Si aucun message n'est pr√©sent, afficher le message d'accueil initial
      if (!chatMessages.children.length) {
        addMessage("Bonjour, que puis-je pour vous ?", "bot-message");
      }
      setTimeout(() => chatInput.focus(), 300);
    } else {
      trackClick("ChatClose", "Interaction", 0);
    }
  });

  // Gestion de l'envoi d'une question
  chatForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const userMsg = chatInput.value.trim();
    if (!userMsg) return;
    addMessage(userMsg, "user-message");
    trackClick("ChatMessage", "Interaction", 0);
    chatInput.value = "";
    simulateTyping(() => {
      const answer = getResponse(userMsg);
      addMessage(answer, "bot-message");
    });
  });
</script>
