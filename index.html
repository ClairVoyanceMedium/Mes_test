<!-- Styles et structure HTML du chat avec les modifications demand√©es -->
<style>
  /* Conteneur g√©n√©ral du chat avec effet n√©on sur la bo√Æte */
  #chat-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    max-height: 450px;
    display: flex;
    flex-direction: column;
    z-index: 999999;
    font-family: Arial, sans-serif;
    cursor: move;
    transition: transform 0.2s;
  }

  /* Bouton de bascule */
  #chat-toggle {
    width: 60px;
    height: 60px;
    background: linear-gradient(145deg, #FFB6C1, #FF69B4);
    color: #fff;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255,105,180,0.7);
    font-size: 1.4rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    outline: none;
  }
  #chat-toggle:hover {
    transform: scale(1.05);
  }

  /* Bo√Æte de dialogue avec contour n√©on rose fluo */
  #chat-box {
    background: #111;
    border-radius: 10px;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-top: -10px;
    border: 2px solid #FF1493;
    box-shadow: 0 0 10px #FF1493;
    transition: all 0.3s ease;
  }

  /* Zone des messages avec effet fade-in */
  #chat-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    color: #fff;
  }
  #chat-messages p {
    margin-bottom: 0.5rem;
    line-height: 1.4;
    opacity: 0;
    animation: fadeIn 0.5s forwards;
  }
  @keyframes fadeIn {
    to { opacity: 1; }
  }

  /* Bulles de messages du bot avec effet n√©on rose */
  .bot-message {
    text-align: left;
    color: #fff;
    background: rgba(255,255,255,0.05);
    padding: 0.5rem;
    border-radius: 5px;
    margin-bottom: 0.8rem;
    display: inline-block;
    max-width: 80%;
    border: 2px solid #FF69B4;
    box-shadow: 0 0 8px #FF69B4;
    transition: border 0.3s, box-shadow 0.3s;
  }

  /* Bulles de messages de l'utilisateur avec effet n√©on bleu */
  .user-message {
    text-align: right;
    color: #ffd700;
    margin-bottom: 0.8rem;
    border: 2px solid #1E90FF;
    box-shadow: 0 0 8px #1E90FF;
    padding: 0.5rem;
    border-radius: 5px;
    display: inline-block;
    max-width: 80%;
    transition: border 0.3s, box-shadow 0.3s;
  }

  /* Formulaire de saisie */
  #chat-form {
    display: flex;
    border-top: 1px solid #333;
  }
  #chat-input {
    flex: 1;
    padding: 0.5rem;
    border: none;
    outline: none;
    color: #333;
    border-radius: 0 0 0 10px;
  }
  #chat-send {
    background: #87CEEB;
    border: none;
    padding: 0.5rem 1rem;
    cursor: pointer;
    color: #fff;
    font-weight: bold;
    border-radius: 0 0 10px 0;
    transition: background 0.2s;
  }
  #chat-send:hover {
    background: #5eb6d1;
  }

  /* Contour de la bulle flottante avec effet n√©on */
  #chat-container {
    border: 2px solid #FF1493; /* N√©on rose */
    box-shadow: 0 0 15px #FF1493;
  }

  /* Gestion des tailles pour mobile */
  @media(max-width: 400px) {
    #chat-container {
      width: 90%;
      right: 5%;
      bottom: 5px;
    }
  }
</style>

<div id="chat-container">
  <!-- Bouton de bascule du chat -->
  <button id="chat-toggle" aria-expanded="false" aria-label="Ouvrir le chat">üí¨</button>
  
  <!-- Bo√Æte de dialogue (initialement masqu√©e) -->
  <div id="chat-box" class="hidden" role="region" aria-label="Chat IA">
    <div id="chat-messages" aria-live="polite"></div>
    <form id="chat-form" aria-label="Formulaire de saisie pour le Tchat IA">
      <input type="text" id="chat-input" placeholder="Posez votre question..." aria-label="Tapez votre message ici" autocomplete="off">
      <button type="submit" id="chat-send" aria-label="Envoyer votre question">‚û§</button>
    </form>
  </div>
</div>

<script>
  // Variable pour compter les incompr√©hensions cons√©cutives
  let nonUnderstoodCount = 0;
  const defaultNonUnderstood = "Je ne comprends pas bien."; // Cha√Æne utilis√©e pour tester la correspondance

  // Fonction pour v√©rifier si un mot est "connu"
  function containsUnknownWord(userMsg) {
    let words = userMsg.split(/\s+/);
    const validRegex = /^[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø'-]+$/;
    for (let word of words) {
      let cleanWord = word.replace(/[.,?!;:()"]/g, '');
      if (cleanWord && !validRegex.test(cleanWord)) {
        return true;
      }
    }
    return false;
  }

  // Recherche de la meilleure correspondance dans la base de connaissances
  function findBestMatch(userInput) {
    userInput = userInput.toLowerCase();
    let bestScore = Infinity, bestAnswer = null;
    // Ajouter ici la base de connaissances personnalis√©e...
    if (bestScore > 5) return defaultNonUnderstood;
    return bestAnswer;
  }

  // R√©ponse √† une demande utilisateur
  function getResponse(userMsg) {
    const lowerMsg = userMsg.toLowerCase().trim();
    if (lowerMsg === "bonjour") {
      nonUnderstoodCount = 0;
      return "Je suis √† votre √©coute.";
    } else if (lowerMsg === "merci" || lowerMsg === "merci beaucoup") {
      nonUnderstoodCount = 0;
      return "Je vous en prie.";
    } else if (lowerMsg === "au revoir" || lowerMsg === "aurevoir" || lowerMsg === "√† bient√¥t" || lowerMsg === "bye") {
      nonUnderstoodCount = 0;
      return "Au revoir, mais sachez que notre aide est toujours √† port√©e de main. Revenez quand vous le souhaitez, chaque √©claircissement peut illuminer votre chemin.";
    } else {
      if (containsUnknownWord(userMsg)) {
        nonUnderstoodCount++;
        if (nonUnderstoodCount < 3) {
          return "Je n'ai pas saisi certains mots de votre question. Pourriez-vous reformuler, s'il vous pla√Æt ?";
        } else {
          nonUnderstoodCount = 0;
          return "Je n'arrive toujours pas √† comprendre votre question. Si vous avez des difficult√©s ou souhaitez plus d'√©claircissements, vous pouvez me contacter directement √† l'adresse suivante : <a href='mailto:contact.clairvoyancemedium@gmail.com'>contacter Fr√©d√©ric</a>. Nous pourrions aussi envisager un rituel de d√©senvo√ªtement ou une d√©tection √† partir de 50‚Ç¨, pour r√©tablir l'√©quilibre √©nerg√©tique.";
        }
      }
      return findBestMatch(userMsg);
    }
  }

  // Ajout d'un message dans le chat
  function addMessage(txt, cls) {
    const p = document.createElement("p");
    p.className = cls;
    p.textContent = txt;
    chatMessages.appendChild(p);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Mise en place de l'ouverture/fermeture du chat
  const chatToggle = document.getElementById("chat-toggle");
  const chatBox = document.getElementById("chat-box");
  const chatMessages = document.getElementById("chat-messages");
  const chatForm = document.getElementById("chat-form");
  const chatInput = document.getElementById("chat-input");

  chatToggle.addEventListener("click", () => {
    const isHidden = chatBox.classList.contains("hidden");
    chatBox.classList.toggle("hidden");
    chatToggle.setAttribute("aria-expanded", isHidden ? "true" : "false");
    if (isHidden) {
      addMessage("Bonjour, que puis-je pour vous ?", "bot-message");
      setTimeout(() => chatInput.focus(), 300);
    }
  });

  // Gestion de l'envoi d'une question
  chatForm.addEventListener("submit", (e) => {
    e.preventDefault();
    const userMsg = chatInput.value.trim();
    if (!userMsg) return;
    addMessage(userMsg, "user-message");
    chatInput.value = "";
    const answer = getResponse(userMsg);
    addMessage(answer, "bot-message");
  });
</script>
