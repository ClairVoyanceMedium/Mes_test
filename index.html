<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  
  <title>Chat IA Spirituel - ClairVoyanceMedium.com</title>
  <meta name="description" content="ClairVoyanceGPT - Assistant spirituel IA pour d√©senvo√ªtement, protection et guidance. Frederick du Cabinet ClairVoyanceMedium.com vous accompagne.">
  
  <!-- Favicon -->
  <link rel="icon" href="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/GmyGlKk.webp">
  <meta name="theme-color" content="#8B0000">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2RSFE6WL4M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2RSFE6WL4M', {'anonymize_ip': true});
    gtag('config', 'GTM-P3J6SXCH', {'anonymize_ip': true});
  </script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg:#000;
      --text:#fff;
      --gold:#FFD700;
      --tab-gold:#BBAE98;
      --burgundy:#FF6B6B;
      --burgundy-light:#FF8787;
      --silver:#C0C0C0;
      --accent:#87CEEB;
    }
    
    *{margin:0;padding:0;box-sizing:border-box;}
    
    body{
      font-family:'Cinzel',serif;
      background:var(--bg);
      color:var(--text);
      text-align:center;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      touch-action:manipulation;
      overscroll-behavior-y:contain;
    }
    
    /* NAVIGATION - DISPOSITION GRILLE COMME PHOTO - EN HAUT */
    nav{
      background:rgba(0,0,0,0.95);
      padding:1rem 0.5rem;
      box-shadow:0 2px 15px rgba(255,215,0,0.3);
    }
    
    nav ul{
      list-style:none;
      padding:0;
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      justify-content:center;
      gap:0.6rem;
      max-width:1200px;
      margin:0 auto;
    }
    
    nav ul li a{
      font-family:'Cinzel',serif;
      font-size:clamp(0.95rem, 2.3vw, 1.15rem);
      color:var(--tab-gold);
      text-decoration:none;
      padding:0.7rem 1rem;
      background:rgba(17,17,17,0.95);
      border:2px solid var(--tab-gold);
      border-radius:8px;
      transition:all .3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:50px;
    }
    
    nav ul li a:hover{
      background:var(--tab-gold);
      color:#111;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(187,174,152,0.5);
    }
    
    /* CLIGNOTEMENT ONGLETS */
    @keyframes blinkTab{
      0%, 100%{
        box-shadow:0 0 15px var(--burgundy);
        border-color:var(--burgundy);
        transform:scale(1);
      }
      50%{
        box-shadow:0 0 25px var(--burgundy-light);
        border-color:var(--burgundy-light);
        transform:scale(1.03);
      }
    }
    
    nav ul li a.blink{
      animation:blinkTab 1.2s ease-in-out infinite;
      background:#000;
      border:3px solid var(--burgundy);
      color:var(--tab-gold) !important;
    }
    
    header{
      padding:1.5rem 0;
      background:#111;
      box-shadow:0 4px 10px rgba(0,0,0,.8);
    }
    
    .logo{
      width:720px;
      max-width:90%;
      height:auto;
      display:block;
      margin:0 auto;
    }
    
    .chat-intro{
      max-width:900px;
      margin:1.5rem auto 2rem;
      padding:0 1rem;
      font-size:clamp(1.4rem, 5vw, 2.2rem);
      background:linear-gradient(145deg, #C0C0C0, #E8E8E8, #A8A8A8);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-weight:700;
    }
    
    #chat-container{
      max-width:900px;
      margin:1rem auto 2rem;
      padding:0 1rem;
    }
    
    #chat-box{
      background:#111;
      border:3px solid var(--burgundy);
      box-shadow:0 0 22px var(--burgundy), 0 0 39px rgba(255,107,107,0.7);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:650px;
    }
    
    #chat-messages{
      flex:1;
      padding:1.5rem;
      overflow-y:auto;
      color:#fff;
      background:#0a0a0a;
    }
    
    #chat-messages::-webkit-scrollbar{width:10px;}
    #chat-messages::-webkit-scrollbar-track{background:#1a1a1a;}
    #chat-messages::-webkit-scrollbar-thumb{background:var(--burgundy);box-shadow:0 0 9px var(--burgundy);}
    
    #chat-messages p{
      margin-bottom:1rem;
      line-height:1.7;
      opacity:0;
      animation:fadeIn 0.6s forwards;
    }
    
    @keyframes fadeIn{to{opacity:1;}}
    
    .bot-message{
      text-align:left;
      color:#fff;
      background:rgba(255,107,107,0.15);
      padding:1rem;
      margin-bottom:1rem;
      border:2px solid var(--burgundy);
      box-shadow:0 0 17px rgba(255,107,107,0.55);
      max-width:90%;
    }
    
    .user-message{
      text-align:right;
      color:#fff;
      margin-bottom:1rem;
      border:2px solid var(--silver);
      box-shadow:0 0 17px rgba(192,192,192,0.55);
      padding:1rem;
      max-width:90%;
      margin-left:auto;
      background:linear-gradient(145deg, rgba(192,192,192,0.1), rgba(211,211,211,0.08));
    }
    
    #chat-form{
      display:flex;
      flex-direction:column;
      border-top:3px solid var(--burgundy);
      padding:1rem;
      background:#111;
      gap:0.8rem;
    }
    
    .input-row{
      display:flex;
      gap:0.7rem;
      align-items:center;
    }
    
    #chat-input{
      flex:1;
      padding:1rem;
      border:2px solid var(--burgundy);
      outline:none;
      color:#fff;
      background:#0a0a0a;
      font-family:'Cinzel',serif;
      font-size:0.9rem;
      box-shadow:0 0 13px rgba(255,107,107,0.45);
    }
    
    #chat-input::placeholder{
      color:#999;
      opacity:0.7;
      font-style:italic;
    }
    
    #voice-toggle{
      width:50px;
      height:50px;
      background:linear-gradient(145deg,#87CEEB,#5eb6d1);
      color:#fff;
      border:none;
      border-radius:50%;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(135,206,235,0.8);
      font-size:1.4rem;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform 0.2s;
    }
    
    #voice-toggle:hover{transform:scale(1.1);}
    #voice-toggle.disabled{background:linear-gradient(145deg,#808080,#666);opacity:0.7;}
    
    #chat-send{
      width:100%;
      background:linear-gradient(145deg,var(--burgundy-light),var(--burgundy));
      border:2px solid var(--burgundy);
      padding:1rem 1.8rem;
      cursor:pointer;
      color:#fff;
      font-weight:bold;
      font-family:'Cinzel',serif;
      box-shadow:0 0 20px rgba(255,107,107,0.65);
      font-size:1.1rem;
      transition:transform .2s;
    }
    
    #chat-send:hover{
      transform:scale(1.03);
      box-shadow:0 0 28px rgba(255,107,107,0.85);
    }
    
    /* BOUTON FLOTTANT DRAGGABLE */
    .floating-tab{
      position:fixed;
      top:50%;
      right:20px;
      transform:translateY(-50%);
      z-index:9999;
      background:#000;
      color:var(--tab-gold);
      padding:1.2rem 2rem;
      border:3px solid var(--burgundy);
      font-family:'Cinzel',serif;
      font-size:clamp(1rem, 2.5vw, 1.3rem);
      font-weight:bold;
      text-decoration:none;
      cursor:move;
      box-shadow:0 0 15px var(--burgundy);
      animation:blinkFloating 1.5s ease-in-out infinite;
      display:none;
      user-select:none;
    }
    
    .floating-tab.show{display:block;}
    
    .floating-tab .close-btn{
      position:absolute;
      top:-8px;
      right:-8px;
      width:24px;
      height:24px;
      background:var(--burgundy);
      color:#fff;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      border:2px solid #fff;
      z-index:10000;
    }
    
    @keyframes blinkFloating{
      0%, 100%{box-shadow:0 0 15px var(--burgundy);}
      50%{box-shadow:0 0 25px var(--burgundy-light);}
    }
    
    .return-line{
      font-family:'Cinzel',serif;
      font-size:0.9rem;
      margin:4.5rem auto 1rem;
      text-align:center;
      padding:0 1rem;
    }
    
    .return-line a{
      color:#BBAE98 !important;
      text-decoration:underline;
      transition:all 0.3s ease;
    }
    
    .return-line a:before{
      content:"‚Üê";
      font-size:1.4rem;
      margin-right:0.5rem;
    }
    
    .return-line a:hover{
      color:var(--gold) !important;
      transform:translateX(-5px);
    }
    
    footer{
      margin-top:2rem;
      font-size:.9rem;
      color:#aaa;
      padding:2rem 1rem;
      background:#111;
    }
    
    footer a{color:var(--gold);text-decoration:none;}
    footer a:hover{color:#fff;}
    
    @media(max-width:768px){
      nav ul{grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));}
      nav ul li a{font-size:0.85rem;padding:0.6rem 0.8rem;}
      #chat-box{height:550px;}
      .logo{width:95%;}
    }
    
    @media(max-width:480px){
      nav ul{grid-template-columns:1fr 1fr;}
      nav ul li a{font-size:0.8rem;padding:0.5rem 0.6rem;}
      #chat-box{height:500px;}
    }
  </style>
</head>
<body>
  <!-- ONGLETS EN HAUT -->
  <nav>
    <ul>
      <li><a href="https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/" target="_blank" rel="noopener noreferrer" data-keywords="voyance t√©l√©phone|appel|30min|t√©l|telephoner|appeler|telephone|tel" data-exact="voyance t√©l√©phone">Voyance T√©l 30min/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp" target="_blank" rel="noopener noreferrer" data-keywords="voyance email|questions|3 questions|mail|courriel|√©crit|email|mails" data-exact="voyance email">Voyance Email 3Q/12‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp" target="_blank" rel="noopener noreferrer" data-keywords="retour|ex|amour|reconqu√©rir|s√©paration|copain|copine" data-exact="retour ex">Retour Ex/175‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp" target="_blank" rel="noopener noreferrer" data-keywords="compatibilit√©|couple|relation|amoureuse" data-exact="compatibilit√©">Compatibilit√©/20‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp" target="_blank" rel="noopener noreferrer" data-keywords="d√©senvo√ªtement|protection|purification|sort|envo√ªtement|magie|sorcellerie|fatigue|cauchemars" data-exact="purification">Purification/150‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp" target="_blank" rel="noopener noreferrer" data-keywords="d√©funt|mort|message|deuil|d√©c√©d√©" data-exact="d√©funt">D√©funt/17‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp" target="_blank" rel="noopener noreferrer" data-keywords="sant√©|m√©decine|bien-√™tre|maladie" data-exact="sant√©">Sant√©/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp" target="_blank" rel="noopener noreferrer" data-keywords="main|chiromancie|ligne|paume" data-exact="main">Main/10‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp" target="_blank" rel="noopener noreferrer" data-keywords="ange|gardien|c√©leste|protection divine" data-exact="ange">Ange/10‚Ç¨</a></li>
    </ul>
  </nav>
  
  <!-- LOGO -->
  <header>
    <picture>
      <source srcset="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
      <img src="https://i.imgur.com/GmyGlKk.jpg" alt="Logo ClairVoyanceMedium" class="logo" width="720" height="720" loading="eager" decoding="async" fetchpriority="high">
    </picture>
  </header>
  
  <div class="chat-intro">Chat IA Spirituel - ClairVoyanceGPT</div>
  
  <!-- CHAT -->
  <div id="chat-container">
    <div id="chat-box">
      <div id="chat-messages"></div>
      <form id="chat-form">
        <div class="input-row">
          <input type="text" id="chat-input" placeholder="Votre question..." autocomplete="off">
          <button type="button" id="voice-toggle" title="Assistant vocal">üé§</button>
        </div>
        <button type="submit" id="chat-send">Envoyer</button>
      </form>
    </div>
  </div>
  
  <div class="return-line">
    <a href="https://www.clairvoyancemedium.com/">Retour vers le cabinet de voyance ClairVoyanceMedium.com</a>
  </div>
  
  <!-- BOUTON FLOTTANT -->
  <a id="floating-tab" class="floating-tab" href="#" target="_blank" rel="noopener noreferrer">
    <span class="close-btn">√ó</span>
    <span id="floating-text">Ce qu'il vous faut</span>
  </a>
  
  <footer>
    <p style="color:#aaa;">¬© 2006-<span id="current-year"></span> ClairVoyanceMedium.com - Tous droits r√©serv√©s</p>
    <p><a href="https://www.clairvoyancemedium.com/Conditions-Generales-des-Ventes-et-d-Utilisation-ccsaaaaaa.asp" target="_blank" rel="noopener noreferrer">Conditions G√©n√©rales</a></p>
  </footer>
  
  <script>
document.getElementById('current-year').textContent = new Date().getFullYear();

function trackClick(label, category, value) {
  if (typeof gtag === 'function') {
    gtag('event', label, {'event_category': category, 'event_label': label, 'value': value});
  }
}

let userName = '';
let messageCount = 0;
let voiceEnabled = true;
let recognition = null;
let currentBlinkingTab = null;

const PHONE_NUMBER = "+33695468923";
const PHONE_DISPLAY = "06 95 46 89 23";

// DRAG AND DROP BOUTON FLOTTANT
let isDragging = false;
let currentX, currentY, initialX, initialY;
let xOffset = 0, yOffset = 0;
const floatingTab = document.getElementById('floating-tab');

floatingTab.addEventListener('mousedown', dragStart);
floatingTab.addEventListener('touchstart', dragStart);
document.addEventListener('mousemove', drag);
document.addEventListener('touchmove', drag);
document.addEventListener('mouseup', dragEnd);
document.addEventListener('touchend', dragEnd);

function dragStart(e) {
  if (e.target.classList.contains('close-btn')) {
    e.preventDefault();
    e.stopPropagation();
    floatingTab.classList.remove('show');
    return;
  }
  if (e.type === "touchstart") {
    initialX = e.touches[0].clientX - xOffset;
    initialY = e.touches[0].clientY - yOffset;
  } else {
    initialX = e.clientX - xOffset;
    initialY = e.clientY - yOffset;
  }
  isDragging = true;
}

function drag(e) {
  if (isDragging) {
    e.preventDefault();
    if (e.type === "touchmove") {
      currentX = e.touches[0].clientX - initialX;
      currentY = e.touches[0].clientY - initialY;
    } else {
      currentX = e.clientX - initialX;
      currentY = e.clientY - initialY;
    }
    xOffset = currentX;
    yOffset = currentY;
    floatingTab.style.transform = `translate(${currentX}px, ${currentY}px)`;
  }
}

function dragEnd() {
  initialX = currentX;
  initialY = currentY;
  isDragging = false;
}

// VOIX HOMME GRAVE
function speak(text) {
  if (!voiceEnabled || !('speechSynthesis' in window)) return;
  
  let textToSpeak = text.replace(/https?:\/\/[^\s]+/g, '');
  
  if (text.match(/https?:\/\/[^\s]+/)) {
    textToSpeak += " Cliquez sur le bouton pour y acc√©der.";
  }
  
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(textToSpeak);
  utterance.lang = 'fr-FR';
  
  const voices = window.speechSynthesis.getVoices();
  const maleVoice = voices.find(v => 
    v.lang.startsWith('fr') && (
      v.name.toLowerCase().includes('thomas') ||
      v.name.toLowerCase().includes('daniel') ||
      v.name.toLowerCase().includes('male')
    )
  );
  
  if (maleVoice) utterance.voice = maleVoice;
  
  utterance.pitch = 0.6;
  utterance.rate = 0.85;
  utterance.volume = 1.0;
  
  window.speechSynthesis.speak(utterance);
}

if ('speechSynthesis' in window) {
  window.speechSynthesis.onvoiceschanged = () => {
    window.speechSynthesis.getVoices();
  };
}

// RECONNAISSANCE VOCALE
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('chat-input').value = transcript;
    handleMessage();
  };
}

document.getElementById('voice-toggle').addEventListener('click', () => {
  voiceEnabled = !voiceEnabled;
  document.getElementById('voice-toggle').classList.toggle('disabled', !voiceEnabled);
  if (voiceEnabled && recognition) {
    try { recognition.start(); } catch(e) {}
  } else if (recognition) {
    recognition.stop();
  }
});

function addMessage(text, isBot = false) {
  const messagesDiv = document.getElementById('chat-messages');
  const messageDiv = document.createElement('p');
  messageDiv.className = isBot ? 'bot-message' : 'user-message';
  messageDiv.textContent = text;
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  if (isBot && voiceEnabled) speak(text);
}

// CLIGNOTER ONGLETS
function blinkTab(exactMatch) {
  if (currentBlinkingTab) {
    currentBlinkingTab.classList.remove('blink');
  }
  
  const navLinks = document.querySelectorAll('nav ul li a');
  navLinks.forEach(link => {
    const linkExact = link.getAttribute('data-exact');
    if (linkExact && linkExact.toLowerCase() === exactMatch.toLowerCase()) {
      link.classList.add('blink');
      currentBlinkingTab = link;
      link.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  });
}

// ONGLET FLOTTANT
function showFloatingTab(url, isPhoneNumber = false) {
  const floatingText = document.getElementById('floating-text');
  
  if (isPhoneNumber) {
    floatingTab.href = `tel:${url}`;
    floatingText.textContent = PHONE_DISPLAY;
  } else {
    floatingTab.href = url;
    floatingText.textContent = "Ce qu'il vous faut";
  }
  
  floatingTab.classList.add('show');
  floatingTab.onclick = (e) => {
    if (!e.target.classList.contains('close-btn')) {
      window.open(floatingTab.href, '_blank');
    }
  };
}

// BASE DE CONNAISSANCES COMPL√àTE DU DOCUMENT
const knowledgeBase = [
    { keywords: "fatigue|lassitude|√©puisement|faiblesse|torpeur|fatig", exactMatch: "purification", answer: (name) => `${name ? name + ', ' : ''}cette fatigue √©crasante est l'≈ìuvre d'une entit√© obscure qui d√©vore votre √©nergie. Frederick, avec 25 ans d'exp√©rience chez ClairVoyanceMedium.com, peut vous lib√©rer. Retrouvez vitalit√© et clart√©.`, url: 'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp', isExternal: true },
    { keywords: "cauchemars|visions|nuits|songe|dormir|r√™ves|insomnie", exactMatch: "purification", answer: (name) => `${name ? 'Vos nuits tourment√©es, ' + name + ', ' : 'Ces cauchemars '}ne sont pas anodins. Une pr√©sence mal√©fique hante votre sommeil. Frederick peut chasser ces ombres et vous offrir des nuits paisibles.`, url: 'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp', isExternal: true },
    { keywords: "sort|mal√©diction|envo√ªtement|magie|sorcellerie|sor|envout", exactMatch: "purification", answer: (name) => `${name ? name + ', tous ' : 'Tous '}ces signes concordent : vous √™tes sous l'emprise d'un sort. Frederick ma√Ætrise les rituels ancestraux pour briser ces liens. Des centaines de personnes d√©j√† lib√©r√©es.`, url: 'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp', isExternal: true },
    { keywords: "voyance t√©l√©phone|appel|telephoner|appeler|tel|phone", exactMatch: "voyance t√©l√©phone", answer: (name) => `${name ? name + ', vous ' : 'Vous '}cherchez des r√©ponses imm√©diates ? Consultation t√©l√©phonique avec Frederick : 30 minutes pour 30 euros. Plus de 10 000 consultations, 98% de satisfaction.`, url: 'https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/', isExternal: false },
    { keywords: "numero|num√©ro|telephone|t√©l√©phone|contacter|joindre", exactMatch: "voyance t√©l√©phone", answer: (name) => `${name ? name + ', voici ' : 'Voici '}le num√©ro de Frederick : ${PHONE_DISPLAY}. Disponible pour vous guider vers la clart√©.`, url: PHONE_NUMBER, isPhone: true },
    { keywords: "voyance email|mail|question|√©crit|message|3 questions|email", exactMatch: "voyance email", answer: (name) => `${name ? name + ', la ' : 'La '}voyance par email est id√©ale : 3 questions pour 12 euros, r√©ponse sous 48 heures. Plus de 15 000 consultations r√©alis√©es !`, url: 'https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp', isExternal: true },
    { keywords: "amour|ex|relation|couple|s√©paration|rupture|retour|copain|copine", exactMatch: "retour ex", answer: (name) => `${name ? 'Cette douleur, ' + name + ', ' : 'Cette douleur '}est insupportable. Frederick a r√©concili√© plus de 500 couples en 25 ans. Son rituel de retour affectif agit en 2 √† 4 semaines pour 175 euros.`, url: 'https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp', isExternal: true },
    { keywords: "d√©funt|mort|d√©c√©d√©|message|deuil|au-del√†|disparu", exactMatch: "d√©funt", answer: (name) => `${name ? name + ', perdre ' : 'Perdre '}un √™tre cher laisse tant de questions. Frederick communique avec l'au-del√†. Pour 17 euros, recevez un message authentique qui apaisera votre c≈ìur.`, url: 'https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp', isExternal: true },
    { keywords: "sant√©|maladie|douleur|gu√©rison|corps|souffrance|mal", exactMatch: "sant√©", answer: (name) => `${name ? 'Ces maux, ' + name + ', ' : 'Ces maux '}ont peut-√™tre des racines √©nerg√©tiques. Frederick identifie ces d√©s√©quilibres avec 25 ans d'approche holistique. Analyse : 30 euros.`, url: 'https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp', isExternal: true },
    { keywords: "main|chiromancie|ligne|paume", exactMatch: "main", answer: (name) => `${name ? 'Vos mains, ' + name + ', sont ' : 'Vos mains sont '}une carte vivante de votre destin√©e. Frederick d√©chiffre ces symboles depuis 25 ans. Pour 10 euros, d√©couvrez vos secrets.`, url: 'https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp', isExternal: true },
    { keywords: "ange|gardien|c√©leste|protection divine", exactMatch: "ange", answer: (name) => `${name ? 'Votre ange, ' + name + ', tente ' : 'Votre ange tente '}de communiquer. Frederick capte ces messages divins. Pour 10 euros, recevez sa guidance et sa protection.`, url: 'https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp', isExternal: true }
];

function removeAccents(str) {
    return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function levenshteinDistance(a, b) {
    const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
    for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
    for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
    for (let j = 1; j <= b.length; j++) {
        for (let i = 1; i <= a.length; i++) {
            const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + indicator);
        }
    }
    return matrix[b.length][a.length];
}

function phoneticNormalize(str) {
    return removeAccents(str).replace(/ph/g, "f").replace(/k/g, "c").replace(/qu/g, "k").replace(/ss/g, "s").replace(/√©e/g, "e").replace(/ai/g, "e").replace(/au/g, "o").replace(/ou/g, "u").replace(/oi/g, "oa");
}

function findBestMatch(userInput) {
    const userLower = phoneticNormalize(userInput.toLowerCase());
    const userWords = userLower.split(/\s+/);
    let bestMatch = null;
    let maxScore = 0;
    
    knowledgeBase.forEach(item => {
        let score = 0;
        const keywords = item.keywords.split('|');
        
        keywords.forEach(keyword => {
            const normalizedKeyword = phoneticNormalize(keyword.trim().toLowerCase());
            
            if (userLower.includes(normalizedKeyword)) {
                score += normalizedKeyword.length * 10;
            }
            
            userWords.forEach(userWord => {
                if (userWord.length >= 2) {
                    const distance = levenshteinDistance(userWord, normalizedKeyword);
                    const similarity = 1 - distance / Math.max(userWord.length, normalizedKeyword.length);
                    
                    if (similarity >= 0.45) {
                        score += similarity * normalizedKeyword.length * 5;
                    }
                }
            });
        });
        
        if (score > maxScore) {
            maxScore = score;
            bestMatch = item;
        }
    });
    
    return maxScore > 1 ? bestMatch : null;
}

function handleMessage() {
  const input = document.getElementById('chat-input');
  const userMsg = input.value.trim();
  
  if (!userMsg) return;
  
  addMessage(userMsg, false);
  input.value = '';
  messageCount++;
  
  setTimeout(() => {
    if (!userName) {
      const nameMatch = userMsg.match(/\b([A-Z√Ä-√ñ√ò-√ùa-z√†-√∂√∏-√ø]{2,})\b/);
      if (nameMatch && messageCount >= 2) {
        userName = nameMatch[1].charAt(0).toUpperCase() + nameMatch[1].slice(1).toLowerCase();
        addMessage(`Enchant√© ${userName} ! Comment puis-je vous aider aujourd'hui ?`, true);
        return;
      }
    }
    
    const lowerMsg = userMsg.toLowerCase().trim();
    
    if (lowerMsg === "bonjour" || lowerMsg.startsWith("bonjour") || lowerMsg === "salut" || lowerMsg === "hello") {
      if (!userName) {
        addMessage("Bonjour ! Quel est votre pr√©nom ?", true);
      } else {
        addMessage(`${userName}, quel plaisir de vous retrouver ! Comment puis-je vous aider ?`, true);
      }
      return;
    }
    
    const goodbyeTriggers = ["au revoir", "aurevoir", "√† bient√¥t", "bye", "ciao"];
    if (goodbyeTriggers.some(phrase => lowerMsg === phrase || lowerMsg.endsWith(phrase))) {
      addMessage(userName ? `${userName}, √† tr√®s bient√¥t ! Frederick et son √©quipe restent √† votre √©coute.` : "√Ä bient√¥t !", true);
      return;
    }
    
    const match = findBestMatch(userMsg);
    
    if (match) {
      const response = match.answer(userName);
      addMessage(response, true);
      
      blinkTab(match.exactMatch);
      
      if (match.isExternal || match.isPhone) {
        showFloatingTab(match.url, match.isPhone);
      }
    } else {
      addMessage(userName ? `${userName}, essayez : amour, voyance, protection, fatigue, d√©funt ?` : `Essayez : amour, voyance, protection, fatigue ?`, true);
    }
  }, 800);
}

document.getElementById('chat-send').addEventListener('click', (e) => {
  e.preventDefault();
  handleMessage();
});

document.getElementById('chat-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    handleMessage();
  }
});

document.getElementById('chat-form').addEventListener('submit', (e) => {
  e.preventDefault();
  handleMessage();
});

setTimeout(() => {
  addMessage("Bienvenue sur ClairVoyanceGPT, l'assistant spirituel de Frederick. Bonjour ! Quel est votre pr√©nom ?", true);
}, 500);

// BLOQUER PULL-TO-REFRESH
let lastTouchY = 0;
let preventPullToRefresh = false;

document.addEventListener('touchstart', (e) => {
  if (e.touches.length !== 1) return;
  lastTouchY = e.touches[0].clientY;
  preventPullToRefresh = window.pageYOffset === 0;
}, {passive: false});

document.addEventListener('touchmove', (e) => {
  const touchY = e.touches[0].clientY;
  const touchYDelta = touchY - lastTouchY;
  lastTouchY = touchY;
  if (preventPullToRefresh && touchYDelta > 0) {
    e.preventDefault();
  }
  preventPullToRefresh = false;
}, {passive: false});
</script>
</body>
</html>
