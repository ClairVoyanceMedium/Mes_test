<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' https://fonts.gstatic.com data:; connect-src 'self' https://www.google-analytics.com https://www.googletagmanager.com; media-src 'self' blob:;">
  
  <title>Assistant Spirituel IA - ClairVoyanceMedium.com</title>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-2RSFE6WL4M"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-2RSFE6WL4M', {'anonymize_ip': true});
    gtag('config', 'AW-00000000000', {'anonymize_ip': true});
    gtag('config', 'GTM-P3J6SXCH', {'anonymize_ip': true});
  </script>
  
  <!-- Favicon pour √©cran d'accueil mobile -->
  <link rel="icon" href="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
  <link rel="apple-touch-icon" sizes="180x180" href="https://i.imgur.com/GmyGlKk.webp">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#8B0000">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg:#000;
      --text:#fff;
      --gold:#FFD700;
      --burgundy:#FF6B6B;
      --burgundy-light:#FF8787;
      --link-blue:#4169E1;
      --silver:#C0C0C0;
      --silver-light:#D3D3D3;
    }
    
    *{margin:0;padding:0;box-sizing:border-box;}
    
    body{
      font-family:'Cinzel',serif;
      background:var(--bg);
      color:var(--text);
      text-align:center;
      overflow-x:hidden;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      touch-action:manipulation;
      overscroll-behavior-y:contain;
    }
    
    header{
      padding:1.5rem 0;
      background:#111;
      box-shadow:0 4px 10px rgba(0,0,0,.8);
    }
    
    .logo{
      width:min(90vw,720px);
      max-width:100%;
      height:auto;
      object-fit:contain;
      display:block;
      margin:0 auto;
    }
    
    nav{
      background:#111;
      padding:1rem;
      box-shadow:0 2px 10px rgba(255,215,0,0.3);
      margin-bottom:1rem;
    }
    
    nav ul{
      list-style:none;
      padding:0;
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:0.5rem;
      max-width:1200px;
      margin:0 auto;
    }
    
    nav ul li a{
      font-family:'Cinzel',serif;
      font-size:clamp(0.85rem, 2.5vw, 1.1rem);
      color:#BBAE98;
      text-decoration:none;
      padding:0.5rem 1rem;
      background:#111;
      border:1px solid #BBAE98;
      border-radius:5px;
      transition:background .3s ease,color .3s ease,box-shadow .3s ease;
      display:inline-block;
      text-align:center;
      white-space:nowrap;
    }
    
    nav ul li a:hover{
      background:#BBAE98;
      color:#111;
    }
    
    nav ul li a:focus{
      outline:2px solid #87CEEB;
      outline-offset:2px;
    }
    
    @keyframes pulseNeonBurgundy{
      0%{
        box-shadow:0 0 20px var(--burgundy),0 0 40px var(--burgundy),0 0 60px var(--burgundy);
        border-color:var(--burgundy);
      }
      50%{
        box-shadow:0 0 30px var(--burgundy-light),0 0 60px var(--burgundy-light),0 0 90px var(--burgundy-light);
        border-color:var(--burgundy-light);
      }
      100%{
        box-shadow:0 0 20px var(--burgundy),0 0 40px var(--burgundy),0 0 60px var(--burgundy);
        border-color:var(--burgundy);
      }
    }
    
    nav ul li a.highlight{
      animation:pulseNeonBurgundy 0.8s ease-in-out infinite;
      border:2px solid var(--burgundy);
    }
    
    .chat-intro{
      max-width:900px;
      margin:2.5rem auto 3rem;
      padding:0 1rem;
      font-size:clamp(1rem, 4vw, 1.6rem);
      color:var(--gold);
      text-shadow:0 0 10px rgba(255,215,0,0.5);
      font-weight:700;
      letter-spacing:1px;
    }
    
    #chat-container{
      max-width:900px;
      margin:1rem auto 2rem;
      padding:0 1rem;
    }
    
    #chat-box{
      background:#111;
      border-radius:15px;
      border:2px solid var(--burgundy);
      box-shadow:0 0 25px var(--burgundy),0 0 50px rgba(255,107,107,0.5),0 0 75px rgba(255,107,107,0.3);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:650px;
    }
    
    #chat-messages{
      flex:1;
      padding:1.5rem;
      overflow-y:auto;
      color:#fff;
      background:#0a0a0a;
      overscroll-behavior-y:contain;
    }
    
    #chat-messages::-webkit-scrollbar{width:10px;}
    #chat-messages::-webkit-scrollbar-track{background:#1a1a1a;border-radius:5px;}
    #chat-messages::-webkit-scrollbar-thumb{background:var(--burgundy);border-radius:5px;}
    
    #chat-messages p{
      margin-bottom:1rem;
      line-height:1.7;
      opacity:0;
      animation:fadeIn 0.6s forwards;
    }
    
    @keyframes fadeIn{to{opacity:1;}}
    
    .bot-message{
      text-align:left;
      color:#fff;
      background:rgba(255,107,107,0.15);
      padding:1rem;
      border-radius:10px;
      margin-bottom:1rem;
      border:2px solid var(--burgundy);
      box-shadow:0 0 12px rgba(255,107,107,0.4);
      max-width:90%;
    }
    
    .user-message{
      text-align:right;
      color:#fff;
      margin-bottom:1rem;
      border:2px solid var(--silver);
      box-shadow:0 0 12px rgba(192,192,192,0.4), inset 0 0 8px rgba(255,255,255,0.1);
      padding:1rem;
      border-radius:10px;
      max-width:90%;
      margin-left:auto;
      background:linear-gradient(145deg, rgba(192,192,192,0.1), rgba(211,211,211,0.08));
    }
    
    #chat-form{
      display:flex;
      flex-direction:column;
      border-top:2px solid var(--burgundy);
      padding:1rem;
      background:#111;
      gap:0.8rem;
    }
    
    .input-row{
      display:flex;
      gap:0.7rem;
      align-items:center;
    }
    
    #chat-input{
      flex:1;
      padding:1rem;
      border:2px solid var(--burgundy);
      outline:none;
      color:#fff;
      background:#0a0a0a;
      border-radius:8px;
      font-family:'Cinzel',serif;
      font-size:1rem;
    }
    
    #chat-input::placeholder{
      color:#999;
      opacity:0.85;
      font-style:italic;
    }
    
    #chat-input:focus{
      box-shadow:0 0 20px rgba(255,107,107,0.5);
      border-color:var(--burgundy-light);
    }
    
    #voice-toggle{
      width:50px;
      height:50px;
      background:linear-gradient(145deg,#87CEEB,#5eb6d1);
      color:#fff;
      border:none;
      border-radius:50%;
      cursor:pointer;
      box-shadow:0 4px 15px rgba(135,206,235,0.8);
      font-size:1.4rem;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:transform 0.2s,box-shadow 0.2s;
      outline:none;
    }
    
    #voice-toggle:hover{
      transform:scale(1.1);
      box-shadow:0 6px 20px rgba(135,206,235,1);
    }
    
    #voice-toggle.disabled{
      background:linear-gradient(145deg,#808080,#666);
      box-shadow:0 0 10px #808080;
      opacity:0.7;
    }
    
    #chat-send{
      width:100%;
      background:linear-gradient(145deg,var(--burgundy-light),var(--burgundy));
      border:none;
      padding:1rem 1.8rem;
      cursor:pointer;
      color:#fff;
      font-weight:bold;
      border-radius:8px;
      transition:transform .2s,box-shadow .2s;
      font-family:'Cinzel',serif;
      box-shadow:0 4px 15px rgba(255,107,107,.5);
      font-size:1.1rem;
    }
    
    #chat-send:hover{
      transform:scale(1.03);
      box-shadow:0 6px 20px rgba(255,107,107,.7);
    }
    
    .return-line{
      font-family:'Cinzel',serif;
      font-size:0.85rem;
      letter-spacing:0.5px;
      margin:4.5rem auto 1rem;
      text-align:center;
      padding:0 1rem;
    }
    
    .return-line a{
      color:#5B9BD5;
      text-decoration:underline;
      transition:color 0.3s ease;
    }
    
    .return-line a:hover{
      color:#87CEEB;
    }
    
    footer{
      margin-top:2rem;
      font-size:.9rem;
      color:#aaa;
      padding:2rem 1rem;
      background:#111;
    }
    
    footer a{
      color:var(--gold);
      text-decoration:none;
      transition:color .3s ease;
    }
    
    footer a:hover{
      color:#fff;
    }
    
    /* Boutons flottants */
    .floating-button{
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:9999;
      padding:1rem 2rem;
      background:linear-gradient(145deg, #87CEEB, #5eb6d1);
      color:#fff;
      border:2px solid #87CEEB;
      border-radius:12px;
      font-family:'Cinzel',serif;
      font-size:clamp(1rem, 2.5vw, 1.3rem);
      font-weight:bold;
      text-decoration:none;
      cursor:pointer;
      animation:pulseFloat 1.5s ease-in-out infinite, scaleText 1s ease-in-out infinite;
      box-shadow:0 4px 20px rgba(135,206,235,0.7);
      transition:transform 0.2s;
      display:none;
    }
    
    .floating-button.show{
      display:block;
    }
    
    .floating-button:hover{
      transform:scale(1.05);
    }
    
    @keyframes pulseFloat{
      0%, 100%{
        box-shadow:0 0 20px #87CEEB, 0 0 40px #87CEEB;
        border-color:#87CEEB;
      }
      50%{
        box-shadow:0 0 30px var(--burgundy), 0 0 60px var(--burgundy);
        border-color:var(--burgundy);
      }
    }
    
    @keyframes scaleText{
      0%, 100%{
        font-size:clamp(1rem, 2.5vw, 1.3rem);
      }
      50%{
        font-size:clamp(1.1rem, 2.7vw, 1.5rem);
      }
    }
    
    @media(max-width:1024px){
      .chat-intro{font-size:1.4rem;}
      #chat-box{height:600px;}
    }
    
    @media(max-width:768px){
      nav ul{gap:0.4rem;}
      nav ul li a{font-size:0.95rem;padding:0.45rem 0.8rem;}
      .chat-intro{font-size:1.2rem;}
      #chat-box{height:550px;}
      .return-line{font-size:0.8rem;}
      .logo{width:95vw;}
      .floating-button{
        bottom:10px;
        right:10px;
        padding:0.8rem 1.5rem;
        font-size:clamp(0.9rem, 2.2vw, 1.1rem);
      }
    }
    
    @media(max-width:480px){
      nav ul{flex-direction:column;align-items:stretch;}
      nav ul li a{display:block;width:100%;font-size:0.9rem;}
      .chat-intro{font-size:1rem;}
      #chat-box{height:500px;}
      #voice-toggle{width:45px;height:45px;font-size:1.2rem;}
      .logo{width:98vw;}
    }
  </style>
</head>
<body>
  <header>
    <picture>
      <source srcset="https://i.imgur.com/GmyGlKk.webp" type="image/webp">
      <img src="https://i.imgur.com/GmyGlKk.jpg" alt="Logo ClairVoyanceMedium" class="logo" width="720" height="720" loading="eager" onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22720%22 height=%22720%22%3E%3Crect fill=%22%23111%22 width=%22720%22 height=%22720%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2248%22 fill=%22%23FFD700%22 text-anchor=%22middle%22 dy=%22.3em%22%3EClairVoyanceMedium%3C/text%3E%3C/svg%3E';">
    </picture>
  </header>
  
  <nav>
    <ul>
      <li><a href="https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/" target="_blank" rel="noopener noreferrer" onclick="trackClick('VoyanceTel','Navigation',30);" data-keyword="voyance t√©l√©phone|t√©l√©phone|appel|30min">Voyance T√©l 30min/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Voyance-3-Questions-par-Email-cbaaaaaca.asp" target="_blank" rel="noopener noreferrer" onclick="trackClick('VoyanceEmail','Navigation',12);" data-keyword="voyance email|email|questions|3 questions">Voyance Email 3Q/12‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp" target="_blank" rel="noopener noreferrer" onclick="trackClick('RetourEx','Navigation',175);" data-keyword="retour affectif|ex|reconqu√©rir|amour">Retour Ex/175‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Compatibilite-amoureuse-cbaaaaata.asp" target="_blank" rel="noopener noreferrer" onclick="trackClick('Compatibilite','Navigation',20);" data-keyword="compatibilit√©|couple|amoureuse|relation">Compatibilit√©/20‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp" target="_blank" rel="noopener noreferrer" onclick="trackClick('Protection','Navigation',150);" data-keyword="d√©senvo√ªtement|protection|purification|envo√ªtement|sort|mal√©diction">Purification/150‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp" target="_blank" rel="noopener noreferrer" onclick="trackClick('Defunt','Navigation',17);" data-keyword="d√©funt|mort|message|au-del√†">D√©funt/17‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp" target="_blank" rel="noopener noreferrer" onclick="trackClick('Sante','Navigation',30);" data-keyword="sant√©|naturelle|m√©decine|bien-√™tre">Sant√©/30‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp" target="_blank" rel="noopener noreferrer" onclick="trackClick('Main','Navigation',10);" data-keyword="ligne main|chiromancie|main|paume">Main/10‚Ç¨</a></li>
      <li><a href="https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp" target="_blank" rel="noopener noreferrer" onclick="trackClick('Ange','Navigation',10);" data-keyword="ange|gardien|ange gardien|c√©leste">Ange/10‚Ç¨</a></li>
    </ul>
  </nav>
  
  <div class="chat-intro">Chat IA Spirituel - ClairVoyanceGPT</div>
  
  <div id="chat-container">
    <div id="chat-box">
      <div id="chat-messages"></div>
      <form id="chat-form">
        <div class="input-row">
          <input type="text" id="chat-input" placeholder="Posez votre question spirituelle ici..." autocomplete="off">
          <button type="button" id="voice-toggle" title="Assistant vocal">üé§</button>
        </div>
        <button type="submit" id="chat-send">Envoyer</button>
      </form>
    </div>
  </div>
  
  <div class="return-line">
    <a href="https://www.clairvoyancemedium.com/" target="_blank" rel="noopener noreferrer" onclick="trackClick('RetourCabinet','Navigation',0);">Retour vers le cabinet de voyance ClairVoyanceMedium.com</a>
  </div>
  
  <!-- Bouton flottant dynamique -->
  <a id="floating-btn" class="floating-button" href="#" target="_blank" rel="noopener noreferrer"></a>
  
  <footer>
    <p style="color:#aaa;">¬© 2006-<span id="current-year"></span> ClairVoyanceMedium.com - Tous droits r√©serv√©s</p>
    <p><a href="https://www.clairvoyancemedium.com/Conditions-Generales-des-Ventes-et-d-Utilisation-ccsaaaaaa.asp" target="_blank" rel="noopener noreferrer" onclick="trackClick('CGV','Footer',0);" style="color:#aaa;">Conditions G√©n√©rales</a></p>
  </footer>
  
  <script>
// Ann√©e auto-mise √† jour
document.getElementById('current-year').textContent = new Date().getFullYear();

// Bloquer pull-to-refresh mobile
let lastTouchY = 0;
let preventPullToRefresh = false;

document.addEventListener('touchstart', (e) => {
  if (e.touches.length !== 1) return;
  lastTouchY = e.touches[0].clientY;
  preventPullToRefresh = window.pageYOffset === 0;
}, {passive: false});

document.addEventListener('touchmove', (e) => {
  const touchY = e.touches[0].clientY;
  const touchYDelta = touchY - lastTouchY;
  lastTouchY = touchY;

  if (preventPullToRefresh) {
    if (touchYDelta > 0) {
      e.preventDefault();
      return;
    }
    preventPullToRefresh = false;
  }
}, {passive: false});

function trackClick(label, category, value) {
  if (typeof gtag === 'function') {
    gtag('event', label, {'event_category': category, 'event_label': label, 'value': value});
  }
}

let userName = '';
let messageCount = 0;
let voiceEnabled = true;
let recognition = null;
let currentHighlightedLinks = [];
let askedForName = false;

// Configuration vocale (du document 2)
function speak(text) {
  if (!voiceEnabled || !('speechSynthesis' in window)) return;
  
  // Ne pas citer les URLs
  const textToSpeak = text.replace(/https?:\/\/[^\s]+/g, '');
  
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(textToSpeak);
  utterance.lang = 'fr-FR';
  utterance.pitch = 0.5;
  utterance.rate = 1.1;
  
  const voices = window.speechSynthesis.getVoices();
  if (voices.length > 0) {
    const maleVoice = voices.find(v => v.name.toLowerCase().includes('male') || v.name.toLowerCase().includes('fran√ßais'));
    if (maleVoice) utterance.voice = maleVoice;
  }
  
  window.speechSynthesis.speak(utterance);
  trackClick('VoiceOutput', 'Chat', 0);
}

// Reconnaissance vocale
if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'fr-FR';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById('chat-input').value = transcript;
    handleMessage();
    trackClick('VoiceInput', 'Chat', 0);
  };
  
  recognition.onerror = (event) => {
    console.error('Erreur reconnaissance:', event.error);
    trackClick('VoiceError', 'Chat', 0);
  };
}

document.getElementById('voice-toggle').addEventListener('click', () => {
  voiceEnabled = !voiceEnabled;
  document.getElementById('voice-toggle').classList.toggle('disabled', !voiceEnabled);
  
  if (voiceEnabled && recognition) {
    try { recognition.start(); trackClick('VoiceOn', 'Chat', 0); } catch(e) {}
  } else if (recognition) {
    recognition.stop(); trackClick('VoiceOff', 'Chat', 0);
  }
});

function highlightNav(keywords) {
  if (!keywords) return;
  
  currentHighlightedLinks.forEach(link => link.classList.remove('highlight'));
  currentHighlightedLinks = [];
  
  const navLinks = document.querySelectorAll('nav ul li a');
  navLinks.forEach(link => {
    const linkKeywords = link.getAttribute('data-keyword').toLowerCase();
    const keywordList = keywords.toLowerCase().split('|');
    if (keywordList.some(k => linkKeywords.includes(k))) {
      link.classList.add('highlight');
      currentHighlightedLinks.push(link);
      
      // Cr√©er bouton flottant pour navigation
      showFloatingButton(link.textContent.trim(), link.href, 8000);
    }
  });
}

function stopHighlight() {
  currentHighlightedLinks.forEach(link => link.classList.remove('highlight'));
  currentHighlightedLinks = [];
}

// Gestion du bouton flottant
function showFloatingButton(text, url, duration) {
  const floatingBtn = document.getElementById('floating-btn');
  floatingBtn.textContent = text || 'Cliquez ici';
  floatingBtn.href = url;
  floatingBtn.classList.add('show');
  
  setTimeout(() => {
    floatingBtn.classList.remove('show');
  }, duration);
}

function addMessage(text, isBot = false) {
  const messagesDiv = document.getElementById('chat-messages');
  const messageDiv = document.createElement('p');
  messageDiv.className = isBot ? 'bot-message' : 'user-message';
  messageDiv.textContent = text;
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  if (isBot && voiceEnabled) speak(text);
}

const knowledgeBase = [
  { 
    q: "pr√©nom|nom|appelle|m'appelle|je suis|c'est", 
    priority: 100, 
    answer: (name) => `Bonjour ${name}, comment puis-je vous aider aujourd'hui ?`,
    track: 'Prenom'
  },
  { 
    q: "bonjour|salut|bonsoir|hello", 
    priority: 99, 
    answer: () => "Bonjour, ravi de vous accueillir ! Je suis ClairVoyanceGPT. Avant de commencer, quel est votre pr√©nom ?",
    track: 'Greeting'
  },
  { 
    q: "voyance|voyant|pr√©diction|avenir|futur|consultation", 
    highlight: "voyance t√©l√©phone|voyance email", 
    answer: (name) => `${name || 'Cher consultant'}, l'incertitude peut √™tre √©touffante. Frederick, fort de plus de 25 ans d'expertise, a guid√© des milliers de personnes. Consultation t√©l√©phone 30min √† 30‚Ç¨ ou email 3Q √† 12‚Ç¨. Les tarifs exceptionnels ne dureront pas. Je vous invite √† cliquer sur le lien qui vient d'appara√Ætre.`,
    track: 'Voyance',
    url: 'https://clairvoyancemedium.github.io/Voyancepartelephonepaschere.github.io/'
  },
  { 
    q: "amour|ex|relation|couple|s√©paration|rupture|retour", 
    highlight: "retour affectif|compatibilit√©", 
    answer: (name) => `${name || 'Cher consultant'}, je comprends cette douleur. Frederick a r√©concili√© des centaines de couples. Son rituel √† 175‚Ç¨ restaurera l'harmonie. Agissez maintenant, je vous invite √† cliquer sur le bouton qui vient d'appara√Ætre.`,
    track: 'Amour',
    url: 'https://www.clairvoyancemedium.com/Reconquerir-son-ex-a-distance-Blanche-cbaaaaasa.asp'
  },
  { 
    q: "d√©senvo√ªtement|envo√ªt√©|sort|mal√©diction|protection|purification", 
    highlight: "purification", 
    answer: (name) => `${name || 'Cher consultant'}, cauchemars, fatigue, malchance r√©v√®lent une influence occulte. Frederick ma√Ætrise les rituels √† 150‚Ç¨. En 4 jours, il brisera ces cha√Ænes. Cliquez sur le bouton qui vient d'appara√Ætre pour commencer.`,
    track: 'Desenvoutement',
    url: 'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp'
  },
  { 
    q: "d√©funt|mort|d√©c√©d√©|au-del√†|message|deuil", 
    highlight: "d√©funt", 
    answer: (name) => `${name || 'Cher consultant'}, le deuil est lourd. Frederick √©tablit ce pont sacr√©. Pour 17‚Ç¨, recevez un message qui apaisera votre c≈ìur. Je vous invite √† cliquer sur le lien propos√©.`,
    track: 'Defunt',
    url: 'https://www.clairvoyancemedium.com/Recevez-1-message-d-un-defunt-cbaaaabka.asp'
  },
  { 
    q: "sant√©|maladie|douleur|corps", 
    highlight: "sant√©", 
    answer: (name) => `${name || 'Cher consultant'}, ces maux ont des racines √©nerg√©tiques. Frederick identifiera les d√©s√©quilibres. Consultation 30‚Ç¨. Le lien est disponible pour vous.`,
    track: 'Sante',
    url: 'https://www.clairvoyancemedium.com/Medecine-Consultation-par-email-cbaaaabja.asp'
  },
  { 
    q: "main|chiromancie|ligne|paume", 
    highlight: "main", 
    answer: (name) => `${name || 'Cher consultant'}, vos mains r√©v√®lent votre destin√©e. Frederick d√©crypte ces symboles pour 10‚Ç¨. Cliquez sur le bouton qui s'affiche.`,
    track: 'Main',
    url: 'https://www.clairvoyancemedium.com/Ligne-de-la-main-Voyance-3-questions-cbaaaaana.asp'
  },
  { 
    q: "ange|gardien|c√©leste", 
    highlight: "ange", 
    answer: (name) => `${name || 'Cher consultant'}, votre ange gardien tente de vous prot√©ger. Frederick capte ce message pour 10‚Ç¨. Je vous invite √† cliquer maintenant.`,
    track: 'Ange',
    url: 'https://www.clairvoyancemedium.com/Message-de-votre-Ange-gardien-cbaaaabba.asp'
  },
  { 
    q: "fatigue|√©puisement|√©nergie", 
    highlight: "purification", 
    answer: (name) => `${name || 'Cher consultant'}, cette fatigue r√©v√®le un drainage √©nerg√©tique. Frederick restaure votre vitalit√© en 4 jours √† 150‚Ç¨. Le bouton est l√† pour vous.`,
    track: 'Fatigue',
    url: 'https://www.clairvoyancemedium.com/Desenvoutement-et-protection-a-distance-cbaaaaala.asp'
  },
  { 
    q: "prix|tarif|combien", 
    answer: (name) => `${name || 'Cher consultant'}, tarifs : Voyance t√©l 30min: 30‚Ç¨ | Email 3Q: 12‚Ç¨ | Retour ex: 175‚Ç¨ | Compatibilit√©: 20‚Ç¨ | Purification: 150‚Ç¨ | D√©funt: 17‚Ç¨ | Sant√©: 30‚Ç¨ | Main: 10‚Ç¨ | Ange: 10‚Ç¨. Prix exceptionnels temporaires.`,
    track: 'Prix'
  },
  { 
    q: "contact|email|joindre", 
    answer: (name) => `${name || 'Cher consultant'}, pour toute question, consultez directement nos services sur le site. R√©ponse rapide garantie.`,
    track: 'Contact'
  },
  { 
    q: "merci|remercie", 
    answer: () => "Je vous en prie. Frederick et son √©quipe sont l√† 24h/24.",
    track: 'Merci'
  },
  { 
    q: "au revoir|bye|adieu", 
    answer: (name) => `Au revoir ${name || 'Cher consultant'}. Que la lumi√®re vous accompagne !`,
    track: 'Bye'
  },
  { 
    q: "d'accord|ok|oui", 
    answer: () => "D'accord, n'h√©sitez pas √† poser d'autres questions.",
    track: 'Accord'
  }
];

function findBestMatch(input) {
  const inputLower = input.toLowerCase();
  
  const nameMatch = input.match(/(?:je m'appelle|mon pr√©nom|je suis|c'est)\s+([a-z√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º√ø√¶≈ì√ß]+)/i);
  if (nameMatch && !userName) {
    userName = nameMatch[1].charAt(0).toUpperCase() + nameMatch[1].slice(1).toLowerCase();
    askedForName = false;
    return knowledgeBase.find(item => item.q.includes('pr√©nom'));
  }
  
  let bestMatch = null;
  let highestPriority = -1;
  
  for (const item of knowledgeBase) {
    const keywords = item.q.split('|');
    const priority = item.priority || 0;
    
    if (keywords.some(k => inputLower.includes(k.toLowerCase()))) {
      if (priority > highestPriority || !bestMatch) {
        highestPriority = priority;
        bestMatch = item;
      }
    }
  }
  
  return bestMatch;
}

function handleMessage() {
  const input = document.getElementById('chat-input');
  const userMsg = input.value.trim();
  
  if (!userMsg) return;
  
  addMessage(userMsg, false);
  input.value = '';
  messageCount++;
  trackClick('MessageSent', 'Chat', messageCount);
  
  setTimeout(() => {
    stopHighlight();
    
    // Demander le pr√©nom si pas encore fait
    if (!userName && !askedForName && messageCount === 1) {
      askedForName = true;
      addMessage("Avant de commencer, quel est votre pr√©nom ?", true);
      return;
    }
    
    const match = findBestMatch(userMsg);
    
    if (match) {
      const response = typeof match.answer === 'function' 
        ? match.answer(userName)
        : match.answer;
      
      addMessage(response, true);
      
      if (match.highlight) {
        highlightNav(match.highlight);
      }
      
      if (match.url) {
        showFloatingButton('Cliquez ici', match.url, 10000);
      }
      
      if (match.track) {
        trackClick(match.track, 'Response', 0);
      }
    } else {
      const defaultMsg = userName 
        ? `${userName}, pr√©cisez votre besoin : amour, voyance, protection ? Ou consultez nos services directement.`
        : `Votre question n√©cessite une guidance personnalis√©e. Consultez nos services pour un accompagnement approfondi.`;
      
      addMessage(defaultMsg, true);
      trackClick('NoMatch', 'Response', 0);
    }
  }, 800);
}

document.getElementById('chat-send').addEventListener('click', (e) => {
  e.preventDefault();
  handleMessage();
});

document.getElementById('chat-input').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    handleMessage();
  }
});

document.getElementById('chat-form').addEventListener('submit', (e) => {
  e.preventDefault();
  handleMessage();
});

setTimeout(() => {
  addMessage("Bienvenue ! Je suis ClairVoyanceGPT, assistant de Frederick, m√©dium depuis plus de 25 ans. Quel est votre pr√©nom ?", true);
  trackClick('ChatOpened', 'Chat', 0);
}, 500);
</script>
</body>
</html>
